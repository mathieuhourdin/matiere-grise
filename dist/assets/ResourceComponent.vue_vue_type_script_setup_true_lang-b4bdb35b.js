import{_ as ne,a as me,u as je}from"./useThoughtInputs-9c987aa4.js";import{a as F,_ as Z}from"./ActionButton.vue_vue_type_script_setup_true_lang-a60d2659.js";import{o as t,f as r,a as f,d as V,b as p,n as Ie,y as Ve,e as K,m as w,F as ee,g as te,i as v,t as k,h as S,j as we,A as Le,q as H,B as ae,C as xe,D as Ne,p as P,E as ye,c as R,x as Te,r as Ue,w as B,l as ie,G as ze,_ as re,u as pe,H as se,I as Me,J as We}from"./index-c23c6ded.js";import{a as Je,_ as Ke}from"./SelectionTextInterface.vue_vue_type_script_setup_true_lang-6f018e08.js";import"./SelectionTextInterface.vue_vue_type_style_index_0_lang-65dce772.js";import{_ as Ae}from"./ProgressBar.vue_vue_type_script_setup_true_lang-40cea443.js";import{u as fe}from"./useResource-d4bf34d0.js";import{_ as De}from"./UserPicker.vue_vue_type_script_setup_true_lang-06028e97.js";import{u as Be}from"./useResourceRelations-121aadd3.js";function He(_,s){return t(),r("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true"},[f("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M9 8.25H7.5a2.25 2.25 0 00-2.25 2.25v9a2.25 2.25 0 002.25 2.25h9a2.25 2.25 0 002.25-2.25v-9a2.25 2.25 0 00-2.25-2.25H15M9 12l3 3m0 0l3-3m-3 3V2.25"})])}function Ge(_,s){return t(),r("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true"},[f("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M7.217 10.907a2.25 2.25 0 100 2.186m0-2.186c.18.324.283.696.283 1.093s-.103.77-.283 1.093m0-2.186l9.566-5.314m-9.566 7.5l9.566 5.314m0 0a2.25 2.25 0 103.935 2.186 2.25 2.25 0 00-3.935-2.186zm0-12.814a2.25 2.25 0 103.933-2.185 2.25 2.25 0 00-3.933 2.185z"})])}function Qe(_,s){return t(),r("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true"},[f("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M21.75 6.75a4.5 4.5 0 01-4.884 4.484c-1.076-.091-2.264.071-2.95.904l-7.152 8.684a2.548 2.548 0 11-3.586-3.586l8.684-7.152c.833-.686.995-1.874.904-2.95a4.5 4.5 0 016.336-4.486l-3.276 3.276a3.004 3.004 0 002.25 2.25l3.276-3.276c.256.565.398 1.192.398 1.852z"}),f("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M4.867 19.125h.008v.008h-.008v-.008z"})])}const Xe={class:"justify-items-center mx-auto flex flex-wrap max-w-full"},Ye={key:0,class:"ml-auto"},Ze={key:0,class:"absolute right-0 top-0 w-4 h-4 rounded-square text-2xs bg-green-400 text-center"},et=f("div",{class:"mr-auto"},null,-1),Ee=V({__name:"ToggleButtonGroup",props:{choices:{},default:{},urlKey:{},url:{type:Boolean,default:!1},center:{type:Boolean,default:!1}},emits:["update"],setup(_,{emit:s}){const n=_,i=p(null),o=Ie(),c=Ve(),u=e=>{if(s("update",e),i.value=e,n.url){const a=c.query,d=c.path,g=n.urlKey??"tab";console.log(g);const h={};h[g]=e;const x={...a,...h};o.push({path:d,query:x}),console.log(`route : ${JSON.stringify(c)}`)}};return K(()=>u(n.default??"")),(e,a)=>(t(),r("div",Xe,[e.center?(t(),r("div",Ye)):w("",!0),(t(!0),r(ee,null,te(e.choices,d=>(t(),r("div",{class:"relative",key:d.value},[v(F,{class:"w-30 my-1 mx-1",text:d.text,onClick:g=>u(d.value),type:d.value==i.value?"valid":"abort"},null,8,["text","onClick","type"]),d.count?(t(),r("div",Ze,k(d.count),1)):w("",!0)]))),128)),et]))}}),tt={class:"bg-slate-100 border p-1 m-1 rounded shadow-xl"},ot={class:"flex"},lt={key:0,class:"text-xs mt-0.5 mb-1 font-bold flex"},st=["src"],nt={class:"my-auto"},at={class:"text-2xs italic ml-auto mr-1 my-auto"},rt={key:0},ut=["value"],it={class:"flex"},ct={key:1,class:"text-xs mt-0.5"},be=V({__name:"CommentCard",props:{editing:{type:Boolean},modelValue:{},author:{},createdAt:{}},emits:["update:modelValue","validate","abort"],setup(_,{emit:s}){const n=_,i=S(()=>n.createdAt?n.createdAt.toLocaleString("fr-FR",{hour:"numeric",weekday:"short",day:"numeric",month:"short",year:"2-digit"}):""),o=e=>{s("update:modelValue",e.target.value)},c=()=>{s("validate")},u=()=>{s("abort")};return(e,a)=>(t(),r("div",tt,[f("div",ot,[e.author?(t(),r("div",lt,[e.author.profile_picture_url?(t(),r("img",{key:0,class:"h-5 w-5 rounded-full mr-1",src:e.author.profile_picture_url},null,8,st)):w("",!0),f("div",nt,k(e.author.first_name)+" "+k(e.author.last_name),1)])):w("",!0),f("div",at,k(i.value),1)]),e.editing?(t(),r("div",rt,[f("textarea",{class:"w-full text-xs rounded-xl p-2",value:e.modelValue,onInput:o},null,40,ut),f("div",it,[v(F,{onClick:c,class:"text-sm",rounded:"",size:"2xs",text:"Commenter",type:"valid"}),v(F,{onClick:u,class:"text-sm",rounded:"",size:"2xs",text:"Annuler",type:"abort"})])])):(t(),r("div",ct,k(e.modelValue),1))]))}}),{launchSnackbar:ke}=Le(),dt=async(_,s,n,i)=>{const{user:o}=H(),c={start_index:s,end_index:s,content:n,editing:i};try{const u=await we.post("/resources/"+_+"/comments",c),e=$e(u.data);return o.value&&e.author_id==o.value.id&&(e.author=o.value),e}catch(u){throw console.log("error : ",u),ke(`Error creating comment : ${u}`,"error"),u}},$e=_=>(_.updated_at=new Date(_.updated_at.split(".")[0]),_.created_at=new Date(_.created_at.split(".")[0]),_),vt=async(_,s=!0)=>{const n=s?"?author=true":"";try{return(await we.get("/resources/"+_+"/comments"+n)).data.map(o=>$e(o))}catch(i){throw console.log("error : ",i),ke(`Error getting comments : ${i}`,"error"),i}},Se=async _=>{try{const s=await we.put("/comments/"+_.id,_);return $e(s.data)}catch(s){console.log("error : ",s),ke(`Error updating comment : ${s}`,"error")}},mt=async _=>{console.log("comments : ",_),_.map(s=>Se(s))};function Ce(){return{createComment:dt,getCommentsForThoughtOutput:vt,updateComment:Se,batchUpdateComments:mt}}const pt={class:"relative"},ft={key:0},_t=f("div",{class:"text-sm align-middle flex items-center p-2",style:{height:"50px"}}," Corriger une faute ",-1),ht={class:"flex mx-auto max-w-full"},gt={class:"w-full"},xt={key:0,class:"flex"},yt=f("div",{class:"w-6"},[f("div",{class:"rounded-full ml-4 mr-2 mt-2 h-1 w-1 bg-black"})],-1),bt=[yt],wt={class:"flex flex-wrap flex-1"},kt=["onClick","onContextmenu"],$t={key:0,style:{width:"5px"}},Ct={key:1,style:{height:"25px"}},Rt={key:2},It=["onClick"],Vt={key:1,class:"absolute h-full",style:{right:"-2%",width:"27%"}},Tt={key:0,style:{width:"33%"}},Ut=V({__name:"TextInterface",props:{resourceId:{},fullText:{},extComments:{default:()=>[]},editable:{type:Boolean,default:!0}},emits:["change","changeComments"],setup(_,{emit:s}){const n=_,i=l=>{console.log("selectCursorPosition letter : ",l),n.editable&&(o.value={id:l.id,char:l.char})},o=p(null),c=p([]),u=p([]),e=async()=>{let l=[{id:0,words:[{id:0,text:[]}],comments:[]}],m=0,b=0;for(var A=0;A<c.value.length;A++){c.value[A].char==`
`&&(m+=1,b=0,l.push({id:m,words:[{id:0,text:[]}],lineStyle:A<c.value.length-1?c.value[A+1].char:null,comments:[]}));const U=E.value.find(z=>z.start_index==A);U&&l[m].comments.push(U),l[m].words[b].text.push({id:A,char:c.value[A].char,comment:U}),c.value[A].char==" "&&(b+=1,l[m].words.push({id:b,text:[]}))}return l},a=l=>{l==1?E.value.forEach(m=>{o.value&&m.start_index>o.value.id&&(m.start_index+=1),o.value&&m.end_index>o.value.id&&(m.end_index+=1)}):l==-1&&E.value.forEach(m=>{o.value&&m.start_index>=o.value.id&&(m.start_index-=1),o.value&&m.end_index>=o.value.id&&(m.end_index-=1)})},d=l=>{console.log("insertChar : ",l),o.value&&(console.log("insertChar with cursor set : ",l),c.value.filter(m=>o.value&&m.id>=o.value.id+1).forEach(m=>m.id+=1),c.value.splice(o.value.id+1,0,{id:o.value.id+1,char:l}),a(1),o.value.id+=1)},g=l=>{if(console.log("Writes : ",l.key),o.value===null)return;const m=l.key;if(h.value&&m=="v"){x();return}if(m.length==1)l.preventDefault(),d(m);else if(m=="Backspace")c.value.splice(o.value.id,1),c.value.filter(b=>o.value&&b.id>o.value.id).forEach(b=>b.id-=1),a(-1),o.value.id-=1;else if(m=="Enter")d(`
`);else if(m=="ArrowRight"){let b=o.value.id;b<c.value.length-1&&i(c.value[b+1])}else if(m=="ArrowLeft"){let b=o.value.id;b>0&&i(c.value[b-1])}else m=="Control"&&(console.log("Control"),h.value=!0)},h=p(!1),x=async()=>{try{let m=await navigator.clipboard.readText();console.log("Clippedtext : ",m);for(var l=0;l<m.length;l++)d(m[l])}catch(m){console.log("Error with clippboard : ",m)}},j=l=>{l.key=="Control"&&(h.value=!1)},{createComment:G,batchUpdateComments:Q}=Ce(),{isMobile:M}=Te(),E=p([]),L=p(null),oe=async l=>{E.value=l.filter(m=>m.start_index!=null)},X=async()=>{if(console.log("Add Comment"),console.log(n.resourceId),console.log(N.value),!n.resourceId||!N.value)return;console.log("Add Comment 2");const l=await G(n.resourceId,N.value);E.value.push(l)};ae(E,async(l,m)=>{console.log("Watch comments triggered : ",l),J.value&&(console.log("Comments : ",l),s("changeComments",l),L.value!==null&&clearTimeout(L.value),L.value=setTimeout(()=>Q(l),1e3)),console.log(`Old comments lenght : ${m.length} new length: ${l.length}`),console.log("OldComments : ",m),console.log("NewComments : ",l),m.length===0&&l.length>0&&(console.log("Finally loading comments"),u.value=await e())},{deep:!0}),ae(xe(n).extComments,async l=>{await oe(l)});const W=p(!1),N=p(null),C=p({position:"absolute","z-index":90,top:"0px",left:"0px",height:"106px",width:"260px"}),{user:T}=H(),O=(l,m)=>{l.preventDefault(),T.value&&(o.value=null,C.value.top=`${l.layerY}px`,C.value.left=`${l.layerX}px`,W.value=!0,N.value=m,console.log("event : ",l),console.log("Have a new right click"))},_e=l=>{if(c.value=[],l===void 0||l==""){c.value=[{id:0,char:`
`}],i({id:0,char:`
`});return}for(var m=0;m<l.length;m++){const b=E.value.find(A=>A.start_index==m);c.value.push({id:m,char:l[m],comment:b})}},ce=l=>l.reduce((m,b)=>m+b.char,""),J=p(!1);return K(async()=>{await oe(n.extComments),await _e(n.fullText),await new Promise(l=>setTimeout(l,10)),u.value=await e(),J.value=!0}),ae(c,async l=>{console.log("Watch triggered : ",l),J.value&&(s("change",ce(l)),u.value=await e())},{deep:!0}),(l,m)=>(t(),r("div",pt,[v(Je,{text:l.fullText,class:"absolute z-10 h-6 right-2"},null,8,["text"]),J.value?(t(),r("div",{key:1,id:"main-interface",class:"relative md:p-4",tabindex:"0",onKeydown:g,onKeyup:j,onClick:m[0]||(m[0]=b=>W.value=!1)},[W.value?(t(),r("div",{key:0,class:"bg-white border-4",style:Ne(C.value)},[f("div",{onClick:X,class:"text-sm border-b-2 flex items-center p-2",style:{height:"50px"}}," Ajouter un commentaire "),_t],4)):w("",!0),f("div",ht,[f("div",gt,[(t(!0),r(ee,null,te(u.value,(b,A)=>(t(),r("div",{key:A,class:"flex"},[b.lineStyle=="*"?(t(),r("div",xt,bt)):w("",!0),f("div",wt,[(t(!0),r(ee,null,te(b.words,(U,z)=>(t(),r("div",{key:z,class:"flex flex-wrap"},[(t(!0),r(ee,null,te(U.text,(D,de)=>{var ve;return t(),r("div",{key:de,class:ye(["border-blue-400",{"border-r-2":D.id==((ve=o.value)==null?void 0:ve.id),"bg-yellow-400":D.comment}]),onClick:le=>i(D),onContextmenu:le=>O(le,D.id)},[D.char==" "?(t(),r("div",$t)):D.char==`
`?(t(),r("div",Ct)):(D.char=="#"||D.char=="*")&&z==0?(t(),r("div",Rt)):(t(),r("div",{key:3,class:ye({"font-bold":b.lineStyle=="#"})},[f("div",null,k(D.char),1)],2))],42,kt)}),128))]))),128)),f("div",{class:"flex-1",onClick:U=>i(b.words.slice(-1)[0].text.slice(-1)[0])},null,8,It)]),E.value.length>0&&!P(M)?(t(),r("div",Vt,[(t(!0),r(ee,null,te(b.comments,(U,z)=>(t(),R(be,{key:z,class:"w-full",modelValue:U.content,"onUpdate:modelValue":D=>U.content=D,editing:U.editing,onValidate:D=>U.editing=!1,author:U.author,"created-at":U.created_at},null,8,["modelValue","onUpdate:modelValue","editing","onValidate","author","created-at"]))),128))])):w("",!0)]))),128))]),E.value.length>0&&!P(M)?(t(),r("div",Tt)):w("",!0)])],32)):(t(),r("div",ft,[f("span",null,k(l.fullText),1)]))]))}}),At=f("hr",{class:"border-top border-zinc-400 my-4"},null,-1),Dt=f("div",{class:"text-xs italic"},"Raison de la lecture",-1),Bt=V({__name:"SeeThoughtInput",props:{thoughtInput:{}},setup(_){const s=_,{getUserById:n,user:i}=H(),o=p(null),c=S(()=>i.value?s.thoughtInput.interaction_user_id===i.value.id:!1);return K(async()=>{s.thoughtInput.interaction_user_id&&(o.value=await n(s.thoughtInput.interaction_user_id))}),(u,e)=>(t(),r("div",null,[v(qo,{id:u.thoughtInput.resource_id,"second-level":""},null,8,["id"]),At,Dt,v(Ut,{"full-text":u.thoughtInput.interaction_comment,editable:c.value},null,8,["full-text","editable"])]))}}),Et={class:"w-full md:w-96"},St={key:0,class:"text-xs italic mb-2 bg-white"},Ft={class:"flex flex-wrap"},Ot={key:1,class:"text-2xs italic ml-2"},qt={key:2,class:"ml-auto m-1 w-1/3"},Pt={key:0,class:"border shadow-lg rounded p-4 md:w-96 bg-white"},jt={class:"flex"},Lt=["src"],Nt={class:"flex flex-wrap w-full",style:{"margin-top":"-8px"}},zt={class:"text-2xs"},Mt={class:"flex flex-wrap"},Wt={key:0,class:"text-2xs italic"},Jt=V({__name:"ThoughtInputCard",props:{contextualResource:{},isDisabled:{type:Boolean,default:!1}},setup(_){const s=_,{getUserById:n}=H(),{getAuthorInteractionForResource:i}=fe(),o=p(null),c=p(null),u=p(null);K(async()=>{s.contextualResource.user_id&&(u.value=await n(s.contextualResource.user_id)),s.contextualResource.resource&&(c.value=await i(s.contextualResource.resource.id)),c.value&&(o.value=await n(c.value.interaction_user_id))});const e=d=>d?d.toLocaleString("fr-FR",{hour:"numeric",weekday:"short",day:"numeric",month:"short",year:"2-digit"}):"",a=d=>d.length>200?d.slice(0,150)+"...":d;return(d,g)=>{const h=Ue("router-link");return t(),r("div",Et,[d.contextualResource.context_comment?(t(),r("div",St,[f("div",null,k(d.contextualResource.context_comment),1),f("div",Ft,[u.value?(t(),R(h,{key:0,to:"/users/"+u.value.id,class:"text-2xs underline"},{default:B(()=>[ie(k(u.value.first_name)+" "+k(u.value.last_name),1)]),_:1},8,["to"])):w("",!0),d.contextualResource.date?(t(),r("div",Ot,k(e(d.contextualResource.date)),1)):w("",!0),d.contextualResource.progress?(t(),r("div",qt,[v(Ae,{"progress-value":d.contextualResource.progress},null,8,["progress-value"])])):w("",!0)])])):w("",!0),d.contextualResource.resource?(t(),R(ze(d.isDisabled?"span":"vue-router"),{key:1,to:"/resources/"+d.contextualResource.resource.id+"?tab=ctnt"},{default:B(()=>[d.contextualResource.resource?(t(),r("div",Pt,[f("div",jt,[d.contextualResource.resource?(t(),r("img",{key:0,class:"w-8 h-fit mr-4",src:d.contextualResource.resource.image_url},null,8,Lt)):w("",!0),f("div",null,[f("div",null,k(d.contextualResource.resource.title)+" "+k(d.contextualResource.resource.subtitle),1),f("div",Nt,[o.value?(t(),R(h,{key:0,to:"/users/"+o.value.id,class:"text-2xs underline"},{default:B(()=>[ie(k(o.value.first_name)+" "+k(o.value.last_name),1)]),_:1},8,["to"])):w("",!0)]),f("div",zt,k(a(d.contextualResource.resource.comment)),1)])]),f("div",Mt,[d.contextualResource.date?(t(),r("div",Wt,k(e(d.contextualResource.resourcedate)),1)):w("",!0)])])):w("",!0)]),_:1},8,["to"])):w("",!0)])}}}),Kt={class:"w-fit"},Ht=V({__name:"ThoughtInputCardWithPopup",props:{thoughtInput:{},usageReason:{},isDisabled:{type:Boolean,default:!1}},setup(_){const s=p(!1);return(n,i)=>(t(),r("div",Kt,[v(ne,{open:s.value,onClose:i[0]||(i[0]=o=>s.value=!1)},{default:B(()=>[v(Bt,{"thought-input":n.thoughtInput,"usage-reason":n.usageReason},null,8,["thought-input","usage-reason"])]),_:1},8,["open"]),v(Jt,{class:"md:w-96","contextual-resource":n.thoughtInput,"is-disabled":n.isDisabled},null,8,["contextual-resource","is-disabled"])]))}}),Gt={class:"relative max-w-full"},Qt={key:0,class:"absolute md:border h-full start-1/2 -z-10"},ue=V({__name:"ThoughtInputsList",props:{contextualResources:{},center:{type:Boolean,default:!1},linksDisabled:{type:Boolean,default:!1}},emits:["select"],setup(_,{emit:s}){const n=o=>o.sort((c,u)=>+(u.date>c.date)),i=o=>{console.log("Select"),s("select",o)};return(o,c)=>(t(),r("div",Gt,[o.center?w("",!0):(t(),r("div",Qt)),(t(!0),r(ee,null,te(n(o.contextualResources),(u,e)=>(t(),R(Ht,{key:u.id,class:ye(["mb-4 md:mb-1 mx-auto max-w-full max-w-fit p-1",{"md:ml-0":e%2==0&&!o.center,"md:mr-0":!o.center}]),"thought-input":u,onClick:a=>i(u),"is-disabled":o.linksDisabled},null,8,["class","thought-input","onClick","is-disabled"]))),128))]))}}),Xt={key:0,class:"mb-4"},Yt={key:1},Zt={key:1},eo={key:2},to={class:"flex flex-row-reverse"},Fe=V({__name:"CreateResourceRelationForm",props:{targetResource:{},originResource:{}},emits:["close","refresh"],setup(_,{emit:s}){const n=_,{user:i}=H(),o=p(),c=C=>{console.log("Event : ",C),o.value=C},u=p([{text:"Externes",value:"extr"},{text:"Internes",value:"artl"},{text:"Problème",value:"pblm"}]),e=p([{text:"Biblio",value:"bibl"},{text:"Résumé",value:"sumr"},{text:"Sujet principal",value:"main"},{text:"Evocation",value:"mino"}]),a=p([]),d=p(null),g=p([]),h=p([]),x=p([]),j=p(""),G=p(""),{createResourceRelation:Q}=Be(),{getResources:M}=fe(),E=S(()=>a.value.map(C=>({resource:C.resource}))),L=C=>C.map(T=>({resource:T})),oe=S(()=>({extr:L(g.value),artl:L(h.value),pblm:L(x.value)})),X=async()=>{if(console.log("create"),!d.value)return;const C={target_resource_id:n.targetResource?n.targetResource.id:d.value.id,origin_resource_id:n.originResource?n.originResource.id:d.value.id,relation_comment:j.value,relation_type:G.value};await Q(C),s("refresh"),s("close")},{getUserThoughtInputs:W}=je(),N=C=>{d.value=C.resource};return K(async()=>{!i.value||!i.value.id||(n.targetResource&&(a.value=await W(i.value.id)),n.originResource&&(g.value=await M({is_external:!0}),h.value=await M({is_external:!1,resource_type:"oatc"}),x.value=await M({is_external:!1,resource_type:"pblm"})))}),(C,T)=>(t(),r("div",null,[P(i)?(t(),r("div",Xt," Nouvelle relation entre ressources par "+k(P(i).first_name)+" "+k(P(i).last_name),1)):w("",!0),d.value?(t(),r("div",eo,[v(re,{class:"m-4",label:"Type de lien",choices:e.value,modelValue:G.value,"onUpdate:modelValue":T[2]||(T[2]=O=>G.value=O)},null,8,["choices","modelValue"]),v(me,{class:"m-4",label:"Pourquoi ajouter cet élément ?",modelValue:j.value,"onUpdate:modelValue":T[3]||(T[3]=O=>j.value=O)},null,8,["modelValue"]),f("div",to,[v(F,{type:"valid",onClick:X,text:"Ajouter"}),v(F,{type:"abort",onClick:T[4]||(T[4]=O=>s("close")),text:"Annuler",class:"mr-1"})])])):(t(),r("div",Yt,[C.targetResource?(t(),R(ue,{key:0,"contextual-resources":E.value,center:"","links-disabled":"",onSelect:T[0]||(T[0]=O=>N(O))},null,8,["contextual-resources"])):(t(),r("div",Zt,[f("div",null,[ie(" Choisir une ressource cible "),v(Ee,{center:"",choices:u.value,default:"pblm",onUpdate:c},null,8,["choices"]),v(ue,{"contextual-resources":oe.value[o.value]||[],center:"",onSelect:T[1]||(T[1]=O=>N(O)),"links-disabled":""},null,8,["contextual-resources"])])]))]))]))}}),oo={class:"flex flex-wrap"},lo={class:"flex flex-row-reverse"},so=V({__name:"CreateInteraction",props:{resource:{}},emits:["close","refresh"],setup(_,{emit:s}){const n=_,i=p([{text:"Lecture / Visionage",value:"inpt"},{text:"Envie",value:"wish"}]),{newInteraction:o,createInteractionForResource:c}=pe(),{user:u}=H(),e=p(o());K(()=>{e.value.interaction_type||(e.value.interaction_type="inpt")});const a=()=>{e.value.resource_id=n.resource.id,e.value.interaction_user_id=u.value.id,c(n.resource.id,e.value),s("refresh"),d()},d=()=>s("close");return(g,h)=>(t(),r("div",null,[f("div",null,"Nouvelle interaction, avec la ressource : "+k(g.resource.title),1),f("div",oo,[v(Z,{label:"Avancement de l'ouvrage",class:"my-auto",modelValue:e.value.interaction_progress,"onUpdate:modelValue":h[0]||(h[0]=x=>e.value.interaction_progress=x),type:"number"},null,8,["modelValue"]),v(re,{label:"Type d'interaction",class:"m-4 w-full md:w-5/12 md:ml-auto",choices:i.value,modelValue:e.value.interaction_type,"onUpdate:modelValue":h[1]||(h[1]=x=>e.value.interaction_type=x)},null,8,["choices","modelValue"])]),v(Z,{label:"Date de lecture",modelValue:e.value.interaction_date,"onUpdate:modelValue":h[2]||(h[2]=x=>e.value.interaction_date=x),type:"date"},null,8,["modelValue"]),v(me,{label:"Pourquoi s'y être interessé ?",modelValue:e.value.interaction_comment,"onUpdate:modelValue":h[3]||(h[3]=x=>e.value.interaction_comment=x)},null,8,["modelValue"]),f("div",lo,[v(F,{onClick:a,class:"m-4",text:"Valider",type:"valid"}),v(F,{onClick:d,class:"m-4",text:"Annuler",type:"abort"})])]))}}),no=f("div",null,"Demander une Review pour l'article :",-1),ao={class:"flex flex-row-reverse mt-4"},ro=V({__name:"CreateReview",props:{resource:{}},emits:["close","refresh"],setup(_,{emit:s}){const n=_,{newInteraction:i,createInteractionForResource:o}=pe(),c=async()=>{const a=i();a.interaction_user_id=e.value,a.resource_id=n.resource.id,a.interaction_type="rvew",a.interaction_comment=u.value,await o(n.resource.id,a),s("refresh"),s("close")},u=p(""),e=p(null);return(a,d)=>(t(),r("div",null,[no,f("div",null,k(a.resource.title),1),v(De,{modelValue:e.value,"onUpdate:modelValue":d[0]||(d[0]=g=>e.value=g)},null,8,["modelValue"]),v(me,{class:"mt-4",label:"Message pour la review",modelValue:u.value,"onUpdate:modelValue":d[1]||(d[1]=g=>u.value=g)},null,8,["modelValue"]),f("div",ao,[v(F,{type:"valid",onClick:c,text:"Ajouter"}),v(F,{type:"abort",onClick:d[2]||(d[2]=g=>s("close")),text:"Annuler",class:"mr-1"})])]))}}),uo=V({__name:"ResourceTools",props:{resource:{},isResourceEditable:{type:Boolean}},emits:["refresh","edit"],setup(_,{emit:s}){const n=p(!1),i=p(!1),o=p(!1),c=p(!1);return(u,e)=>(t(),r("div",null,[u.isResourceEditable&&n.value?(t(),R(se,{key:0,title:"Modifier",onClick:e[0]||(e[0]=a=>s("edit"))},{default:B(()=>[v(P(Me),{class:"m-1"})]),_:1})):w("",!0),u.isResourceEditable&&n.value?(t(),R(se,{key:1,class:"mt-2",color:"blue",title:"Demander une review",onClick:e[1]||(e[1]=a=>i.value=!0)},{default:B(()=>[v(P(We),{class:"m-1"})]),_:1})):w("",!0),v(ne,{open:i.value,onClose:e[4]||(e[4]=a=>i.value=!1)},{default:B(()=>[v(ro,{onRefresh:e[2]||(e[2]=a=>s("refresh")),onClose:e[3]||(e[3]=a=>i.value=!1),resource:u.resource},null,8,["resource"])]),_:1},8,["open"]),u.isResourceEditable&&n.value?(t(),R(se,{key:2,class:"mt-2",color:"red",title:"Marquer comme lu",onClick:e[5]||(e[5]=a=>o.value=!0)},{default:B(()=>[v(P(He),{class:"m-1"})]),_:1})):w("",!0),v(ne,{open:o.value,onClose:e[8]||(e[8]=a=>o.value=!1)},{default:B(()=>[v(so,{onRefresh:e[6]||(e[6]=a=>s("refresh")),onClose:e[7]||(e[7]=a=>o.value=!1),resource:u.resource},null,8,["resource"])]),_:1},8,["open"]),u.isResourceEditable&&n.value?(t(),R(se,{key:3,class:"mt-2",color:"green",title:"Relier à d'autres ressources",onClick:e[9]||(e[9]=a=>c.value=!0)},{default:B(()=>[v(P(Ge),{class:"m-1"})]),_:1})):w("",!0),v(ne,{open:c.value,onClose:e[12]||(e[12]=a=>c.value=!1)},{default:B(()=>[v(Fe,{onRefresh:e[10]||(e[10]=a=>s("refresh")),onClose:e[11]||(e[11]=a=>c.value=!1),"origin-resource":u.resource},null,8,["origin-resource"])]),_:1},8,["open"]),v(se,{class:"mt-2",color:"gray",onClick:e[13]||(e[13]=a=>n.value=!n.value)},{default:B(()=>[v(P(Qe))]),_:1})]))}}),io=V({__name:"CommentsThread",props:{resourceId:{}},setup(_){const s=_,{user:n}=H(),i=p([]),{createComment:o,getCommentsForThoughtOutput:c}=Ce(),u=async()=>{console.log("Comment thread"),console.log("Props id : ",s.resourceId),i.value=await c(s.resourceId)},e=S(()=>i.value.filter(g=>!g.start_index).sort((g,h)=>g.created_at-h.created_at)),a=p(""),d=async()=>{await o(s.resourceId,null,a.value,!1),a.value="",await u()};return K(async()=>await u()),(g,h)=>(t(),r("div",null,[(t(!0),r(ee,null,te(e.value,x=>(t(),R(be,{key:x.id,class:"w-full",modelValue:x.content,"onUpdate:modelValue":j=>x.content=j,editing:x.editing,onValidate:j=>x.editing=!1,author:x.author,"created-at":x.created_at},null,8,["modelValue","onUpdate:modelValue","editing","onValidate","author","created-at"]))),128)),v(be,{class:"w-full",modelValue:a.value,"onUpdate:modelValue":h[0]||(h[0]=x=>a.value=x),editing:!0,onValidate:d,author:P(n),"created-at":null},null,8,["modelValue","author"])]))}}),co=V({__name:"DateField",props:{date:{}},setup(_){const s=_,n=S(()=>new Date(s.date).toLocaleDateString("fr-FR",{day:"numeric",month:"short",year:"numeric"}));return(i,o)=>(t(),r("div",null,k(n.value),1))}}),vo={class:"flex flex-col"},mo={class:"block text-2xs text-slate-800"},po=["value","placeholder"],fo=V({__name:"NumberInput",props:{label:{},modelValue:{},placeholder:{}},emits:["update:modelValue","input"],setup(_,{emit:s}){const n=i=>{s("update:modelValue",i.target.value),s("input",i.target.value)};return(i,o)=>(t(),r("div",vo,[f("label",mo,k(i.label),1),f("input",{class:"border border-neutral-400 block h-full w-full rounded-md border-2 p-1 pl-2 text-xs",type:"number",value:i.modelValue,placeholder:i.placeholder,onInput:o[0]||(o[0]=c=>n(c))},null,40,po)]))}}),_o={class:"grid grid-cols-4 gap-y-2 gap-x-4 auto-rows-auto"},ho=V({__name:"ArticleForm",props:{article:{}},emits:["change"],setup(_,{emit:s}){const n=_,i=p([{text:"Terminé",value:"fnsh"},{text:"Relecture",value:"rvew"},{text:"Brouillon",value:"drft"}]),{resourceTypeOptions:o}=fe(),c=(u,e)=>{let a={...n.article};a[u]=e,a.is_external&&(a.maturing_state="fnsh"),console.log("Article : ",a),s("change",a)};return(u,e)=>(t(),r("div",_o,[v(Z,{class:"col-span-4",label:"Titre",modelValue:u.article.title,"onUpdate:modelValue":e[0]||(e[0]=a=>c("title",a))},null,8,["modelValue"]),v(Z,{class:"col-span-4",label:"Sous-titre",modelValue:u.article.subtitle,"onUpdate:modelValue":e[1]||(e[1]=a=>c("subtitle",a))},null,8,["modelValue"]),v(Z,{class:"col-span-4 md:col-span-2",label:"Lien contenu externe",modelValue:u.article.external_content_url,"onUpdate:modelValue":e[2]||(e[2]=a=>c("external_content_url",a))},null,8,["modelValue"]),v(Z,{class:"col-span-4 md:col-span-2",label:"Lien image",modelValue:u.article.image_url,"onUpdate:modelValue":e[3]||(e[3]=a=>c("image_url",a))},null,8,["modelValue"]),v(re,{label:"Type de ressource",class:"col-span-4 md:col-span-2",choices:P(o),"onUpdate:modelValue":e[4]||(e[4]=a=>c("resource_type",a)),"model-value":u.article.resource_type},null,8,["choices","model-value"]),v(re,{label:"Ressource externe",class:"col-span-4 md:col-span-1",choices:[{text:"Oui",value:!0},{text:"Non",value:!1}],"onUpdate:modelValue":e[5]||(e[5]=a=>c("is_external",JSON.parse(a))),"model-value":u.article.is_external},null,8,["model-value"]),v(re,{label:"Stade d'écriture",class:"col-span-4 md:col-span-1",choices:i.value,"model-value":u.article.maturing_state,"onUpdate:modelValue":e[6]||(e[6]=a=>c("maturing_state",a))},null,8,["choices","model-value"])]))}}),go={class:"grid grid-cols-3 gap-4"},xo=V({__name:"ResourceAuthorPicker",props:{interaction:{},resourceId:{}},emits:["update"],setup(_,{emit:s}){const n=_,i=S(()=>{var g;return(g=n.interaction)==null?void 0:g.interaction_user_id}),{createInteractionForResource:o,newInteraction:c,createInteraction:u,updateInteraction:e}=pe(),a=async g=>{if(console.log(`newUser : ${JSON.stringify(g)}`),n.interaction){const h={...n.interaction};h.interaction_user_id=g,console.log("newUserid : ",g.id),console.log(`Interaction payload : ${JSON.stringify(h)}`),await e(n.interaction.id,h),s("update")}else{console.log("create interaction");const h=c();h.interaction_user_id=g,h.resource_id=n.resourceId,await o(n.resourceId,h),s("update")}},d=async g=>{await e(n.interaction.id,g),s("update")};return(g,h)=>(t(),r("div",go,[v(De,{"model-value":i.value,"onUpdate:modelValue":h[0]||(h[0]=x=>a(x))},null,8,["model-value"]),g.interaction?(t(),R(Z,{key:0,class:"text-2xs",label:"Date d'écriture","model-value":g.interaction.interaction_date?g.interaction.interaction_date.split("T")[0]:null,"onUpdate:modelValue":h[1]||(h[1]=x=>d({...g.interaction,interaction_date:x})),type:"date"},null,8,["model-value"])):w("",!0),g.interaction?(t(),R(fo,{key:1,class:"",label:"Progression",modelValue:g.interaction.interaction_progress,"onUpdate:modelValue":h[2]||(h[2]=x=>d({...g.interaction,interaction_progress:x}))},null,8,["modelValue"])):w("",!0)]))}}),yo={key:0,class:"text-center text-2xl pt-10"},bo={key:1},wo={key:0},ko={class:"my-8"},$o=["src"],Co={class:"text-3xl my-3 font-mplus md:text-center text-left"},Ro={class:"md:text-center text-left"},Io={class:"md:text-center text-left"},Vo={class:"md:flex my-8"},To=["href"],Uo={key:1,class:"my-2 flex flex-col"},Ao={class:"flex flex-row-reverse mb-4"},Do=f("hr",{class:"border-top border-zinc-400 my-4"},null,-1),Bo={key:2},Eo=f("div",{class:"text-xs italic"},"Contenu",-1),So={key:3},Fo={key:4},Oo={key:5},qo=V({__name:"ResourceComponent",props:{resourceId:{},secondLevel:{type:Boolean}},setup(_){const s=_,n=Ve(),i=S(()=>A.value&&b.value||!C.value||l.value.is_local_draft||!u.value),o=S(()=>s.secondLevel?"popup_tab":"tab"),c=S(()=>[{text:"Contenu",value:"ctnt"},{text:"Biblio",value:"bbli",count:h.value.length},{text:"Sujets",value:"pblm",count:X.value.length},{text:"Interactions",value:"inpt",count:Q.value.length}]),u=p(!0),e=p(n.query[o.value]&&typeof n.query[o.value]=="string"?n.query[o.value]:"ctnt"),a=p(n.query[o.value]);ae(()=>n.query[o.value],y=>{console.log("new route query",y),typeof y=="string"&&(a.value=y)});const{getResourceRelationsForResource:d,getUsagesForResource:g}=Be(),h=p([]),x=p(!1),j=async()=>{h.value=await d(xe(s).resourceId.value)},G=S(()=>h.value.map(y=>({resource:y.origin_resource,date:y.created_at,user_id:y.user_id,context_comment:y.relation_comment,progress:null}))),Q=p([]),{getInteractionsForResource:M,updateInteraction:E}=pe(),L=async()=>{Q.value=await M(s.resourceId)},oe=S(()=>Q.value.map(y=>({resource:null,date:y.interaction_date,user_id:y.interaction_user_id,context_comment:y.interaction_comment,progress:y.interaction_progress}))),X=p([]),W=async()=>{X.value=await g(s.resourceId)},N=S(()=>X.value.map(y=>({resource:y.target_resource,date:y.created_at,user_id:y.user_id,context_comment:y.relation_comment,progress:null}))),C=p(!1),{newResource:T,getResource:O,updateResource:_e,getAuthorInteractionForResource:ce}=fe(),J=p(null),l=p(T()),m=Ie();ae(()=>n.query.editing,y=>{console.log("Editing : ",y),b.value=y==="false"?!1:!!y});const b=p(!1),{isMobile:A}=Te(),U=y=>{m.push({query:{editing:y.toString()}})},z=(y,$)=>{l.value=$,J.value!==null&&clearTimeout(J.value),J.value=setTimeout(async()=>{try{await _e(y,l.value)}catch(ge){console.log("An error : ",ge)}},1e3)},D=y=>{y!=`
`&&z(xe(s).resourceId.value,{...l.value,content:y})},{user:de,getUserById:ve}=H(),le=S(()=>l.value.is_external?!0:de.value?Y.value?Y.value.id==de.value.id:!0:!1),Y=p(null),I=p(null),he=async()=>{I.value=await ce(s.resourceId)},Oe=async()=>{!I.value||!I.value.id||(await E(I.value.id,{...I.value,interaction_is_public:!0}),he())},qe=async()=>{!I.value||!I.value.id||(await E(I.value.id,{...I.value,interaction_is_public:!1}),he())},{getCommentsForThoughtOutput:Pe}=Ce(),Re=p([]);return K(async()=>{C.value=!1,l.value=await O(s.resourceId),C.value=!0,await j(),await L(),await W(),Re.value=await Pe(s.resourceId),I.value=await ce(s.resourceId),I.value&&(Y.value=await ve(I.value.interaction_user_id));const y=n.query.editing;b.value=y==="false"?!1:!!y}),(y,$)=>{const ge=Ue("router-link");return t(),r("div",null,[C.value?(t(),r("div",bo,[b.value?(t(),r("div",Uo,[v(ho,{article:l.value,class:"",onChange:$[0]||($[0]=q=>z(l.value.id,q))},null,8,["article"]),v(xo,{class:"my-2",interaction:I.value,"resource-id":y.resourceId,onChange:he},null,8,["interaction","resource-id"]),f("div",Ao,[v(F,{class:"ml-2",onClick:$[1]||($[1]=q=>U(!1)),type:"valid",text:"Preview"},{default:B(()=>[ie("Ok")]),_:1}),I.value.interaction_is_public?(t(),R(F,{key:1,class:"ml-2",onClick:qe,type:"abort",text:"Dépublier"})):(t(),R(F,{key:0,class:"ml-2",onClick:Oe,type:"valid",text:"Publier"})),v(F,{class:"ml-2",onClick:$[2]||($[2]=q=>u.value=!u.value),type:"valid",text:u.value?"Text brut":"Editeur"},null,8,["text"])])])):(t(),r("div",wo,[f("div",ko,[f("img",{src:l.value.image_url,class:"border border-slate-300 dark:border-zinc-700 rounded-xl ml-auto mr-auto",style:{"max-height":"20rem"}},null,8,$o)]),f("h1",Co,k(l.value.title),1),f("div",Ro,k(l.value.subtitle),1),f("div",Io,[Y.value?(t(),R(ge,{key:0,to:"/users/"+Y.value.id,class:"text-sm underline"},{default:B(()=>[ie(k(Y.value.first_name)+" "+k(Y.value.last_name),1)]),_:1},8,["to"])):w("",!0),I.value?(t(),R(co,{key:1,date:I.value.interaction_date},null,8,["date"])):w("",!0)]),f("div",Vo,[I.value?(t(),R(Ae,{key:0,"progress-value":I.value.interaction_progress,class:"m-2 w-1/3"},null,8,["progress-value"])):w("",!0),l.value.external_content_url?(t(),r("a",{key:1,class:"ml-auto underline",href:l.value.external_content_url,target:"_blank"}," Lien ressource externe ",8,To)):w("",!0)])])),f("div",null,[b.value?w("",!0):(t(),R(Ee,{key:0,choices:c.value,default:e.value,"url-key":o.value,url:""},null,8,["choices","default","url-key"]))]),Do,a.value=="ctnt"?(t(),r("div",Bo,[Eo,i.value?(t(),R(me,{key:0,class:"mt-4 h-96",modelValue:l.value.content,"onUpdate:modelValue":$[3]||($[3]=q=>D(q))},null,8,["modelValue"])):(t(),R(Ke,{key:1,class:"min-h-fit","ext-comments":Re.value,"resource-id":l.value.id,text:l.value.content,editable:le.value,onChange:$[4]||($[4]=q=>D(q))},null,8,["ext-comments","resource-id","text","editable"])),v(io,{class:"mt-6","resource-id":y.resourceId},null,8,["resource-id"])])):a.value=="bbli"?(t(),r("div",So,[v(ne,{open:x.value,onClose:$[6]||($[6]=q=>x.value=!1)},{default:B(()=>[v(Fe,{onRefresh:j,onClose:$[5]||($[5]=q=>x.value=!1),"target-resource":l.value},null,8,["target-resource"])]),_:1},8,["open"]),f("div",{onClick:$[7]||($[7]=q=>x.value=!0),class:"text-sm italic underline"}," Ajouter une référence "),v(ue,{"contextual-resources":G.value},null,8,["contextual-resources"])])):a.value=="pblm"?(t(),r("div",Fo,[v(ue,{"contextual-resources":N.value},null,8,["contextual-resources"])])):a.value=="inpt"?(t(),r("div",Oo,[v(ue,{"contextual-resources":oe.value},null,8,["contextual-resources"])])):w("",!0),v(uo,{class:"fixed right-3 bottom-5",resource:l.value,"is-resource-editable":le.value,onRefresh:$[8]||($[8]=q=>W()&&L()),onEdit:$[9]||($[9]=q=>U(!0))},null,8,["resource","is-resource-editable"])])):(t(),r("div",yo,"Loading..."))])}}});export{qo as _,Bt as a,ue as b};
