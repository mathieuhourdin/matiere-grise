import{o as t,f as u,a as p,d as V,b as f,e as N,A as Le,B as le,C as me,z as qe,D as Pe,k as je,m as b,p as Re,y as Ie,F as Y,g as Z,i as v,t as k,h as S,n as te,E as ze,q,G as we,c as R,x as Ve,r as Te,w as E,l as ie,H as Me,j as pe,I as Ne,_ as ae,u as fe,J as ne,K as Ke,L as We}from"./index-781691fe.js";import{a as O,_ as ee}from"./ActionButton.vue_vue_type_script_setup_true_lang-fbec98a0.js";import{_ as _e}from"./TextAreaInput.vue_vue_type_script_setup_true_lang-a10e548b.js";import{a as Je,u as $e,_ as He}from"./SelectionTextInterface.vue_vue_type_style_index_0_lang-0d6e0f02.js";import{_ as Ue}from"./ProgressBar.vue_vue_type_script_setup_true_lang-2be930e5.js";import{u as he}from"./useResource-59c53aef.js";import{_ as Ae}from"./UserPicker.vue_vue_type_script_setup_true_lang-8fa15b60.js";import{u as De}from"./useResourceRelations-585ce753.js";function Ge(_,l){return t(),u("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true"},[p("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M9 8.25H7.5a2.25 2.25 0 00-2.25 2.25v9a2.25 2.25 0 002.25 2.25h9a2.25 2.25 0 002.25-2.25v-9a2.25 2.25 0 00-2.25-2.25H15M9 12l3 3m0 0l3-3m-3 3V2.25"})])}function Qe(_,l){return t(),u("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true"},[p("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M7.217 10.907a2.25 2.25 0 100 2.186m0-2.186c.18.324.283.696.283 1.093s-.103.77-.283 1.093m0-2.186l9.566-5.314m-9.566 7.5l9.566 5.314m0 0a2.25 2.25 0 103.935 2.186 2.25 2.25 0 00-3.935-2.186zm0-12.814a2.25 2.25 0 103.933-2.185 2.25 2.25 0 00-3.933 2.185z"})])}function Xe(_,l){return t(),u("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true"},[p("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M21.75 6.75a4.5 4.5 0 01-4.884 4.484c-1.076-.091-2.264.071-2.95.904l-7.152 8.684a2.548 2.548 0 11-3.586-3.586l8.684-7.152c.833-.686.995-1.874.904-2.95a4.5 4.5 0 016.336-4.486l-3.276 3.276a3.004 3.004 0 002.25 2.25l3.276-3.276c.256.565.398 1.192.398 1.852z"}),p("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M4.867 19.125h.008v.008h-.008v-.008z"})])}const Ye={class:"flex"},re=V({__name:"ModalSheet",props:{open:{type:Boolean,default:!1}},emits:["close"],setup(_,{emit:l}){const n=_,c=f(!1);return N(()=>{c.value=n.open}),Le(()=>{const o=a=>{(a.key==="Escape"||a.key==="Enter"||a.key==="Esc"||a.keyCode===27)&&l("close")};return window.addEventListener("keydown",o),()=>{window.removeEventListener("keydown",o)}}),le(me(n).open,o=>c.value=o),(o,a)=>c.value?(t(),u("div",{key:0,tabindex:"0",onKeyup:a[2]||(a[2]=je(i=>l("close"),["esc"])),class:"fixed top-0 left-0 w-full h-full z-10 bg-slate-500/50",onClick:a[3]||(a[3]=i=>l("close"))},[p("div",{class:"max-w-xl overflow-y-scroll max-h-screen mb-10 bg-white mx-auto mt-6 p-4 rounded shadow",onClick:a[1]||(a[1]=Pe(()=>{},["stop"]))},[p("div",Ye,[p("div",{class:"ml-auto",onClick:a[0]||(a[0]=i=>l("close"))},"x")]),qe(o.$slots,"default")])],32)):b("",!0)}}),Ze={class:"justify-items-center mx-auto flex flex-wrap max-w-full"},et={key:0,class:"ml-auto"},tt={key:0,class:"absolute right-0 top-0 w-4 h-4 rounded-square text-2xs bg-green-400 text-center"},ot=p("div",{class:"mr-auto"},null,-1),Ee=V({__name:"ToggleButtonGroup",props:{choices:{},default:{},urlKey:{},url:{type:Boolean,default:!1},center:{type:Boolean,default:!1}},emits:["update"],setup(_,{emit:l}){const n=_,c=f(null),o=Re(),a=Ie(),i=e=>{if(l("update",e),c.value=e,n.url){const r=a.query,d=a.path,g=n.urlKey??"tab";console.log(g);const h={};h[g]=e;const x={...r,...h};o.push({path:d,query:x}),console.log(`route : ${JSON.stringify(a)}`)}};return N(()=>i(n.default??"")),(e,r)=>(t(),u("div",Ze,[e.center?(t(),u("div",et)):b("",!0),(t(!0),u(Y,null,Z(e.choices,d=>(t(),u("div",{class:"relative",key:d.value},[v(O,{class:"w-30 my-1 mx-1",text:d.text,onClick:g=>i(d.value),type:d.value==c.value?"valid":"abort"},null,8,["text","onClick","type"]),d.count?(t(),u("div",tt,k(d.count),1)):b("",!0)]))),128)),ot]))}});const lt={class:"bg-slate-100 border p-1 m-1 rounded shadow-xl"},st={class:"flex"},nt={key:0,class:"text-xs mt-0.5 mb-1 font-bold flex"},at=["src"],rt={class:"my-auto"},ut={class:"text-2xs italic ml-auto mr-1 my-auto"},it={key:0},ct=["value"],dt={class:"flex"},vt={key:1,class:"text-xs mt-0.5"},ke=V({__name:"CommentCard",props:{editing:{type:Boolean},modelValue:{},author:{},createdAt:{}},emits:["update:modelValue","validate","abort"],setup(_,{emit:l}){const n=_,c=S(()=>n.createdAt?n.createdAt.toLocaleString("fr-FR",{hour:"numeric",weekday:"short",day:"numeric",month:"short",year:"2-digit"}):""),o=e=>{l("update:modelValue",e.target.value)},a=()=>{l("validate")},i=()=>{l("abort")};return(e,r)=>(t(),u("div",lt,[p("div",st,[e.author?(t(),u("div",nt,[e.author.profile_picture_url?(t(),u("img",{key:0,class:"h-5 w-5 rounded-full mr-1",src:e.author.profile_picture_url},null,8,at)):b("",!0),p("div",rt,k(e.author.first_name)+" "+k(e.author.last_name),1)])):b("",!0),p("div",ut,k(c.value),1)]),e.editing?(t(),u("div",it,[p("textarea",{class:"w-full text-xs rounded-xl p-2",value:e.modelValue,onInput:o},null,40,ct),p("div",dt,[v(O,{onClick:a,class:"text-sm",rounded:"",size:"2xs",text:"Commenter",type:"valid"}),v(O,{onClick:i,class:"text-sm",rounded:"",size:"2xs",text:"Annuler",type:"abort"})])])):(t(),u("div",vt,k(e.modelValue),1))]))}}),mt={class:"relative"},pt={key:0},ft=p("div",{class:"text-sm align-middle flex items-center p-2",style:{height:"50px"}}," Corriger une faute ",-1),_t={class:"flex mx-auto max-w-full"},ht={class:"w-full"},gt={key:0,class:"flex"},xt=p("div",{class:"w-6"},[p("div",{class:"rounded-full ml-4 mr-2 mt-2 h-1 w-1 bg-black"})],-1),yt=[xt],bt={class:"flex flex-wrap flex-1"},wt=["onClick","onContextmenu"],kt={key:0,style:{width:"5px"}},$t={key:1,style:{height:"25px"}},Ct={key:2},Rt=["onClick"],It={key:1,class:"absolute h-full",style:{right:"-2%",width:"27%"}},Vt={key:0,style:{width:"33%"}},Tt=V({__name:"TextInterface",props:{resourceId:{},fullText:{},extComments:{default:()=>[]},editable:{type:Boolean,default:!0}},emits:["change","changeComments"],setup(_,{emit:l}){const n=_,c=s=>{console.log("selectCursorPosition letter : ",s),n.editable&&(o.value={id:s.id,char:s.char})},o=f(null),a=f([]),i=f([]),e=async()=>{let s=[{id:0,words:[{id:0,text:[]}],comments:[]}],m=0,w=0;for(var A=0;A<a.value.length;A++){a.value[A].char==`
`&&(m+=1,w=0,s.push({id:m,words:[{id:0,text:[]}],lineStyle:A<a.value.length-1?a.value[A+1].char:null,comments:[]}));const U=B.value.find(M=>M.start_index==A);U&&s[m].comments.push(U),s[m].words[w].text.push({id:A,char:a.value[A].char,comment:U}),a.value[A].char==" "&&(w+=1,s[m].words.push({id:w,text:[]}))}return s},r=s=>{s==1?B.value.forEach(m=>{o.value&&m.start_index>o.value.id&&(m.start_index+=1),o.value&&m.end_index>o.value.id&&(m.end_index+=1)}):s==-1&&B.value.forEach(m=>{o.value&&m.start_index>=o.value.id&&(m.start_index-=1),o.value&&m.end_index>=o.value.id&&(m.end_index-=1)})},d=s=>{console.log("insertChar : ",s),o.value&&(console.log("insertChar with cursor set : ",s),a.value.filter(m=>o.value&&m.id>=o.value.id+1).forEach(m=>m.id+=1),a.value.splice(o.value.id+1,0,{id:o.value.id+1,char:s}),r(1),o.value.id+=1)},g=s=>{if(console.log("Writes : ",s.key),o.value===null)return;const m=s.key;if(h.value&&m=="v"){x();return}if(m.length==1)s.preventDefault(),d(m);else if(m=="Backspace")a.value.splice(o.value.id,1),a.value.filter(w=>o.value&&w.id>o.value.id).forEach(w=>w.id-=1),r(-1),o.value.id-=1;else if(m=="Enter")d(`
`);else if(m=="ArrowRight"){let w=o.value.id;w<a.value.length-1&&c(a.value[w+1])}else if(m=="ArrowLeft"){let w=o.value.id;w>0&&c(a.value[w-1])}else m=="Control"&&(console.log("Control"),h.value=!0)},h=f(!1),x=async()=>{try{let m=await navigator.clipboard.readText();console.log("Clippedtext : ",m);for(var s=0;s<m.length;s++)d(m[s])}catch(m){console.log("Error with clippboard : ",m)}},P=s=>{s.key=="Control"&&(h.value=!1)},{createComment:H,batchUpdateComments:G}=$e(),{isMobile:K}=Ve(),B=f([]),j=f(null),oe=async s=>{B.value=s.filter(m=>m.start_index!=null)},Q=async()=>{if(console.log("Add Comment"),console.log(n.resourceId),console.log(z.value),!n.resourceId||!z.value)return;console.log("Add Comment 2");const s=await H(n.resourceId,z.value,z.value);B.value.push(s)};le(B,async(s,m)=>{console.log("Watch comments triggered : ",s),J.value&&(console.log("Comments : ",s),l("changeComments",s),j.value!==null&&clearTimeout(j.value),j.value=setTimeout(()=>G(s),1e3)),console.log(`Old comments lenght : ${m.length} new length: ${s.length}`),console.log("OldComments : ",m),console.log("NewComments : ",s),m.length===0&&s.length>0&&(console.log("Finally loading comments"),i.value=await e())},{deep:!0}),le(me(n).extComments,async s=>{await oe(s)});const W=f(!1),z=f(null),C=f({position:"absolute","z-index":90,top:"0px",left:"0px",height:"106px",width:"260px"}),{user:T}=te(),F=(s,m)=>{s.preventDefault(),T.value&&(o.value=null,C.value.top=`${s.layerY}px`,C.value.left=`${s.layerX}px`,W.value=!0,z.value=m,console.log("event : ",s),console.log("Have a new right click"))},xe=s=>{if(a.value=[],s===void 0||s==""){a.value=[{id:0,char:`
`}],c({id:0,char:`
`});return}for(var m=0;m<s.length;m++){const w=B.value.find(A=>A.start_index==m);a.value.push({id:m,char:s[m],comment:w})}},ce=s=>s.reduce((m,w)=>m+w.char,""),J=f(!1);return N(async()=>{await oe(n.extComments),await xe(n.fullText),await new Promise(s=>setTimeout(s,10)),i.value=await e(),J.value=!0}),le(a,async s=>{console.log("Watch triggered : ",s),J.value&&(l("change",ce(s)),i.value=await e())},{deep:!0}),(s,m)=>(t(),u("div",mt,[v(Je,{text:s.fullText,class:"absolute z-10 h-6 right-2"},null,8,["text"]),J.value?(t(),u("div",{key:1,id:"main-interface",class:"relative md:p-4",tabindex:"0",onKeydown:g,onKeyup:P,onClick:m[0]||(m[0]=w=>W.value=!1)},[W.value?(t(),u("div",{key:0,class:"bg-white border-4",style:ze(C.value)},[p("div",{onClick:Q,class:"text-sm border-b-2 flex items-center p-2",style:{height:"50px"}}," Ajouter un commentaire "),ft],4)):b("",!0),p("div",_t,[p("div",ht,[(t(!0),u(Y,null,Z(i.value,(w,A)=>(t(),u("div",{key:A,class:"flex"},[w.lineStyle=="*"?(t(),u("div",gt,yt)):b("",!0),p("div",bt,[(t(!0),u(Y,null,Z(w.words,(U,M)=>(t(),u("div",{key:M,class:"flex flex-wrap"},[(t(!0),u(Y,null,Z(U.text,(D,de)=>{var ve;return t(),u("div",{key:de,class:we(["border-blue-400",{"border-r-2":D.id==((ve=o.value)==null?void 0:ve.id),"bg-yellow-400":D.comment}]),onClick:se=>c(D),onContextmenu:se=>F(se,D.id)},[D.char==" "?(t(),u("div",kt)):D.char==`
`?(t(),u("div",$t)):(D.char=="#"||D.char=="*")&&M==0?(t(),u("div",Ct)):(t(),u("div",{key:3,class:we({"font-bold":w.lineStyle=="#"})},[p("div",null,k(D.char),1)],2))],42,wt)}),128))]))),128)),p("div",{class:"flex-1",onClick:U=>c(w.words.slice(-1)[0].text.slice(-1)[0])},null,8,Rt)]),B.value.length>0&&!q(K)?(t(),u("div",It,[(t(!0),u(Y,null,Z(w.comments,(U,M)=>(t(),R(ke,{key:M,class:"w-full",modelValue:U.content,"onUpdate:modelValue":D=>U.content=D,editing:U.editing,onValidate:D=>U.editing=!1,author:U.author,"created-at":U.created_at},null,8,["modelValue","onUpdate:modelValue","editing","onValidate","author","created-at"]))),128))])):b("",!0)]))),128))]),B.value.length>0&&!q(K)?(t(),u("div",Vt)):b("",!0)])],32)):(t(),u("div",pt,[p("span",null,k(s.fullText),1)]))]))}}),Ut=p("hr",{class:"border-top border-zinc-400 my-4"},null,-1),At=p("div",{class:"text-xs italic"},"Raison de la lecture",-1),Dt=V({__name:"SeeThoughtInput",props:{thoughtInput:{}},setup(_){const l=_,{getUserById:n,user:c}=te(),o=f(null),a=S(()=>c.value?l.thoughtInput.interaction_user_id===c.value.id:!1);return N(async()=>{l.thoughtInput.interaction_user_id&&(o.value=await n(l.thoughtInput.interaction_user_id))}),(i,e)=>(t(),u("div",null,[v(No,{id:i.thoughtInput.resource_id,"second-level":""},null,8,["id"]),Ut,At,v(Tt,{"full-text":i.thoughtInput.interaction_comment,editable:a.value},null,8,["full-text","editable"])]))}}),Et={class:"w-full md:w-96"},Bt={key:0,class:"text-xs italic mb-2 bg-white"},St={class:"flex flex-wrap"},Ot={key:1,class:"text-2xs italic ml-2"},Ft={key:2,class:"ml-auto m-1 w-1/3"},Lt={key:0,class:"border shadow-lg rounded p-4 md:w-96 bg-white"},qt={class:"flex"},Pt=["src"],jt={class:"flex flex-wrap w-full",style:{"margin-top":"-8px"}},zt={class:"text-2xs"},Mt={class:"flex flex-wrap"},Nt={key:0,class:"text-2xs italic"},Kt=V({__name:"ThoughtInputCard",props:{contextualResource:{},isDisabled:{type:Boolean,default:!1}},setup(_){const l=_,{getUserById:n}=te(),{getAuthorInteractionForResource:c}=he(),o=f(null),a=f(null),i=f(null);N(async()=>{l.contextualResource.user_id&&(i.value=await n(l.contextualResource.user_id)),l.contextualResource.resource&&(a.value=await c(l.contextualResource.resource.id)),a.value&&(o.value=await n(a.value.interaction_user_id))});const e=d=>d?d.toLocaleString("fr-FR",{hour:"numeric",weekday:"short",day:"numeric",month:"short",year:"2-digit"}):"",r=d=>d.length>200?d.slice(0,150)+"...":d;return(d,g)=>{const h=Te("router-link");return t(),u("div",Et,[d.contextualResource.context_comment?(t(),u("div",Bt,[p("div",null,k(d.contextualResource.context_comment),1),p("div",St,[i.value?(t(),R(h,{key:0,to:"/users/"+i.value.id,class:"text-2xs underline"},{default:E(()=>[ie(k(i.value.first_name)+" "+k(i.value.last_name),1)]),_:1},8,["to"])):b("",!0),d.contextualResource.date?(t(),u("div",Ot,k(e(d.contextualResource.date)),1)):b("",!0),d.contextualResource.progress?(t(),u("div",Ft,[v(Ue,{"progress-value":d.contextualResource.progress},null,8,["progress-value"])])):b("",!0)])])):b("",!0),d.contextualResource.resource?(t(),R(Me(d.isDisabled?"span":"vue-router"),{key:1,to:"/resources/"+d.contextualResource.resource.id+"?tab=ctnt"},{default:E(()=>[d.contextualResource.resource?(t(),u("div",Lt,[p("div",qt,[d.contextualResource.resource?(t(),u("img",{key:0,class:"w-8 h-fit mr-4",src:d.contextualResource.resource.image_url},null,8,Pt)):b("",!0),p("div",null,[p("div",null,k(d.contextualResource.resource.title)+" "+k(d.contextualResource.resource.subtitle),1),p("div",jt,[o.value?(t(),R(h,{key:0,to:"/users/"+o.value.id,class:"text-2xs underline"},{default:E(()=>[ie(k(o.value.first_name)+" "+k(o.value.last_name),1)]),_:1},8,["to"])):b("",!0)]),p("div",zt,k(r(d.contextualResource.resource.comment)),1)])]),p("div",Mt,[d.contextualResource.date?(t(),u("div",Nt,k(e(d.contextualResource.resourcedate)),1)):b("",!0)])])):b("",!0)]),_:1},8,["to"])):b("",!0)])}}}),Wt={class:"w-fit"},Jt=V({__name:"ThoughtInputCardWithPopup",props:{thoughtInput:{},usageReason:{},isDisabled:{type:Boolean,default:!1}},setup(_){const l=f(!1);return(n,c)=>(t(),u("div",Wt,[v(re,{open:l.value,onClose:c[0]||(c[0]=o=>l.value=!1)},{default:E(()=>[v(Dt,{"thought-input":n.thoughtInput,"usage-reason":n.usageReason},null,8,["thought-input","usage-reason"])]),_:1},8,["open"]),v(Kt,{class:"md:w-96","contextual-resource":n.thoughtInput,"is-disabled":n.isDisabled},null,8,["contextual-resource","is-disabled"])]))}}),Ht={class:"relative max-w-full"},Gt={key:0,class:"absolute md:border h-full start-1/2 -z-10"},ue=V({__name:"ThoughtInputsList",props:{contextualResources:{},center:{type:Boolean,default:!1},linksDisabled:{type:Boolean,default:!1}},emits:["select"],setup(_,{emit:l}){const n=o=>o.sort((a,i)=>+(i.date>a.date)),c=o=>{console.log("Select"),l("select",o)};return(o,a)=>(t(),u("div",Ht,[o.center?b("",!0):(t(),u("div",Gt)),(t(!0),u(Y,null,Z(n(o.contextualResources),(i,e)=>(t(),R(Jt,{key:i.id,class:we(["mb-4 md:mb-1 mx-auto max-w-full max-w-fit p-1",{"md:ml-0":e%2==0&&!o.center,"md:mr-0":!o.center}]),"thought-input":i,onClick:r=>c(i),"is-disabled":o.linksDisabled},null,8,["class","thought-input","onClick","is-disabled"]))),128))]))}}),{launchSnackbar:Qt}=Ne();function Xt(){const _={title:"",subtitle:"",content:"",external_content_url:"",publishing_state:"pbsh",maturing_state:"fnsh",image_url:"",resource_type:"",comment:""};return{interaction_progress:0,interaction_date:new Date(Date.now()),interaction_comment:"",interaction_is_public:!0,resource:_}}function ge(_){return console.log("Date : ",_.interaction_date),_.interaction_date=new Date(_.interaction_date),_}async function Yt(){return(await pe.get("/thought_inputs?limit=60")).data.map(l=>ge(l))}async function Zt(_){const l=await pe.get("/thought_inputs/"+_);return ge(l.data)}async function eo(_){return(await pe.get("/users/"+_+"/thought_inputs?limit=60")).data.map(n=>ge(n))}async function to(_){const l=new Date(_.interaction_date);console.log("Date : ",l);const n=l.toISOString().split(".")[0];_.interaction_progress=Number(_.interaction_progress);const c=await pe.post("/thought_inputs",{..._,interaction_date:n});return Qt("Creation de l'input réussie","success"),ge(c.data)}function oo(){return{getUserThoughtInputs:eo,newThoughtInput:Xt,createThoughtInput:to,getThoughtInputs:Yt,getThoughtInput:Zt}}const lo={key:0,class:"mb-4"},so={key:1},no={key:1},ao={key:2},ro={class:"flex flex-row-reverse"},Be=V({__name:"CreateResourceRelationForm",props:{targetResource:{},originResource:{}},emits:["close","refresh"],setup(_,{emit:l}){const n=_,{user:c}=te(),o=f(),a=C=>{console.log("Event : ",C),o.value=C},i=f([{text:"Externes",value:"extr"},{text:"Internes",value:"artl"},{text:"Problème",value:"pblm"}]),e=f([{text:"Biblio",value:"bibl"},{text:"Résumé",value:"sumr"},{text:"Sujet principal",value:"main"},{text:"Evocation",value:"mino"}]),r=f([]),d=f(null),g=f([]),h=f([]),x=f([]),P=f(""),H=f(""),{createResourceRelation:G}=De(),{getResources:K}=he(),B=S(()=>r.value.map(C=>({resource:C.resource}))),j=C=>C.map(T=>({resource:T})),oe=S(()=>({extr:j(g.value),artl:j(h.value),pblm:j(x.value)})),Q=async()=>{if(console.log("create"),!d.value)return;const C={target_resource_id:n.targetResource?n.targetResource.id:d.value.id,origin_resource_id:n.originResource?n.originResource.id:d.value.id,relation_comment:P.value,relation_type:H.value};await G(C),l("refresh"),l("close")},{getUserThoughtInputs:W}=oo(),z=C=>{d.value=C.resource};return N(async()=>{!c.value||!c.value.id||(n.targetResource&&(r.value=await W(c.value.id)),n.originResource&&(g.value=await K({is_external:!0}),h.value=await K({is_external:!1,resource_type:"oatc"}),x.value=await K({is_external:!1,resource_type:"pblm"})))}),(C,T)=>(t(),u("div",null,[q(c)?(t(),u("div",lo," Nouvelle relation entre ressources par "+k(q(c).first_name)+" "+k(q(c).last_name),1)):b("",!0),d.value?(t(),u("div",ao,[v(ae,{class:"m-4",label:"Type de lien",choices:e.value,modelValue:H.value,"onUpdate:modelValue":T[2]||(T[2]=F=>H.value=F)},null,8,["choices","modelValue"]),v(_e,{class:"m-4",label:"Pourquoi ajouter cet élément ?",modelValue:P.value,"onUpdate:modelValue":T[3]||(T[3]=F=>P.value=F)},null,8,["modelValue"]),p("div",ro,[v(O,{type:"valid",onClick:Q,text:"Ajouter"}),v(O,{type:"abort",onClick:T[4]||(T[4]=F=>l("close")),text:"Annuler",class:"mr-1"})])])):(t(),u("div",so,[C.targetResource?(t(),R(ue,{key:0,"contextual-resources":B.value,center:"","links-disabled":"",onSelect:T[0]||(T[0]=F=>z(F))},null,8,["contextual-resources"])):(t(),u("div",no,[p("div",null,[ie(" Choisir une ressource cible "),v(Ee,{center:"",choices:i.value,default:"pblm",onUpdate:a},null,8,["choices"]),v(ue,{"contextual-resources":oe.value[o.value]||[],center:"",onSelect:T[1]||(T[1]=F=>z(F)),"links-disabled":""},null,8,["contextual-resources"])])]))]))]))}}),uo={class:"flex flex-wrap"},io={class:"flex flex-row-reverse"},co=V({__name:"CreateInteraction",props:{resource:{}},emits:["close","refresh"],setup(_,{emit:l}){const n=_,c=f([{text:"Lecture / Visionage",value:"inpt"},{text:"Envie",value:"wish"}]),{newInteraction:o,createInteractionForResource:a}=fe(),{user:i}=te(),e=f(o());N(()=>{e.value.interaction_type||(e.value.interaction_type="inpt")});const r=()=>{e.value.resource_id=n.resource.id,e.value.interaction_user_id=i.value.id,a(n.resource.id,e.value),l("refresh"),d()},d=()=>l("close");return(g,h)=>(t(),u("div",null,[p("div",null,"Nouvelle interaction, avec la ressource : "+k(g.resource.title),1),p("div",uo,[v(ee,{label:"Avancement de l'ouvrage",class:"my-auto",modelValue:e.value.interaction_progress,"onUpdate:modelValue":h[0]||(h[0]=x=>e.value.interaction_progress=x),type:"number"},null,8,["modelValue"]),v(ae,{label:"Type d'interaction",class:"m-4 w-full md:w-5/12 md:ml-auto",choices:c.value,modelValue:e.value.interaction_type,"onUpdate:modelValue":h[1]||(h[1]=x=>e.value.interaction_type=x)},null,8,["choices","modelValue"])]),v(ee,{label:"Date de lecture",modelValue:e.value.interaction_date,"onUpdate:modelValue":h[2]||(h[2]=x=>e.value.interaction_date=x),type:"date"},null,8,["modelValue"]),v(_e,{label:"Pourquoi s'y être interessé ?",modelValue:e.value.interaction_comment,"onUpdate:modelValue":h[3]||(h[3]=x=>e.value.interaction_comment=x)},null,8,["modelValue"]),p("div",io,[v(O,{onClick:r,class:"m-4",text:"Valider",type:"valid"}),v(O,{onClick:d,class:"m-4",text:"Annuler",type:"abort"})])]))}}),vo=p("div",null,"Demander une Review pour l'article :",-1),mo={class:"flex flex-row-reverse mt-4"},po=V({__name:"CreateReview",props:{resource:{}},emits:["close","refresh"],setup(_,{emit:l}){const n=_,{newInteraction:c,createInteractionForResource:o}=fe(),a=async()=>{const r=c();r.interaction_user_id=e.value,r.resource_id=n.resource.id,r.interaction_type="rvew",r.interaction_comment=i.value,await o(n.resource.id,r),l("refresh"),l("close")},i=f(""),e=f(null);return(r,d)=>(t(),u("div",null,[vo,p("div",null,k(r.resource.title),1),v(Ae,{modelValue:e.value,"onUpdate:modelValue":d[0]||(d[0]=g=>e.value=g)},null,8,["modelValue"]),v(_e,{class:"mt-4",label:"Message pour la review",modelValue:i.value,"onUpdate:modelValue":d[1]||(d[1]=g=>i.value=g)},null,8,["modelValue"]),p("div",mo,[v(O,{type:"valid",onClick:a,text:"Ajouter"}),v(O,{type:"abort",onClick:d[2]||(d[2]=g=>l("close")),text:"Annuler",class:"mr-1"})])]))}}),fo=V({__name:"ResourceTools",props:{resource:{},isResourceEditable:{type:Boolean}},emits:["refresh","edit"],setup(_,{emit:l}){const n=f(!1),c=f(!1),o=f(!1),a=f(!1);return(i,e)=>(t(),u("div",null,[i.isResourceEditable&&n.value?(t(),R(ne,{key:0,title:"Modifier",onClick:e[0]||(e[0]=r=>l("edit"))},{default:E(()=>[v(q(Ke),{class:"m-1"})]),_:1})):b("",!0),i.isResourceEditable&&n.value?(t(),R(ne,{key:1,class:"mt-2",color:"blue",title:"Demander une review",onClick:e[1]||(e[1]=r=>c.value=!0)},{default:E(()=>[v(q(We),{class:"m-1"})]),_:1})):b("",!0),v(re,{open:c.value,onClose:e[4]||(e[4]=r=>c.value=!1)},{default:E(()=>[v(po,{onRefresh:e[2]||(e[2]=r=>l("refresh")),onClose:e[3]||(e[3]=r=>c.value=!1),resource:i.resource},null,8,["resource"])]),_:1},8,["open"]),i.isResourceEditable&&n.value?(t(),R(ne,{key:2,class:"mt-2",color:"red",title:"Marquer comme lu",onClick:e[5]||(e[5]=r=>o.value=!0)},{default:E(()=>[v(q(Ge),{class:"m-1"})]),_:1})):b("",!0),v(re,{open:o.value,onClose:e[8]||(e[8]=r=>o.value=!1)},{default:E(()=>[v(co,{onRefresh:e[6]||(e[6]=r=>l("refresh")),onClose:e[7]||(e[7]=r=>o.value=!1),resource:i.resource},null,8,["resource"])]),_:1},8,["open"]),i.isResourceEditable&&n.value?(t(),R(ne,{key:3,class:"mt-2",color:"green",title:"Relier à d'autres ressources",onClick:e[9]||(e[9]=r=>a.value=!0)},{default:E(()=>[v(q(Qe),{class:"m-1"})]),_:1})):b("",!0),v(re,{open:a.value,onClose:e[12]||(e[12]=r=>a.value=!1)},{default:E(()=>[v(Be,{onRefresh:e[10]||(e[10]=r=>l("refresh")),onClose:e[11]||(e[11]=r=>a.value=!1),"origin-resource":i.resource},null,8,["origin-resource"])]),_:1},8,["open"]),v(ne,{class:"mt-2",color:"gray",onClick:e[13]||(e[13]=r=>n.value=!n.value)},{default:E(()=>[v(q(Xe))]),_:1})]))}}),_o=V({__name:"CommentsThread",props:{resourceId:{}},setup(_){const l=_,{user:n}=te(),c=f([]),{createComment:o,getCommentsForThoughtOutput:a}=$e(),i=async()=>{console.log("Comment thread"),console.log("Props id : ",l.resourceId),c.value=await a(l.resourceId)},e=S(()=>c.value.filter(g=>!g.start_index).sort((g,h)=>g.created_at-h.created_at)),r=f(""),d=async()=>{await o(l.resourceId,null,null,r.value,!1),r.value="",await i()};return N(async()=>await i()),(g,h)=>(t(),u("div",null,[(t(!0),u(Y,null,Z(e.value,x=>(t(),R(ke,{key:x.id,class:"w-full",modelValue:x.content,"onUpdate:modelValue":P=>x.content=P,editing:x.editing,onValidate:P=>x.editing=!1,author:x.author,"created-at":x.created_at},null,8,["modelValue","onUpdate:modelValue","editing","onValidate","author","created-at"]))),128)),v(ke,{class:"w-full",modelValue:r.value,"onUpdate:modelValue":h[0]||(h[0]=x=>r.value=x),editing:!0,onValidate:d,author:q(n),"created-at":null},null,8,["modelValue","author"])]))}}),ho=V({__name:"DateField",props:{date:{}},setup(_){const l=_,n=S(()=>new Date(l.date).toLocaleDateString("fr-FR",{day:"numeric",month:"short",year:"numeric"}));return(c,o)=>(t(),u("div",null,k(n.value),1))}}),go={class:"flex flex-col"},xo={class:"block text-2xs text-slate-800"},yo=["value","placeholder"],bo=V({__name:"NumberInput",props:{label:{},modelValue:{},placeholder:{}},emits:["update:modelValue","input"],setup(_,{emit:l}){const n=c=>{l("update:modelValue",c.target.value),l("input",c.target.value)};return(c,o)=>(t(),u("div",go,[p("label",xo,k(c.label),1),p("input",{class:"border border-neutral-400 block h-full w-full rounded-md border-2 p-1 pl-2 text-xs",type:"number",value:c.modelValue,placeholder:c.placeholder,onInput:o[0]||(o[0]=a=>n(a))},null,40,yo)]))}}),wo={class:"grid grid-cols-4 gap-y-2 gap-x-4 auto-rows-auto"},ko=V({__name:"ResourceForm",props:{article:{}},emits:["change"],setup(_,{emit:l}){const n=_,c=f([{text:"Terminé",value:"fnsh"},{text:"Relecture",value:"rvew"},{text:"Brouillon",value:"drft"},{text:"Poubelle",value:"trsh"}]),{resourceTypeOptions:o}=he(),a=(i,e)=>{let r={...n.article};r[i]=e,r.is_external&&(r.maturing_state="fnsh"),console.log("Article : ",r),l("change",r)};return(i,e)=>(t(),u("div",wo,[v(ee,{class:"col-span-4",label:"Titre",modelValue:i.article.title,"onUpdate:modelValue":e[0]||(e[0]=r=>a("title",r))},null,8,["modelValue"]),v(ee,{class:"col-span-4",label:"Sous-titre",modelValue:i.article.subtitle,"onUpdate:modelValue":e[1]||(e[1]=r=>a("subtitle",r))},null,8,["modelValue"]),v(ee,{class:"col-span-4 md:col-span-2",label:"Lien contenu externe",modelValue:i.article.external_content_url,"onUpdate:modelValue":e[2]||(e[2]=r=>a("external_content_url",r))},null,8,["modelValue"]),v(ee,{class:"col-span-4 md:col-span-2",label:"Lien image",modelValue:i.article.image_url,"onUpdate:modelValue":e[3]||(e[3]=r=>a("image_url",r))},null,8,["modelValue"]),v(ae,{label:"Type de ressource",class:"col-span-4 md:col-span-2",choices:q(o),"onUpdate:modelValue":e[4]||(e[4]=r=>a("resource_type",r)),"model-value":i.article.resource_type},null,8,["choices","model-value"]),v(ae,{label:"Ressource externe",class:"col-span-4 md:col-span-1",choices:[{text:"Oui",value:!0},{text:"Non",value:!1}],"onUpdate:modelValue":e[5]||(e[5]=r=>a("is_external",JSON.parse(r))),"model-value":i.article.is_external},null,8,["model-value"]),v(ae,{label:"Stade d'écriture",class:"col-span-4 md:col-span-1",choices:c.value,"model-value":i.article.maturing_state,"onUpdate:modelValue":e[6]||(e[6]=r=>a("maturing_state",r))},null,8,["choices","model-value"])]))}}),$o={class:"grid grid-cols-3 gap-4"},Co=V({__name:"ResourceAuthorPicker",props:{interaction:{},resourceId:{}},emits:["update"],setup(_,{emit:l}){const n=_,c=S(()=>{var g;return(g=n.interaction)==null?void 0:g.interaction_user_id}),{createInteractionForResource:o,newInteraction:a,createInteraction:i,updateInteraction:e}=fe(),r=async g=>{if(console.log(`newUser : ${JSON.stringify(g)}`),n.interaction){const h={...n.interaction};h.interaction_user_id=g,console.log("newUserid : ",g.id),console.log(`Interaction payload : ${JSON.stringify(h)}`),await e(n.interaction.id,h),l("update")}else{console.log("create interaction");const h=a();h.interaction_user_id=g,h.resource_id=n.resourceId,await o(n.resourceId,h),l("update")}},d=async g=>{await e(n.interaction.id,g),l("update")};return(g,h)=>(t(),u("div",$o,[v(Ae,{"model-value":c.value,"onUpdate:modelValue":h[0]||(h[0]=x=>r(x))},null,8,["model-value"]),g.interaction?(t(),R(ee,{key:0,class:"text-2xs",label:"Date d'écriture","model-value":g.interaction.interaction_date?g.interaction.interaction_date.split("T")[0]:null,"onUpdate:modelValue":h[1]||(h[1]=x=>d({...g.interaction,interaction_date:x})),type:"date"},null,8,["model-value"])):b("",!0),g.interaction?(t(),R(bo,{key:1,class:"",label:"Progression",modelValue:g.interaction.interaction_progress,"onUpdate:modelValue":h[2]||(h[2]=x=>d({...g.interaction,interaction_progress:x}))},null,8,["modelValue"])):b("",!0)]))}}),Ro={key:0,class:"text-center text-2xl pt-10"},Io={key:1},Vo={key:0},To={class:"my-8"},Uo=["src"],Ao={class:"text-3xl my-3 font-mplus md:text-center text-left"},Do={class:"md:text-center text-left"},Eo={class:"md:text-center text-left"},Bo={class:"md:flex my-8"},So=["href"],Oo={key:1,class:"my-2 flex flex-col"},Fo={class:"flex flex-row-reverse mb-4"},Lo=p("hr",{class:"border-top border-zinc-400 my-4"},null,-1),qo={key:2},Po=p("div",{class:"text-xs italic"},"Contenu",-1),jo={key:3},zo={key:4},Mo={key:5},No=V({__name:"ResourceComponent",props:{resourceId:{},secondLevel:{type:Boolean}},setup(_){const l=_,n=Ie(),c=S(()=>A.value&&w.value||!C.value||s.value.is_local_draft||!i.value),o=S(()=>l.secondLevel?"popup_tab":"tab"),a=S(()=>[{text:"Contenu",value:"ctnt"},{text:"Biblio",value:"bbli",count:h.value.length},{text:"Sujets",value:"pblm",count:Q.value.length},{text:"Interactions",value:"inpt",count:G.value.length}]),i=f(!0),e=f(n.query[o.value]&&typeof n.query[o.value]=="string"?n.query[o.value]:"ctnt"),r=f(n.query[o.value]);le(()=>n.query[o.value],y=>{console.log("new route query",y),typeof y=="string"&&(r.value=y)});const{getResourceRelationsForResource:d,getUsagesForResource:g}=De(),h=f([]),x=f(!1),P=async()=>{h.value=await d(me(l).resourceId.value)},H=S(()=>h.value.map(y=>({resource:y.origin_resource,date:y.created_at,user_id:y.user_id,context_comment:y.relation_comment,progress:null}))),G=f([]),{getInteractionsForResource:K,updateInteraction:B}=fe(),j=async()=>{G.value=await K(l.resourceId)},oe=S(()=>G.value.map(y=>({resource:null,date:y.interaction_date,user_id:y.interaction_user_id,context_comment:y.interaction_comment,progress:y.interaction_progress}))),Q=f([]),W=async()=>{Q.value=await g(l.resourceId)},z=S(()=>Q.value.map(y=>({resource:y.target_resource,date:y.created_at,user_id:y.user_id,context_comment:y.relation_comment,progress:null}))),C=f(!1),{newResource:T,getResource:F,updateResource:xe,getAuthorInteractionForResource:ce}=he(),J=f(null),s=f(T()),m=Re();le(()=>n.query.editing,y=>{console.log("Editing : ",y),w.value=y==="false"?!1:!!y});const w=f(!1),{isMobile:A}=Ve(),U=y=>{m.push({query:{editing:y.toString()}})},M=(y,$)=>{s.value=$,J.value!==null&&clearTimeout(J.value),J.value=setTimeout(async()=>{try{await xe(y,s.value)}catch(be){console.log("An error : ",be)}},1e3)},D=y=>{y!=`
`&&M(me(l).resourceId.value,{...s.value,content:y})},{user:de,getUserById:ve}=te(),se=S(()=>s.value.is_external?!0:de.value?X.value?X.value.id==de.value.id:!0:!1),X=f(null),I=f(null),ye=async()=>{I.value=await ce(l.resourceId)},Se=async()=>{!I.value||!I.value.id||(await B(I.value.id,{...I.value,interaction_is_public:!0}),ye())},Oe=async()=>{!I.value||!I.value.id||(await B(I.value.id,{...I.value,interaction_is_public:!1}),ye())},{getCommentsForThoughtOutput:Fe}=$e(),Ce=f([]);return N(async()=>{C.value=!1,s.value=await F(l.resourceId),C.value=!0,await P(),await j(),await W(),Ce.value=await Fe(l.resourceId),I.value=await ce(l.resourceId),I.value&&(X.value=await ve(I.value.interaction_user_id));const y=n.query.editing;w.value=y==="false"?!1:!!y}),(y,$)=>{const be=Te("router-link");return t(),u("div",null,[C.value?(t(),u("div",Io,[w.value?(t(),u("div",Oo,[v(ko,{article:s.value,class:"",onChange:$[0]||($[0]=L=>M(s.value.id,L))},null,8,["article"]),v(Co,{class:"my-2",interaction:I.value,"resource-id":y.resourceId,onChange:ye},null,8,["interaction","resource-id"]),p("div",Fo,[v(O,{class:"ml-2",onClick:$[1]||($[1]=L=>U(!1)),type:"valid",text:"Preview"},{default:E(()=>[ie("Ok")]),_:1}),I.value&&!I.value.interaction_is_public?(t(),R(O,{key:0,class:"ml-2",onClick:Se,type:"valid",text:"Publier"})):I.value?(t(),R(O,{key:1,class:"ml-2",onClick:Oe,type:"abort",text:"Dépublier"})):b("",!0),v(O,{class:"ml-2",onClick:$[2]||($[2]=L=>i.value=!i.value),type:"valid",text:i.value?"Text brut":"Editeur"},null,8,["text"])])])):(t(),u("div",Vo,[p("div",To,[p("img",{src:s.value.image_url,class:"border border-slate-300 dark:border-zinc-700 rounded-xl ml-auto mr-auto",style:{"max-height":"20rem"}},null,8,Uo)]),p("h1",Ao,k(s.value.title),1),p("div",Do,k(s.value.subtitle),1),p("div",Eo,[X.value?(t(),R(be,{key:0,to:"/users/"+X.value.id,class:"text-sm underline"},{default:E(()=>[ie(k(X.value.first_name)+" "+k(X.value.last_name),1)]),_:1},8,["to"])):b("",!0),I.value?(t(),R(ho,{key:1,date:I.value.interaction_date},null,8,["date"])):b("",!0)]),p("div",Bo,[I.value?(t(),R(Ue,{key:0,"progress-value":I.value.interaction_progress,class:"m-2 w-1/3"},null,8,["progress-value"])):b("",!0),s.value.external_content_url?(t(),u("a",{key:1,class:"ml-auto underline",href:s.value.external_content_url,target:"_blank"}," Lien ressource externe ",8,So)):b("",!0)])])),p("div",null,[w.value?b("",!0):(t(),R(Ee,{key:0,choices:a.value,default:e.value,"url-key":o.value,url:""},null,8,["choices","default","url-key"]))]),Lo,r.value=="ctnt"?(t(),u("div",qo,[Po,c.value?(t(),R(_e,{key:0,class:"mt-4 h-96",modelValue:s.value.content,"onUpdate:modelValue":$[3]||($[3]=L=>D(L))},null,8,["modelValue"])):(t(),R(He,{key:1,class:"min-h-fit","ext-comments":Ce.value,"resource-id":s.value.id,text:s.value.content,editable:se.value,onChange:$[4]||($[4]=L=>D(L))},null,8,["ext-comments","resource-id","text","editable"])),v(_o,{class:"mt-6","resource-id":y.resourceId},null,8,["resource-id"])])):r.value=="bbli"?(t(),u("div",jo,[v(re,{open:x.value,onClose:$[6]||($[6]=L=>x.value=!1)},{default:E(()=>[v(Be,{onRefresh:P,onClose:$[5]||($[5]=L=>x.value=!1),"target-resource":s.value},null,8,["target-resource"])]),_:1},8,["open"]),p("div",{onClick:$[7]||($[7]=L=>x.value=!0),class:"text-sm italic underline"}," Ajouter une référence "),v(ue,{"contextual-resources":H.value},null,8,["contextual-resources"])])):r.value=="pblm"?(t(),u("div",zo,[v(ue,{"contextual-resources":z.value},null,8,["contextual-resources"])])):r.value=="inpt"?(t(),u("div",Mo,[v(ue,{"contextual-resources":oe.value},null,8,["contextual-resources"])])):b("",!0),v(fo,{class:"fixed right-3 bottom-5",resource:s.value,"is-resource-editable":se.value,onRefresh:$[8]||($[8]=L=>W()&&j()),onEdit:$[9]||($[9]=L=>U(!0))},null,8,["resource","is-resource-editable"])])):(t(),u("div",Ro,"Loading..."))])}}});export{No as _,Dt as a,ue as b,oo as u};
