import{O as M,Q as ot,d as lt,x as it,r as L,j as p,o as dt,y as ct,a as ut,c as i,l as s,t as v,k as m,m as R,e as N,F as w,g as S,b as o,h as A,w as J,f as _t,S as gt,U as mt,n as yt,M as pt}from"./index-7b431e64.js";import{_ as V}from"./HeatmapDisplay.vue_vue_type_script_setup_true_lang-c402bd2f.js";import{a as vt,_ as ft}from"./LandmarksDisplayGrid.vue_vue_type_script_setup_true_lang-e2ecfbae.js";import"./ChevronDownIcon-baccdbe7.js";const{launchSnackbar:ht}=ot(),kt=async f=>{try{return(await M.get("/landmarks/"+f)).data}catch(b){throw ht(`Error getting landmark: ${b}`,"error"),b}};function bt(){return{getLandmark:kt}}const g=f=>(gt("data-v-3eab7488"),f=f(),mt(),f),xt={class:"p-4 md:px-24"},wt={key:0,class:"text-center text-2xl pt-10"},St={key:1},Dt=g(()=>s("h1",{class:"text-3xl font-bold mb-6"},"Landmark Details",-1)),Ct={class:"mb-6"},Lt={class:"border border-slate-300 dark:border-zinc-700 rounded-lg p-4"},Tt={class:"flex items-center justify-between mb-3"},Ut={key:0,class:"mb-4"},$t=g(()=>s("div",{class:"text-sm font-semibold text-gray-600 dark:text-gray-400 mb-2"},"Title",-1)),Et={class:"text-2xl font-bold"},Nt={key:1,class:"mb-4"},At=g(()=>s("div",{class:"text-sm font-semibold text-gray-600 dark:text-gray-400 mb-2"},"Subtitle",-1)),Mt={class:"text-lg"},Ft={key:0},Pt={key:0},Bt=g(()=>s("div",{class:"text-sm font-semibold text-gray-600 dark:text-gray-400 mb-2"},"Content",-1)),jt={class:"whitespace-pre-wrap text-sm"},zt={class:"mt-4 border-t border-slate-200 dark:border-zinc-700 pt-4"},It=g(()=>s("div",{class:"text-sm font-semibold text-gray-600 dark:text-gray-400 mb-2"},"Base fields",-1)),Wt={class:"grid grid-cols-1 md:grid-cols-2 gap-3"},Rt={class:"text-[11px] uppercase tracking-wide text-gray-500 dark:text-gray-400"},Jt={class:"text-sm text-gray-800 dark:text-gray-200 break-words mt-0.5"},Vt={key:0,class:"mb-6"},Ot=g(()=>s("h2",{class:"text-xl font-semibold mb-4"},"Related Elements Activity",-1)),Yt={class:"border border-slate-300 dark:border-zinc-700 rounded-lg p-4"},Ht={key:1,class:"mb-6"},Kt=g(()=>s("h2",{class:"text-xl font-semibold mb-4"},"Parent Landmarks",-1)),Qt={class:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"},qt=g(()=>s("div",{class:"text-sm font-semibold text-gray-600 dark:text-gray-400 mb-1"},"Parent",-1)),Gt={class:"text-base font-medium"},Xt={key:2,class:"mb-6"},Zt=g(()=>s("h2",{class:"text-xl font-semibold mb-4"},"Related Landmarks",-1)),te={key:3,class:"mb-6"},ee=g(()=>s("h2",{class:"text-xl font-semibold mb-4"},"Related Elements",-1)),ae={class:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"},re={key:4,class:"mb-6"},se=g(()=>s("h2",{class:"text-xl font-semibold mb-4"},"Related Elements Journal View",-1)),ne={class:"max-w-2xl mx-auto"},oe={class:"journal-canvas min-h-[320px]"},le={class:"traces-scroll h-full overflow-y-auto pr-2"},ie={class:"paper-content"},de={class:"flex flex-col md:flex-row md:items-center md:justify-between gap-2 mb-1"},ce={class:"text-xs text-slate-500"},ue={class:"flex flex-wrap gap-1.5 md:justify-end"},_e={key:2,class:"text-center text-2xl pt-10 text-red-600"},ge=6,me=lt({__name:"SeeLandmarkPage",props:{id:{}},setup(f){const b=f,{isMobile:F}=yt(),{getLandmark:O}=bt(),P=it(),l=L(null),U=L(!0),T=L(!1),B=["Mo","Tu","We","Th","Fr","Sa","Su"],h=L({}),k=L({}),Y=()=>{if(window.history.length>1){P.back();return}P.push("/me")},$=p(()=>{var t;return((t=l.value)==null?void 0:t.parent_landmarks)??[]}),H=p(()=>T.value?$.value:$.value.slice(0,4)),K=p(()=>$.value.length>4),u=t=>{if(t==null)return"-";if(t instanceof Date)return t.toLocaleString();if(Array.isArray(t))return t.length===0?"[]":t.map(a=>u(a)).join(", ");if(typeof t=="object")try{return JSON.stringify(t)}catch{return String(t)}const e=String(t).trim();return e.length>0?e:"-"},Q=p(()=>{const t=l.value;return t?[{key:"id",label:"ID",value:u(t.id)},{key:"landmark_type",label:"Type",value:u(t.landmark_type)},{key:"title",label:"Title",value:u(t.title)},{key:"subtitle",label:"Subtitle",value:u(t.subtitle)},{key:"analysis_id",label:"Analysis ID",value:u(t.analysis_id)},{key:"user_id",label:"User ID",value:u(t.user_id)},{key:"parent_id",label:"Parent ID",value:u(t.parent_id)},{key:"maturing_state",label:"Maturing state",value:u(t.maturing_state)},{key:"created_at",label:"Created at",value:u(t.created_at)},{key:"updated_at",label:"Updated at",value:u(t.updated_at)}].filter(a=>a.value!=="-"||a.key==="landmark_type"):[]}),q=t=>{const e=t.getUTCFullYear(),a=String(t.getUTCMonth()+1).padStart(2,"0"),r=String(t.getUTCDate()).padStart(2,"0");return`${e}-${a}-${r}`},G=t=>{if(!t)return null;const e=new Date(String(t));if(Number.isNaN(e.getTime()))return null;const a=new Date(Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate()));return Number.isNaN(a.getTime())?null:a},D=p(()=>{const t=new Date,e=new Date(Date.UTC(t.getUTCFullYear(),t.getUTCMonth(),t.getUTCDate()));return{start:new Date(Date.UTC(e.getUTCFullYear(),e.getUTCMonth()-(ge-1),1)),end:e}}),X=p(()=>{var n;const t=new Map,e=((n=l.value)==null?void 0:n.related_elements)??[],{start:a,end:r}=D.value;for(const d of e){const c=d.interaction_date??d.created_at,_=G(c);if(!_||_<a||_>r)continue;const C=q(_);t.set(C,(t.get(C)??0)+1)}return t}),j=p(()=>Array.from(X.value.entries()).map(([t,e])=>({day:t,value:e}))),E=p(()=>{var r,n;const t=(r=l.value)!=null&&r.id?String(l.value.id).trim():"";if(!t)return[];const e=new Map,a=((n=l.value)==null?void 0:n.related_elements)??[];for(const d of a){const c=z(d);if(!c)continue;const _=h.value[c]??[],C=new Set;for(const y of _){const x=(y==null?void 0:y.id)!=null?String(y.id).trim():"";if(!x||x===t||C.has(x))continue;C.add(x);const nt=typeof(y==null?void 0:y.title)=="string"&&y.title.trim().length>0?y.title.trim():"Sans titre",W=e.get(x);W?W.count+=1:e.set(x,{title:nt,count:1})}}return Array.from(e.entries()).map(([d,c])=>({id:d,title:c.title,count:c.count})).sort((d,c)=>c.count!==d.count?c.count-d.count:d.title.localeCompare(c.title,"fr-FR"))}),Z=p(()=>E.value.map(t=>{var e,a,r;return{id:t.id,title:((e=k.value[t.id])==null?void 0:e.title)??t.title,display_subtitle:`${t.count} relation${t.count>1?"s":""}`,display_content:((a=k.value[t.id])==null?void 0:a.content)??"",landmark_type:(r=k.value[t.id])==null?void 0:r.landmark_type}})),z=t=>{const e=t==null?void 0:t.id;if(e==null)return null;const a=String(e).trim();return a.length>0?a:null},tt=t=>{if(typeof t!="string")return null;let e=t.trim();if(!e)return null;for(let a=0;a<3;a++){if(typeof e!="string")return e;const r=e.trim();if(!r)return null;if(!(r.startsWith("{")||r.startsWith("[")||r.startsWith('"')))return a===0?null:e;try{e=JSON.parse(r)}catch{return a===0?null:e}}return e},et=t=>{var n;const e=(t==null?void 0:t.spans)??(t==null?void 0:t.span);if(Array.isArray(e)){const d=e.map(c=>typeof c=="string"?c.trim():"").filter(c=>c.length>0);if(d.length>0)return d}else if(typeof e=="string"&&e.trim().length>0)return[e.trim()];const a=tt((t==null?void 0:t.content)??((n=t==null?void 0:t.resource)==null?void 0:n.content)??"");if(a&&typeof a=="object"){const d=a.spans??a.span;if(Array.isArray(d)){const c=d.map(_=>typeof _=="string"?_.trim():"").filter(_=>_.length>0);if(c.length>0)return c}else if(typeof d=="string"&&d.trim().length>0)return[d.trim()]}return[typeof(t==null?void 0:t.title)=="string"&&t.title.trim().length>0?t.title.trim():"Élément"]},at=t=>{const e=(t==null?void 0:t.interaction_date)??(t==null?void 0:t.interactionDate)??(t==null?void 0:t.created_at)??(t==null?void 0:t.createdAt);if(!e)return"Date inconnue";const a=new Date(String(e));return Number.isNaN(a.getTime())?String(e):a.toLocaleString("fr-FR",{weekday:"short",year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})},rt=async t=>{if(t&&h.value[t]==null)try{const e=await M.get(`/elements/${t}/landmarks`);h.value[t]=Array.isArray(e.data)?e.data:[]}catch(e){console.error(`Error fetching landmarks for element ${t}:`,e),h.value[t]=[]}},st=async t=>{if(t&&k.value[t]==null)try{const e=await M.get(`/landmarks/${t}`);k.value[t]=e.data??null}catch(e){console.error(`Error fetching co-occurring landmark ${t}:`,e),k.value[t]=null}},I=async()=>{var t;try{U.value=!0,T.value=!1,h.value={},k.value={},l.value=await O(b.id);const a=(((t=l.value)==null?void 0:t.related_elements)??[]).map(n=>z(n)).filter(n=>!!n);await Promise.all(a.map(n=>rt(n)));const r=E.value.map(n=>n.id);await Promise.all(r.map(n=>st(n)))}catch(e){console.error("Error loading landmark:",e)}finally{U.value=!1}};return dt(async()=>{await I()}),ct(()=>b.id,async()=>{await I()}),(t,e)=>{const a=ut("router-link");return o(),i("div",xt,[U.value?(o(),i("div",wt,"Loading...")):l.value?(o(),i("div",St,[s("div",{class:"mb-6"},[s("button",{type:"button",onClick:Y,class:"text-sm underline text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200"}," ← Back ")]),Dt,s("div",Ct,[s("div",Lt,[s("div",Tt,[s("div",null,[l.value.title?(o(),i("div",Ut,[$t,s("div",Et,v(l.value.title),1)])):m("",!0),l.value.subtitle?(o(),i("div",Nt,[At,s("div",Mt,v(l.value.subtitle),1)])):m("",!0)]),R(F)?m("",!0):(o(),i("div",Ft,[N(V,{days:j.value,"range-start":D.value.start,"range-end":D.value.end,"empty-text":"No dated elements found","month-locale":"en-US","weekday-labels":B,"show-legend":!1,"show-max":!1},null,8,["days","range-start","range-end"])]))]),l.value.content?(o(),i("div",Pt,[Bt,s("div",jt,v(l.value.content),1)])):m("",!0),s("div",zt,[It,s("div",Wt,[(o(!0),i(w,null,S(Q.value,r=>(o(),i("div",{key:r.key,class:"rounded-md border border-slate-200 dark:border-zinc-700 px-3 py-2"},[s("div",Rt,v(r.label),1),s("div",Jt,v(r.value),1)]))),128))])])])]),R(F)&&l.value.related_elements&&l.value.related_elements.length>0?(o(),i("div",Vt,[Ot,s("div",Yt,[N(V,{days:j.value,"range-start":D.value.start,"range-end":D.value.end,"empty-text":"No dated elements found","month-locale":"en-US","weekday-labels":B,"legend-less-label":"Less","legend-more-label":"More"},null,8,["days","range-start","range-end"])])])):m("",!0),l.value.parent_landmarks&&l.value.parent_landmarks.length>0?(o(),i("div",Ht,[Kt,s("div",Qt,[(o(!0),i(w,null,S(H.value,r=>(o(),A(a,{key:r.id,to:`/app/landmarks/${r.id}`,class:"border border-slate-300 dark:border-zinc-700 rounded-lg p-3 hover:bg-gray-50 dark:hover:bg-zinc-800 transition-colors"},{default:J(()=>[qt,s("div",Gt,v(r.title||"Untitled"),1)]),_:2},1032,["to"]))),128))]),K.value&&!T.value?(o(),i("button",{key:0,type:"button",class:"mt-3 text-sm underline text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200",onClick:e[0]||(e[0]=r=>T.value=!0)}," Show all ")):m("",!0)])):m("",!0),E.value.length>0?(o(),i("div",Xt,[Zt,N(vt,{landmarks:Z.value},null,8,["landmarks"])])):m("",!0),l.value.related_elements&&l.value.related_elements.length>0?(o(),i("div",te,[ee,s("div",ae,[(o(!0),i(w,null,S(l.value.related_elements,r=>(o(),A(ft,{key:r.id,element:r,"associated-landmarks":h.value[r.id]??[],tone:"dark"},null,8,["element","associated-landmarks"]))),128))])])):m("",!0),l.value.related_elements&&l.value.related_elements.length>0?(o(),i("div",re,[se,s("div",ne,[s("div",oe,[s("div",le,[s("div",ie,[(o(!0),i(w,null,S(l.value.related_elements,r=>(o(),i("div",{key:`journal-${r.id}`,class:"journal-element-entry py-2 border-b border-slate-300/40 last:border-b-0"},[s("div",de,[s("div",ce,v(at(r)),1),s("div",ue,[(o(!0),i(w,null,S(h.value[r.id]??[],n=>(o(),A(a,{key:`chip-${r.id}-${n.id??n.title}`,to:`/me/landmarks/${n.id}`,class:"text-[10px] px-1.5 py-0.5 rounded-full border border-slate-400/70 text-slate-600 bg-white/65 hover:border-slate-500 hover:text-slate-800 transition-colors"},{default:J(()=>[_t(v(n.title||"Sans nom"),1)]),_:2},1032,["to"]))),128))])]),(o(!0),i(w,null,S(et(r),(n,d)=>(o(),i("div",{key:`span-${r.id}-${d}`,class:"font-georgia text-[15px] text-slate-700 leading-relaxed whitespace-pre-wrap"},v(n),1))),128))]))),128))])])])])])):m("",!0)])):(o(),i("div",_e,"Landmark not found"))])}}});const he=pt(me,[["__scopeId","data-v-3eab7488"]]);export{he as default};
