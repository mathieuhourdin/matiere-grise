import{_ as Ie,u as Be}from"./useArticle-b4cb5000.js";import{_ as fe}from"./RoundLinkButton.vue_vue_type_style_index_0_lang-b5019ced.js";import{o as e,f as n,a as d,d as S,h as F,m as k,t as $,i as v,q as xe,A as Pe,p as K,b as m,j as re,B as de,e as te,C as Oe,F as le,g as se,n as M,D as he,c as R,y as Ee,r as Te,w as P,l as ie,E as Le,_ as ae,G as Ne,u as qe,k as ze}from"./index-456102ed.js";import{_ as J}from"./ActionButton.vue_vue_type_script_setup_true_lang-1a6f154e.js";import{_ as ve,a as me,u as je,r as Me}from"./useThoughtInputs-260d1c51.js";import{_ as We,a as Re}from"./SelectionTextInterface.vue_vue_type_script_setup_true_lang-aac40220.js";import{_ as ee}from"./TextInput.vue_vue_type_script_setup_true_lang-452c144c.js";import{u as ye}from"./useInteraction-c860e408.js";/* empty css                                                               */import{_ as Ue}from"./ProgressBar.vue_vue_type_script_setup_true_lang-d76f4302.js";import{_ as He}from"./UserPicker.vue_vue_type_script_setup_true_lang-b2fc4285.js";import{u as be}from"./useResource-8a85ad0a.js";import{u as Ae}from"./useResourceRelations-9056c5c2.js";import{u as Je}from"./useProblem-a94f1cdd.js";function Ke(h,o){return e(),n("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true"},[d("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M9 8.25H7.5a2.25 2.25 0 00-2.25 2.25v9a2.25 2.25 0 002.25 2.25h9a2.25 2.25 0 002.25-2.25v-9a2.25 2.25 0 00-2.25-2.25H15M9 12l3 3m0 0l3-3m-3 3V2.25"})])}function Ge(h,o){return e(),n("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true"},[d("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M7.217 10.907a2.25 2.25 0 100 2.186m0-2.186c.18.324.283.696.283 1.093s-.103.77-.283 1.093m0-2.186l9.566-5.314m-9.566 7.5l9.566 5.314m0 0a2.25 2.25 0 103.935 2.186 2.25 2.25 0 00-3.935-2.186zm0-12.814a2.25 2.25 0 103.933-2.185 2.25 2.25 0 00-3.933 2.185z"})])}const Xe={class:"bg-slate-100 border p-1 m-1 rounded shadow-xl"},Ye={class:"flex"},Qe={key:0,class:"text-xs mt-0.5 mb-1 font-bold flex"},Ze=["src"],et={class:"my-auto"},tt={class:"text-2xs italic ml-auto mr-1 my-auto"},ot={key:0},lt=["value"],st={class:"flex"},at={key:1,class:"text-xs mt-0.5"},ge=S({__name:"CommentCard",props:{editing:{type:Boolean},modelValue:{},author:{},createdAt:{}},emits:["update:modelValue","validate","abort"],setup(h,{emit:o}){const a=h,u=F(()=>a.createdAt?a.createdAt.toLocaleString("fr-FR",{hour:"numeric",weekday:"short",day:"numeric",month:"short",year:"2-digit"}):""),t=i=>{o("update:modelValue",i.target.value)},p=()=>{o("validate")},_=()=>{o("abort")};return(i,y)=>(e(),n("div",Xe,[d("div",Ye,[i.author?(e(),n("div",Qe,[i.author.profile_picture_url?(e(),n("img",{key:0,class:"h-5 w-5 rounded-full mr-1",src:i.author.profile_picture_url},null,8,Ze)):k("",!0),d("div",et,$(i.author.first_name)+" "+$(i.author.last_name),1)])):k("",!0),d("div",tt,$(u.value),1)]),i.editing?(e(),n("div",ot,[d("textarea",{class:"w-full text-xs rounded-xl p-2",value:i.modelValue,onInput:t},null,40,lt),d("div",st,[v(J,{onClick:p,class:"text-sm",rounded:"",size:"2xs",text:"Commenter",type:"valid"}),v(J,{onClick:_,class:"text-sm",rounded:"",size:"2xs",text:"Annuler",type:"abort"})])])):(e(),n("div",at,$(i.modelValue),1))]))}}),{launchSnackbar:we}=Pe(),nt=async(h,o,a,u)=>{const{user:t}=K(),p={start_index:o,end_index:o,content:a,editing:u};try{const _=await xe.post("/resources/"+h+"/comments",p),i=ke(_.data);return t.value&&i.author_id==t.value.id&&(i.author=t.value),i}catch(_){throw console.log("error : ",_),we(`Error creating comment : ${_}`,"error"),_}},ke=h=>(h.updated_at=new Date(h.updated_at.split(".")[0]),h.created_at=new Date(h.created_at.split(".")[0]),h),rt=async(h,o=!0)=>{const a=o?"?author=true":"";try{return(await xe.get("/resources/"+h+"/comments"+a)).data.map(t=>ke(t))}catch(u){throw console.log("error : ",u),we(`Error getting comments : ${u}`,"error"),u}},De=async h=>{try{const o=await xe.put("/comments/"+h.id,h);return ke(o.data)}catch(o){console.log("error : ",o),we(`Error updating comment : ${o}`,"error")}},ut=async h=>{console.log("comments : ",h),h.map(o=>De(o))};function Ce(){return{createComment:nt,getCommentsForThoughtOutput:rt,updateComment:De,batchUpdateComments:ut}}const it={class:"relative"},ct={key:0},dt=d("div",{class:"text-sm align-middle flex items-center p-2",style:{height:"50px"}}," Corriger une faute ",-1),vt={class:"flex mx-auto max-w-full"},mt={class:"w-full"},pt={key:0,class:"flex"},_t=d("div",{class:"w-6"},[d("div",{class:"rounded-full ml-4 mr-2 mt-2 h-1 w-1 bg-black"})],-1),ft=[_t],ht={class:"flex flex-wrap flex-1"},gt=["onClick","onContextmenu"],xt={key:0,style:{width:"5px"}},yt={key:1,style:{height:"25px"}},bt={key:2},wt=["onClick"],kt={key:1,class:"absolute h-full",style:{right:"-2%",width:"27%"}},Ct={key:0,style:{width:"33%"}},$t=S({__name:"TextInterface",props:{resourceId:{},fullText:{},extComments:{default:()=>[]},editable:{type:Boolean,default:!0}},emits:["change","changeComments"],setup(h,{emit:o}){const a=h,u=s=>{console.log("selectCursorPosition letter : ",s),a.editable&&(t.value={id:s.id,char:s.char})},t=m(null),p=m([]),_=m([]),i=async()=>{let s=[{id:0,words:[{id:0,text:[]}],comments:[]}],c=0,C=0;for(var U=0;U<p.value.length;U++){p.value[U].char==`
`&&(c+=1,C=0,s.push({id:c,words:[{id:0,text:[]}],lineStyle:U<p.value.length-1?p.value[U+1].char:null,comments:[]}));const A=B.value.find(z=>z.start_index==U);A&&s[c].comments.push(A),s[c].words[C].text.push({id:U,char:p.value[U].char,comment:A}),p.value[U].char==" "&&(C+=1,s[c].words.push({id:C,text:[]}))}return s},y=s=>{s==1?B.value.forEach(c=>{t.value&&c.start_index>t.value.id&&(c.start_index+=1),t.value&&c.end_index>t.value.id&&(c.end_index+=1)}):s==-1&&B.value.forEach(c=>{t.value&&c.start_index>=t.value.id&&(c.start_index-=1),t.value&&c.end_index>=t.value.id&&(c.end_index-=1)})},l=s=>{console.log("insertChar : ",s),t.value&&(console.log("insertChar with cursor set : ",s),p.value.filter(c=>t.value&&c.id>=t.value.id+1).forEach(c=>c.id+=1),p.value.splice(t.value.id+1,0,{id:t.value.id+1,char:s}),y(1),t.value.id+=1)},r=s=>{if(console.log("Writes : ",s.key),t.value===null)return;const c=s.key;if(f.value&&c=="v"){w();return}if(c.length==1)s.preventDefault(),l(c);else if(c=="Backspace")p.value.splice(t.value.id,1),p.value.filter(C=>t.value&&C.id>t.value.id).forEach(C=>C.id-=1),y(-1),t.value.id-=1;else if(c=="Enter")l(`
`);else if(c=="ArrowRight"){let C=t.value.id;C<p.value.length-1&&u(p.value[C+1])}else if(c=="ArrowLeft"){let C=t.value.id;C>0&&u(p.value[C-1])}else c=="Control"&&(console.log("Control"),f.value=!0)},f=m(!1),w=async()=>{try{let c=await navigator.clipboard.readText();console.log("Clippedtext : ",c);for(var s=0;s<c.length;s++)l(c[s])}catch(c){console.log("Error with clippboard : ",c)}},O=s=>{s.key=="Control"&&(f.value=!1)},{createComment:N,batchUpdateComments:ne}=Ce(),{isMobile:G}=Ee(),B=m([]),q=m(null),X=async s=>{B.value=s.filter(c=>c.start_index!=null)},Y=async()=>{if(console.log("Add Comment"),console.log(a.resourceId),console.log(W.value),!a.resourceId||!W.value)return;console.log("Add Comment 2");const s=await N(a.resourceId,W.value);B.value.push(s)};re(B,async(s,c)=>{console.log("Watch comments triggered : ",s),oe.value&&(console.log("Comments : ",s),o("changeComments",s),q.value!==null&&clearTimeout(q.value),q.value=setTimeout(()=>ne(s),1e3)),console.log(`Old comments lenght : ${c.length} new length: ${s.length}`),console.log("OldComments : ",c),console.log("NewComments : ",s),c.length===0&&s.length>0&&(console.log("Finally loading comments"),_.value=await i())},{deep:!0}),re(de(a).extComments,async s=>{await X(s)});const E=m(!1),W=m(null),Q=m({position:"absolute","z-index":90,top:"0px",left:"0px",height:"106px",width:"260px"}),{user:Z}=K(),T=(s,c)=>{s.preventDefault(),Z.value&&(t.value=null,Q.value.top=`${s.layerY}px`,Q.value.left=`${s.layerX}px`,E.value=!0,W.value=c,console.log("event : ",s),console.log("Have a new right click"))},I=s=>{if(p.value=[],s===void 0||s==""){p.value=[{id:0,char:`
`}],u({id:0,char:`
`});return}for(var c=0;c<s.length;c++){const C=B.value.find(U=>U.start_index==c);p.value.push({id:c,char:s[c],comment:C})}},g=s=>s.reduce((c,C)=>c+C.char,""),oe=m(!1);return te(async()=>{await X(a.extComments),await I(a.fullText),await new Promise(s=>setTimeout(s,10)),_.value=await i(),oe.value=!0}),re(p,async s=>{console.log("Watch triggered : ",s),oe.value&&(o("change",g(s)),_.value=await i())},{deep:!0}),(s,c)=>(e(),n("div",it,[v(We,{text:s.fullText,class:"absolute z-10 h-6 right-2"},null,8,["text"]),oe.value?(e(),n("div",{key:1,id:"main-interface",class:"relative md:p-4",tabindex:"0",onKeydown:r,onKeyup:O,onClick:c[0]||(c[0]=C=>E.value=!1)},[E.value?(e(),n("div",{key:0,class:"bg-white border-4",style:Oe(Q.value)},[d("div",{onClick:Y,class:"text-sm border-b-2 flex items-center p-2",style:{height:"50px"}}," Ajouter un commentaire "),dt],4)):k("",!0),d("div",vt,[d("div",mt,[(e(!0),n(le,null,se(_.value,(C,U)=>(e(),n("div",{key:U,class:"flex"},[C.lineStyle=="*"?(e(),n("div",pt,ft)):k("",!0),d("div",ht,[(e(!0),n(le,null,se(C.words,(A,z)=>(e(),n("div",{key:z,class:"flex flex-wrap"},[(e(!0),n(le,null,se(A.text,(D,pe)=>{var H;return e(),n("div",{key:pe,class:he(["border-blue-400",{"border-r-2":D.id==((H=t.value)==null?void 0:H.id),"bg-yellow-400":D.comment}]),onClick:L=>u(D),onContextmenu:L=>T(L,D.id)},[D.char==" "?(e(),n("div",xt)):D.char==`
`?(e(),n("div",yt)):(D.char=="#"||D.char=="*")&&z==0?(e(),n("div",bt)):(e(),n("div",{key:3,class:he({"font-bold":C.lineStyle=="#"})},[d("div",null,$(D.char),1)],2))],42,gt)}),128))]))),128)),d("div",{class:"flex-1",onClick:A=>u(C.words.slice(-1)[0].text.slice(-1)[0])},null,8,wt)]),B.value.length>0&&!M(G)?(e(),n("div",kt,[(e(!0),n(le,null,se(C.comments,(A,z)=>(e(),R(ge,{key:z,class:"w-full",modelValue:A.content,"onUpdate:modelValue":D=>A.content=D,editing:A.editing,onValidate:D=>A.editing=!1,author:A.author,"created-at":A.created_at},null,8,["modelValue","onUpdate:modelValue","editing","onValidate","author","created-at"]))),128))])):k("",!0)]))),128))]),B.value.length>0&&!M(G)?(e(),n("div",Ct)):k("",!0)])],32)):(e(),n("div",ct,[d("span",null,$(s.fullText),1)]))]))}}),Rt=d("hr",{class:"border-top border-zinc-400 my-4"},null,-1),Vt=d("div",{class:"text-xs italic"},"Raison de la lecture",-1),It=S({__name:"SeeThoughtInput",props:{thoughtInput:{}},setup(h){const o=h,{getUserById:a,user:u}=K(),t=m(null),p=F(()=>u.value?o.thoughtInput.interaction_user_id===u.value.id:!1);return te(async()=>{o.thoughtInput.interaction_user_id&&(t.value=await a(o.thoughtInput.interaction_user_id))}),(_,i)=>(e(),n("div",null,[v(Fo,{id:_.thoughtInput.resource_id,"second-level":""},null,8,["id"]),Rt,Vt,v($t,{"full-text":_.thoughtInput.interaction_comment,editable:p.value},null,8,["full-text","editable"])]))}}),Tt={class:"w-full md:w-96"},Ut={key:0,class:"text-xs italic mb-2 bg-white"},At={class:"flex flex-wrap"},Dt={key:1,class:"text-2xs italic ml-2"},Ft={key:2,class:"ml-auto m-1 w-1/3"},St={key:0,class:"border shadow-lg rounded p-4 md:w-96 bg-white"},Bt={class:"flex"},Pt=["src"],Ot={class:"flex flex-wrap w-full",style:{"margin-top":"-8px"}},Et={class:"text-2xs"},Lt={class:"flex flex-wrap"},Nt={key:0,class:"text-2xs italic"},qt=S({__name:"ThoughtInputCard",props:{contextualResource:{},isDisabled:{type:Boolean,default:!1}},setup(h){const o=h,{getUserById:a}=K(),{getAuthorInteractionForResource:u}=be(),t=m(null),p=m(null),_=m(null);te(async()=>{o.contextualResource.user_id&&(_.value=await a(o.contextualResource.user_id)),o.contextualResource.resource&&(p.value=await u(o.contextualResource.resource.id)),p.value&&(t.value=await a(p.value.interaction_user_id))});const i=l=>l?l.toLocaleString("fr-FR",{hour:"numeric",weekday:"short",day:"numeric",month:"short",year:"2-digit"}):"",y=l=>l.length>200?l.slice(0,150)+"...":l;return(l,r)=>{const f=Te("router-link");return e(),n("div",Tt,[l.contextualResource.context_comment?(e(),n("div",Ut,[d("div",null,$(l.contextualResource.context_comment),1),d("div",At,[_.value?(e(),R(f,{key:0,to:"/users/"+_.value.id,class:"text-2xs underline"},{default:P(()=>[ie($(_.value.first_name)+" "+$(_.value.last_name),1)]),_:1},8,["to"])):k("",!0),l.contextualResource.date?(e(),n("div",Dt,$(i(l.contextualResource.date)),1)):k("",!0),l.contextualResource.progress?(e(),n("div",Ft,[v(Ue,{"progress-value":l.contextualResource.progress},null,8,["progress-value"])])):k("",!0)])])):k("",!0),l.contextualResource.resource?(e(),R(Le(l.isDisabled?"span":"vue-router"),{key:1,to:"/resources/"+l.contextualResource.resource.id+"?tab=ctnt"},{default:P(()=>[l.contextualResource.resource?(e(),n("div",St,[d("div",Bt,[l.contextualResource.resource?(e(),n("img",{key:0,class:"w-8 h-fit mr-4",src:l.contextualResource.resource.image_url},null,8,Pt)):k("",!0),d("div",null,[d("div",null,$(l.contextualResource.resource.title)+" "+$(l.contextualResource.resource.subtitle),1),d("div",Ot,[t.value?(e(),R(f,{key:0,to:"/users/"+t.value.id,class:"text-2xs underline"},{default:P(()=>[ie($(t.value.first_name)+" "+$(t.value.last_name),1)]),_:1},8,["to"])):k("",!0)]),d("div",Et,$(y(l.contextualResource.resource.comment)),1)])]),d("div",Lt,[l.contextualResource.date?(e(),n("div",Nt,$(i(l.contextualResource.resourcedate)),1)):k("",!0)])])):k("",!0)]),_:1},8,["to"])):k("",!0)])}}}),zt={class:"w-fit"},jt=S({__name:"ThoughtInputCardWithPopup",props:{thoughtInput:{},usageReason:{},isDisabled:{type:Boolean,default:!1}},setup(h){const o=m(!1);return(a,u)=>(e(),n("div",zt,[v(ve,{open:o.value,onClose:u[0]||(u[0]=t=>o.value=!1)},{default:P(()=>[v(It,{"thought-input":a.thoughtInput,"usage-reason":a.usageReason},null,8,["thought-input","usage-reason"])]),_:1},8,["open"]),v(qt,{class:"md:w-96","contextual-resource":a.thoughtInput,"is-disabled":a.isDisabled},null,8,["contextual-resource","is-disabled"])]))}}),Mt={class:"relative max-w-full"},Wt={key:0,class:"absolute md:border h-full start-1/2 -z-10"},ue=S({__name:"ThoughtInputsList",props:{contextualResources:{},center:{type:Boolean,default:!1},linksDisabled:{type:Boolean,default:!1}},emits:["select"],setup(h,{emit:o}){const a=t=>t.sort((p,_)=>+(_.date>p.date)),u=t=>{console.log("Select"),o("select",t)};return(t,p)=>(e(),n("div",Mt,[t.center?k("",!0):(e(),n("div",Wt)),(e(!0),n(le,null,se(a(t.contextualResources),(_,i)=>(e(),R(jt,{key:_.id,class:he(["mb-4 md:mb-1 mx-auto max-w-full max-w-fit p-1",{"md:ml-0":i%2==0&&!t.center,"md:mr-0":!t.center}]),"thought-input":_,onClick:y=>u(_),"is-disabled":t.linksDisabled},null,8,["class","thought-input","onClick","is-disabled"]))),128))]))}}),Ht={key:0,class:"mb-4"},Jt={key:1},Kt={key:1},Gt={key:2},Xt={class:"flex flex-row-reverse"},Ve=S({__name:"CreateResourceRelationForm",props:{targetResource:{},originResource:{}},emits:["close","refresh"],setup(h,{emit:o}){const a=h,{user:u}=K(),t=m(),p=T=>{console.log("Event : ",T),t.value=T},_=m([{text:"Externes",value:"extr"},{text:"Internes",value:"artl"},{text:"Problème",value:"pblm"}]),i=m([{text:"Biblio",value:"bibl"},{text:"Résumé",value:"sumr"},{text:"Sujet principal",value:"main"},{text:"Evocation",value:"mino"}]),y=m([]),l=m(null),r=m([]),f=m([]),w=m([]),O=m(""),N=m(""),{createResourceRelation:ne}=Ae(),{getResources:G}=be(),{getArticles:B}=Be(),{getProblems:q}=Je(),X=F(()=>y.value.map(T=>({resource:T.resource}))),Y=T=>T.map(I=>({resource:I})),E=F(()=>({extr:Y(r.value),artl:Y(f.value),pblm:Y(w.value)})),W=async()=>{if(console.log("create"),!l.value)return;const T={target_resource_id:a.targetResource?a.targetResource.id:l.value.id,origin_resource_id:a.originResource?a.originResource.id:l.value.id,relation_comment:O.value,relation_type:N.value};await ne(T),o("refresh"),o("close")},{getUserThoughtInputs:Q}=je(),Z=T=>{l.value=T.resource};return te(async()=>{!u.value||!u.value.id||(a.targetResource&&(y.value=await Q(u.value.id)),a.originResource&&(r.value=await G(),f.value=await B({author:!0}),w.value=await q()))}),(T,I)=>(e(),n("div",null,[M(u)?(e(),n("div",Ht," Nouvelle relation entre ressources par "+$(M(u).first_name)+" "+$(M(u).last_name),1)):k("",!0),l.value?(e(),n("div",Gt,[v(ae,{class:"m-4",label:"Type de lien",choices:i.value,modelValue:N.value,"onUpdate:modelValue":I[2]||(I[2]=g=>N.value=g)},null,8,["choices","modelValue"]),v(me,{class:"m-4",label:"Pourquoi ajouter cet élément ?",modelValue:O.value,"onUpdate:modelValue":I[3]||(I[3]=g=>O.value=g)},null,8,["modelValue"]),d("div",Xt,[v(J,{type:"valid",onClick:W,text:"Ajouter"}),v(J,{type:"abort",onClick:I[4]||(I[4]=g=>o("close")),text:"Annuler",class:"mr-1"})])])):(e(),n("div",Jt,[T.targetResource?(e(),R(ue,{key:0,"contextual-resources":X.value,center:"","links-disabled":"",onSelect:I[0]||(I[0]=g=>Z(g))},null,8,["contextual-resources"])):(e(),n("div",Kt,[d("div",null,[ie(" Choisir une ressource cible "),v(Ie,{center:"",choices:_.value,default:"pblm",onUpdate:p},null,8,["choices"]),v(ue,{"contextual-resources":E.value[t.value]||[],center:"",onSelect:I[1]||(I[1]=g=>Z(g)),"links-disabled":""},null,8,["contextual-resources"])])]))]))]))}}),Yt=S({__name:"CommentsThread",props:{resourceId:{}},setup(h){const o=h,{user:a}=K(),u=m([]),{createComment:t,getCommentsForThoughtOutput:p}=Ce(),_=async()=>{console.log("Comment thread"),console.log("Props id : ",o.resourceId),u.value=await p(o.resourceId)},i=F(()=>u.value.filter(r=>!r.start_index).sort((r,f)=>r.created_at-f.created_at)),y=m(""),l=async()=>{await t(o.resourceId,null,y.value,!1),y.value="",await _()};return te(async()=>await _()),(r,f)=>(e(),n("div",null,[(e(!0),n(le,null,se(i.value,w=>(e(),R(ge,{key:w.id,class:"w-full",modelValue:w.content,"onUpdate:modelValue":O=>w.content=O,editing:w.editing,onValidate:O=>w.editing=!1,author:w.author,"created-at":w.created_at},null,8,["modelValue","onUpdate:modelValue","editing","onValidate","author","created-at"]))),128)),v(ge,{class:"w-full",modelValue:y.value,"onUpdate:modelValue":f[0]||(f[0]=w=>y.value=w),editing:!0,onValidate:l,author:M(a),"created-at":null},null,8,["modelValue","author"])]))}}),Qt={class:"flex flex-wrap"},Zt={class:"flex flex-row-reverse"},eo=S({__name:"CreateInteraction",props:{resource:{}},emits:["close","refresh"],setup(h,{emit:o}){const a=h,u=m([{text:"Lecture / Visionage",value:"inpt"},{text:"Envie",value:"wish"}]),{newInteraction:t,createInteractionForResource:p}=ye(),{user:_}=K(),i=m(t());te(()=>{i.value.interaction_type||(i.value.interaction_type="inpt")});const y=()=>{i.value.resource_id=a.resource.id,i.value.interaction_user_id=_.value.id,p(a.resource.id,i.value),o("refresh"),l()},l=()=>o("close");return(r,f)=>(e(),n("div",null,[d("div",null,"Nouvelle interaction, avec la ressource : "+$(r.resource.title),1),d("div",Qt,[v(ee,{label:"Avancement de l'ouvrage",class:"my-auto",modelValue:i.value.interaction_progress,"onUpdate:modelValue":f[0]||(f[0]=w=>i.value.interaction_progress=w),type:"number"},null,8,["modelValue"]),v(ae,{label:"Type d'interaction",class:"m-4 w-full md:w-5/12 md:ml-auto",choices:u.value,modelValue:i.value.interaction_type,"onUpdate:modelValue":f[1]||(f[1]=w=>i.value.interaction_type=w)},null,8,["choices","modelValue"])]),v(ee,{label:"Date de lecture",modelValue:i.value.interaction_date,"onUpdate:modelValue":f[2]||(f[2]=w=>i.value.interaction_date=w),type:"date"},null,8,["modelValue"]),v(me,{label:"Pourquoi s'y être interessé ?",modelValue:i.value.interaction_comment,"onUpdate:modelValue":f[3]||(f[3]=w=>i.value.interaction_comment=w)},null,8,["modelValue"]),d("div",Zt,[v(J,{onClick:y,class:"m-4",text:"Valider",type:"valid"}),v(J,{onClick:l,class:"m-4",text:"Annuler",type:"abort"})])]))}}),to=S({__name:"DateField",props:{date:{}},setup(h){const o=h,a=F(()=>new Date(o.date).toLocaleDateString("fr-FR",{day:"numeric",month:"short",year:"numeric"}));return(u,t)=>(e(),n("div",null,$(a.value),1))}}),oo={class:"flex flex-col"},lo={class:"block text-2xs text-slate-800"},so=["value","placeholder"],ao=S({__name:"NumberInput",props:{label:{},modelValue:{},placeholder:{}},emits:["update:modelValue","input"],setup(h,{emit:o}){const a=u=>{o("update:modelValue",u.target.value),o("input",u.target.value)};return(u,t)=>(e(),n("div",oo,[d("label",lo,$(u.label),1),d("input",{class:"border border-neutral-400 block h-full w-full rounded-md border-2 p-1 pl-2 text-xs",type:"number",value:u.modelValue,placeholder:u.placeholder,onInput:t[0]||(t[0]=p=>a(p))},null,40,so)]))}}),no={class:"grid grid-cols-4 gap-y-2 gap-x-4 auto-rows-auto"},ro=S({__name:"ArticleForm",props:{article:{}},emits:["change"],setup(h,{emit:o}){const a=h,u=m([{text:"Terminé",value:"fnsh"},{text:"Relecture",value:"rvew"},{text:"Idée",value:"idea"}]),t=m([{text:"Livre",value:"book"},{text:"Fiche de lecture",value:"shet"},{text:"Article de média",value:"natc"},{text:"Article de recherche",value:"ratc"},{text:"Film",value:"movi"},{text:"Podcast",value:"pcst"}]),{categories:p}=Ne(),_=F(()=>p.value.map(y=>({text:y.display_name,value:y.id}))),i=(y,l)=>{let r={...a.article};r[y]=l,r.is_external&&(r.maturing_state="fnsh"),console.log("Article : ",r),o("change",r)};return(y,l)=>(e(),n("div",no,[v(ee,{class:"col-span-4",label:"Titre",modelValue:y.article.title,"onUpdate:modelValue":l[0]||(l[0]=r=>i("title",r))},null,8,["modelValue"]),v(ee,{class:"col-span-4",label:"Sous-titre",modelValue:y.article.subtitle,"onUpdate:modelValue":l[1]||(l[1]=r=>i("subtitle",r))},null,8,["modelValue"]),v(ee,{class:"col-span-4 md:col-span-2",label:"Lien contenu externe",modelValue:y.article.external_content_url,"onUpdate:modelValue":l[2]||(l[2]=r=>i("external_content_url",r))},null,8,["modelValue"]),v(ee,{class:"col-span-4 md:col-span-2",label:"Lien image",modelValue:y.article.image_url,"onUpdate:modelValue":l[3]||(l[3]=r=>i("image_url",r))},null,8,["modelValue"]),v(ae,{label:"Catégorie",class:"col-span-4 md:col-span-1",choices:_.value,"model-value":y.article.category_id,"onUpdate:modelValue":l[4]||(l[4]=r=>i("category_id",r))},null,8,["choices","model-value"]),v(ae,{label:"Type de ressource",class:"col-span-4 md:col-span-1",choices:t.value,"onUpdate:modelValue":l[5]||(l[5]=r=>i("resource_type",r)),"model-value":y.article.resource_type},null,8,["choices","model-value"]),v(ae,{label:"Ressource externe",class:"col-span-4 md:col-span-1",choices:[{text:"Oui",value:!0},{text:"Non",value:!1}],"onUpdate:modelValue":l[6]||(l[6]=r=>i("is_external",JSON.parse(r))),"model-value":y.article.is_external},null,8,["model-value"]),v(ae,{label:"Stade d'écriture",class:"col-span-4 md:col-span-1",choices:u.value,"model-value":y.article.maturing_state,"onUpdate:modelValue":l[7]||(l[7]=r=>i("maturing_state",r))},null,8,["choices","model-value"])]))}}),uo={class:"grid grid-cols-3 gap-4"},io=S({__name:"ResourceAuthorPicker",props:{interaction:{},resourceId:{}},emits:["update"],setup(h,{emit:o}){const a=h,u=F(()=>{var r;return(r=a.interaction)==null?void 0:r.interaction_user_id}),{createInteractionForResource:t,newInteraction:p,createInteraction:_,updateInteraction:i}=ye(),y=async r=>{if(console.log(`newUser : ${JSON.stringify(r)}`),a.interaction){const f={...a.interaction};f.interaction_user_id=r,console.log("newUserid : ",r.id),console.log(`Interaction payload : ${JSON.stringify(f)}`),await i(a.interaction.id,f),o("update")}else{console.log("create interaction");const f=p();f.interaction_user_id=r,f.resource_id=a.resourceId,await t(a.resourceId,f),o("update")}},l=async r=>{await i(a.interaction.id,r),o("update")};return(r,f)=>(e(),n("div",uo,[v(He,{"model-value":u.value,"onUpdate:modelValue":f[0]||(f[0]=w=>y(w))},null,8,["model-value"]),r.interaction?(e(),R(ee,{key:0,class:"text-2xs",label:"Date d'écriture","model-value":r.interaction.interaction_date?r.interaction.interaction_date.split("T")[0]:null,"onUpdate:modelValue":f[1]||(f[1]=w=>l({...r.interaction,interaction_date:w})),type:"date"},null,8,["model-value"])):k("",!0),r.interaction?(e(),R(ao,{key:1,class:"",label:"Progression",modelValue:r.interaction.interaction_progress,"onUpdate:modelValue":f[2]||(f[2]=w=>l({...r.interaction,interaction_progress:w}))},null,8,["modelValue"])):k("",!0)]))}}),co={key:0,class:"text-center text-2xl pt-10"},vo={key:1},mo={key:0},po={class:"my-8"},_o=["src"],fo={class:"text-3xl my-3 font-mplus md:text-center text-left"},ho={class:"md:text-center text-left"},go={class:"md:text-center text-left"},xo={class:"md:flex my-8"},yo=["href"],bo={key:1,class:"my-2 flex flex-col"},wo={class:"flex flex-row-reverse mb-4"},ko={key:1,class:"p-2 border rounded bg-neutral-100"},Co=d("hr",{class:"border-top border-zinc-400 my-4"},null,-1),$o={key:2},Ro=d("div",{class:"text-xs italic"},"Commentaire",-1),Vo=d("hr",{class:"border-top border-zinc-400 my-4"},null,-1),Io=d("div",{class:"text-xs italic"},"Contenu",-1),To={key:3},Uo={key:4},Ao={key:5},Do={class:"fixed right-3 bottom-5"},Fo=S({__name:"ResourceComponent",props:{resourceId:{},secondLevel:{type:Boolean}},setup(h){const o=h,a=qe(),u=F(()=>o.secondLevel?"popup_tab":"tab"),t=F(()=>[{text:"Contenu",value:"ctnt"},{text:"Biblio",value:"bbli",count:l.value.length},{text:"Sujets",value:"pblm",count:q.value.length},{text:"Interactions",value:"inpt",count:N.value.length}]),p=m(a.query[u.value]&&typeof a.query[u.value]=="string"?a.query[u.value]:"ctnt"),_=m(a.query[u.value]);re(()=>a.query[u.value],x=>{console.log("new route query",x),typeof x=="string"&&(_.value=x)});const{getResourceRelationsForResource:i,getUsagesForResource:y}=Ae(),l=m([]),r=m(!1),f=m(!1),w=async()=>{l.value=await i(de(o).resourceId.value)},O=F(()=>l.value.map(x=>({resource:x.origin_resource,date:x.created_at,user_id:x.user_id,context_comment:x.relation_comment,progress:null}))),N=m([]),{getInteractionsForResource:ne}=ye(),G=async()=>{N.value=await ne(o.resourceId)},B=F(()=>N.value.map(x=>({resource:null,date:x.interaction_date,user_id:x.interaction_user_id,context_comment:x.interaction_comment,progress:x.interaction_progress}))),q=m([]),X=async()=>{q.value=await y(o.resourceId)},Y=F(()=>q.value.map(x=>({resource:x.target_resource,date:x.created_at,user_id:x.user_id,context_comment:x.relation_comment,progress:null}))),E=m(!1),{newResource:W,getResource:Q,updateResource:Z,getAuthorInteractionForResource:T}=be(),I=m(null),g=m(W()),oe=ze();re(()=>a.query.editing,x=>{console.log("Editing : ",x),s.value=x==="false"?!1:!!x});const s=m(!1),c=x=>{oe.push({query:{editing:x.toString()}})},C=()=>{!g.value||!g.value.id||(g.value.publishing_state="pbsh",Z(g.value.id,g.value))},U=(x,b)=>{g.value=b,I.value!==null&&clearTimeout(I.value),I.value=setTimeout(async()=>{try{await Z(x,g.value)}catch(_e){console.log("An error : ",_e)}},1e3)},A=x=>{x!=`
`&&U(de(o).resourceId.value,{...g.value,content:x})},z=x=>{x!=`
`&&U(de(o).resourceId.value,{...g.value,comment:x})},{user:D,getUserById:pe}=K(),H=F(()=>g.value.is_external?!0:D.value?L.value?L.value.id==D.value.id:!0:!1),L=m(null),j=m(null),ce=m(!1),Fe=async()=>{j.value=await T(o.resourceId)},{getCommentsForThoughtOutput:Se}=Ce(),$e=m([]);return te(async()=>{E.value=!1,g.value=await Q(o.resourceId),E.value=!0,await w(),await G(),await X(),$e.value=await Se(o.resourceId),j.value=await T(o.resourceId),j.value&&(L.value=await pe(j.value.interaction_user_id));const x=a.query.editing;s.value=x==="false"?!1:!!x}),(x,b)=>{const _e=Te("router-link");return e(),n("div",null,[E.value?(e(),n("div",vo,[s.value?(e(),n("div",bo,[v(ro,{article:g.value,class:"",onChange:b[0]||(b[0]=V=>U(g.value.id,V))},null,8,["article"]),v(io,{class:"my-2",interaction:j.value,"resource-id":x.resourceId,onChange:Fe},null,8,["interaction","resource-id"]),d("div",wo,[v(J,{class:"ml-4",onClick:b[1]||(b[1]=V=>c(!1)),type:"valid",text:"Preview"},{default:P(()=>[ie("Ok")]),_:1}),g.value.publishing_state=="drft"?(e(),R(J,{key:0,onClick:C,type:"valid",text:"Publier"})):(e(),n("div",ko,"Publié"))])])):(e(),n("div",mo,[d("div",po,[d("img",{src:g.value.image_url,class:"border border-slate-300 dark:border-zinc-700 rounded-xl ml-auto mr-auto",style:{"max-height":"20rem"}},null,8,_o)]),d("h1",fo,$(g.value.title),1),d("div",ho,$(g.value.subtitle),1),d("div",go,[L.value?(e(),R(_e,{key:0,to:"/users/"+L.value.id,class:"text-sm underline"},{default:P(()=>[ie($(L.value.first_name)+" "+$(L.value.last_name),1)]),_:1},8,["to"])):k("",!0),j.value?(e(),R(to,{key:1,date:j.value.interaction_date},null,8,["date"])):k("",!0)]),d("div",xo,[j.value?(e(),R(Ue,{key:0,"progress-value":j.value.interaction_progress,class:"m-2 w-1/3"},null,8,["progress-value"])):k("",!0),g.value.external_content_url?(e(),n("a",{key:1,class:"ml-auto underline",href:g.value.external_content_url,target:"_blank"}," Lien ressource externe ",8,yo)):k("",!0)])])),d("div",null,[s.value?k("",!0):(e(),R(Ie,{key:0,choices:t.value,default:p.value,"url-key":u.value,url:""},null,8,["choices","default","url-key"]))]),Co,_.value=="ctnt"?(e(),n("div",$o,[Ro,g.value.publishing_state!="drft"?(e(),R(Re,{key:0,text:g.value.comment,editable:H.value,onChange:b[2]||(b[2]=V=>z(V))},null,8,["text","editable"])):(e(),R(me,{key:1,class:"h-20",label:"Commentaire",modelValue:g.value.comment,"onUpdate:modelValue":b[3]||(b[3]=V=>z(V))},null,8,["modelValue"])),Vo,Io,E.value&&!g.value.is_local_draft&&g.value.publishing_state!="drft"?(e(),R(Re,{key:2,class:"min-h-fit","ext-comments":$e.value,"resource-id":g.value.id,text:g.value.content,editable:H.value,onChange:b[4]||(b[4]=V=>A(V))},null,8,["ext-comments","resource-id","text","editable"])):(e(),R(me,{key:3,class:"h-96",label:"Contenu",modelValue:g.value.content,"onUpdate:modelValue":b[5]||(b[5]=V=>A(V))},null,8,["modelValue"])),v(Yt,{"resource-id":x.resourceId},null,8,["resource-id"])])):_.value=="bbli"?(e(),n("div",To,[v(ve,{open:r.value,onClose:b[7]||(b[7]=V=>r.value=!1)},{default:P(()=>[v(Ve,{onRefresh:w,onClose:b[6]||(b[6]=V=>r.value=!1),"target-resource":g.value},null,8,["target-resource"])]),_:1},8,["open"]),d("div",{onClick:b[8]||(b[8]=V=>r.value=!0),class:"text-sm italic underline"}," Ajouter une référence "),v(ue,{"contextual-resources":O.value},null,8,["contextual-resources"])])):_.value=="pblm"?(e(),n("div",Uo,[v(ue,{"contextual-resources":Y.value},null,8,["contextual-resources"])])):_.value=="inpt"?(e(),n("div",Ao,[v(ue,{"contextual-resources":B.value},null,8,["contextual-resources"])])):k("",!0),d("div",Do,[H.value?(e(),R(fe,{key:0,title:"Modifier",onClick:b[9]||(b[9]=V=>c(!0))},{default:P(()=>[v(M(Me),{class:"m-1"})]),_:1})):k("",!0),H.value?(e(),R(fe,{key:1,class:"mt-2",color:"red",title:"Marquer comme lu",onClick:b[10]||(b[10]=V=>ce.value=!0)},{default:P(()=>[v(M(Ke),{class:"m-1"})]),_:1})):k("",!0),v(ve,{open:ce.value,onClose:b[12]||(b[12]=V=>ce.value=!1)},{default:P(()=>[v(eo,{onRefresh:G,onClose:b[11]||(b[11]=V=>ce.value=!1),resource:g.value},null,8,["resource"])]),_:1},8,["open"]),H.value?(e(),R(fe,{key:2,class:"mt-2",color:"green",title:"Relier à d'autres ressources",onClick:b[13]||(b[13]=V=>f.value=!0)},{default:P(()=>[v(M(Ge),{class:"m-1"})]),_:1})):k("",!0),v(ve,{open:f.value,onClose:b[15]||(b[15]=V=>f.value=!1)},{default:P(()=>[v(Ve,{onRefresh:X,onClose:b[14]||(b[14]=V=>f.value=!1),"origin-resource":g.value},null,8,["origin-resource"])]),_:1},8,["open"])])])):(e(),n("div",co,"Loading..."))])}}});export{Fo as _,It as a,ue as b};
