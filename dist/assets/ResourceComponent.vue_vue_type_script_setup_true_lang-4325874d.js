import{_ as we,u as Se,a as ie}from"./useArticle-342f7727.js";import{b as l,e as c,f as n,d as I,t as w,F as de,h as me,r as v,c as A,o as L,g as u,u as j,y as Be,k as te,z as N,s as Fe,A as Le,B as Pe,n as k,a as ke,i as R,w as T,m as X,C as Ee,D as Oe,E as oe,G as Me,p as M,H as je,I as qe,v as Ne,j as ze,l as He}from"./index-a881fb4e.js";import{_ as H}from"./ActionButton.vue_vue_type_script_setup_true_lang-46a6271b.js";import{_ as ce,a as ye,u as $e}from"./TextInterface.vue_vue_type_script_setup_true_lang-45487d5e.js";import{_ as O}from"./TextInput.vue_vue_type_script_setup_true_lang-a3ef8a20.js";import{u as ve}from"./useInteraction-19d0f2b6.js";import{_ as Ve}from"./ProgressBar.vue_vue_type_script_setup_true_lang-9a1b4fef.js";import{u as pe}from"./useResource-3a2a4e37.js";import{u as Re}from"./useResourceRelations-6e848931.js";import{u as Je}from"./useProblem-59e863ae.js";function Ke(r,e){return l(),c("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true"},[n("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M9 8.25H7.5a2.25 2.25 0 00-2.25 2.25v9a2.25 2.25 0 002.25 2.25h9a2.25 2.25 0 002.25-2.25v-9a2.25 2.25 0 00-2.25-2.25H15M9 12l3 3m0 0l3-3m-3 3V2.25"})])}function We(r,e){return l(),c("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true"},[n("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10"})])}function Ge(r,e){return l(),c("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true"},[n("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M7.217 10.907a2.25 2.25 0 100 2.186m0-2.186c.18.324.283.696.283 1.093s-.103.77-.283 1.093m0-2.186l9.566-5.314m-9.566 7.5l9.566 5.314m0 0a2.25 2.25 0 103.935 2.186 2.25 2.25 0 00-3.935-2.186zm0-12.814a2.25 2.25 0 103.933-2.185 2.25 2.25 0 00-3.933 2.185z"})])}const Qe={class:"block text-2xs text-slate-800"},Xe=["value"],Ye=["value"],z=I({__name:"SelectInput",props:{label:{},choices:{},modelValue:{},displayFunction:{type:Function,default:r=>r.text}},emits:["update:modelValue"],setup(r,{emit:e}){const s=t=>{console.log(t.target.value),e("update:modelValue",t.target.value)};return(t,a)=>(l(),c("div",null,[n("label",Qe,w(t.label),1),n("select",{value:t.modelValue,name:"Stade d'écriture",class:"text-xs w-full p-1 block rounded border-2 border-neutral-400",onInput:a[0]||(a[0]=i=>s(i))},[(l(!0),c(de,null,me(t.choices,i=>(l(),c("option",{key:i.value,value:i.value},w(t.displayFunction(i)),9,Ye))),128))],40,Xe)]))}}),Ze={class:"m-4"},et={class:"block text-2xs text-slate-800"},tt=["value","placeholder"],Y=I({__name:"TextAreaInput",props:{label:{},modelValue:{},placeholder:{}},emits:["update:modelValue"],setup(r,{emit:e}){const s=t=>{e("update:modelValue",t.target.value)};return(t,a)=>(l(),c("div",Ze,[n("label",et,w(t.label),1),n("textarea",{class:"border border-neutral-800 block h-full w-full",value:t.modelValue,placeholder:t.placeholder,onInput:a[0]||(a[0]=i=>s(i))},null,40,tt)]))}}),ot=n("hr",{class:"border-top border-zinc-400 my-4"},null,-1),lt=n("div",{class:"text-xs italic"},"Raison de la lecture",-1),st=I({__name:"SeeThoughtInput",props:{thoughtInput:{}},setup(r){const e=r,{getUserById:s,user:t}=j(),a=v(null),i=A(()=>t.value?e.thoughtInput.interaction_user_id===t.value.id:!1);return L(async()=>{e.thoughtInput.interaction_user_id&&(a.value=await s(e.thoughtInput.interaction_user_id))}),(f,d)=>(l(),c("div",null,[u(wo,{id:f.thoughtInput.resource_id,"second-level":""},null,8,["id"]),ot,lt,u(ce,{"full-text":f.thoughtInput.interaction_comment,editable:i.value},null,8,["full-text","editable"])]))}}),at={class:"flex"},ee=I({__name:"ModalSheet",props:{open:{type:Boolean,default:!1}},emits:["close"],setup(r,{emit:e}){const s=r,t=v(!1);return L(()=>{t.value=s.open}),Be(()=>{const a=i=>{(i.key==="Escape"||i.key==="Enter"||i.key==="Esc"||i.keyCode===27)&&e("close")};return window.addEventListener("keydown",a),()=>{window.removeEventListener("keydown",a)}}),te(N(s).open,a=>t.value=a),(a,i)=>t.value?(l(),c("div",{key:0,tabindex:"0",onKeyup:i[2]||(i[2]=Pe(f=>e("close"),["esc"])),class:"fixed top-0 left-0 w-full h-full z-10 bg-slate-500/50",onClick:i[3]||(i[3]=f=>e("close"))},[n("div",{class:"max-w-xl overflow-y-scroll max-h-screen mb-10 bg-white mx-auto mt-6 p-4 rounded shadow",onClick:i[1]||(i[1]=Le(()=>{},["stop"]))},[n("div",at,[n("div",{class:"ml-auto",onClick:i[0]||(i[0]=f=>e("close"))},"x")]),Fe(a.$slots,"default")])],32)):k("",!0)}}),nt={class:"w-full md:w-96"},rt={key:0,class:"text-xs italic mb-2 bg-white"},ut={class:"flex flex-wrap"},it={key:1,class:"text-2xs italic ml-2"},ct={key:2,class:"ml-auto m-1 w-1/3"},dt={key:0,class:"border shadow-lg rounded p-4 md:w-96 bg-white"},mt={class:"flex"},vt=["src"],pt={class:"flex flex-wrap w-full",style:{"margin-top":"-8px"}},_t={class:"text-2xs"},ft={class:"flex flex-wrap"},gt={key:0,class:"text-2xs italic"},ht=I({__name:"ThoughtInputCard",props:{contextualResource:{},isDisabled:{type:Boolean,default:!1}},setup(r){const e=r,{getUserById:s}=j(),{getAuthorInteractionForResource:t}=pe(),a=v(null),i=v(null),f=v(null);L(async()=>{e.contextualResource.user_id&&(f.value=await s(e.contextualResource.user_id)),e.contextualResource.resource&&(i.value=await t(e.contextualResource.resource.id)),i.value&&(a.value=await s(i.value.interaction_user_id))});const d=o=>o?o.toLocaleString("fr-FR",{hour:"numeric",weekday:"short",day:"numeric",month:"short",year:"2-digit"}):"",g=o=>o.length>200?o.slice(0,150)+"...":o;return(o,m)=>{const y=ke("router-link");return l(),c("div",nt,[o.contextualResource.context_comment?(l(),c("div",rt,[n("div",null,w(o.contextualResource.context_comment),1),n("div",ut,[f.value?(l(),R(y,{key:0,to:"/users/"+f.value.id,class:"text-2xs underline"},{default:T(()=>[X(w(f.value.first_name)+" "+w(f.value.last_name),1)]),_:1},8,["to"])):k("",!0),o.contextualResource.date?(l(),c("div",it,w(d(o.contextualResource.date)),1)):k("",!0),o.contextualResource.progress?(l(),c("div",ct,[u(Ve,{"progress-value":o.contextualResource.progress},null,8,["progress-value"])])):k("",!0)])])):k("",!0),o.contextualResource.resource?(l(),R(Ee(o.isDisabled?"span":"vue-router"),{key:1,to:"/resources/"+o.contextualResource.resource.id+"?tab=ctnt"},{default:T(()=>[o.contextualResource.resource?(l(),c("div",dt,[n("div",mt,[o.contextualResource.resource?(l(),c("img",{key:0,class:"w-8 h-fit mr-4",src:o.contextualResource.resource.image_url},null,8,vt)):k("",!0),n("div",null,[n("div",null,w(o.contextualResource.resource.title)+" "+w(o.contextualResource.resource.subtitle),1),n("div",pt,[a.value?(l(),R(y,{key:0,to:"/users/"+a.value.id,class:"text-2xs underline"},{default:T(()=>[X(w(a.value.first_name)+" "+w(a.value.last_name),1)]),_:1},8,["to"])):k("",!0)]),n("div",_t,w(g(o.contextualResource.resource.comment)),1)])]),n("div",ft,[o.contextualResource.date?(l(),c("div",gt,w(d(o.contextualResource.resourcedate)),1)):k("",!0)])])):k("",!0)]),_:1},8,["to"])):k("",!0)])}}}),bt={class:"w-fit"},yt=I({__name:"ThoughtInputCardWithPopup",props:{thoughtInput:{},usageReason:{},isDisabled:{type:Boolean,default:!1}},setup(r){const e=v(!1);return(s,t)=>(l(),c("div",bt,[u(ee,{open:e.value,onClose:t[0]||(t[0]=a=>e.value=!1)},{default:T(()=>[u(st,{"thought-input":s.thoughtInput,"usage-reason":s.usageReason},null,8,["thought-input","usage-reason"])]),_:1},8,["open"]),u(ht,{class:"md:w-96","contextual-resource":s.thoughtInput,"is-disabled":s.isDisabled},null,8,["contextual-resource","is-disabled"])]))}}),xt={class:"relative max-w-full"},wt={key:0,class:"absolute md:border h-full start-1/2 -z-10"},Q=I({__name:"ThoughtInputsList",props:{contextualResources:{},center:{type:Boolean,default:!1},linksDisabled:{type:Boolean,default:!1}},emits:["select"],setup(r,{emit:e}){const s=a=>a.sort((i,f)=>+(f.date>i.date)),t=a=>{console.log("Select"),e("select",a)};return(a,i)=>(l(),c("div",xt,[a.center?k("",!0):(l(),c("div",wt)),(l(!0),c(de,null,me(s(a.contextualResources),(f,d)=>(l(),R(yt,{key:f.id,class:Oe(["mb-4 md:mb-1 mx-auto max-w-full max-w-fit p-1",{"md:ml-0":d%2==0&&!a.center,"md:mr-0":!a.center}]),"thought-input":f,onClick:g=>t(f),"is-disabled":a.linksDisabled},null,8,["class","thought-input","onClick","is-disabled"]))),128))]))}}),{launchSnackbar:kt}=Me();function $t(){const r={title:"",subtitle:"",content:"",external_content_url:"",publishing_state:"pbsh",maturing_state:"fnsh",image_url:"",resource_type:"",comment:""};return{interaction_progress:0,interaction_date:new Date(Date.now()),interaction_comment:"",interaction_is_public:!0,resource:r}}function le(r){return console.log("Date : ",r.interaction_date),r.interaction_date=new Date(r.interaction_date),r}async function Vt(){return(await oe.get("/thought_inputs?limit=60")).data.map(e=>le(e))}async function Rt(r){const e=await oe.get("/thought_inputs/"+r);return le(e.data)}async function Ct(r){return(await oe.get("/users/"+r+"/thought_inputs?limit=60")).data.map(s=>le(s))}async function It(r){const e=new Date(r.interaction_date);console.log("Date : ",e);const s=e.toISOString().split(".")[0];r.interaction_progress=Number(r.interaction_progress);const t=await oe.post("/thought_inputs",{...r,interaction_date:s});return kt("Creation de l'input réussie","success"),le(t.data)}function Ut(){return{getUserThoughtInputs:Ct,newThoughtInput:$t,createThoughtInput:It,getThoughtInputs:Vt,getThoughtInput:Rt}}const At={key:0,class:"mb-4"},Tt={key:1},Dt={key:1},St={key:2},Bt={class:"flex flex-row-reverse"},xe=I({__name:"CreateResourceRelationForm",props:{targetResource:{},originResource:{}},emits:["close","refresh"],setup(r,{emit:e}){const s=r,{user:t}=j(),a=v(),i=U=>{console.log("Event : ",U),a.value=U},f=v([{text:"Externes",value:"extr"},{text:"Internes",value:"artl"},{text:"Problème",value:"pblm"}]),d=v([{text:"Biblio",value:"bibl"},{text:"Résumé",value:"sumr"},{text:"Sujet principal",value:"main"},{text:"Evocation",value:"mino"}]),g=v([]),o=v(null),m=v([]),y=v([]),x=v([]),B=v(""),D=v(""),{createResourceRelation:J}=Re(),{getResources:P}=pe(),{getArticles:b}=Se(),{getProblems:$}=Je(),S=A(()=>g.value.map(U=>({resource:U.resource}))),K=U=>U.map(C=>({resource:C})),q=A(()=>({extr:K(m.value),artl:K(y.value),pblm:K(x.value)})),se=async()=>{if(console.log("create"),!o.value)return;const U={target_resource_id:s.targetResource?s.targetResource.id:o.value.id,origin_resource_id:s.originResource?s.originResource.id:o.value.id,relation_comment:B.value,relation_type:D.value};await J(U),e("refresh"),e("close")},{getUserThoughtInputs:ae}=Ut(),W=U=>{o.value=U.resource};return L(async()=>{!t.value||!t.value.id||(s.targetResource&&(g.value=await ae(t.value.id)),s.originResource&&(m.value=await P(),y.value=await b({author:!0}),x.value=await $()))}),(U,C)=>(l(),c("div",null,[M(t)?(l(),c("div",At," Nouvelle relation entre ressources par "+w(M(t).first_name)+" "+w(M(t).last_name),1)):k("",!0),o.value?(l(),c("div",St,[u(z,{class:"m-4",label:"Type de lien",choices:d.value,modelValue:D.value,"onUpdate:modelValue":C[2]||(C[2]=p=>D.value=p)},null,8,["choices","modelValue"]),u(Y,{class:"m-4",label:"Pourquoi ajouter cet élément ?",modelValue:B.value,"onUpdate:modelValue":C[3]||(C[3]=p=>B.value=p)},null,8,["modelValue"]),n("div",Bt,[u(H,{type:"valid",onClick:se,text:"Ajouter"}),u(H,{type:"abort",onClick:C[4]||(C[4]=p=>e("close")),text:"Annuler",class:"mr-1"})])])):(l(),c("div",Tt,[U.targetResource?(l(),R(Q,{key:0,"contextual-resources":S.value,center:"","links-disabled":"",onSelect:C[0]||(C[0]=p=>W(p))},null,8,["contextual-resources"])):(l(),c("div",Dt,[n("div",null,[X(" Choisir une ressource cible "),u(we,{center:"",choices:f.value,default:"pblm",onUpdate:i},null,8,["choices"]),u(Q,{"contextual-resources":q.value[a.value]||[],center:"",onSelect:C[1]||(C[1]=p=>W(p)),"links-disabled":""},null,8,["contextual-resources"])])]))]))]))}}),Ft=I({__name:"CommentsThread",props:{resourceId:{}},setup(r){const e=r,{user:s}=j(),t=v([]),{createComment:a,getCommentsForThoughtOutput:i}=$e(),f=async()=>{console.log("Comment thread"),console.log("Props id : ",e.resourceId),t.value=await i(e.resourceId)},d=A(()=>t.value.filter(m=>!m.start_index).sort((m,y)=>m.created_at-y.created_at)),g=v(""),o=async()=>{await a(e.resourceId,null,g.value,!1),g.value="",await f()};return L(async()=>await f()),(m,y)=>(l(),c("div",null,[(l(!0),c(de,null,me(d.value,x=>(l(),R(ye,{key:x.id,class:"w-full",modelValue:x.content,"onUpdate:modelValue":B=>x.content=B,editing:x.editing,onValidate:B=>x.editing=!1,author:x.author,"created-at":x.created_at},null,8,["modelValue","onUpdate:modelValue","editing","onValidate","author","created-at"]))),128)),u(ye,{class:"w-full",modelValue:g.value,"onUpdate:modelValue":y[0]||(y[0]=x=>g.value=x),editing:!0,onValidate:o,author:M(s),"created-at":null},null,8,["modelValue","author"])]))}}),Lt={class:"flex flex-wrap"},Pt={class:"flex flex-row-reverse"},Et=I({__name:"CreateInteraction",props:{resource:{}},emits:["close","refresh"],setup(r,{emit:e}){const s=r,t=v([{text:"Lecture / Visionage",value:"inpt"},{text:"Envie",value:"wish"}]),{newInteraction:a,createInteractionForResource:i}=ve(),{user:f}=j(),d=v(a());L(()=>{d.value.interaction_type||(d.value.interaction_type="inpt")});const g=()=>{d.value.resource_id=s.resource.id,d.value.interaction_user_id=f.value.id,i(s.resource.id,d.value),e("refresh"),o()},o=()=>e("close");return(m,y)=>(l(),c("div",null,[n("div",null,"Nouvelle interaction, avec la ressource : "+w(m.resource.title),1),n("div",Lt,[u(O,{label:"Avancement de l'ouvrage",class:"my-auto",modelValue:d.value.interaction_progress,"onUpdate:modelValue":y[0]||(y[0]=x=>d.value.interaction_progress=x),type:"number"},null,8,["modelValue"]),u(z,{label:"Type d'interaction",class:"m-4 w-full md:w-5/12 md:ml-auto",choices:t.value,modelValue:d.value.interaction_type,"onUpdate:modelValue":y[1]||(y[1]=x=>d.value.interaction_type=x)},null,8,["choices","modelValue"])]),u(O,{label:"Date de lecture",modelValue:d.value.interaction_date,"onUpdate:modelValue":y[2]||(y[2]=x=>d.value.interaction_date=x),type:"date"},null,8,["modelValue"]),u(Y,{label:"Pourquoi s'y être interessé ?",modelValue:d.value.interaction_comment,"onUpdate:modelValue":y[3]||(y[3]=x=>d.value.interaction_comment=x)},null,8,["modelValue"]),n("div",Pt,[u(H,{onClick:g,class:"m-4",text:"Valider",type:"valid"}),u(H,{onClick:o,class:"m-4",text:"Annuler",type:"abort"})])]))}}),Ot=I({__name:"DateField",props:{date:{}},setup(r){const e=r,s=A(()=>new Date(e.date).toLocaleDateString("fr-FR",{day:"numeric",month:"short",year:"numeric"}));return(t,a)=>(l(),c("div",null,w(s.value),1))}}),Mt=I({__name:"CheckboxInput",props:{label:{},modelValue:{type:Boolean}},emits:["update:modelValue"],setup(r,{emit:e}){const s=r,t="checkbox-"+Math.random().toString(36).substr(2,9),a=v(N(s).modelValue),i=()=>{a.value=!a.value,console.log(a.value),e("update:modelValue",!s.modelValue)};return(f,d)=>(l(),c("div",null,[je(n("input",{class:"m-2",type:"checkbox",id:t,"onUpdate:modelValue":d[0]||(d[0]=g=>a.value=g),onChange:i},null,544),[[qe,a.value]]),n("label",{for:t},w(f.label),1)]))}}),jt={class:"m-4"},qt={class:"block text-2xs text-slate-800"},Nt=["value","placeholder"],Ce=I({__name:"NumberInput",props:{label:{},modelValue:{},placeholder:{}},emits:["update:modelValue","input"],setup(r,{emit:e}){const s=t=>{e("update:modelValue",t.target.value),e("input",t.target.value)};return(t,a)=>(l(),c("div",jt,[n("label",qt,w(t.label),1),n("input",{class:"border border-neutral-400 block h-full w-full rounded-md border-2 p-1 pl-2 text-xs",type:"number",value:t.modelValue,placeholder:t.placeholder,onInput:a[0]||(a[0]=i=>s(i))},null,40,Nt)]))}}),zt={class:"flex"},Ht={class:"ml-auto h-6 m-4 w-1/3"},Jt={class:"ml-auto h-6 m-4 w-1/3"},Kt={class:"ml-auto h-6 m-4 w-1/3"},Wt={class:"my-auto ml-auto h-6 m-4 w-1/3"},Gt={class:"flex"},Qt=I({__name:"ArticleForm",props:{article:{}},emits:["change"],setup(r,{emit:e}){const s=r,t=v([{text:"Terminé",value:"fnsh"},{text:"Relecture",value:"rvew"},{text:"Idée",value:"idea"}]),a=v([{text:"Livre",value:"book"},{text:"Fiche de lecture",value:"shet"},{text:"Article de média",value:"natc"},{text:"Article de recherche",value:"ratc"},{text:"Film",value:"movi"},{text:"Podcast",value:"pcst"}]),{categories:i}=Ne(),f=A(()=>i.value.map(g=>({text:g.display_name,value:g.id}))),d=(g,o)=>{let m={...s.article};m[g]=o,e("change",m)};return(g,o)=>(l(),c("div",null,[u(O,{label:"Titre",modelValue:g.article.title,"onUpdate:modelValue":o[0]||(o[0]=m=>d("title",m))},null,8,["modelValue"]),u(O,{class:"h-6",label:"Sous-titre",modelValue:g.article.subtitle,"onUpdate:modelValue":o[1]||(o[1]=m=>d("subtitle",m))},null,8,["modelValue"]),n("div",zt,[u(Ce,{class:"mr-auto h-6",label:"Progression",modelValue:g.article.interaction_progress,"onUpdate:modelValue":o[2]||(o[2]=m=>d("progress",m))},null,8,["modelValue"]),n("div",Ht,[u(z,{label:"Catégorie",choices:f.value,"model-value":g.article.category_id,"onUpdate:modelValue":o[3]||(o[3]=m=>d("category_id",m))},null,8,["choices","model-value"])]),n("div",Jt,[u(z,{label:"Stade d'écriture",choices:t.value,"model-value":g.article.maturing_state,"onUpdate:modelValue":o[4]||(o[4]=m=>d("maturing_state",m))},null,8,["choices","model-value"])]),n("div",Kt,[u(z,{label:"Type de ressource",choices:a.value,"onUpdate:modelValue":o[5]||(o[5]=m=>d("resource_type",m)),"model-value":g.article.resource_type},null,8,["choices","model-value"])]),n("div",Wt,[u(Mt,{class:"mt-3",label:"Externe","onUpdate:modelValue":o[6]||(o[6]=m=>d("is_external",m)),"model-value":g.article.is_external},null,8,["model-value"])])]),n("div",Gt,[u(O,{class:"h-6",label:"Lien contenu externe",modelValue:g.article.external_content_url,"onUpdate:modelValue":o[7]||(o[7]=m=>d("external_content_url",m))},null,8,["modelValue"]),u(O,{class:"h-6",label:"Lien image",modelValue:g.article.image_url,"onUpdate:modelValue":o[8]||(o[8]=m=>d("image_url",m))},null,8,["modelValue"])]),u(Y,{label:"Pistes d'amélioration",modelValue:g.article.comment,"onUpdate:modelValue":o[9]||(o[9]=m=>d("comment",m))},null,8,["modelValue"])]))}}),Xt={class:"flex flex-wrap"},Yt=I({__name:"ResourceAuthorPicker",props:{interaction:{},resourceId:{}},emits:["update"],setup(r,{emit:e}){const s=r,t=v(null),a=v([]),i=b=>{if(b)return{text:`${b.first_name} ${b.last_name}`,value:b.id}},f=A(()=>{var b;return(b=t.value)==null?void 0:b.id}),d=A(()=>{if(a.value)return a.value.map(b=>i(b))}),{getUsers:g,getUserById:o}=j(),m=async b=>t.value=await o(b.interaction_user_id),{createInteractionForResource:y,newInteraction:x,createInteraction:B,updateInteraction:D}=ve(),J=async b=>{if(console.log(`newUser : ${JSON.stringify(b)}`),s.interaction){const $={...s.interaction};$.interaction_user_id=b,console.log("newUserid : ",b.id),console.log(`Interaction payload : ${JSON.stringify($)}`),await D(s.interaction.id,$),e("update")}else{console.log("create interaction");const $=x();$.interaction_user_id=b,$.resource_id=s.resourceId,await y(s.resourceId,$),e("update")}},P=async b=>{await D(s.interaction.id,b),e("update")};return L(async()=>{a.value=await g(),await m(s.interaction)}),te(N(s).interaction,async b=>await m(b)),(b,$)=>(l(),c("div",null,[n("div",Xt,[u(z,{label:"Auteur",class:"my-auto",choices:d.value,"model-value":f.value,"onUpdate:modelValue":$[0]||($[0]=S=>J(S))},null,8,["choices","model-value"]),b.interaction?(l(),R(O,{key:0,class:"my-auto",label:"Date d'écriture","model-value":b.interaction.interaction_date.split("T")[0],"onUpdate:modelValue":$[1]||($[1]=S=>P({...b.interaction,interaction_date:S})),type:"date"},null,8,["model-value"])):k("",!0),b.interaction?(l(),R(Ce,{key:1,class:"my-auto",label:"Progression",modelValue:b.interaction.interaction_progress,"onUpdate:modelValue":$[2]||($[2]=S=>P({...b.interaction,interaction_progress:S}))},null,8,["modelValue"])):k("",!0)])]))}}),Zt={key:0,class:"text-center text-2xl pt-10"},eo={key:1},to={key:0},oo={class:"my-8"},lo=["src"],so={class:"text-3xl my-3 font-mplus md:text-center text-left"},ao={class:"md:text-center text-left"},no={class:"md:text-center text-left"},ro={class:"md:flex my-8"},uo=["href"],io={key:1},co={class:"flex flex-row-reverse"},mo={key:1,class:"p-2 border rounded bg-neutral-100"},vo=n("hr",{class:"border-top border-zinc-400 my-4"},null,-1),po={key:2},_o=n("div",{class:"text-xs italic"},"Commentaire",-1),fo=n("hr",{class:"border-top border-zinc-400 my-4"},null,-1),go=n("div",{class:"text-xs italic"},"Contenu",-1),ho={key:3},bo={key:4},yo={key:5},xo={class:"fixed right-3 bottom-5"},wo=I({__name:"ResourceComponent",props:{id:{},secondLevel:{type:Boolean}},setup(r){const e=r,s=ze(),t=A(()=>e.secondLevel?"popup_tab":"tab"),a=A(()=>[{text:"Contenu",value:"ctnt"},{text:"Biblio",value:"bbli",count:o.value.length},{text:"Sujets",value:"pblm",count:$.value.length},{text:"Interactions",value:"inpt",count:D.value.length}]),i=v(s.query[t.value]&&typeof s.query[t.value]=="string"?s.query[t.value]:"ctnt"),f=v(s.query[t.value]);te(()=>s.query[t.value],_=>{console.log("new route query",_),typeof _=="string"&&(f.value=_)});const{getResourceRelationsForResource:d,getUsagesForResource:g}=Re(),o=v([]),m=v(!1),y=v(!1),x=async()=>{o.value=await d(N(e).id.value)},B=A(()=>o.value.map(_=>({resource:_.origin_resource,date:_.created_at,user_id:_.user_id,context_comment:_.relation_comment,progress:null}))),D=v([]),{getInteractionsForResource:J}=ve(),P=async()=>{D.value=await J(e.id)},b=A(()=>D.value.map(_=>({resource:null,date:_.interaction_date,user_id:_.interaction_user_id,context_comment:_.interaction_comment,progress:_.interaction_progress}))),$=v([]),S=async()=>{$.value=await g(e.id)},K=A(()=>$.value.map(_=>({resource:_.target_resource,date:_.created_at,user_id:_.user_id,context_comment:_.relation_comment,progress:null}))),q=v(!1),{newResource:se,getResource:ae,updateResource:W,getAuthorInteractionForResource:U}=pe(),C=v(null),p=v(se()),Ie=He();te(()=>s.query.editing,_=>{console.log("Editing : ",_),ne.value=_==="false"?!1:!!_});const ne=v(!1),_e=_=>{Ie.push({query:{editing:_.toString()}})},Ue=()=>{!p.value||!p.value.id||(p.value.publishing_state="pbsh",W(p.value.id,p.value))},re=(_,h)=>{p.value=h,C.value!==null&&clearTimeout(C.value),C.value=setTimeout(async()=>{try{await W(_,p.value)}catch(ue){console.log("An error : ",ue)}},1e3)},fe=_=>{_!=`
`&&re(N(e).id.value,{...p.value,content:_})},ge=_=>{_!=`
`&&re(N(e).id.value,{...p.value,comment:_})},{user:he,getUserById:Ae}=j(),G=A(()=>p.value.is_external?!0:he.value?E.value?E.value.id==he.value.id:!0:!1),E=v(null),F=v(null),Z=v(!1),Te=async()=>{F.value=await U(e.id)},{getCommentsForThoughtOutput:De}=$e(),be=v([]);return L(async()=>{q.value=!1,p.value=await ae(e.id),q.value=!0,await x(),await P(),await S(),be.value=await De(e.id),F.value=await U(e.id),F.value&&(E.value=await Ae(F.value.interaction_user_id));const _=s.query.editing;ne.value=_==="false"?!1:!!_}),(_,h)=>{const ue=ke("router-link");return l(),c("div",null,[q.value?(l(),c("div",eo,[ne.value?(l(),c("div",io,[u(Qt,{article:p.value,onChange:h[0]||(h[0]=V=>re(p.value.id,V))},null,8,["article"]),u(Yt,{class:"mx-4",interaction:F.value,"resource-id":_.id,onChange:Te},null,8,["interaction","resource-id"]),n("div",co,[u(H,{class:"mx-4",onClick:h[1]||(h[1]=V=>_e(!1)),type:"valid",text:"Preview"},{default:T(()=>[X("Ok")]),_:1}),p.value.publishing_state=="drft"?(l(),R(H,{key:0,onClick:Ue,type:"valid",text:"Publier"})):(l(),c("div",mo,"Publié"))])])):(l(),c("div",to,[n("div",oo,[n("img",{src:p.value.image_url,class:"border border-slate-300 dark:border-zinc-700 rounded-xl ml-auto mr-auto",style:{"max-height":"20rem"}},null,8,lo)]),n("h1",so,w(p.value.title),1),n("div",ao,w(p.value.subtitle),1),n("div",no,[E.value?(l(),R(ue,{key:0,to:"/users/"+E.value.id,class:"text-sm underline"},{default:T(()=>[X(w(E.value.first_name)+" "+w(E.value.last_name),1)]),_:1},8,["to"])):k("",!0),F.value?(l(),R(Ot,{key:1,date:F.value.interaction_date},null,8,["date"])):k("",!0)]),n("div",ro,[F.value?(l(),R(Ve,{key:0,"progress-value":F.value.interaction_progress,class:"m-2 w-1/3"},null,8,["progress-value"])):k("",!0),p.value.external_content_url?(l(),c("a",{key:1,class:"ml-auto underline",href:p.value.external_content_url,target:"_blank"}," Lien ressource externe ",8,uo)):k("",!0)])])),n("div",null,[u(we,{choices:a.value,default:i.value,"url-key":t.value,url:""},null,8,["choices","default","url-key"])]),vo,f.value=="ctnt"?(l(),c("div",po,[_o,p.value.publishing_state!="drft"?(l(),R(ce,{key:0,"full-text":p.value.comment,editable:G.value,onChange:h[2]||(h[2]=V=>ge(V))},null,8,["full-text","editable"])):(l(),R(Y,{key:1,class:"h-20",label:"Commentaire",modelValue:p.value.comment,"onUpdate:modelValue":h[3]||(h[3]=V=>ge(V))},null,8,["modelValue"])),fo,go,q.value&&!p.value.is_local_draft&&p.value.publishing_state!="drft"?(l(),R(ce,{key:2,class:"min-h-fit","ext-comments":be.value,"resource-id":p.value.id,"full-text":p.value.content,editable:G.value,onChange:h[4]||(h[4]=V=>fe(V))},null,8,["ext-comments","resource-id","full-text","editable"])):(l(),R(Y,{key:3,class:"h-96",label:"Contenu",modelValue:p.value.content,"onUpdate:modelValue":h[5]||(h[5]=V=>fe(V))},null,8,["modelValue"])),u(Ft,{"resource-id":_.id},null,8,["resource-id"])])):f.value=="bbli"?(l(),c("div",ho,[u(ee,{open:m.value,onClose:h[7]||(h[7]=V=>m.value=!1)},{default:T(()=>[u(xe,{onRefresh:x,onClose:h[6]||(h[6]=V=>m.value=!1),"target-resource":p.value},null,8,["target-resource"])]),_:1},8,["open"]),n("div",{onClick:h[8]||(h[8]=V=>m.value=!0),class:"text-sm italic underline"}," Ajouter une référence "),u(Q,{"contextual-resources":B.value},null,8,["contextual-resources"])])):f.value=="pblm"?(l(),c("div",bo,[u(Q,{"contextual-resources":K.value},null,8,["contextual-resources"])])):f.value=="inpt"?(l(),c("div",yo,[u(Q,{"contextual-resources":b.value},null,8,["contextual-resources"])])):k("",!0),n("div",xo,[G.value?(l(),R(ie,{key:0,title:"Modifier",onClick:h[9]||(h[9]=V=>_e(!0))},{default:T(()=>[u(M(We),{class:"m-1"})]),_:1})):k("",!0),G.value?(l(),R(ie,{key:1,class:"mt-2",color:"red",title:"Marquer comme lu",onClick:h[10]||(h[10]=V=>Z.value=!0)},{default:T(()=>[u(M(Ke),{class:"m-1"})]),_:1})):k("",!0),u(ee,{open:Z.value,onClose:h[12]||(h[12]=V=>Z.value=!1)},{default:T(()=>[u(Et,{onRefresh:P,onClose:h[11]||(h[11]=V=>Z.value=!1),resource:p.value},null,8,["resource"])]),_:1},8,["open"]),G.value?(l(),R(ie,{key:2,class:"mt-2",color:"green",title:"Relier à d'autres ressources",onClick:h[13]||(h[13]=V=>y.value=!0)},{default:T(()=>[u(M(Ge),{class:"m-1"})]),_:1})):k("",!0),u(ee,{open:y.value,onClose:h[15]||(h[15]=V=>y.value=!1)},{default:T(()=>[u(xe,{onRefresh:S,onClose:h[14]||(h[14]=V=>y.value=!1),"origin-resource":p.value},null,8,["origin-resource"])]),_:1},8,["open"])])])):(l(),c("div",Zt,"Loading..."))])}}});export{wo as _,st as a,ee as b,Q as c,Y as d,z as e,We as r,Ut as u};
