import{i as N,m as j,o as l,c as n,a as m,t as _,d as L,_ as P,x as b,z as I,u as ee,r as p,l as y,n as te,A as oe,q as C,F as w,B as k,C as R,e as ae}from"./index-236ba4ec.js";const se={class:"bg-slate-100 border p-1 m-1 rounded shadow-xl"},le={class:"flex"},ne={class:"text-xs mt-0.5 font-bold"},re={class:"text-2xs italic ml-auto mr-1 my-auto"},ie={key:0},de=["value"],ce={class:"flex"},ue={key:1,class:"text-xs mt-0.5"},me=N({__name:"CommentCard",props:{editing:{type:Boolean},modelValue:{},author:{},createdAt:{}},emits:["update:modelValue","validate","abort"],setup(u,{emit:i}){const d=u,h=j(()=>{console.log(`date : ${d.createdAt}`),console.log(b(d).createdAt.value.split(".")[0]);const v=new Date(b(d).createdAt.value.split(".")[0]);return console.log(v),v.toLocaleString("fr-FR",{hour:"numeric",weekday:"short",day:"numeric",month:"short",year:"2-digit"})}),s=v=>{i("update:modelValue",v.target.value)},a=()=>{i("validate")},$=()=>{i("abort")};return(v,A)=>(l(),n("div",se,[m("div",le,[m("div",ne,_(v.author.first_name)+" "+_(v.author.last_name),1),m("div",re,_(h.value),1)]),v.editing?(l(),n("div",ie,[m("textarea",{class:"w-full text-xs rounded-xl p-2",value:v.modelValue,onInput:s},null,40,de),m("div",ce,[L(P,{onClick:a,class:"text-sm",rounded:"",size:"2xs",text:"Commenter",type:"valid"}),L(P,{onClick:$,class:"text-sm",rounded:"",size:"2xs",text:"Annuler",type:"abort"})])])):(l(),n("div",ue,_(v.modelValue),1))]))}}),ve=async(u,i)=>{const{user:d}=ee(),h={start_index:i,end_index:i};try{const a=(await I.post("/articles/"+u+"/comments",h)).data;return d.value&&a.author_id==d.value.id&&(a.author=d.value),a}catch(s){console.log("error : ",s)}},he=async(u,i=!0)=>{const d=i?"?author=true":"";try{return(await I.get("/articles/"+u+"/comments"+d)).data}catch(h){console.log("error : ",h)}},K=async u=>{try{return(await I.put("/comments/"+u.id,u)).data}catch(i){console.log("error : ",i)}},fe=async u=>{console.log("comments : ",u),u.map(i=>K(i))};function pe(){return{createComment:ve,getCommentsForArticle:he,updateComment:K,batchUpdateComments:fe}}const xe=m("div",{class:"text-sm align-middle flex items-center p-2",style:{height:"50px"}}," Corriger une faute ",-1),ge={class:"flex mx-auto max-w-full"},_e={class:"w-full"},ye={key:0,class:"flex"},Ce=m("div",{class:"w-6"},[m("div",{class:"rounded-full ml-4 mr-2 mt-2 h-1 w-1 bg-black"})],-1),we=[Ce],ke={class:"flex flex-wrap"},be=["id","onClick","onContextmenu"],$e={key:0,style:{width:"5px"}},Ae={key:1,style:{height:"25px"}},Ve={key:2},Te={key:1,class:"absolute h-full",style:{right:"-2%",width:"27%"}},Be={key:0,style:{width:"33%"}},Fe=N({__name:"TextInterface",props:{ressourceId:{},fullText:{},extComments:{default:()=>[]},editable:{type:Boolean,default:!0}},emits:["change","changeComments"],setup(u,{emit:i}){const d=u,h=e=>{console.log("selectCursorPosition letter : ",e),d.editable&&(s.value={id:e.id,char:e.char})},s=p(null),a=p([]),$=j(()=>v(a.value)),v=e=>{console.log("textArrayFromString textString: ",e);let t=[{id:0,words:[{id:0,text:[]}],comments:[]}],o=0,x=0;for(var r=0;r<a.value.length;r++){a.value[r].char==`
`&&(o+=1,x=0,t.push({id:o,words:[{id:0,text:[]}],lineStyle:r<a.value.length-1?a.value[r+1].char:null,comments:[]}));const g=f.value.find(c=>c.start_index==r);g&&t[o].comments.push(g),t[o].words[x].text.push({id:r,char:a.value[r].char,comment:g}),a.value[r].char==" "&&(x+=1,t[o].words.push({id:x,text:[]}))}return t},A=e=>{e==1?f.value.forEach(t=>{t.start_index>s.value.id&&(t.start_index+=1),t.end_index>s.value.id&&(t.end_index+=1)}):e==-1&&f.value.forEach(t=>{t.start_index>=s.value.id&&(t.start_index-=1),t.end_index>=s.value.id&&(t.end_index-=1)})},V=e=>{a.value.filter(t=>t.id>=s.value.id+1).forEach(t=>t.id+=1),a.value.splice(s.value.id+1,0,{id:s.value.id+1,char:e,line:0}),A(1),s.value.id+=1},O=e=>{if(console.log("Writes : ",e.key),s.value===null)return;const t=e.key;if(T.value&&t=="v"){q();return}if(t.length==1)e.preventDefault(),V(t);else if(t=="Backspace")a.value.splice(s.value.id,1),a.value.filter(o=>o.id>s.value.id).forEach(o=>o.id-=1),A(-1),s.value.id-=1;else if(t=="Enter")V(`
`);else if(t=="ArrowRight"){let o=s.value.id;o<a.value.length-1&&h(a.value[o+1])}else if(t=="ArrowLeft"){let o=s.value.id;o>0&&h(a.value[o-1])}else t=="Control"&&(console.log("Control"),T.value=!0)},T=p(!1),q=async()=>{try{let t=await navigator.clipboard.readText();console.log("Clippedtext : ",t);for(var e=0;e<t.length;e++)V(t[e])}catch(t){console.log("Error with clippboard : ",t)}},H=e=>{e.key=="Control"&&(T.value=!1)},{createComment:M,batchUpdateComments:X}=pe(),f=p([]),S=p(null),Y=e=>{console.log("Comments loading : ",e),f.value=e},G=async()=>{console.log("Add Comment");const e=await M(d.ressourceId,z.value);f.value.push(e)};y(f,e=>{console.log("Watch comments triggered : ",e.value),F.value&&(console.log("Comments : ",e),i("changeComments",e.value),clearTimeout(S.value),S.value=setTimeout(()=>X(e),1e3))},{deep:!0}),y(b(d).extComments,e=>{f.value=e});const B=p(!1),z=p(null),E=p({position:"absolute","z-index":90,top:0,left:0,height:"106px",width:"260px"}),J=(e,t)=>{e.preventDefault(),s.value=null,E.value.top=`${e.layerY}px`,E.value.left=`${e.layerX}px`,B.value=!0,z.value=t,console.log("event : ",e),console.log("Have a new right click")},D=e=>{if(console.log("textArrayFromString textString: ",e),a.value=[],e===void 0||e==""){a.value=[{id:0,char:`
`}],h({id:0,char:`
`});return}for(var t=0;t<e.length;t++){const o=f.value.find(x=>x.start_index==t);a.value.push({id:t,char:e[t],comment:o})}},Q=e=>e.reduce((t,o)=>t+o.char,""),F=p(!1);return te(()=>{D(d.fullText),Y(d.extComments),F.value=!0}),y(a,e=>{console.log("Watch triggered : ",e),F.value&&i("change",Q(e))},{deep:!0}),y(b(d).fullText,e=>{D(e)}),(e,t)=>(l(),n("div",{class:"relative p-4",tabindex:"0",onKeydown:O,onKeyup:H,onClick:t[0]||(t[0]=o=>B.value=!1)},[B.value?(l(),n("div",{key:0,class:"bg-white border-4",style:oe(E.value)},[m("div",{onClick:G,class:"text-sm border-b-2 flex items-center p-2",style:{height:"50px"}}," Ajouter un commentaire "),xe],4)):C("",!0),m("div",ge,[m("div",_e,[(l(!0),n(w,null,k($.value,(o,x)=>(l(),n("div",{key:x,class:"flex"},[o.lineStyle=="*"?(l(),n("div",ye,we)):C("",!0),m("div",ke,[(l(!0),n(w,null,k(o.words,(r,g)=>(l(),n("div",{key:g,class:"flex flex-wrap"},[(l(!0),n(w,null,k(r.text,(c,Z)=>{var U;return l(),n("div",{id:c.id,key:Z,class:R(["border-blue-400",{"border-r-2":c.id==((U=s.value)==null?void 0:U.id),"bg-yellow-400":c.comment}]),onClick:W=>h(c),onContextmenu:W=>J(W,c.id)},[c.char==" "?(l(),n("div",$e)):c.char==`
`?(l(),n("div",Ae)):(c.char=="#"||c.char=="*")&&g==0?(l(),n("div",Ve)):(l(),n("div",{key:3,class:R({"font-bold":o.lineStyle=="#"})},[m("div",null,_(c.char),1)],2))],42,be)}),128))]))),128))]),f.value.length>0?(l(),n("div",Te,[(l(!0),n(w,null,k(o.comments,(r,g)=>(l(),ae(me,{key:g,class:"w-full",modelValue:r.content,"onUpdate:modelValue":c=>r.content=c,editing:r.editing,onValidate:c=>r.editing=!1,author:r.author,"created-at":r.created_at},null,8,["modelValue","onUpdate:modelValue","editing","onValidate","author","created-at"]))),128))])):C("",!0)]))),128))]),f.value.length>0?(l(),n("div",Be)):C("",!0)])],32))}});export{Fe as _,pe as u};
