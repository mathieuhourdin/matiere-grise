import{d as O,q as j,c as n,i as m,t as y,a as C,k as L,o as s,n as P,G as S,L as ae,e as K,r as _,x as b,A as R,g as le,M as se,F as $,j as V,E as N,p as ne}from"./index-3737297f.js";const re={class:"bg-slate-100 border p-1 m-1 rounded shadow-xl"},ue={class:"flex"},de={key:0,class:"text-xs mt-0.5 font-bold"},ce={class:"text-2xs italic ml-auto mr-1 my-auto"},ie={key:0},ve=["value"],he={class:"flex"},me={key:1,class:"text-xs mt-0.5"},fe=O({__name:"CommentCard",props:{editing:{type:Boolean},modelValue:{},author:{},createdAt:{}},emits:["update:modelValue","validate","abort"],setup(r,{emit:u}){const d=r,i=j(()=>d.createdAt?d.createdAt.toLocaleString("fr-FR",{hour:"numeric",weekday:"short",day:"numeric",month:"short",year:"2-digit"}):""),o=c=>{u("update:modelValue",c.target.value)},l=()=>{u("validate")},x=()=>{u("abort")};return(c,k)=>(s(),n("div",re,[m("div",ue,[c.author?(s(),n("div",de,y(c.author.first_name)+" "+y(c.author.last_name),1)):C("",!0),m("div",ce,y(i.value),1)]),c.editing?(s(),n("div",ie,[m("textarea",{class:"w-full text-xs rounded-xl p-2",value:c.modelValue,onInput:o},null,40,ve),m("div",he,[L(P,{onClick:l,class:"text-sm",rounded:"",size:"2xs",text:"Commenter",type:"valid"}),L(P,{onClick:x,class:"text-sm",rounded:"",size:"2xs",text:"Annuler",type:"abort"})])])):(s(),n("div",me,y(c.modelValue),1))]))}}),{launchSnackbar:D}=ae(),pe=async(r,u,d,i)=>{const{user:o}=K(),l={start_index:u,end_index:u,content:d,editing:i};try{const x=await S.post("/resources/"+r+"/comments",l),c=z(x.data);return o.value&&c.author_id==o.value.id&&(c.author=o.value),c}catch(x){throw console.log("error : ",x),D(`Error creating comment : ${x}`,"error"),x}},z=r=>(r.updated_at=new Date(r.updated_at.split(".")[0]),r.created_at=new Date(r.created_at.split(".")[0]),r),xe=async(r,u=!0)=>{const d=u?"?author=true":"";try{return(await S.get("/resources/"+r+"/comments"+d)).data.map(o=>z(o))}catch(i){throw console.log("error : ",i),D(`Error getting comments : ${i}`,"error"),i}},M=async r=>{try{const u=await S.put("/comments/"+r.id,r);return z(u.data)}catch(u){console.log("error : ",u),D(`Error updating comment : ${u}`,"error")}},_e=async r=>{console.log("comments : ",r),r.map(u=>M(u))};function ge(){return{createComment:pe,getCommentsForThoughtOutput:xe,updateComment:M,batchUpdateComments:_e}}const ye=m("div",{class:"text-sm align-middle flex items-center p-2",style:{height:"50px"}}," Corriger une faute ",-1),Ce={class:"flex mx-auto max-w-full"},ke={class:"w-full"},we={key:0,class:"flex"},be=m("div",{class:"w-6"},[m("div",{class:"rounded-full ml-4 mr-2 mt-2 h-1 w-1 bg-black"})],-1),$e=[be],Ve={class:"flex flex-wrap flex-1"},Ae=["onClick","onContextmenu"],Ee={key:0,style:{width:"5px"}},Te={key:1,style:{height:"25px"}},Ie={key:2},Be=["onClick"],Se={key:1,class:"absolute h-full",style:{right:"-2%",width:"27%"}},De={key:0,style:{width:"33%"}},Fe=O({__name:"TextInterface",props:{resourceId:{},fullText:{},extComments:{default:()=>[]},editable:{type:Boolean,default:!0}},emits:["change","changeComments"],setup(r,{emit:u}){const d=r,i=e=>{console.log("selectCursorPosition letter : ",e),d.editable&&(o.value={id:e.id,char:e.char})},o=_(null),l=_([]),x=j(()=>{let e=[{id:0,words:[{id:0,text:[]}],comments:[]}],t=0,a=0;for(var v=0;v<l.value.length;v++){l.value[v].char==`
`&&(t+=1,a=0,e.push({id:t,words:[{id:0,text:[]}],lineStyle:v<l.value.length-1?l.value[v+1].char:null,comments:[]}));const h=p.value.find(g=>g.start_index==v);h&&e[t].comments.push(h),e[t].words[a].text.push({id:v,char:l.value[v].char,comment:h}),l.value[v].char==" "&&(a+=1,e[t].words.push({id:a,text:[]}))}return e}),c=e=>{e==1?p.value.forEach(t=>{o.value&&t.start_index>o.value.id&&(t.start_index+=1),o.value&&t.end_index>o.value.id&&(t.end_index+=1)}):e==-1&&p.value.forEach(t=>{o.value&&t.start_index>=o.value.id&&(t.start_index-=1),o.value&&t.end_index>=o.value.id&&(t.end_index-=1)})},k=e=>{o.value&&(l.value.filter(t=>o.value&&t.id>=o.value.id+1).forEach(t=>t.id+=1),l.value.splice(o.value.id+1,0,{id:o.value.id+1,char:e}),c(1),o.value.id+=1)},q=e=>{if(console.log("Writes : ",e.key),o.value===null)return;const t=e.key;if(A.value&&t=="v"){G();return}if(t.length==1)e.preventDefault(),k(t);else if(t=="Backspace")l.value.splice(o.value.id,1),l.value.filter(a=>o.value&&a.id>o.value.id).forEach(a=>a.id-=1),c(-1),o.value.id-=1;else if(t=="Enter")k(`
`);else if(t=="ArrowRight"){let a=o.value.id;a<l.value.length-1&&i(l.value[a+1])}else if(t=="ArrowLeft"){let a=o.value.id;a>0&&i(l.value[a-1])}else t=="Control"&&(console.log("Control"),A.value=!0)},A=_(!1),G=async()=>{try{let t=await navigator.clipboard.readText();console.log("Clippedtext : ",t);for(var e=0;e<t.length;e++)k(t[e])}catch(t){console.log("Error with clippboard : ",t)}},H=e=>{e.key=="Control"&&(A.value=!1)},{createComment:X,batchUpdateComments:Y}=ge(),p=_([]),E=_(null),J=e=>{console.log("Comments loading : ",e),p.value=e.filter(t=>t.start_index!==null)},Q=async()=>{if(console.log("Add Comment"),console.log(d.resourceId),console.log(w.value),!d.resourceId||!w.value)return;console.log("Add Comment 2");const e=await X(d.resourceId,w.value);p.value.push(e)};b(p,e=>{console.log("Watch comments triggered : ",e),B.value&&(console.log("Comments : ",e),u("changeComments",e),E.value!==null&&clearTimeout(E.value),E.value=setTimeout(()=>Y(e),1e3))},{deep:!0}),b(R(d).extComments,e=>{p.value=e});const T=_(!1),w=_(null),I=_({position:"absolute","z-index":90,top:"0px",left:"0px",height:"106px",width:"260px"}),{user:Z}=K(),ee=(e,t)=>{e.preventDefault(),Z.value&&(o.value=null,I.value.top=`${e.layerY}px`,I.value.left=`${e.layerX}px`,T.value=!0,w.value=t,console.log("event : ",e),console.log("Have a new right click"))},F=e=>{if(l.value=[],e===void 0||e==""){l.value=[{id:0,char:`
`}],i({id:0,char:`
`});return}for(var t=0;t<e.length;t++){const a=p.value.find(v=>v.start_index==t);l.value.push({id:t,char:e[t],comment:a})}},te=e=>e.reduce((t,a)=>t+a.char,""),B=_(!1);return le(()=>{F(d.fullText),J(d.extComments),B.value=!0}),b(l,e=>{console.log("Watch triggered : ",e),B.value&&u("change",te(e))},{deep:!0}),b(R(d).fullText,e=>{F(e)}),(e,t)=>(s(),n("div",{class:"relative p-4",tabindex:"0",onKeydown:q,onKeyup:H,onClick:t[0]||(t[0]=a=>T.value=!1)},[T.value?(s(),n("div",{key:0,class:"bg-white border-4",style:se(I.value)},[m("div",{onClick:Q,class:"text-sm border-b-2 flex items-center p-2",style:{height:"50px"}}," Ajouter un commentaire "),ye],4)):C("",!0),m("div",Ce,[m("div",ke,[(s(!0),n($,null,V(x.value,(a,v)=>(s(),n("div",{key:v,class:"flex"},[a.lineStyle=="*"?(s(),n("div",we,$e)):C("",!0),m("div",Ve,[(s(!0),n($,null,V(a.words,(h,g)=>(s(),n("div",{key:g,class:"flex flex-wrap"},[(s(!0),n($,null,V(h.text,(f,oe)=>{var U;return s(),n("div",{key:oe,class:N(["border-blue-400",{"border-r-2":f.id==((U=o.value)==null?void 0:U.id),"bg-yellow-400":f.comment}]),onClick:W=>i(f),onContextmenu:W=>ee(W,f.id)},[f.char==" "?(s(),n("div",Ee)):f.char==`
`?(s(),n("div",Te)):(f.char=="#"||f.char=="*")&&g==0?(s(),n("div",Ie)):(s(),n("div",{key:3,class:N({"font-bold":a.lineStyle=="#"})},[m("div",null,y(f.char),1)],2))],42,Ae)}),128))]))),128)),m("div",{class:"flex-1",onClick:h=>i(a.words.slice(-1)[0].text.slice(-1)[0])},null,8,Be)]),p.value.length>0?(s(),n("div",Se,[(s(!0),n($,null,V(a.comments,(h,g)=>(s(),ne(fe,{key:g,class:"w-full",modelValue:h.content,"onUpdate:modelValue":f=>h.content=f,editing:h.editing,onValidate:f=>h.editing=!1,author:h.author,"created-at":h.created_at},null,8,["modelValue","onUpdate:modelValue","editing","onValidate","author","created-at"]))),128))])):C("",!0)]))),128))]),p.value.length>0?(s(),n("div",De)):C("",!0)])],32))}});export{Fe as _,fe as a,ge as u};
