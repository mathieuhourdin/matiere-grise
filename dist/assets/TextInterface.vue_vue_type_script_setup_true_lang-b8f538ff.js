import{d as j,q as H,c as r,i as h,a as y,t as C,k as R,o as s,n as L,G as S,H as ae,e as K,r as x,x as b,A as N,g as se,M as le,F as $,j as V,E as O,p as re}from"./index-0cefe29e.js";const ne={class:"bg-slate-100 border p-1 m-1 rounded shadow-xl"},ue={class:"flex"},de={key:0,class:"text-xs mt-0.5 mb-1 font-bold flex"},ie=["src"],ce={class:"my-auto"},he={class:"text-2xs italic ml-auto mr-1 my-auto"},ve={key:0},me=["value"],fe={class:"flex"},pe={key:1,class:"text-xs mt-0.5"},_e=j({__name:"CommentCard",props:{editing:{type:Boolean},modelValue:{},author:{},createdAt:{}},emits:["update:modelValue","validate","abort"],setup(n,{emit:u}){const i=n,c=H(()=>i.createdAt?i.createdAt.toLocaleString("fr-FR",{hour:"numeric",weekday:"short",day:"numeric",month:"short",year:"2-digit"}):""),o=d=>{u("update:modelValue",d.target.value)},l=()=>{u("validate")},p=()=>{u("abort")};return(d,k)=>(s(),r("div",ne,[h("div",ue,[d.author?(s(),r("div",de,[d.author.profile_picture_url?(s(),r("img",{key:0,class:"h-5 w-5 rounded-full mr-1",src:d.author.profile_picture_url},null,8,ie)):y("",!0),h("div",ce,C(d.author.first_name)+" "+C(d.author.last_name),1)])):y("",!0),h("div",he,C(c.value),1)]),d.editing?(s(),r("div",ve,[h("textarea",{class:"w-full text-xs rounded-xl p-2",value:d.modelValue,onInput:o},null,40,me),h("div",fe,[R(L,{onClick:l,class:"text-sm",rounded:"",size:"2xs",text:"Commenter",type:"valid"}),R(L,{onClick:p,class:"text-sm",rounded:"",size:"2xs",text:"Annuler",type:"abort"})])])):(s(),r("div",pe,C(d.modelValue),1))]))}}),{launchSnackbar:D}=ae(),xe=async(n,u,i,c)=>{const{user:o}=K(),l={start_index:u,end_index:u,content:i,editing:c};try{const p=await S.post("/resources/"+n+"/comments",l),d=z(p.data);return o.value&&d.author_id==o.value.id&&(d.author=o.value),d}catch(p){throw console.log("error : ",p),D(`Error creating comment : ${p}`,"error"),p}},z=n=>(n.updated_at=new Date(n.updated_at.split(".")[0]),n.created_at=new Date(n.created_at.split(".")[0]),n),ge=async(n,u=!0)=>{const i=u?"?author=true":"";try{return(await S.get("/resources/"+n+"/comments"+i)).data.map(o=>z(o))}catch(c){throw console.log("error : ",c),D(`Error getting comments : ${c}`,"error"),c}},M=async n=>{try{const u=await S.put("/comments/"+n.id,n);return z(u.data)}catch(u){console.log("error : ",u),D(`Error updating comment : ${u}`,"error")}},ye=async n=>{console.log("comments : ",n),n.map(u=>M(u))};function Ce(){return{createComment:xe,getCommentsForThoughtOutput:ge,updateComment:M,batchUpdateComments:ye}}const ke=h("div",{class:"text-sm align-middle flex items-center p-2",style:{height:"50px"}}," Corriger une faute ",-1),we={class:"flex mx-auto max-w-full"},be={class:"w-full"},$e={key:0,class:"flex"},Ve=h("div",{class:"w-6"},[h("div",{class:"rounded-full ml-4 mr-2 mt-2 h-1 w-1 bg-black"})],-1),Ae=[Ve],Ee={class:"flex flex-wrap flex-1"},Te=["onClick","onContextmenu"],Ie={key:0,style:{width:"5px"}},Be={key:1,style:{height:"25px"}},Se={key:2},De=["onClick"],ze={key:1,class:"absolute h-full",style:{right:"-2%",width:"27%"}},Fe={key:0,style:{width:"33%"}},We=j({__name:"TextInterface",props:{resourceId:{},fullText:{},extComments:{default:()=>[]},editable:{type:Boolean,default:!0}},emits:["change","changeComments"],setup(n,{emit:u}){const i=n,c=e=>{console.log("selectCursorPosition letter : ",e),i.editable&&(o.value={id:e.id,char:e.char})},o=x(null),l=x([]),p=H(()=>{let e=[{id:0,words:[{id:0,text:[]}],comments:[]}],t=0,a=0;for(var v=0;v<l.value.length;v++){l.value[v].char==`
`&&(t+=1,a=0,e.push({id:t,words:[{id:0,text:[]}],lineStyle:v<l.value.length-1?l.value[v+1].char:null,comments:[]}));const m=_.value.find(g=>g.start_index==v);m&&e[t].comments.push(m),e[t].words[a].text.push({id:v,char:l.value[v].char,comment:m}),l.value[v].char==" "&&(a+=1,e[t].words.push({id:a,text:[]}))}return e}),d=e=>{e==1?_.value.forEach(t=>{o.value&&t.start_index>o.value.id&&(t.start_index+=1),o.value&&t.end_index>o.value.id&&(t.end_index+=1)}):e==-1&&_.value.forEach(t=>{o.value&&t.start_index>=o.value.id&&(t.start_index-=1),o.value&&t.end_index>=o.value.id&&(t.end_index-=1)})},k=e=>{o.value&&(l.value.filter(t=>o.value&&t.id>=o.value.id+1).forEach(t=>t.id+=1),l.value.splice(o.value.id+1,0,{id:o.value.id+1,char:e}),d(1),o.value.id+=1)},q=e=>{if(console.log("Writes : ",e.key),o.value===null)return;const t=e.key;if(A.value&&t=="v"){G();return}if(t.length==1)e.preventDefault(),k(t);else if(t=="Backspace")l.value.splice(o.value.id,1),l.value.filter(a=>o.value&&a.id>o.value.id).forEach(a=>a.id-=1),d(-1),o.value.id-=1;else if(t=="Enter")k(`
`);else if(t=="ArrowRight"){let a=o.value.id;a<l.value.length-1&&c(l.value[a+1])}else if(t=="ArrowLeft"){let a=o.value.id;a>0&&c(l.value[a-1])}else t=="Control"&&(console.log("Control"),A.value=!0)},A=x(!1),G=async()=>{try{let t=await navigator.clipboard.readText();console.log("Clippedtext : ",t);for(var e=0;e<t.length;e++)k(t[e])}catch(t){console.log("Error with clippboard : ",t)}},X=e=>{e.key=="Control"&&(A.value=!1)},{createComment:Y,batchUpdateComments:J}=Ce(),_=x([]),E=x(null),F=e=>{_.value=e.filter(t=>t.start_index!=null)},Q=async()=>{if(console.log("Add Comment"),console.log(i.resourceId),console.log(w.value),!i.resourceId||!w.value)return;console.log("Add Comment 2");const e=await Y(i.resourceId,w.value);_.value.push(e)};b(_,e=>{console.log("Watch comments triggered : ",e),B.value&&(console.log("Comments : ",e),u("changeComments",e),E.value!==null&&clearTimeout(E.value),E.value=setTimeout(()=>J(e),1e3))},{deep:!0}),b(N(i).extComments,e=>{F(e)});const T=x(!1),w=x(null),I=x({position:"absolute","z-index":90,top:"0px",left:"0px",height:"106px",width:"260px"}),{user:Z}=K(),ee=(e,t)=>{e.preventDefault(),Z.value&&(o.value=null,I.value.top=`${e.layerY}px`,I.value.left=`${e.layerX}px`,T.value=!0,w.value=t,console.log("event : ",e),console.log("Have a new right click"))},U=e=>{if(l.value=[],e===void 0||e==""){l.value=[{id:0,char:`
`}],c({id:0,char:`
`});return}for(var t=0;t<e.length;t++){const a=_.value.find(v=>v.start_index==t);l.value.push({id:t,char:e[t],comment:a})}},te=e=>e.reduce((t,a)=>t+a.char,""),B=x(!1);return se(()=>{U(i.fullText),F(i.extComments),B.value=!0}),b(l,e=>{console.log("Watch triggered : ",e),B.value&&u("change",te(e))},{deep:!0}),b(N(i).fullText,e=>{U(e)}),(e,t)=>(s(),r("div",{class:"relative p-4",tabindex:"0",onKeydown:q,onKeyup:X,onClick:t[0]||(t[0]=a=>T.value=!1)},[T.value?(s(),r("div",{key:0,class:"bg-white border-4",style:le(I.value)},[h("div",{onClick:Q,class:"text-sm border-b-2 flex items-center p-2",style:{height:"50px"}}," Ajouter un commentaire "),ke],4)):y("",!0),h("div",we,[h("div",be,[(s(!0),r($,null,V(p.value,(a,v)=>(s(),r("div",{key:v,class:"flex"},[a.lineStyle=="*"?(s(),r("div",$e,Ae)):y("",!0),h("div",Ee,[(s(!0),r($,null,V(a.words,(m,g)=>(s(),r("div",{key:g,class:"flex flex-wrap"},[(s(!0),r($,null,V(m.text,(f,oe)=>{var W;return s(),r("div",{key:oe,class:O(["border-blue-400",{"border-r-2":f.id==((W=o.value)==null?void 0:W.id),"bg-yellow-400":f.comment}]),onClick:P=>c(f),onContextmenu:P=>ee(P,f.id)},[f.char==" "?(s(),r("div",Ie)):f.char==`
`?(s(),r("div",Be)):(f.char=="#"||f.char=="*")&&g==0?(s(),r("div",Se)):(s(),r("div",{key:3,class:O({"font-bold":a.lineStyle=="#"})},[h("div",null,C(f.char),1)],2))],42,Te)}),128))]))),128)),h("div",{class:"flex-1",onClick:m=>c(a.words.slice(-1)[0].text.slice(-1)[0])},null,8,De)]),_.value.length>0?(s(),r("div",ze,[(s(!0),r($,null,V(a.comments,(m,g)=>(s(),re(_e,{key:g,class:"w-full",modelValue:m.content,"onUpdate:modelValue":f=>m.content=f,editing:m.editing,onValidate:f=>m.editing=!1,author:m.author,"created-at":m.created_at},null,8,["modelValue","onUpdate:modelValue","editing","onValidate","author","created-at"]))),128))])):y("",!0)]))),128))]),_.value.length>0?(s(),r("div",Fe)):y("",!0)])],32))}});export{We as _,_e as a,Ce as u};
