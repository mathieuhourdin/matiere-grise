import{o as t,f as i,a as p,d as V,b as f,e as N,D as Fe,E as oe,G as pe,C as Le,H as qe,k as Me,m as y,p as $e,B as Ce,F as Y,g as Z,i as d,t as k,h as S,n as te,I as Pe,s as ye,q,c as R,A as Re,r as Ie,w as B,l as ie,J as je,_ as ae,u as ce,K as ne,L as ze,M as Ne}from"./index-6f83482f.js";import{a as O,_ as ee}from"./ActionButton.vue_vue_type_script_setup_true_lang-5d52dbdc.js";import{_ as fe}from"./TextAreaInput.vue_vue_type_script_setup_true_lang-f47a69f5.js";import{a as Ke,u as we,_ as Je}from"./SelectionTextInterface.vue_vue_type_style_index_0_lang-0c76bdf3.js";import{_ as Ve}from"./ProgressBar.vue_vue_type_script_setup_true_lang-db85e06f.js";import{u as _e}from"./useResource-712252ff.js";import{u as Te}from"./useResourceRelations-a9e61b0d.js";import{_ as Ue}from"./UserPicker.vue_vue_type_script_setup_true_lang-37068324.js";function We(g,a){return t(),i("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true"},[p("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M9 8.25H7.5a2.25 2.25 0 00-2.25 2.25v9a2.25 2.25 0 002.25 2.25h9a2.25 2.25 0 002.25-2.25v-9a2.25 2.25 0 00-2.25-2.25H15M9 12l3 3m0 0l3-3m-3 3V2.25"})])}function He(g,a){return t(),i("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true"},[p("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M7.217 10.907a2.25 2.25 0 100 2.186m0-2.186c.18.324.283.696.283 1.093s-.103.77-.283 1.093m0-2.186l9.566-5.314m-9.566 7.5l9.566 5.314m0 0a2.25 2.25 0 103.935 2.186 2.25 2.25 0 00-3.935-2.186zm0-12.814a2.25 2.25 0 103.933-2.185 2.25 2.25 0 00-3.933 2.185z"})])}function Ge(g,a){return t(),i("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true"},[p("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M21.75 6.75a4.5 4.5 0 01-4.884 4.484c-1.076-.091-2.264.071-2.95.904l-7.152 8.684a2.548 2.548 0 11-3.586-3.586l8.684-7.152c.833-.686.995-1.874.904-2.95a4.5 4.5 0 016.336-4.486l-3.276 3.276a3.004 3.004 0 002.25 2.25l3.276-3.276c.256.565.398 1.192.398 1.852z"}),p("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M4.867 19.125h.008v.008h-.008v-.008z"})])}const Qe={class:"flex"},re=V({__name:"ModalSheet",props:{open:{type:Boolean,default:!1}},emits:["close"],setup(g,{emit:a}){const n=g,v=f(!1);return N(()=>{v.value=n.open}),Fe(()=>{const l=r=>{(r.key==="Escape"||r.key==="Enter"||r.key==="Esc"||r.keyCode===27)&&a("close")};return window.addEventListener("keydown",l),()=>{window.removeEventListener("keydown",l)}}),oe(pe(n).open,l=>v.value=l),(l,r)=>v.value?(t(),i("div",{key:0,tabindex:"0",onKeyup:r[2]||(r[2]=Me(c=>a("close"),["esc"])),class:"fixed top-0 left-0 w-full h-full z-10 bg-slate-500/50",onClick:r[3]||(r[3]=c=>a("close"))},[p("div",{class:"max-w-xl overflow-y-scroll max-h-screen mb-10 bg-white mx-auto mt-6 p-4 rounded shadow",onClick:r[1]||(r[1]=qe(()=>{},["stop"]))},[p("div",Qe,[p("div",{class:"ml-auto",onClick:r[0]||(r[0]=c=>a("close"))},"x")]),Le(l.$slots,"default")])],32)):y("",!0)}}),Xe={class:"justify-items-center mx-auto flex flex-wrap max-w-full"},Ye={key:0,class:"ml-auto"},Ze={key:0,class:"absolute right-0 top-0 w-4 h-4 rounded-square text-2xs bg-green-400 text-center"},et=p("div",{class:"mr-auto"},null,-1),Ae=V({__name:"ToggleButtonGroup",props:{choices:{},default:{},urlKey:{},url:{type:Boolean,default:!1},center:{type:Boolean,default:!1}},emits:["update"],setup(g,{emit:a}){const n=g,v=f(null),l=$e(),r=Ce(),c=e=>{if(a("update",e),v.value=e,n.url){const u=r.query,s=r.path,_=n.urlKey??"tab";console.log(_);const h={};h[_]=e;const w={...u,...h};l.push({path:s,query:w}),console.log(`route : ${JSON.stringify(r)}`)}};return N(()=>c(n.default??"")),(e,u)=>(t(),i("div",Xe,[e.center?(t(),i("div",Ye)):y("",!0),(t(!0),i(Y,null,Z(e.choices,s=>(t(),i("div",{class:"relative",key:s.value},[d(O,{class:"w-30 my-1 mx-1",text:s.text,onClick:_=>c(s.value),type:s.value==v.value?"valid":"abort"},null,8,["text","onClick","type"]),s.count?(t(),i("div",Ze,k(s.count),1)):y("",!0)]))),128)),et]))}});const tt={class:"bg-slate-100 border p-1 m-1 rounded shadow-xl"},lt={class:"flex"},ot={key:0,class:"text-xs mt-0.5 mb-1 font-bold flex"},st=["src"],nt={class:"my-auto"},at={class:"text-2xs italic ml-auto mr-1 my-auto"},rt={key:0},ut=["value"],it={class:"flex"},ct={key:1,class:"text-xs mt-0.5"},be=V({__name:"CommentCard",props:{editing:{type:Boolean},modelValue:{},author:{},createdAt:{}},emits:["update:modelValue","validate","abort"],setup(g,{emit:a}){const n=g,v=S(()=>n.createdAt?n.createdAt.toLocaleString("fr-FR",{hour:"numeric",weekday:"short",day:"numeric",month:"short",year:"2-digit"}):""),l=e=>{a("update:modelValue",e.target.value)},r=()=>{a("validate")},c=()=>{a("abort")};return(e,u)=>(t(),i("div",tt,[p("div",lt,[e.author?(t(),i("div",ot,[e.author.profile_picture_url?(t(),i("img",{key:0,class:"h-5 w-5 rounded-full mr-1",src:e.author.profile_picture_url},null,8,st)):y("",!0),p("div",nt,k(e.author.first_name)+" "+k(e.author.last_name),1)])):y("",!0),p("div",at,k(v.value),1)]),e.editing?(t(),i("div",rt,[p("textarea",{class:"w-full text-xs rounded-xl p-2",value:e.modelValue,onInput:l},null,40,ut),p("div",it,[d(O,{onClick:r,class:"text-sm",rounded:"",size:"2xs",text:"Commenter",type:"valid"}),d(O,{onClick:c,class:"text-sm",rounded:"",size:"2xs",text:"Annuler",type:"abort"})])])):(t(),i("div",ct,k(e.modelValue),1))]))}}),dt={class:"relative"},vt={key:0},mt=p("div",{class:"text-sm align-middle flex items-center p-2",style:{height:"50px"}}," Corriger une faute ",-1),pt={class:"flex mx-auto max-w-full"},ft={class:"w-full"},_t={key:0,class:"flex"},ht=p("div",{class:"w-6"},[p("div",{class:"rounded-full ml-4 mr-2 mt-2 h-1 w-1 bg-black"})],-1),gt=[ht],xt={class:"flex flex-wrap flex-1"},yt=["onClick","onContextmenu"],bt={key:0,style:{width:"5px"}},wt={key:1,style:{height:"25px"}},kt={key:2},$t=["onClick"],Ct={key:1,class:"absolute h-full",style:{right:"-2%",width:"27%"}},Rt={key:0,style:{width:"33%"}},It=V({__name:"TextInterface",props:{resourceId:{},fullText:{},extComments:{default:()=>[]},editable:{type:Boolean,default:!0}},emits:["change","changeComments"],setup(g,{emit:a}){const n=g,v=o=>{console.log("selectCursorPosition letter : ",o),n.editable&&(l.value={id:o.id,char:o.char})},l=f(null),r=f([]),c=f([]),e=async()=>{let o=[{id:0,words:[{id:0,text:[]}],comments:[]}],m=0,b=0;for(var A=0;A<r.value.length;A++){r.value[A].char==`
`&&(m+=1,b=0,o.push({id:m,words:[{id:0,text:[]}],lineStyle:A<r.value.length-1?r.value[A+1].char:null,comments:[]}));const U=D.value.find(z=>z.start_index==A);U&&o[m].comments.push(U),o[m].words[b].text.push({id:A,char:r.value[A].char,comment:U}),r.value[A].char==" "&&(b+=1,o[m].words.push({id:b,text:[]}))}return o},u=o=>{o==1?D.value.forEach(m=>{l.value&&m.start_index>l.value.id&&(m.start_index+=1),l.value&&m.end_index>l.value.id&&(m.end_index+=1)}):o==-1&&D.value.forEach(m=>{l.value&&m.start_index>=l.value.id&&(m.start_index-=1),l.value&&m.end_index>=l.value.id&&(m.end_index-=1)})},s=o=>{console.log("insertChar : ",o),l.value&&(console.log("insertChar with cursor set : ",o),r.value.filter(m=>l.value&&m.id>=l.value.id+1).forEach(m=>m.id+=1),r.value.splice(l.value.id+1,0,{id:l.value.id+1,char:o}),u(1),l.value.id+=1)},_=o=>{if(console.log("Writes : ",o.key),l.value===null)return;const m=o.key;if(h.value&&m=="v"){w();return}if(m.length==1)o.preventDefault(),s(m);else if(m=="Backspace")r.value.splice(l.value.id,1),r.value.filter(b=>l.value&&b.id>l.value.id).forEach(b=>b.id-=1),u(-1),l.value.id-=1;else if(m=="Enter")s(`
`);else if(m=="ArrowRight"){let b=l.value.id;b<r.value.length-1&&v(r.value[b+1])}else if(m=="ArrowLeft"){let b=l.value.id;b>0&&v(r.value[b-1])}else m=="Control"&&(console.log("Control"),h.value=!0)},h=f(!1),w=async()=>{try{let m=await navigator.clipboard.readText();console.log("Clippedtext : ",m);for(var o=0;o<m.length;o++)s(m[o])}catch(m){console.log("Error with clippboard : ",m)}},M=o=>{o.key=="Control"&&(h.value=!1)},{createComment:H,batchUpdateComments:G}=we(),{isMobile:K}=Re(),D=f([]),P=f(null),le=async o=>{D.value=o.filter(m=>m.start_index!=null)},Q=async()=>{if(console.log("Add Comment"),console.log(n.resourceId),console.log(j.value),!n.resourceId||!j.value)return;console.log("Add Comment 2");const o=await H(n.resourceId,j.value,j.value);D.value.push(o)};oe(D,async(o,m)=>{console.log("Watch comments triggered : ",o),W.value&&(console.log("Comments : ",o),a("changeComments",o),P.value!==null&&clearTimeout(P.value),P.value=setTimeout(()=>G(o),1e3)),console.log(`Old comments lenght : ${m.length} new length: ${o.length}`),console.log("OldComments : ",m),console.log("NewComments : ",o),m.length===0&&o.length>0&&(console.log("Finally loading comments"),c.value=await e())},{deep:!0}),oe(pe(n).extComments,async o=>{await le(o)});const J=f(!1),j=f(null),C=f({position:"absolute","z-index":90,top:"0px",left:"0px",height:"106px",width:"260px"}),{user:T}=te(),F=(o,m)=>{o.preventDefault(),T.value&&(l.value=null,C.value.top=`${o.layerY}px`,C.value.left=`${o.layerX}px`,J.value=!0,j.value=m,console.log("event : ",o),console.log("Have a new right click"))},he=o=>{if(r.value=[],o===void 0||o==""){r.value=[{id:0,char:`
`}],v({id:0,char:`
`});return}for(var m=0;m<o.length;m++){const b=D.value.find(A=>A.start_index==m);r.value.push({id:m,char:o[m],comment:b})}},de=o=>o.reduce((m,b)=>m+b.char,""),W=f(!1);return N(async()=>{await le(n.extComments),await he(n.fullText),await new Promise(o=>setTimeout(o,10)),c.value=await e(),W.value=!0}),oe(r,async o=>{console.log("Watch triggered : ",o),W.value&&(a("change",de(o)),c.value=await e())},{deep:!0}),(o,m)=>(t(),i("div",dt,[d(Ke,{text:o.fullText,class:"absolute z-10 h-6 right-2"},null,8,["text"]),W.value?(t(),i("div",{key:1,id:"main-interface",class:"relative md:p-4",tabindex:"0",onKeydown:_,onKeyup:M,onClick:m[0]||(m[0]=b=>J.value=!1)},[J.value?(t(),i("div",{key:0,class:"bg-white border-4",style:Pe(C.value)},[p("div",{onClick:Q,class:"text-sm border-b-2 flex items-center p-2",style:{height:"50px"}}," Ajouter un commentaire "),mt],4)):y("",!0),p("div",pt,[p("div",ft,[(t(!0),i(Y,null,Z(c.value,(b,A)=>(t(),i("div",{key:A,class:"flex"},[b.lineStyle=="*"?(t(),i("div",_t,gt)):y("",!0),p("div",xt,[(t(!0),i(Y,null,Z(b.words,(U,z)=>(t(),i("div",{key:z,class:"flex flex-wrap"},[(t(!0),i(Y,null,Z(U.text,(E,ve)=>{var me;return t(),i("div",{key:ve,class:ye(["border-blue-400",{"border-r-2":E.id==((me=l.value)==null?void 0:me.id),"bg-yellow-400":E.comment}]),onClick:se=>v(E),onContextmenu:se=>F(se,E.id)},[E.char==" "?(t(),i("div",bt)):E.char==`
`?(t(),i("div",wt)):(E.char=="#"||E.char=="*")&&z==0?(t(),i("div",kt)):(t(),i("div",{key:3,class:ye({"font-bold":b.lineStyle=="#"})},[p("div",null,k(E.char),1)],2))],42,yt)}),128))]))),128)),p("div",{class:"flex-1",onClick:U=>v(b.words.slice(-1)[0].text.slice(-1)[0])},null,8,$t)]),D.value.length>0&&!q(K)?(t(),i("div",Ct,[(t(!0),i(Y,null,Z(b.comments,(U,z)=>(t(),R(be,{key:z,class:"w-full",modelValue:U.content,"onUpdate:modelValue":E=>U.content=E,editing:U.editing,onValidate:E=>U.editing=!1,author:U.author,"created-at":U.created_at},null,8,["modelValue","onUpdate:modelValue","editing","onValidate","author","created-at"]))),128))])):y("",!0)]))),128))]),D.value.length>0&&!q(K)?(t(),i("div",Rt)):y("",!0)])],32)):(t(),i("div",vt,[p("span",null,k(o.fullText),1)]))]))}}),Vt=p("hr",{class:"border-top border-zinc-400 my-4"},null,-1),Tt=p("div",{class:"text-xs italic"},"Raison de la lecture",-1),Ut=V({__name:"SeeThoughtInput",props:{thoughtInput:{}},setup(g){const a=g,{getUserById:n,user:v}=te(),l=f(null),r=S(()=>v.value?a.thoughtInput.interaction_user_id===v.value.id:!1);return N(async()=>{a.thoughtInput.interaction_user_id&&(l.value=await n(a.thoughtInput.interaction_user_id))}),(c,e)=>(t(),i("div",null,[d(Be,{id:c.thoughtInput.resource_id,"second-level":""},null,8,["id"]),Vt,Tt,d(It,{"full-text":c.thoughtInput.interaction_comment,editable:r.value},null,8,["full-text","editable"])]))}}),At={class:"w-full md:w-96"},Et={key:0,class:"text-xs italic mb-2 bg-white"},Bt={class:"flex flex-wrap"},Dt={key:1,class:"text-2xs italic ml-2"},St={key:2,class:"ml-auto m-1 w-1/3"},Ot={key:0,class:"border shadow-lg rounded p-4 md:w-96 bg-white"},Ft={class:"flex"},Lt=["src"],qt={class:"flex flex-wrap w-full",style:{"margin-top":"-8px"}},Mt={class:"text-2xs"},Pt={class:"flex flex-wrap"},jt={key:0,class:"text-2xs italic"},zt=V({__name:"ThoughtInputCard",props:{contextualResource:{},isDisabled:{type:Boolean,default:!1}},setup(g){const a=g,{getUserById:n}=te(),{getAuthorInteractionForResource:v}=_e(),l=f(null),r=f(null),c=f(null);N(async()=>{a.contextualResource.user_id&&(c.value=await n(a.contextualResource.user_id)),a.contextualResource.resource&&(r.value=await v(a.contextualResource.resource.id)),r.value&&(l.value=await n(r.value.interaction_user_id))});const e=s=>s?s.toLocaleString("fr-FR",{hour:"numeric",weekday:"short",day:"numeric",month:"short",year:"2-digit"}):"",u=s=>s.length>200?s.slice(0,150)+"...":s;return(s,_)=>{const h=Ie("router-link");return t(),i("div",At,[s.contextualResource.context_comment?(t(),i("div",Et,[p("div",null,k(s.contextualResource.context_comment),1),p("div",Bt,[c.value?(t(),R(h,{key:0,to:"/users/"+c.value.id,class:"text-2xs underline"},{default:B(()=>[ie(k(c.value.first_name)+" "+k(c.value.last_name),1)]),_:1},8,["to"])):y("",!0),s.contextualResource.date?(t(),i("div",Dt,k(e(s.contextualResource.date)),1)):y("",!0),s.contextualResource.progress?(t(),i("div",St,[d(Ve,{"progress-value":s.contextualResource.progress},null,8,["progress-value"])])):y("",!0)])])):y("",!0),s.contextualResource.resource?(t(),R(je(s.isDisabled?"span":"vue-router"),{key:1,to:"/resources/"+s.contextualResource.resource.id+"?tab=ctnt"},{default:B(()=>[s.contextualResource.resource?(t(),i("div",Ot,[p("div",Ft,[s.contextualResource.resource?(t(),i("img",{key:0,class:"w-8 h-fit mr-4",src:s.contextualResource.resource.image_url},null,8,Lt)):y("",!0),p("div",null,[p("div",null,k(s.contextualResource.resource.title)+" "+k(s.contextualResource.resource.subtitle),1),p("div",qt,[l.value?(t(),R(h,{key:0,to:"/users/"+l.value.id,class:"text-2xs underline"},{default:B(()=>[ie(k(l.value.first_name)+" "+k(l.value.last_name),1)]),_:1},8,["to"])):y("",!0)]),p("div",Mt,k(u(s.contextualResource.resource.comment)),1)])]),p("div",Pt,[s.contextualResource.date?(t(),i("div",jt,k(e(s.contextualResource.resourcedate)),1)):y("",!0)])])):y("",!0)]),_:1},8,["to"])):y("",!0)])}}}),Nt={class:"w-fit"},Kt=V({__name:"ThoughtInputCardWithPopup",props:{thoughtInput:{},usageReason:{},isDisabled:{type:Boolean,default:!1}},setup(g){const a=f(!1);return(n,v)=>(t(),i("div",Nt,[d(re,{open:a.value,onClose:v[0]||(v[0]=l=>a.value=!1)},{default:B(()=>[d(Ut,{"thought-input":n.thoughtInput,"usage-reason":n.usageReason},null,8,["thought-input","usage-reason"])]),_:1},8,["open"]),d(zt,{class:"md:w-96","contextual-resource":n.thoughtInput,"is-disabled":n.isDisabled},null,8,["contextual-resource","is-disabled"])]))}}),Jt={class:"relative max-w-full"},Wt={key:0,class:"absolute md:border h-full start-1/2 -z-10"},ue=V({__name:"ThoughtInputsList",props:{contextualResources:{},center:{type:Boolean,default:!1},linksDisabled:{type:Boolean,default:!1}},emits:["select"],setup(g,{emit:a}){const n=l=>l.sort((r,c)=>+(c.date>r.date)),v=l=>{console.log("Select"),a("select",l)};return(l,r)=>(t(),i("div",Jt,[l.center?y("",!0):(t(),i("div",Wt)),(t(!0),i(Y,null,Z(n(l.contextualResources),(c,e)=>(t(),R(Kt,{key:c.id,class:ye(["mb-4 md:mb-1 mx-auto max-w-full max-w-fit p-1",{"md:ml-0":e%2==0&&!l.center,"md:mr-0":!l.center}]),"thought-input":c,onClick:u=>v(c),"is-disabled":l.linksDisabled},null,8,["class","thought-input","onClick","is-disabled"]))),128))]))}}),Ht={key:0,class:"mb-4"},Gt={key:1},Qt={key:1},Xt={key:2},Yt={class:"flex flex-row-reverse"},Ee=V({__name:"CreateResourceRelationForm",props:{targetResource:{},originResource:{}},emits:["close","refresh"],setup(g,{emit:a}){const n=g,{user:v}=te(),l=f(),r=C=>{console.log("Event : ",C),l.value=C},c=f([{text:"Externes",value:"extr"},{text:"Internes",value:"artl"},{text:"Problème",value:"pblm"}]),e=f([{text:"Biblio",value:"bibl"},{text:"Résumé",value:"sumr"},{text:"Sujet principal",value:"main"},{text:"Evocation",value:"mino"}]),u=f([]),s=f(null),_=f([]),h=f([]),w=f([]),M=f(""),H=f(""),{createResourceRelation:G}=Te(),{getResources:K}=_e(),D=S(()=>u.value.map(C=>({resource:C.resource}))),P=C=>C.map(T=>({resource:T})),le=S(()=>({extr:P(_.value),artl:P(h.value),pblm:P(w.value)})),Q=async()=>{if(console.log("create"),!s.value)return;const C={target_resource_id:n.targetResource?n.targetResource.id:s.value.id,origin_resource_id:n.originResource?n.originResource.id:s.value.id,relation_comment:M.value,relation_type:H.value};await G(C),a("refresh"),a("close")},{getUserInteractions:J}=ce(),j=C=>{s.value=C.resource};return N(async()=>{!v.value||!v.value.id||(n.targetResource&&(u.value=await J(v.value.id)),n.originResource&&(_.value=await K({is_external:!0}),h.value=await K({is_external:!1,resource_type:"oatc"}),w.value=await K({is_external:!1,resource_type:"pblm"})))}),(C,T)=>(t(),i("div",null,[q(v)?(t(),i("div",Ht," Nouvelle relation entre ressources par "+k(q(v).first_name)+" "+k(q(v).last_name),1)):y("",!0),s.value?(t(),i("div",Xt,[d(ae,{class:"m-4",label:"Type de lien",choices:e.value,modelValue:H.value,"onUpdate:modelValue":T[2]||(T[2]=F=>H.value=F)},null,8,["choices","modelValue"]),d(fe,{class:"m-4",label:"Pourquoi ajouter cet élément ?",modelValue:M.value,"onUpdate:modelValue":T[3]||(T[3]=F=>M.value=F)},null,8,["modelValue"]),p("div",Yt,[d(O,{type:"valid",onClick:Q,text:"Ajouter"}),d(O,{type:"abort",onClick:T[4]||(T[4]=F=>a("close")),text:"Annuler",class:"mr-1"})])])):(t(),i("div",Gt,[C.targetResource?(t(),R(ue,{key:0,"contextual-resources":D.value,center:"","links-disabled":"",onSelect:T[0]||(T[0]=F=>j(F))},null,8,["contextual-resources"])):(t(),i("div",Qt,[p("div",null,[ie(" Choisir une ressource cible "),d(Ae,{center:"",choices:c.value,default:"pblm",onUpdate:r},null,8,["choices"]),d(ue,{"contextual-resources":le.value[l.value]||[],center:"",onSelect:T[1]||(T[1]=F=>j(F)),"links-disabled":""},null,8,["contextual-resources"])])]))]))]))}}),Zt={class:"flex flex-wrap"},el={class:"flex flex-row-reverse"},tl=V({__name:"CreateInteraction",props:{resource:{}},emits:["close","refresh"],setup(g,{emit:a}){const n=g,v=f([{text:"Lecture / Visionage",value:"inpt"},{text:"Envie",value:"wish"}]),{newInteraction:l,createInteractionForResource:r}=ce(),{user:c}=te(),e=f(l());N(()=>{e.value.interaction_type||(e.value.interaction_type="inpt")});const u=()=>{e.value.resource_id=n.resource.id,e.value.interaction_user_id=c.value.id,r(n.resource.id,e.value),a("refresh"),s()},s=()=>a("close");return(_,h)=>(t(),i("div",null,[p("div",null,"Nouvelle interaction, avec la ressource : "+k(_.resource.title),1),p("div",Zt,[d(ee,{label:"Avancement de l'ouvrage",class:"my-auto",modelValue:e.value.interaction_progress,"onUpdate:modelValue":h[0]||(h[0]=w=>e.value.interaction_progress=w),type:"number"},null,8,["modelValue"]),d(ae,{label:"Type d'interaction",class:"m-4 w-full md:w-5/12 md:ml-auto",choices:v.value,modelValue:e.value.interaction_type,"onUpdate:modelValue":h[1]||(h[1]=w=>e.value.interaction_type=w)},null,8,["choices","modelValue"])]),d(ee,{label:"Date de lecture",modelValue:e.value.interaction_date,"onUpdate:modelValue":h[2]||(h[2]=w=>e.value.interaction_date=w),type:"date"},null,8,["modelValue"]),d(fe,{label:"Pourquoi s'y être interessé ?",modelValue:e.value.interaction_comment,"onUpdate:modelValue":h[3]||(h[3]=w=>e.value.interaction_comment=w)},null,8,["modelValue"]),p("div",el,[d(O,{onClick:u,class:"m-4",text:"Valider",type:"valid"}),d(O,{onClick:s,class:"m-4",text:"Annuler",type:"abort"})])]))}}),ll=p("div",null,"Demander une Review pour l'article :",-1),ol={class:"flex flex-row-reverse mt-4"},sl=V({__name:"CreateReview",props:{resource:{}},emits:["close","refresh"],setup(g,{emit:a}){const n=g,{newInteraction:v,createInteractionForResource:l}=ce(),r=async()=>{const u=v();u.interaction_user_id=e.value,u.resource_id=n.resource.id,u.interaction_type="rvew",u.interaction_comment=c.value,await l(n.resource.id,u),a("refresh"),a("close")},c=f(""),e=f(null);return(u,s)=>(t(),i("div",null,[ll,p("div",null,k(u.resource.title),1),d(Ue,{modelValue:e.value,"onUpdate:modelValue":s[0]||(s[0]=_=>e.value=_)},null,8,["modelValue"]),d(fe,{class:"mt-4",label:"Message pour la review",modelValue:c.value,"onUpdate:modelValue":s[1]||(s[1]=_=>c.value=_)},null,8,["modelValue"]),p("div",ol,[d(O,{type:"valid",onClick:r,text:"Ajouter"}),d(O,{type:"abort",onClick:s[2]||(s[2]=_=>a("close")),text:"Annuler",class:"mr-1"})])]))}}),nl=V({__name:"ResourceTools",props:{resource:{},isResourceEditable:{type:Boolean}},emits:["refresh","edit"],setup(g,{emit:a}){const n=f(!1),v=f(!1),l=f(!1),r=f(!1);return(c,e)=>(t(),i("div",null,[c.isResourceEditable&&n.value?(t(),R(ne,{key:0,title:"Modifier",onClick:e[0]||(e[0]=u=>a("edit"))},{default:B(()=>[d(q(ze),{class:"m-1"})]),_:1})):y("",!0),c.isResourceEditable&&n.value?(t(),R(ne,{key:1,class:"mt-2",color:"blue",title:"Demander une review",onClick:e[1]||(e[1]=u=>v.value=!0)},{default:B(()=>[d(q(Ne),{class:"m-1"})]),_:1})):y("",!0),d(re,{open:v.value,onClose:e[4]||(e[4]=u=>v.value=!1)},{default:B(()=>[d(sl,{onRefresh:e[2]||(e[2]=u=>a("refresh")),onClose:e[3]||(e[3]=u=>v.value=!1),resource:c.resource},null,8,["resource"])]),_:1},8,["open"]),c.isResourceEditable&&n.value?(t(),R(ne,{key:2,class:"mt-2",color:"red",title:"Marquer comme lu",onClick:e[5]||(e[5]=u=>l.value=!0)},{default:B(()=>[d(q(We),{class:"m-1"})]),_:1})):y("",!0),d(re,{open:l.value,onClose:e[8]||(e[8]=u=>l.value=!1)},{default:B(()=>[d(tl,{onRefresh:e[6]||(e[6]=u=>a("refresh")),onClose:e[7]||(e[7]=u=>l.value=!1),resource:c.resource},null,8,["resource"])]),_:1},8,["open"]),c.isResourceEditable&&n.value?(t(),R(ne,{key:3,class:"mt-2",color:"green",title:"Relier à d'autres ressources",onClick:e[9]||(e[9]=u=>r.value=!0)},{default:B(()=>[d(q(He),{class:"m-1"})]),_:1})):y("",!0),d(re,{open:r.value,onClose:e[12]||(e[12]=u=>r.value=!1)},{default:B(()=>[d(Ee,{onRefresh:e[10]||(e[10]=u=>a("refresh")),onClose:e[11]||(e[11]=u=>r.value=!1),"origin-resource":c.resource},null,8,["origin-resource"])]),_:1},8,["open"]),d(ne,{class:"mt-2",color:"gray",onClick:e[13]||(e[13]=u=>n.value=!n.value)},{default:B(()=>[d(q(Ge))]),_:1})]))}}),al=V({__name:"CommentsThread",props:{resourceId:{}},setup(g){const a=g,{user:n}=te(),v=f([]),{createComment:l,getCommentsForThoughtOutput:r}=we(),c=async()=>{console.log("Comment thread"),console.log("Props id : ",a.resourceId),v.value=await r(a.resourceId)},e=S(()=>v.value.filter(_=>!_.start_index).sort((_,h)=>_.created_at-h.created_at)),u=f(""),s=async()=>{await l(a.resourceId,null,null,u.value,!1),u.value="",await c()};return N(async()=>await c()),(_,h)=>(t(),i("div",null,[(t(!0),i(Y,null,Z(e.value,w=>(t(),R(be,{key:w.id,class:"w-full",modelValue:w.content,"onUpdate:modelValue":M=>w.content=M,editing:w.editing,onValidate:M=>w.editing=!1,author:w.author,"created-at":w.created_at},null,8,["modelValue","onUpdate:modelValue","editing","onValidate","author","created-at"]))),128)),d(be,{class:"w-full",modelValue:u.value,"onUpdate:modelValue":h[0]||(h[0]=w=>u.value=w),editing:!0,onValidate:s,author:q(n),"created-at":null},null,8,["modelValue","author"])]))}}),rl=V({__name:"DateField",props:{date:{}},setup(g){const a=g,n=S(()=>new Date(a.date).toLocaleDateString("fr-FR",{day:"numeric",month:"short",year:"numeric"}));return(v,l)=>(t(),i("div",null,k(n.value),1))}}),ul={class:"flex flex-col"},il={class:"block text-2xs text-slate-800"},cl=["value","placeholder"],dl=V({__name:"NumberInput",props:{label:{},modelValue:{},placeholder:{}},emits:["update:modelValue","input"],setup(g,{emit:a}){const n=v=>{a("update:modelValue",v.target.value),a("input",v.target.value)};return(v,l)=>(t(),i("div",ul,[p("label",il,k(v.label),1),p("input",{class:"border border-neutral-400 block h-full w-full rounded-md border-2 p-1 pl-2 text-xs",type:"number",value:v.modelValue,placeholder:v.placeholder,onInput:l[0]||(l[0]=r=>n(r))},null,40,cl)]))}}),vl={class:"grid grid-cols-4 gap-y-2 gap-x-4 auto-rows-auto"},ml=V({__name:"ResourceForm",props:{article:{}},emits:["change"],setup(g,{emit:a}){const n=g,v=f([{text:"Terminé",value:"fnsh"},{text:"Relecture",value:"rvew"},{text:"Brouillon",value:"drft"},{text:"Poubelle",value:"trsh"}]),{resourceTypeOptions:l}=_e(),r=(c,e)=>{let u={...n.article};u[c]=e,u.is_external&&(u.maturing_state="fnsh"),console.log("Article : ",u),a("change",u)};return(c,e)=>(t(),i("div",vl,[d(ee,{class:"col-span-4",label:"Titre",modelValue:c.article.title,"onUpdate:modelValue":e[0]||(e[0]=u=>r("title",u))},null,8,["modelValue"]),d(ee,{class:"col-span-4",label:"Sous-titre",modelValue:c.article.subtitle,"onUpdate:modelValue":e[1]||(e[1]=u=>r("subtitle",u))},null,8,["modelValue"]),d(ee,{class:"col-span-4 md:col-span-2",label:"Lien contenu externe",modelValue:c.article.external_content_url,"onUpdate:modelValue":e[2]||(e[2]=u=>r("external_content_url",u))},null,8,["modelValue"]),d(ee,{class:"col-span-4 md:col-span-2",label:"Lien image",modelValue:c.article.image_url,"onUpdate:modelValue":e[3]||(e[3]=u=>r("image_url",u))},null,8,["modelValue"]),d(ae,{label:"Type de ressource",class:"col-span-4 md:col-span-2",choices:q(l),"onUpdate:modelValue":e[4]||(e[4]=u=>r("resource_type",u)),"model-value":c.article.resource_type},null,8,["choices","model-value"]),d(ae,{label:"Ressource externe",class:"col-span-4 md:col-span-1",choices:[{text:"Oui",value:!0},{text:"Non",value:!1}],"onUpdate:modelValue":e[5]||(e[5]=u=>r("is_external",JSON.parse(u))),"model-value":c.article.is_external},null,8,["model-value"]),d(ae,{label:"Stade d'écriture",class:"col-span-4 md:col-span-1",choices:v.value,"model-value":c.article.maturing_state,"onUpdate:modelValue":e[6]||(e[6]=u=>r("maturing_state",u))},null,8,["choices","model-value"])]))}}),pl={class:"grid grid-cols-3 gap-4"},fl=V({__name:"ResourceAuthorPicker",props:{interaction:{},resourceId:{}},emits:["update"],setup(g,{emit:a}){const n=g,v=S(()=>{var s;return(s=n.interaction)==null?void 0:s.interaction_user_id}),{createInteractionForResource:l,newInteraction:r,updateInteraction:c}=ce(),e=async s=>{if(console.log(`newUser : ${JSON.stringify(s)}`),n.interaction){const _={...n.interaction};_.interaction_user_id=s,console.log("newUserid : ",s.id),console.log(`Interaction payload : ${JSON.stringify(_)}`),await c(n.interaction.id,_),a("update")}else{console.log("create interaction");const _=r();_.interaction_user_id=s,_.resource_id=n.resourceId,await l(n.resourceId,_),a("update")}},u=async s=>{await c(n.interaction.id,s),a("update")};return(s,_)=>(t(),i("div",pl,[d(Ue,{"model-value":v.value,"onUpdate:modelValue":_[0]||(_[0]=h=>e(h))},null,8,["model-value"]),s.interaction?(t(),R(ee,{key:0,class:"text-2xs",label:"Date d'écriture","model-value":s.interaction.interaction_date?s.interaction.interaction_date.split("T")[0]:null,"onUpdate:modelValue":_[1]||(_[1]=h=>u({...s.interaction,interaction_date:h})),type:"date"},null,8,["model-value"])):y("",!0),s.interaction?(t(),R(dl,{key:1,class:"",label:"Progression",modelValue:s.interaction.interaction_progress,"onUpdate:modelValue":_[2]||(_[2]=h=>u({...s.interaction,interaction_progress:h}))},null,8,["modelValue"])):y("",!0)]))}}),_l={key:0,class:"text-center text-2xl pt-10"},hl={key:1},gl={key:0},xl={class:"my-8"},yl=["src"],bl={class:"text-3xl my-3 font-mplus md:text-center text-left"},wl={class:"md:text-center text-left"},kl={class:"md:text-center text-left"},$l={class:"md:flex my-8"},Cl=["href"],Rl={key:1,class:"my-2 flex flex-col"},Il={class:"flex flex-row-reverse mb-4"},Vl=p("hr",{class:"border-top border-zinc-400 my-4"},null,-1),Tl={key:2},Ul=p("div",{class:"text-xs italic"},"Contenu",-1),Al={key:3},El={key:4},Bl={key:5},Be=V({__name:"ResourceComponent",props:{resourceId:{},secondLevel:{type:Boolean}},setup(g){const a=g,n=Ce(),v=S(()=>A.value&&b.value||!C.value||o.value.is_local_draft||!c.value),l=S(()=>a.secondLevel?"popup_tab":"tab"),r=S(()=>[{text:"Contenu",value:"ctnt"},{text:"Biblio",value:"bbli",count:h.value.length},{text:"Sujets",value:"pblm",count:Q.value.length},{text:"Interactions",value:"inpt",count:G.value.length}]),c=f(!0),e=f(n.query[l.value]&&typeof n.query[l.value]=="string"?n.query[l.value]:"ctnt"),u=f(n.query[l.value]);oe(()=>n.query[l.value],x=>{console.log("new route query",x),typeof x=="string"&&(u.value=x)});const{getResourceRelationsForResource:s,getUsagesForResource:_}=Te(),h=f([]),w=f(!1),M=async()=>{h.value=await s(pe(a).resourceId.value)},H=S(()=>h.value.map(x=>({resource:x.origin_resource,date:x.created_at,user_id:x.user_id,context_comment:x.relation_comment,progress:null}))),G=f([]),{getInteractionsForResource:K,updateInteraction:D}=ce(),P=async()=>{G.value=await K(a.resourceId)},le=S(()=>G.value.map(x=>({resource:null,date:x.interaction_date,user_id:x.interaction_user_id,context_comment:x.interaction_comment,progress:x.interaction_progress}))),Q=f([]),J=async()=>{Q.value=await _(a.resourceId)},j=S(()=>Q.value.map(x=>({resource:x.target_resource,date:x.created_at,user_id:x.user_id,context_comment:x.relation_comment,progress:null}))),C=f(!1),{newResource:T,getResource:F,updateResource:he,getAuthorInteractionForResource:de}=_e(),W=f(null),o=f(T()),m=$e();oe(()=>n.query.editing,x=>{console.log("Editing : ",x),b.value=x==="false"?!1:!!x});const b=f(!1),{isMobile:A}=Re(),U=x=>{m.push({query:{editing:x.toString()}})},z=(x,$)=>{o.value=$,W.value!==null&&clearTimeout(W.value),W.value=setTimeout(async()=>{try{await he(x,o.value)}catch(xe){console.log("An error : ",xe)}},1e3)},E=x=>{x!=`
`&&z(pe(a).resourceId.value,{...o.value,content:x})},{user:ve,getUserById:me}=te(),se=S(()=>o.value.is_external?!0:ve.value?X.value?X.value.id==ve.value.id:!0:!1),X=f(null),I=f(null),ge=async()=>{I.value=await de(a.resourceId)},De=async()=>{!I.value||!I.value.id||(await D(I.value.id,{...I.value,interaction_is_public:!0}),ge())},Se=async()=>{!I.value||!I.value.id||(await D(I.value.id,{...I.value,interaction_is_public:!1}),ge())},{getCommentsForThoughtOutput:Oe}=we(),ke=f([]);return N(async()=>{C.value=!1,o.value=await F(a.resourceId),C.value=!0,await M(),await P(),await J(),ke.value=await Oe(a.resourceId),I.value=await de(a.resourceId),I.value&&(X.value=await me(I.value.interaction_user_id));const x=n.query.editing;b.value=x==="false"?!1:!!x}),(x,$)=>{const xe=Ie("router-link");return t(),i("div",null,[C.value?(t(),i("div",hl,[b.value?(t(),i("div",Rl,[d(ml,{article:o.value,class:"",onChange:$[0]||($[0]=L=>z(o.value.id,L))},null,8,["article"]),d(fl,{class:"my-2",interaction:I.value,"resource-id":x.resourceId,onChange:ge},null,8,["interaction","resource-id"]),p("div",Il,[d(O,{class:"ml-2",onClick:$[1]||($[1]=L=>U(!1)),type:"valid",text:"Preview"},{default:B(()=>[ie("Ok")]),_:1}),I.value&&!I.value.interaction_is_public?(t(),R(O,{key:0,class:"ml-2",onClick:De,type:"valid",text:"Publier"})):I.value?(t(),R(O,{key:1,class:"ml-2",onClick:Se,type:"abort",text:"Dépublier"})):y("",!0),d(O,{class:"ml-2",onClick:$[2]||($[2]=L=>c.value=!c.value),type:"valid",text:c.value?"Text brut":"Editeur"},null,8,["text"])])])):(t(),i("div",gl,[p("div",xl,[p("img",{src:o.value.image_url,class:"border border-slate-300 dark:border-zinc-700 rounded-xl ml-auto mr-auto",style:{"max-height":"20rem"}},null,8,yl)]),p("h1",bl,k(o.value.title),1),p("div",wl,k(o.value.subtitle),1),p("div",kl,[X.value?(t(),R(xe,{key:0,to:"/users/"+X.value.id,class:"text-sm underline"},{default:B(()=>[ie(k(X.value.first_name)+" "+k(X.value.last_name),1)]),_:1},8,["to"])):y("",!0),I.value?(t(),R(rl,{key:1,date:I.value.interaction_date},null,8,["date"])):y("",!0)]),p("div",$l,[I.value?(t(),R(Ve,{key:0,"progress-value":I.value.interaction_progress,class:"m-2 w-1/3"},null,8,["progress-value"])):y("",!0),o.value.external_content_url?(t(),i("a",{key:1,class:"ml-auto underline",href:o.value.external_content_url,target:"_blank"}," Lien ressource externe ",8,Cl)):y("",!0)])])),p("div",null,[b.value?y("",!0):(t(),R(Ae,{key:0,choices:r.value,default:e.value,"url-key":l.value,url:""},null,8,["choices","default","url-key"]))]),Vl,u.value=="ctnt"?(t(),i("div",Tl,[Ul,v.value?(t(),R(fe,{key:0,class:"mt-4 h-96",modelValue:o.value.content,"onUpdate:modelValue":$[3]||($[3]=L=>E(L))},null,8,["modelValue"])):(t(),R(Je,{key:1,class:"min-h-fit","ext-comments":ke.value,"resource-id":o.value.id,text:o.value.content,editable:se.value,onChange:$[4]||($[4]=L=>E(L))},null,8,["ext-comments","resource-id","text","editable"])),d(al,{class:"mt-6","resource-id":x.resourceId},null,8,["resource-id"])])):u.value=="bbli"?(t(),i("div",Al,[d(re,{open:w.value,onClose:$[6]||($[6]=L=>w.value=!1)},{default:B(()=>[d(Ee,{onRefresh:M,onClose:$[5]||($[5]=L=>w.value=!1),"target-resource":o.value},null,8,["target-resource"])]),_:1},8,["open"]),p("div",{onClick:$[7]||($[7]=L=>w.value=!0),class:"text-sm italic underline"}," Ajouter une référence "),d(ue,{"contextual-resources":H.value},null,8,["contextual-resources"])])):u.value=="pblm"?(t(),i("div",El,[d(ue,{"contextual-resources":j.value},null,8,["contextual-resources"])])):u.value=="inpt"?(t(),i("div",Bl,[d(ue,{"contextual-resources":le.value},null,8,["contextual-resources"])])):y("",!0),d(nl,{class:"fixed right-3 bottom-5",resource:o.value,"is-resource-editable":se.value,onRefresh:$[8]||($[8]=L=>J()&&P()),onEdit:$[9]||($[9]=L=>U(!0))},null,8,["resource","is-resource-editable"])])):(t(),i("div",_l,"Loading..."))])}}}),jl=V({__name:"SeeResourceView",props:{id:{}},setup(g){return(a,n)=>(t(),i("div",null,[d(Be,{class:"md:px-8 px-4","resource-id":a.id},null,8,["resource-id"])]))}});export{jl as default};
