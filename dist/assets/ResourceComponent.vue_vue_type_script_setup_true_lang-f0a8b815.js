import{_ as Te,u as Pe}from"./useArticle-a0887fe5.js";import{_ as fe}from"./RoundLinkButton.vue_vue_type_style_index_0_lang-d194c586.js";import{o as t,f as n,a as m,d as F,h as A,m as k,t as $,i as d,q as ye,A as Le,p as X,b as v,j as ue,B as he,e as Z,C as Ne,F as oe,g as le,n as j,D as ge,c as C,y as Ue,r as Ae,w as O,l as ce,E as qe,_ as se,G as je,u as ze,k as Me}from"./index-833bea60.js";import{_ as L}from"./ActionButton.vue_vue_type_script_setup_true_lang-809d7c01.js";import{_ as pe,a as be,u as We,r as He}from"./useThoughtInputs-f393d585.js";import{a as Je,_ as Ke}from"./SelectionTextInterface.vue_vue_type_script_setup_true_lang-7e458faf.js";import{_ as Q}from"./TextInput.vue_vue_type_script_setup_true_lang-e259b9dc.js";import{u as we}from"./useInteraction-9ba15714.js";import"./SelectionTextInterface.vue_vue_type_style_index_0_lang-1a8a3cbd.js";import{_ as De}from"./ProgressBar.vue_vue_type_script_setup_true_lang-5b60d855.js";import{_ as Ge}from"./UserPicker.vue_vue_type_script_setup_true_lang-a175e3ab.js";import{u as ke}from"./useResource-a65cf681.js";import{u as Fe}from"./useResourceRelations-9899c3b8.js";import{u as Xe}from"./useProblem-62a4b7b6.js";function Ye(_,l){return t(),n("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true"},[m("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M9 8.25H7.5a2.25 2.25 0 00-2.25 2.25v9a2.25 2.25 0 002.25 2.25h9a2.25 2.25 0 002.25-2.25v-9a2.25 2.25 0 00-2.25-2.25H15M9 12l3 3m0 0l3-3m-3 3V2.25"})])}function Qe(_,l){return t(),n("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true"},[m("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M7.217 10.907a2.25 2.25 0 100 2.186m0-2.186c.18.324.283.696.283 1.093s-.103.77-.283 1.093m0-2.186l9.566-5.314m-9.566 7.5l9.566 5.314m0 0a2.25 2.25 0 103.935 2.186 2.25 2.25 0 00-3.935-2.186zm0-12.814a2.25 2.25 0 103.933-2.185 2.25 2.25 0 00-3.933 2.185z"})])}const Ze={class:"bg-slate-100 border p-1 m-1 rounded shadow-xl"},et={class:"flex"},tt={key:0,class:"text-xs mt-0.5 mb-1 font-bold flex"},ot=["src"],lt={class:"my-auto"},st={class:"text-2xs italic ml-auto mr-1 my-auto"},at={key:0},nt=["value"],rt={class:"flex"},ut={key:1,class:"text-xs mt-0.5"},xe=F({__name:"CommentCard",props:{editing:{type:Boolean},modelValue:{},author:{},createdAt:{}},emits:["update:modelValue","validate","abort"],setup(_,{emit:l}){const a=_,c=A(()=>a.createdAt?a.createdAt.toLocaleString("fr-FR",{hour:"numeric",weekday:"short",day:"numeric",month:"short",year:"2-digit"}):""),o=r=>{l("update:modelValue",r.target.value)},p=()=>{l("validate")},f=()=>{l("abort")};return(r,g)=>(t(),n("div",Ze,[m("div",et,[r.author?(t(),n("div",tt,[r.author.profile_picture_url?(t(),n("img",{key:0,class:"h-5 w-5 rounded-full mr-1",src:r.author.profile_picture_url},null,8,ot)):k("",!0),m("div",lt,$(r.author.first_name)+" "+$(r.author.last_name),1)])):k("",!0),m("div",st,$(c.value),1)]),r.editing?(t(),n("div",at,[m("textarea",{class:"w-full text-xs rounded-xl p-2",value:r.modelValue,onInput:o},null,40,nt),m("div",rt,[d(L,{onClick:p,class:"text-sm",rounded:"",size:"2xs",text:"Commenter",type:"valid"}),d(L,{onClick:f,class:"text-sm",rounded:"",size:"2xs",text:"Annuler",type:"abort"})])])):(t(),n("div",ut,$(r.modelValue),1))]))}}),{launchSnackbar:$e}=Le(),it=async(_,l,a,c)=>{const{user:o}=X(),p={start_index:l,end_index:l,content:a,editing:c};try{const f=await ye.post("/resources/"+_+"/comments",p),r=Ce(f.data);return o.value&&r.author_id==o.value.id&&(r.author=o.value),r}catch(f){throw console.log("error : ",f),$e(`Error creating comment : ${f}`,"error"),f}},Ce=_=>(_.updated_at=new Date(_.updated_at.split(".")[0]),_.created_at=new Date(_.created_at.split(".")[0]),_),ct=async(_,l=!0)=>{const a=l?"?author=true":"";try{return(await ye.get("/resources/"+_+"/comments"+a)).data.map(o=>Ce(o))}catch(c){throw console.log("error : ",c),$e(`Error getting comments : ${c}`,"error"),c}},Se=async _=>{try{const l=await ye.put("/comments/"+_.id,_);return Ce(l.data)}catch(l){console.log("error : ",l),$e(`Error updating comment : ${l}`,"error")}},dt=async _=>{console.log("comments : ",_),_.map(l=>Se(l))};function Re(){return{createComment:it,getCommentsForThoughtOutput:ct,updateComment:Se,batchUpdateComments:dt}}const vt={class:"relative"},mt={key:0},pt=m("div",{class:"text-sm align-middle flex items-center p-2",style:{height:"50px"}}," Corriger une faute ",-1),_t={class:"flex mx-auto max-w-full"},ft={class:"w-full"},ht={key:0,class:"flex"},gt=m("div",{class:"w-6"},[m("div",{class:"rounded-full ml-4 mr-2 mt-2 h-1 w-1 bg-black"})],-1),xt=[gt],yt={class:"flex flex-wrap flex-1"},bt=["onClick","onContextmenu"],wt={key:0,style:{width:"5px"}},kt={key:1,style:{height:"25px"}},$t={key:2},Ct=["onClick"],Rt={key:1,class:"absolute h-full",style:{right:"-2%",width:"27%"}},It={key:0,style:{width:"33%"}},Vt=F({__name:"TextInterface",props:{resourceId:{},fullText:{},extComments:{default:()=>[]},editable:{type:Boolean,default:!0}},emits:["change","changeComments"],setup(_,{emit:l}){const a=_,c=e=>{console.log("selectCursorPosition letter : ",e),a.editable&&(o.value={id:e.id,char:e.char})},o=v(null),p=v([]),f=v([]),r=async()=>{let e=[{id:0,words:[{id:0,text:[]}],comments:[]}],u=0,w=0;for(var U=0;U<p.value.length;U++){p.value[U].char==`
`&&(u+=1,w=0,e.push({id:u,words:[{id:0,text:[]}],lineStyle:U<p.value.length-1?p.value[U+1].char:null,comments:[]}));const T=B.value.find(G=>G.start_index==U);T&&e[u].comments.push(T),e[u].words[w].text.push({id:U,char:p.value[U].char,comment:T}),p.value[U].char==" "&&(w+=1,e[u].words.push({id:w,text:[]}))}return e},g=e=>{e==1?B.value.forEach(u=>{o.value&&u.start_index>o.value.id&&(u.start_index+=1),o.value&&u.end_index>o.value.id&&(u.end_index+=1)}):e==-1&&B.value.forEach(u=>{o.value&&u.start_index>=o.value.id&&(u.start_index-=1),o.value&&u.end_index>=o.value.id&&(u.end_index-=1)})},s=e=>{console.log("insertChar : ",e),o.value&&(console.log("insertChar with cursor set : ",e),p.value.filter(u=>o.value&&u.id>=o.value.id+1).forEach(u=>u.id+=1),p.value.splice(o.value.id+1,0,{id:o.value.id+1,char:e}),g(1),o.value.id+=1)},i=e=>{if(console.log("Writes : ",e.key),o.value===null)return;const u=e.key;if(h.value&&u=="v"){y();return}if(u.length==1)e.preventDefault(),s(u);else if(u=="Backspace")p.value.splice(o.value.id,1),p.value.filter(w=>o.value&&w.id>o.value.id).forEach(w=>w.id-=1),g(-1),o.value.id-=1;else if(u=="Enter")s(`
`);else if(u=="ArrowRight"){let w=o.value.id;w<p.value.length-1&&c(p.value[w+1])}else if(u=="ArrowLeft"){let w=o.value.id;w>0&&c(p.value[w-1])}else u=="Control"&&(console.log("Control"),h.value=!0)},h=v(!1),y=async()=>{try{let u=await navigator.clipboard.readText();console.log("Clippedtext : ",u);for(var e=0;e<u.length;e++)s(u[e])}catch(u){console.log("Error with clippboard : ",u)}},S=e=>{e.key=="Control"&&(h.value=!1)},{createComment:z,batchUpdateComments:ae}=Re(),{isMobile:M}=Ue(),B=v([]),W=v(null),ee=async e=>{B.value=e.filter(u=>u.start_index!=null)},N=async()=>{if(console.log("Add Comment"),console.log(a.resourceId),console.log(J.value),!a.resourceId||!J.value)return;console.log("Add Comment 2");const e=await z(a.resourceId,J.value);B.value.push(e)};ue(B,async(e,u)=>{console.log("Watch comments triggered : ",e),K.value&&(console.log("Comments : ",e),l("changeComments",e),W.value!==null&&clearTimeout(W.value),W.value=setTimeout(()=>ae(e),1e3)),console.log(`Old comments lenght : ${u.length} new length: ${e.length}`),console.log("OldComments : ",u),console.log("NewComments : ",e),u.length===0&&e.length>0&&(console.log("Finally loading comments"),f.value=await r())},{deep:!0}),ue(he(a).extComments,async e=>{await ee(e)});const H=v(!1),J=v(null),P=v({position:"absolute","z-index":90,top:"0px",left:"0px",height:"106px",width:"260px"}),{user:te}=X(),V=(e,u)=>{e.preventDefault(),te.value&&(o.value=null,P.value.top=`${e.layerY}px`,P.value.left=`${e.layerX}px`,H.value=!0,J.value=u,console.log("event : ",e),console.log("Have a new right click"))},R=e=>{if(p.value=[],e===void 0||e==""){p.value=[{id:0,char:`
`}],c({id:0,char:`
`});return}for(var u=0;u<e.length;u++){const w=B.value.find(U=>U.start_index==u);p.value.push({id:u,char:e[u],comment:w})}},E=e=>e.reduce((u,w)=>u+w.char,""),K=v(!1);return Z(async()=>{await ee(a.extComments),await R(a.fullText),await new Promise(e=>setTimeout(e,10)),f.value=await r(),K.value=!0}),ue(p,async e=>{console.log("Watch triggered : ",e),K.value&&(l("change",E(e)),f.value=await r())},{deep:!0}),(e,u)=>(t(),n("div",vt,[d(Je,{text:e.fullText,class:"absolute z-10 h-6 right-2"},null,8,["text"]),K.value?(t(),n("div",{key:1,id:"main-interface",class:"relative md:p-4",tabindex:"0",onKeydown:i,onKeyup:S,onClick:u[0]||(u[0]=w=>H.value=!1)},[H.value?(t(),n("div",{key:0,class:"bg-white border-4",style:Ne(P.value)},[m("div",{onClick:N,class:"text-sm border-b-2 flex items-center p-2",style:{height:"50px"}}," Ajouter un commentaire "),pt],4)):k("",!0),m("div",_t,[m("div",ft,[(t(!0),n(oe,null,le(f.value,(w,U)=>(t(),n("div",{key:U,class:"flex"},[w.lineStyle=="*"?(t(),n("div",ht,xt)):k("",!0),m("div",yt,[(t(!0),n(oe,null,le(w.words,(T,G)=>(t(),n("div",{key:G,class:"flex flex-wrap"},[(t(!0),n(oe,null,le(T.text,(D,de)=>{var ne;return t(),n("div",{key:de,class:ge(["border-blue-400",{"border-r-2":D.id==((ne=o.value)==null?void 0:ne.id),"bg-yellow-400":D.comment}]),onClick:re=>c(D),onContextmenu:re=>V(re,D.id)},[D.char==" "?(t(),n("div",wt)):D.char==`
`?(t(),n("div",kt)):(D.char=="#"||D.char=="*")&&G==0?(t(),n("div",$t)):(t(),n("div",{key:3,class:ge({"font-bold":w.lineStyle=="#"})},[m("div",null,$(D.char),1)],2))],42,bt)}),128))]))),128)),m("div",{class:"flex-1",onClick:T=>c(w.words.slice(-1)[0].text.slice(-1)[0])},null,8,Ct)]),B.value.length>0&&!j(M)?(t(),n("div",Rt,[(t(!0),n(oe,null,le(w.comments,(T,G)=>(t(),C(xe,{key:G,class:"w-full",modelValue:T.content,"onUpdate:modelValue":D=>T.content=D,editing:T.editing,onValidate:D=>T.editing=!1,author:T.author,"created-at":T.created_at},null,8,["modelValue","onUpdate:modelValue","editing","onValidate","author","created-at"]))),128))])):k("",!0)]))),128))]),B.value.length>0&&!j(M)?(t(),n("div",It)):k("",!0)])],32)):(t(),n("div",mt,[m("span",null,$(e.fullText),1)]))]))}}),Tt=m("hr",{class:"border-top border-zinc-400 my-4"},null,-1),Ut=m("div",{class:"text-xs italic"},"Raison de la lecture",-1),At=F({__name:"SeeThoughtInput",props:{thoughtInput:{}},setup(_){const l=_,{getUserById:a,user:c}=X(),o=v(null),p=A(()=>c.value?l.thoughtInput.interaction_user_id===c.value.id:!1);return Z(async()=>{l.thoughtInput.interaction_user_id&&(o.value=await a(l.thoughtInput.interaction_user_id))}),(f,r)=>(t(),n("div",null,[d(Fo,{id:f.thoughtInput.resource_id,"second-level":""},null,8,["id"]),Tt,Ut,d(Vt,{"full-text":f.thoughtInput.interaction_comment,editable:p.value},null,8,["full-text","editable"])]))}}),Dt={class:"w-full md:w-96"},Ft={key:0,class:"text-xs italic mb-2 bg-white"},St={class:"flex flex-wrap"},Bt={key:1,class:"text-2xs italic ml-2"},Et={key:2,class:"ml-auto m-1 w-1/3"},Ot={key:0,class:"border shadow-lg rounded p-4 md:w-96 bg-white"},Pt={class:"flex"},Lt=["src"],Nt={class:"flex flex-wrap w-full",style:{"margin-top":"-8px"}},qt={class:"text-2xs"},jt={class:"flex flex-wrap"},zt={key:0,class:"text-2xs italic"},Mt=F({__name:"ThoughtInputCard",props:{contextualResource:{},isDisabled:{type:Boolean,default:!1}},setup(_){const l=_,{getUserById:a}=X(),{getAuthorInteractionForResource:c}=ke(),o=v(null),p=v(null),f=v(null);Z(async()=>{l.contextualResource.user_id&&(f.value=await a(l.contextualResource.user_id)),l.contextualResource.resource&&(p.value=await c(l.contextualResource.resource.id)),p.value&&(o.value=await a(p.value.interaction_user_id))});const r=s=>s?s.toLocaleString("fr-FR",{hour:"numeric",weekday:"short",day:"numeric",month:"short",year:"2-digit"}):"",g=s=>s.length>200?s.slice(0,150)+"...":s;return(s,i)=>{const h=Ae("router-link");return t(),n("div",Dt,[s.contextualResource.context_comment?(t(),n("div",Ft,[m("div",null,$(s.contextualResource.context_comment),1),m("div",St,[f.value?(t(),C(h,{key:0,to:"/users/"+f.value.id,class:"text-2xs underline"},{default:O(()=>[ce($(f.value.first_name)+" "+$(f.value.last_name),1)]),_:1},8,["to"])):k("",!0),s.contextualResource.date?(t(),n("div",Bt,$(r(s.contextualResource.date)),1)):k("",!0),s.contextualResource.progress?(t(),n("div",Et,[d(De,{"progress-value":s.contextualResource.progress},null,8,["progress-value"])])):k("",!0)])])):k("",!0),s.contextualResource.resource?(t(),C(qe(s.isDisabled?"span":"vue-router"),{key:1,to:"/resources/"+s.contextualResource.resource.id+"?tab=ctnt"},{default:O(()=>[s.contextualResource.resource?(t(),n("div",Ot,[m("div",Pt,[s.contextualResource.resource?(t(),n("img",{key:0,class:"w-8 h-fit mr-4",src:s.contextualResource.resource.image_url},null,8,Lt)):k("",!0),m("div",null,[m("div",null,$(s.contextualResource.resource.title)+" "+$(s.contextualResource.resource.subtitle),1),m("div",Nt,[o.value?(t(),C(h,{key:0,to:"/users/"+o.value.id,class:"text-2xs underline"},{default:O(()=>[ce($(o.value.first_name)+" "+$(o.value.last_name),1)]),_:1},8,["to"])):k("",!0)]),m("div",qt,$(g(s.contextualResource.resource.comment)),1)])]),m("div",jt,[s.contextualResource.date?(t(),n("div",zt,$(r(s.contextualResource.resourcedate)),1)):k("",!0)])])):k("",!0)]),_:1},8,["to"])):k("",!0)])}}}),Wt={class:"w-fit"},Ht=F({__name:"ThoughtInputCardWithPopup",props:{thoughtInput:{},usageReason:{},isDisabled:{type:Boolean,default:!1}},setup(_){const l=v(!1);return(a,c)=>(t(),n("div",Wt,[d(pe,{open:l.value,onClose:c[0]||(c[0]=o=>l.value=!1)},{default:O(()=>[d(At,{"thought-input":a.thoughtInput,"usage-reason":a.usageReason},null,8,["thought-input","usage-reason"])]),_:1},8,["open"]),d(Mt,{class:"md:w-96","contextual-resource":a.thoughtInput,"is-disabled":a.isDisabled},null,8,["contextual-resource","is-disabled"])]))}}),Jt={class:"relative max-w-full"},Kt={key:0,class:"absolute md:border h-full start-1/2 -z-10"},ie=F({__name:"ThoughtInputsList",props:{contextualResources:{},center:{type:Boolean,default:!1},linksDisabled:{type:Boolean,default:!1}},emits:["select"],setup(_,{emit:l}){const a=o=>o.sort((p,f)=>+(f.date>p.date)),c=o=>{console.log("Select"),l("select",o)};return(o,p)=>(t(),n("div",Jt,[o.center?k("",!0):(t(),n("div",Kt)),(t(!0),n(oe,null,le(a(o.contextualResources),(f,r)=>(t(),C(Ht,{key:f.id,class:ge(["mb-4 md:mb-1 mx-auto max-w-full max-w-fit p-1",{"md:ml-0":r%2==0&&!o.center,"md:mr-0":!o.center}]),"thought-input":f,onClick:g=>c(f),"is-disabled":o.linksDisabled},null,8,["class","thought-input","onClick","is-disabled"]))),128))]))}}),Gt={key:0,class:"mb-4"},Xt={key:1},Yt={key:1},Qt={key:2},Zt={class:"flex flex-row-reverse"},Ve=F({__name:"CreateResourceRelationForm",props:{targetResource:{},originResource:{}},emits:["close","refresh"],setup(_,{emit:l}){const a=_,{user:c}=X(),o=v(),p=V=>{console.log("Event : ",V),o.value=V},f=v([{text:"Externes",value:"extr"},{text:"Internes",value:"artl"},{text:"Problème",value:"pblm"}]),r=v([{text:"Biblio",value:"bibl"},{text:"Résumé",value:"sumr"},{text:"Sujet principal",value:"main"},{text:"Evocation",value:"mino"}]),g=v([]),s=v(null),i=v([]),h=v([]),y=v([]),S=v(""),z=v(""),{createResourceRelation:ae}=Fe(),{getResources:M}=ke(),{getArticles:B}=Pe(),{getProblems:W}=Xe(),ee=A(()=>g.value.map(V=>({resource:V.resource}))),N=V=>V.map(R=>({resource:R})),H=A(()=>({extr:N(i.value),artl:N(h.value),pblm:N(y.value)})),J=async()=>{if(console.log("create"),!s.value)return;const V={target_resource_id:a.targetResource?a.targetResource.id:s.value.id,origin_resource_id:a.originResource?a.originResource.id:s.value.id,relation_comment:S.value,relation_type:z.value};await ae(V),l("refresh"),l("close")},{getUserThoughtInputs:P}=We(),te=V=>{s.value=V.resource};return Z(async()=>{!c.value||!c.value.id||(a.targetResource&&(g.value=await P(c.value.id)),a.originResource&&(i.value=await M(),h.value=await B({author:!0}),y.value=await W()))}),(V,R)=>(t(),n("div",null,[j(c)?(t(),n("div",Gt," Nouvelle relation entre ressources par "+$(j(c).first_name)+" "+$(j(c).last_name),1)):k("",!0),s.value?(t(),n("div",Qt,[d(se,{class:"m-4",label:"Type de lien",choices:r.value,modelValue:z.value,"onUpdate:modelValue":R[2]||(R[2]=E=>z.value=E)},null,8,["choices","modelValue"]),d(be,{class:"m-4",label:"Pourquoi ajouter cet élément ?",modelValue:S.value,"onUpdate:modelValue":R[3]||(R[3]=E=>S.value=E)},null,8,["modelValue"]),m("div",Zt,[d(L,{type:"valid",onClick:J,text:"Ajouter"}),d(L,{type:"abort",onClick:R[4]||(R[4]=E=>l("close")),text:"Annuler",class:"mr-1"})])])):(t(),n("div",Xt,[V.targetResource?(t(),C(ie,{key:0,"contextual-resources":ee.value,center:"","links-disabled":"",onSelect:R[0]||(R[0]=E=>te(E))},null,8,["contextual-resources"])):(t(),n("div",Yt,[m("div",null,[ce(" Choisir une ressource cible "),d(Te,{center:"",choices:f.value,default:"pblm",onUpdate:p},null,8,["choices"]),d(ie,{"contextual-resources":H.value[o.value]||[],center:"",onSelect:R[1]||(R[1]=E=>te(E)),"links-disabled":""},null,8,["contextual-resources"])])]))]))]))}}),eo=F({__name:"CommentsThread",props:{resourceId:{}},setup(_){const l=_,{user:a}=X(),c=v([]),{createComment:o,getCommentsForThoughtOutput:p}=Re(),f=async()=>{console.log("Comment thread"),console.log("Props id : ",l.resourceId),c.value=await p(l.resourceId)},r=A(()=>c.value.filter(i=>!i.start_index).sort((i,h)=>i.created_at-h.created_at)),g=v(""),s=async()=>{await o(l.resourceId,null,g.value,!1),g.value="",await f()};return Z(async()=>await f()),(i,h)=>(t(),n("div",null,[(t(!0),n(oe,null,le(r.value,y=>(t(),C(xe,{key:y.id,class:"w-full",modelValue:y.content,"onUpdate:modelValue":S=>y.content=S,editing:y.editing,onValidate:S=>y.editing=!1,author:y.author,"created-at":y.created_at},null,8,["modelValue","onUpdate:modelValue","editing","onValidate","author","created-at"]))),128)),d(xe,{class:"w-full",modelValue:g.value,"onUpdate:modelValue":h[0]||(h[0]=y=>g.value=y),editing:!0,onValidate:s,author:j(a),"created-at":null},null,8,["modelValue","author"])]))}}),to={class:"flex flex-wrap"},oo={class:"flex flex-row-reverse"},lo=F({__name:"CreateInteraction",props:{resource:{}},emits:["close","refresh"],setup(_,{emit:l}){const a=_,c=v([{text:"Lecture / Visionage",value:"inpt"},{text:"Envie",value:"wish"}]),{newInteraction:o,createInteractionForResource:p}=we(),{user:f}=X(),r=v(o());Z(()=>{r.value.interaction_type||(r.value.interaction_type="inpt")});const g=()=>{r.value.resource_id=a.resource.id,r.value.interaction_user_id=f.value.id,p(a.resource.id,r.value),l("refresh"),s()},s=()=>l("close");return(i,h)=>(t(),n("div",null,[m("div",null,"Nouvelle interaction, avec la ressource : "+$(i.resource.title),1),m("div",to,[d(Q,{label:"Avancement de l'ouvrage",class:"my-auto",modelValue:r.value.interaction_progress,"onUpdate:modelValue":h[0]||(h[0]=y=>r.value.interaction_progress=y),type:"number"},null,8,["modelValue"]),d(se,{label:"Type d'interaction",class:"m-4 w-full md:w-5/12 md:ml-auto",choices:c.value,modelValue:r.value.interaction_type,"onUpdate:modelValue":h[1]||(h[1]=y=>r.value.interaction_type=y)},null,8,["choices","modelValue"])]),d(Q,{label:"Date de lecture",modelValue:r.value.interaction_date,"onUpdate:modelValue":h[2]||(h[2]=y=>r.value.interaction_date=y),type:"date"},null,8,["modelValue"]),d(be,{label:"Pourquoi s'y être interessé ?",modelValue:r.value.interaction_comment,"onUpdate:modelValue":h[3]||(h[3]=y=>r.value.interaction_comment=y)},null,8,["modelValue"]),m("div",oo,[d(L,{onClick:g,class:"m-4",text:"Valider",type:"valid"}),d(L,{onClick:s,class:"m-4",text:"Annuler",type:"abort"})])]))}}),so=F({__name:"DateField",props:{date:{}},setup(_){const l=_,a=A(()=>new Date(l.date).toLocaleDateString("fr-FR",{day:"numeric",month:"short",year:"numeric"}));return(c,o)=>(t(),n("div",null,$(a.value),1))}}),ao={class:"flex flex-col"},no={class:"block text-2xs text-slate-800"},ro=["value","placeholder"],uo=F({__name:"NumberInput",props:{label:{},modelValue:{},placeholder:{}},emits:["update:modelValue","input"],setup(_,{emit:l}){const a=c=>{l("update:modelValue",c.target.value),l("input",c.target.value)};return(c,o)=>(t(),n("div",ao,[m("label",no,$(c.label),1),m("input",{class:"border border-neutral-400 block h-full w-full rounded-md border-2 p-1 pl-2 text-xs",type:"number",value:c.modelValue,placeholder:c.placeholder,onInput:o[0]||(o[0]=p=>a(p))},null,40,ro)]))}}),io={class:"grid grid-cols-4 gap-y-2 gap-x-4 auto-rows-auto"},co=F({__name:"ArticleForm",props:{article:{}},emits:["change"],setup(_,{emit:l}){const a=_,c=v([{text:"Terminé",value:"fnsh"},{text:"Relecture",value:"rvew"},{text:"Idée",value:"idea"}]),o=v([{text:"Livre",value:"book"},{text:"Fiche de lecture",value:"shet"},{text:"Article de média",value:"natc"},{text:"Article de recherche",value:"ratc"},{text:"Film",value:"movi"},{text:"Podcast",value:"pcst"}]),{categories:p}=je(),f=A(()=>p.value.map(g=>({text:g.display_name,value:g.id}))),r=(g,s)=>{let i={...a.article};i[g]=s,i.is_external&&(i.maturing_state="fnsh"),console.log("Article : ",i),l("change",i)};return(g,s)=>(t(),n("div",io,[d(Q,{class:"col-span-4",label:"Titre",modelValue:g.article.title,"onUpdate:modelValue":s[0]||(s[0]=i=>r("title",i))},null,8,["modelValue"]),d(Q,{class:"col-span-4",label:"Sous-titre",modelValue:g.article.subtitle,"onUpdate:modelValue":s[1]||(s[1]=i=>r("subtitle",i))},null,8,["modelValue"]),d(Q,{class:"col-span-4 md:col-span-2",label:"Lien contenu externe",modelValue:g.article.external_content_url,"onUpdate:modelValue":s[2]||(s[2]=i=>r("external_content_url",i))},null,8,["modelValue"]),d(Q,{class:"col-span-4 md:col-span-2",label:"Lien image",modelValue:g.article.image_url,"onUpdate:modelValue":s[3]||(s[3]=i=>r("image_url",i))},null,8,["modelValue"]),d(se,{label:"Catégorie",class:"col-span-4 md:col-span-1",choices:f.value,"model-value":g.article.category_id,"onUpdate:modelValue":s[4]||(s[4]=i=>r("category_id",i))},null,8,["choices","model-value"]),d(se,{label:"Type de ressource",class:"col-span-4 md:col-span-1",choices:o.value,"onUpdate:modelValue":s[5]||(s[5]=i=>r("resource_type",i)),"model-value":g.article.resource_type},null,8,["choices","model-value"]),d(se,{label:"Ressource externe",class:"col-span-4 md:col-span-1",choices:[{text:"Oui",value:!0},{text:"Non",value:!1}],"onUpdate:modelValue":s[6]||(s[6]=i=>r("is_external",JSON.parse(i))),"model-value":g.article.is_external},null,8,["model-value"]),d(se,{label:"Stade d'écriture",class:"col-span-4 md:col-span-1",choices:c.value,"model-value":g.article.maturing_state,"onUpdate:modelValue":s[7]||(s[7]=i=>r("maturing_state",i))},null,8,["choices","model-value"])]))}}),vo={class:"grid grid-cols-3 gap-4"},mo=F({__name:"ResourceAuthorPicker",props:{interaction:{},resourceId:{}},emits:["update"],setup(_,{emit:l}){const a=_,c=A(()=>{var i;return(i=a.interaction)==null?void 0:i.interaction_user_id}),{createInteractionForResource:o,newInteraction:p,createInteraction:f,updateInteraction:r}=we(),g=async i=>{if(console.log(`newUser : ${JSON.stringify(i)}`),a.interaction){const h={...a.interaction};h.interaction_user_id=i,console.log("newUserid : ",i.id),console.log(`Interaction payload : ${JSON.stringify(h)}`),await r(a.interaction.id,h),l("update")}else{console.log("create interaction");const h=p();h.interaction_user_id=i,h.resource_id=a.resourceId,await o(a.resourceId,h),l("update")}},s=async i=>{await r(a.interaction.id,i),l("update")};return(i,h)=>(t(),n("div",vo,[d(Ge,{"model-value":c.value,"onUpdate:modelValue":h[0]||(h[0]=y=>g(y))},null,8,["model-value"]),i.interaction?(t(),C(Q,{key:0,class:"text-2xs",label:"Date d'écriture","model-value":i.interaction.interaction_date?i.interaction.interaction_date.split("T")[0]:null,"onUpdate:modelValue":h[1]||(h[1]=y=>s({...i.interaction,interaction_date:y})),type:"date"},null,8,["model-value"])):k("",!0),i.interaction?(t(),C(uo,{key:1,class:"",label:"Progression",modelValue:i.interaction.interaction_progress,"onUpdate:modelValue":h[2]||(h[2]=y=>s({...i.interaction,interaction_progress:y}))},null,8,["modelValue"])):k("",!0)]))}}),po={key:0,class:"text-center text-2xl pt-10"},_o={key:1},fo={key:0},ho={class:"my-8"},go=["src"],xo={class:"text-3xl my-3 font-mplus md:text-center text-left"},yo={class:"md:text-center text-left"},bo={class:"md:text-center text-left"},wo={class:"md:flex my-8"},ko=["href"],$o={key:1,class:"my-2 flex flex-col"},Co={class:"flex flex-row-reverse mb-4"},Ro=m("hr",{class:"border-top border-zinc-400 my-4"},null,-1),Io={key:2},Vo=m("div",{class:"text-xs italic"},"Contenu",-1),To={key:3},Uo={key:4},Ao={key:5},Do={class:"fixed right-3 bottom-5"},Fo=F({__name:"ResourceComponent",props:{resourceId:{},secondLevel:{type:Boolean}},setup(_){const l=_,a=ze(),c=A(()=>U.value&&w.value||!P.value||e.value.is_local_draft||!f.value),o=A(()=>l.secondLevel?"popup_tab":"tab"),p=A(()=>[{text:"Contenu",value:"ctnt"},{text:"Biblio",value:"bbli",count:h.value.length},{text:"Sujets",value:"pblm",count:N.value.length},{text:"Interactions",value:"inpt",count:M.value.length}]),f=v(!0),r=v(a.query[o.value]&&typeof a.query[o.value]=="string"?a.query[o.value]:"ctnt"),g=v(a.query[o.value]);ue(()=>a.query[o.value],x=>{console.log("new route query",x),typeof x=="string"&&(g.value=x)});const{getResourceRelationsForResource:s,getUsagesForResource:i}=Fe(),h=v([]),y=v(!1),S=v(!1),z=async()=>{h.value=await s(he(l).resourceId.value)},ae=A(()=>h.value.map(x=>({resource:x.origin_resource,date:x.created_at,user_id:x.user_id,context_comment:x.relation_comment,progress:null}))),M=v([]),{getInteractionsForResource:B}=we(),W=async()=>{M.value=await B(l.resourceId)},ee=A(()=>M.value.map(x=>({resource:null,date:x.interaction_date,user_id:x.interaction_user_id,context_comment:x.interaction_comment,progress:x.interaction_progress}))),N=v([]),H=async()=>{N.value=await i(l.resourceId)},J=A(()=>N.value.map(x=>({resource:x.target_resource,date:x.created_at,user_id:x.user_id,context_comment:x.relation_comment,progress:null}))),P=v(!1),{newResource:te,getResource:V,updateResource:R,getAuthorInteractionForResource:E}=ke(),K=v(null),e=v(te()),u=Me();ue(()=>a.query.editing,x=>{console.log("Editing : ",x),w.value=x==="false"?!1:!!x});const w=v(!1),{isMobile:U}=Ue(),T=x=>{u.push({query:{editing:x.toString()}})},G=()=>{!e.value||!e.value.id||(e.value.publishing_state="pbsh",R(e.value.id,e.value))},D=()=>{!e.value||!e.value.id||(e.value.publishing_state="drft",R(e.value.id,e.value))},de=(x,b)=>{e.value=b,K.value!==null&&clearTimeout(K.value),K.value=setTimeout(async()=>{try{await R(x,e.value)}catch(_e){console.log("An error : ",_e)}},1e3)},ne=x=>{x!=`
`&&de(he(l).resourceId.value,{...e.value,content:x})},{user:re,getUserById:Be}=X(),ve=A(()=>e.value.is_external?!0:re.value?Y.value?Y.value.id==re.value.id:!0:!1),Y=v(null),q=v(null),me=v(!1),Ee=async()=>{q.value=await E(l.resourceId)},{getCommentsForThoughtOutput:Oe}=Re(),Ie=v([]);return Z(async()=>{P.value=!1,e.value=await V(l.resourceId),P.value=!0,await z(),await W(),await H(),Ie.value=await Oe(l.resourceId),q.value=await E(l.resourceId),q.value&&(Y.value=await Be(q.value.interaction_user_id));const x=a.query.editing;w.value=x==="false"?!1:!!x}),(x,b)=>{const _e=Ae("router-link");return t(),n("div",null,[P.value?(t(),n("div",_o,[w.value?(t(),n("div",$o,[d(co,{article:e.value,class:"",onChange:b[0]||(b[0]=I=>de(e.value.id,I))},null,8,["article"]),d(mo,{class:"my-2",interaction:q.value,"resource-id":x.resourceId,onChange:Ee},null,8,["interaction","resource-id"]),m("div",Co,[d(L,{class:"ml-2",onClick:b[1]||(b[1]=I=>T(!1)),type:"valid",text:"Preview"},{default:O(()=>[ce("Ok")]),_:1}),e.value.publishing_state=="drft"?(t(),C(L,{key:0,class:"ml-2",onClick:G,type:"valid",text:"Publier"})):(t(),C(L,{key:1,class:"ml-2",onClick:D,type:"abort",text:"Dépublier"})),d(L,{class:"ml-2",onClick:b[2]||(b[2]=I=>f.value=!f.value),type:"valid",text:f.value?"Text brut":"Editeur"},null,8,["text"])])])):(t(),n("div",fo,[m("div",ho,[m("img",{src:e.value.image_url,class:"border border-slate-300 dark:border-zinc-700 rounded-xl ml-auto mr-auto",style:{"max-height":"20rem"}},null,8,go)]),m("h1",xo,$(e.value.title),1),m("div",yo,$(e.value.subtitle),1),m("div",bo,[Y.value?(t(),C(_e,{key:0,to:"/users/"+Y.value.id,class:"text-sm underline"},{default:O(()=>[ce($(Y.value.first_name)+" "+$(Y.value.last_name),1)]),_:1},8,["to"])):k("",!0),q.value?(t(),C(so,{key:1,date:q.value.interaction_date},null,8,["date"])):k("",!0)]),m("div",wo,[q.value?(t(),C(De,{key:0,"progress-value":q.value.interaction_progress,class:"m-2 w-1/3"},null,8,["progress-value"])):k("",!0),e.value.external_content_url?(t(),n("a",{key:1,class:"ml-auto underline",href:e.value.external_content_url,target:"_blank"}," Lien ressource externe ",8,ko)):k("",!0)])])),m("div",null,[w.value?k("",!0):(t(),C(Te,{key:0,choices:p.value,default:r.value,"url-key":o.value,url:""},null,8,["choices","default","url-key"]))]),Ro,g.value=="ctnt"?(t(),n("div",Io,[Vo,c.value?(t(),C(be,{key:0,class:"mt-4 h-96",modelValue:e.value.content,"onUpdate:modelValue":b[3]||(b[3]=I=>ne(I))},null,8,["modelValue"])):(t(),C(Ke,{key:1,class:"min-h-fit","ext-comments":Ie.value,"resource-id":e.value.id,text:e.value.content,editable:ve.value,onChange:b[4]||(b[4]=I=>ne(I))},null,8,["ext-comments","resource-id","text","editable"])),d(eo,{class:"mt-6","resource-id":x.resourceId},null,8,["resource-id"])])):g.value=="bbli"?(t(),n("div",To,[d(pe,{open:y.value,onClose:b[6]||(b[6]=I=>y.value=!1)},{default:O(()=>[d(Ve,{onRefresh:z,onClose:b[5]||(b[5]=I=>y.value=!1),"target-resource":e.value},null,8,["target-resource"])]),_:1},8,["open"]),m("div",{onClick:b[7]||(b[7]=I=>y.value=!0),class:"text-sm italic underline"}," Ajouter une référence "),d(ie,{"contextual-resources":ae.value},null,8,["contextual-resources"])])):g.value=="pblm"?(t(),n("div",Uo,[d(ie,{"contextual-resources":J.value},null,8,["contextual-resources"])])):g.value=="inpt"?(t(),n("div",Ao,[d(ie,{"contextual-resources":ee.value},null,8,["contextual-resources"])])):k("",!0),m("div",Do,[ve.value?(t(),C(fe,{key:0,title:"Modifier",onClick:b[8]||(b[8]=I=>T(!0))},{default:O(()=>[d(j(He),{class:"m-1"})]),_:1})):k("",!0),ve.value?(t(),C(fe,{key:1,class:"mt-2",color:"red",title:"Marquer comme lu",onClick:b[9]||(b[9]=I=>me.value=!0)},{default:O(()=>[d(j(Ye),{class:"m-1"})]),_:1})):k("",!0),d(pe,{open:me.value,onClose:b[11]||(b[11]=I=>me.value=!1)},{default:O(()=>[d(lo,{onRefresh:W,onClose:b[10]||(b[10]=I=>me.value=!1),resource:e.value},null,8,["resource"])]),_:1},8,["open"]),ve.value?(t(),C(fe,{key:2,class:"mt-2",color:"green",title:"Relier à d'autres ressources",onClick:b[12]||(b[12]=I=>S.value=!0)},{default:O(()=>[d(j(Qe),{class:"m-1"})]),_:1})):k("",!0),d(pe,{open:S.value,onClose:b[14]||(b[14]=I=>S.value=!1)},{default:O(()=>[d(Ve,{onRefresh:H,onClose:b[13]||(b[13]=I=>S.value=!1),"origin-resource":e.value},null,8,["origin-resource"])]),_:1},8,["open"])])])):(t(),n("div",po,"Loading..."))])}}});export{Fo as _,At as a,ie as b};
