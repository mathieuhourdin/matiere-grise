import{i as L,o as n,c as r,a as m,t as C,d as U,_ as W,v as A,u as Q,r as h,j as Z,q as g,p as P,k as ee,x as te,n as T,F as _,y,z as D,e as oe}from"./index-dbdb1fe2.js";const le={class:"bg-slate-100 border p-1 m-1 rounded shadow-xl"},se={class:"text-xs m-0.5 font-bold"},ae={key:0},ne=["value"],re={class:"flex"},ie={key:1,class:"text-xs"},ce=L({__name:"CommentCard",props:{editing:{type:Boolean},modelValue:{},author:{}},emits:["update:modelValue","validate","abort"],setup(u,{emit:i}){const c=o=>{i("update:modelValue",o.target.value)},v=()=>{i("validate")},s=()=>{i("abort")};return(o,I)=>(n(),r("div",le,[m("div",se,C(o.author.first_name)+" "+C(o.author.last_name),1),o.editing?(n(),r("div",ae,[m("textarea",{class:"w-full text-xs rounded-xl p-2",value:o.modelValue,onInput:c},null,40,ne),m("div",re,[U(W,{onClick:v,class:"text-sm",rounded:"",size:"2xs",text:"Commenter",type:"valid"}),U(W,{onClick:s,class:"text-sm",rounded:"",size:"2xs",text:"Annuler",type:"abort"})])])):(n(),r("div",ie,C(o.modelValue),1))]))}}),de=async(u,i)=>{const{user:c}=Q(),v={start_index:i,end_index:i};try{const o=(await A.post("/articles/"+u+"/comments",v)).data;return c.value&&o.author_id==c.value.id&&(o.author=c.value),o}catch(s){console.log("error : ",s)}},ue=async(u,i=!0)=>{const c=i?"?author=true":"";try{return(await A.get("/articles/"+u+"/comments"+c)).data}catch(v){console.log("error : ",v)}},N=async u=>{try{return(await A.put("/comments/"+u.id,u)).data}catch(i){console.log("error : ",i)}},me=async u=>{console.log("comments : ",u),u.map(i=>N(i))};function ve(){return{createComment:de,getCommentsForArticle:ue,updateComment:N,batchUpdateComments:me}}const he=m("div",{class:"text-sm align-middle flex items-center p-2",style:{height:"50px"}}," Corriger une faute ",-1),pe={class:"flex mx-auto max-w-full"},fe={class:"w-full"},xe={key:0,class:"flex"},ge=m("div",{class:"w-6"},[m("div",{class:"rounded-full ml-4 mr-2 mt-2 h-1 w-1 bg-black"})],-1),_e=[ge],ye={class:"flex flex-wrap"},Ce=["onClick","onContextmenu"],ke={key:0,style:{width:"5px"}},we={key:1,style:{height:"25px"}},be={key:2},Ve={class:"absolute h-full",style:{right:"-2%",width:"27%"}},$e={key:0,style:{width:"33%"}},Ae=L({__name:"TextInterface",props:{ressourceId:{},fullText:{},extComments:{default:()=>[]},editable:{type:Boolean,default:!0}},emits:["change","changeComments"],setup(u,{emit:i}){const c=u,v=e=>{console.log("selectCursorPosition letter : ",e),c.editable&&(s.value={id:e.id,char:e.char})},s=h(null),o=h([]),I=Z(()=>R(o.value)),R=e=>{console.log("textArrayFromString textString: ",e);let t=[{id:0,words:[{id:0,text:[]}],comments:[]}],l=0,f=0;for(var a=0;a<o.value.length;a++){o.value[a].char==`
`&&(l+=1,f=0,t.push({id:l,words:[{id:0,text:[]}],lineStyle:a<o.value.length-1?o.value[a+1].char:null,comments:[]}));const x=p.value.find(d=>d.start_index==a);x&&t[l].comments.push(x),t[l].words[f].text.push({id:a,char:o.value[a].char,comment:x}),o.value[a].char==" "&&(f+=1,t[l].words.push({id:f,text:[{id:a,char:o.value[a].char}]}))}return t},k=e=>{o.value.filter(t=>t.id>=s.value.id+1).forEach(t=>t.id+=1),o.value.splice(s.value.id+1,0,{id:s.value.id+1,char:e,line:0}),p.value.forEach(t=>{t.start_index>s.value.id&&(t.start_index+=1),t.end_index>s.value.id&&(t.end_index+=1)}),s.value.id+=1},j=e=>{if(console.log("Writes : ",e.key),s.value===null)return;const t=e.key;if(w.value&&t=="v"){K();return}if(t.length==1)e.preventDefault(),k(t);else if(t=="Backspace")o.value.splice(s.value.id,1),o.value.filter(l=>l.id>s.value.id).forEach(l=>l.id-=1),s.value.id-=1;else if(t=="Enter")k(`
`);else if(t=="ArrowRight"){let l=s.value.id;l<o.value.length-1&&v(o.value[l+1])}else if(t=="ArrowLeft"){let l=s.value.id;l>0&&v(o.value[l-1])}else t=="Control"&&(console.log("Control"),w.value=!0)},w=h(!1),K=async()=>{try{let t=await navigator.clipboard.readText();console.log("Clippedtext : ",t);for(var e=0;e<t.length;e++)k(t[e])}catch(t){console.log("Error with clippboard : ",t)}},O=e=>{e.key=="Control"&&(w.value=!1)},{createComment:q,batchUpdateComments:H}=ve(),p=h([]),B=h(null),M=e=>{console.log("Comments loading : ",e),p.value=e},X=async()=>{console.log("Add Comment");const e=await q(c.ressourceId,E.value);p.value.push(e)};g(p,e=>{console.log("Watch comments triggered : ",e.value),$.value&&(console.log("Comments : ",e),i("changeComments",e.value),clearTimeout(B.value),B.value=setTimeout(()=>H(e),1e3))},{deep:!0}),g(P(c).extComments,e=>{p.value=e});const b=h(!1),E=h(null),V=h({position:"absolute","z-index":90,top:0,left:0,height:"106px",width:"260px"}),Y=(e,t)=>{e.preventDefault(),s.value=null,V.value.top=`${e.layerY}px`,V.value.left=`${e.layerX}px`,b.value=!0,E.value=t,console.log("event : ",e),console.log("Have a new right click")},F=e=>{if(console.log("textArrayFromString textString: ",e),o.value=[],e===void 0||e==""){o.value=[{id:0,char:`
`}],v({id:0,char:`
`});return}for(var t=0;t<e.length;t++){const l=p.value.find(f=>f.start_index==t);o.value.push({id:t,char:e[t],comment:l})}},G=e=>e.reduce((t,l)=>t+l.char,""),$=h(!1);return ee(()=>{F(c.fullText),M(c.extComments),$.value=!0}),g(o,e=>{console.log("Watch triggered : ",e),$.value&&i("change",G(e))},{deep:!0}),g(P(c).fullText,e=>{F(e)}),(e,t)=>(n(),r("div",{class:"relative p-4",tabindex:"0",onKeydown:j,onKeyup:O,onClick:t[0]||(t[0]=l=>b.value=!1)},[b.value?(n(),r("div",{key:0,class:"bg-white border-4",style:te(V.value)},[m("div",{onClick:X,class:"text-sm border-b-2 flex items-center p-2",style:{height:"50px"}}," Ajouter un commentaire "),he],4)):T("",!0),m("div",pe,[m("div",fe,[(n(!0),r(_,null,y(I.value,(l,f)=>(n(),r("div",{key:f,class:"flex"},[l.lineStyle=="*"?(n(),r("div",xe,_e)):T("",!0),m("div",ye,[(n(!0),r(_,null,y(l.words,(a,x)=>(n(),r("div",{key:x,class:"flex flex-wrap"},[(n(!0),r(_,null,y(a.text,(d,J)=>{var S;return n(),r("div",{key:J,class:D(["border-blue-400",{"border-r-2":d.id==((S=s.value)==null?void 0:S.id),"bg-yellow-400":d.comment}]),onClick:z=>v(d),onContextmenu:z=>Y(z,d.id)},[d.char==" "?(n(),r("div",ke)):d.char==`
`?(n(),r("div",we)):(d.char=="#"||d.char=="*")&&x==0?(n(),r("div",be)):(n(),r("div",{key:3,class:D({"font-bold":l.lineStyle=="#"})},[m("div",null,C(d.char),1)],2))],42,Ce)}),128))]))),128))]),m("div",Ve,[(n(!0),r(_,null,y(l.comments,(a,x)=>(n(),oe(ce,{key:x,class:"w-full",modelValue:a.content,"onUpdate:modelValue":d=>a.content=d,editing:a.editing,onValidate:d=>a.editing=!1,author:a.author},null,8,["modelValue","onUpdate:modelValue","editing","onValidate","author"]))),128))])]))),128))]),p.value.length>0?(n(),r("div",$e)):T("",!0)])],32))}});export{Ae as _,ve as u};
