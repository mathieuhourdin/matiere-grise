import{d as Me,u as ze,r as u,j as g,y as H,o as De,a0 as Se,a as Ae,b as o,c as n,l as s,e as m,m as f,t as d,F as N,g as q,p as w,k as $,w as re,h as K,J as ae,a3 as le,a1 as oe,O as ne,S as Le,U as Oe,s as Ve,v as Ne,Q as qe,M as Be}from"./index-23800723.js";import{u as Pe}from"./useJournal-c6cde84e.js";import{g as Qe,b as Ue,r as We,e as Ge,a as He,d as Ke,f as Xe,c as Ye}from"./SwatchIcon-d6de7cb3.js";import{r as ie}from"./XMarkIcon-a2b00390.js";const B=M=>(Le("data-v-6021c20d"),M=M(),Oe(),M),Ze={class:"ipad-screen"},Re={class:"mb-4 flex items-start justify-between gap-3"},et=B(()=>s("div",null,[s("h2",{class:"text-xl font-semibold text-slate-800"},"Vos journaux"),s("p",{class:"text-xs text-slate-500"},"Consultez ce que vous avez ecrit et ajoutez de nouvelles traces")],-1)),tt={class:"flex items-center gap-2"},st={class:"hidden md:inline text-xs"},rt={key:0,class:"absolute right-0 mt-1 w-40 rounded-lg border border-slate-300 bg-white shadow-lg p-1 z-20"},at=["onClick"],lt={class:"journal-tabs flex gap-2 overflow-x-auto pb-1"},ot=["onClick"],nt=["disabled"],it={class:"mt-4 flex-1 min-h-0"},ut={key:0,class:"text-sm text-slate-500"},ct={key:1,class:"text-sm text-slate-500"},dt={class:"mb-3 flex items-center justify-between gap-2"},vt={class:"text-xs text-slate-500 truncate"},ft=["disabled"],ht={class:"traces-scroll flex-1 min-h-0 overflow-y-auto pr-2"},mt=["placeholder","disabled"],pt={class:"mt-2 flex justify-end"},bt=["disabled"],xt={key:0,class:"text-sm text-slate-500"},_t={class:"mb-1 flex items-center justify-between gap-2"},yt={class:"text-xs text-slate-500"},gt={class:"inline-flex items-center gap-1.5"},wt=["onClick"],kt=["onClick"],jt={class:"font-handwritten text-4xl mb-2 leading-tight text-slate-800"},Ct={key:0,class:"font-georgia"},Tt={key:2,class:"text-sm text-slate-500"},Jt=B(()=>s("div",{class:"ipad-home-indicator"},null,-1)),It={class:"flex items-start justify-between gap-3 mb-3"},Et=B(()=>s("h3",{class:"text-sm font-semibold"},"Question sur la trace",-1)),Ft={class:"text-xs text-slate-400 mt-1"},$t={class:"mt-3 flex justify-end gap-2"},Mt=["disabled"],zt={class:"flex items-start justify-between gap-3 mb-3"},Dt=B(()=>s("h3",{class:"text-sm font-semibold"},"Chat autour de la trace",-1)),St={class:"text-xs text-slate-400 mt-1"},At={class:"space-y-2 max-h-72 overflow-y-auto pr-1"},Lt={class:"font-semibold text-[11px] mb-0.5 opacity-90"},Ot=Me({__name:"JournalPadComponent",props:{fullscreen:{type:Boolean,default:!1}},setup(M){const{userJournals:z,loadUserJournal:P}=Pe(),{createResource:ue,createTrace:ce,updateResource:de}=Ve(),{createInteractionForResource:ve}=Ne(),{user:b,updateUser:fe}=ze(),{launchSnackbar:c}=qe(),Q=u(!1),J=u(!1),x=u(""),p=u([]),k=u(!1),I=u(!1),E=u(!1),D=u(null),S=u({}),A=u(null),j=u(null),C=u(""),_=u("Classic"),y=u(!1),X=u(null),Y=[{key:"Classic",label:"Actuel"},{key:"White",label:"Blanc"},{key:"Flowers",label:"Fleurs"},{key:"Dark",label:"Sombre"}];let L=0;const O=g(()=>z.value.length?[...z.value].sort((e,t)=>{var a,i;const l=new Date(((a=e.resource)==null?void 0:a.created_at)||e.created_at||0).getTime(),r=new Date(((i=t.resource)==null?void 0:i.created_at)||t.created_at||0).getTime();return l-r}):[]),v=u(null),h=g(()=>{var e,t,l;return((e=v.value)==null?void 0:e.resource_id)??((l=(t=v.value)==null?void 0:t.resource)==null?void 0:l.id)??null}),Z=g(()=>{var l,r;const e=h.value;if(!e||S.value[e]||p.value.length>0)return!1;const t=(((r=(l=v.value)==null?void 0:l.resource)==null?void 0:r.title)??"").trim();return t.length===0||t==="Nouveau journal"}),he=g(()=>Z.value?"Titre du journal":"Ecrire une nouvelle trace..."),me=e=>{v.value=e},pe=async()=>{var e;if(!k.value){if(!((e=b.value)!=null&&e.id)){c("Utilisateur non trouvé","error");return}k.value=!0;try{const l=await ue({title:"Nouveau journal",subtitle:"",content:"",external_content_url:"",comment:"",image_url:"",maturing_state:"drft",publishing_state:"",resource_type:"jrnl",is_local_draft:!1});await ve(l.id,{interaction_progress:0,interaction_date:new Date,interaction_comment:"",interaction_is_public:!1}),await P();const r=z.value.find(a=>{var i;return(a.resource_id??((i=a.resource)==null?void 0:i.id))===l.id});r&&(v.value=r),S.value[l.id]=!1,c("Nouveau journal créé","success")}catch(t){console.error("Error creating new journal:",t),c("Erreur lors de la création du journal","error")}finally{k.value=!1}}},be=()=>{var e;if(!I.value){if(!h.value){c("Sélectionnez un journal avant import","error");return}(e=D.value)==null||e.click()}},R=()=>{D.value&&(D.value.value="")},xe=async e=>{const t=h.value;if(!t){c("Aucun journal sélectionné","error");return}const l=e.name.toLowerCase();if(!(l.endsWith(".txt")||l.endsWith(".md"))){c("Format non supporté. Utilisez un fichier .txt ou .md","error");return}I.value=!0;try{const a=new FormData;a.append("file",e),await ne.post(`/journals/${t}/import_text`,a,"multipart/form-data"),await U(t),c("Journal importé avec succès","success")}catch(a){console.error("Error importing journal text:",a),c("Erreur lors de l'import du journal","error")}finally{I.value=!1}},_e=async e=>{var r;const t=e.target,l=(r=t==null?void 0:t.files)==null?void 0:r[0];if(!l){R();return}await xe(l),R()},ye=async()=>{var l;const e=x.value.trim(),t=h.value;if(!(!e||!t)){E.value=!0;try{if(Z.value){const r=(l=v.value)==null?void 0:l.resource,a={title:e,subtitle:(r==null?void 0:r.subtitle)??"",content:(r==null?void 0:r.content)??"",external_content_url:(r==null?void 0:r.external_content_url)??"",comment:(r==null?void 0:r.comment)??"",image_url:(r==null?void 0:r.image_url)??"",maturing_state:(r==null?void 0:r.maturing_state)??"drft",publishing_state:(r==null?void 0:r.publishing_state)??"",resource_type:"jrnl",is_local_draft:!1};await de(t,a),S.value[t]=!0,await P();const i=z.value.find(F=>{var G;return(F.resource_id??((G=F.resource)==null?void 0:G.id))===t});i&&(v.value=i),c("Titre du journal mis à jour","success")}else await ce({content:e,journal_id:t}),await U(t),c("Trace ajoutée","success");x.value=""}catch(r){console.error("Error submitting journal entry:",r),c("Erreur lors de l'envoi","error")}finally{E.value=!1}}},U=async e=>{const t=++L;J.value=!0;try{const l=await ne.get(`/journals/${e}/traces`);if(t!==L)return;const r=Array.isArray(l.data)?l.data:[];p.value=r,r.length>0&&(S.value[e]=!0)}catch(l){if(t!==L)return;console.error("Error loading traces for journal:",l),c(`Error loading journal traces: ${l}`,"error"),p.value=[]}finally{if(t!==L)return;J.value=!1}},ge=e=>e?(typeof e=="string"?new Date(e):e).toLocaleDateString("fr-FR",{day:"numeric",month:"short",year:"numeric"}):"",T=e=>{const l=(e.content||e.title||"Trace sans contenu").split(`
`),a=(l.shift()??"").replace(/^[#\s]+/,""),i=l.join(`
`).trim();return{first:a,rest:i}},we=e=>{var r;const t=(e==null?void 0:e.analysis_id)??(e==null?void 0:e.analysisId)??((r=e==null?void 0:e.analysis)==null?void 0:r.id)??null;if(t==null)return null;const l=String(t).trim();return l.length>0?l:null},ee=e=>{const t=we(e);return t?{name:"analysis",query:{id:t,tab:"current"}}:null},ke=e=>{A.value=e,C.value=""},V=()=>{A.value=null,C.value=""},je=()=>{C.value.trim()&&(c("Question enregistrée (placeholder)","success"),V())},Ce=e=>{j.value=e},te=()=>{j.value=null},Te=g(()=>j.value?[{id:"msg-1",from:"assistant",author:"Assistant",content:`J'ai relu ${T(j.value).first||"cette trace"}. Quel aspect voulez-vous approfondir ?`},{id:"msg-2",from:"you",author:"Vous",content:"J'aimerais comprendre les points bloquants."},{id:"msg-3",from:"assistant",author:"Assistant",content:"Très bien, on peut démarrer par les actions en cours et les prochaines étapes."}]:[]),Je=g(()=>{const e=Y.find(t=>t.key===_.value);return(e==null?void 0:e.label)??"Thème"}),W=g(()=>_.value==="Flowers"?"flower":_.value.toLowerCase()),Ie=e=>{const t=String(e??"").trim().toLowerCase();return t==="white"?"White":t==="flower"||t==="flowers"?"Flowers":t==="dark"?"Dark":"Classic"},Ee=()=>{y.value=!y.value},Fe=async e=>{var t;if((t=b.value)!=null&&t.id)try{const l={...b.value,journal_theme:e};await fe(b.value.id,l),b.value={...b.value,journal_theme:e}}catch(l){console.error("Error updating journal theme:",l),c("Erreur lors de l'enregistrement du thème","error")}},$e=e=>{if(e===_.value){y.value=!1;return}_.value=e,y.value=!1,Fe(e)},se=e=>{var l;if(!y.value)return;const t=e.target;t&&((l=X.value)!=null&&l.contains(t)||(y.value=!1))};return H(O,e=>{if(!e.length){v.value=null,p.value=[];return}const t=h.value;e.find(r=>{var a;return(r.resource_id??((a=r.resource)==null?void 0:a.id))===t})||(v.value=e[0])}),H(h,async e=>{if(!e){p.value=[],x.value="";return}p.value=[],x.value="",await U(e)}),H(b,e=>{const t=Ie(e==null?void 0:e.journal_theme);_.value=t},{immediate:!0}),De(async()=>{window.addEventListener("click",se),Q.value=!0;try{await P(),!v.value&&O.value.length>0&&(v.value=O.value[0])}finally{Q.value=!1}}),Se(()=>{window.removeEventListener("click",se)}),(e,t)=>{var r;const l=Ae("router-link");return o(),n("section",{class:w(["ipad-shell",`theme-${W.value}`,{"ipad-shell-fullscreen":e.fullscreen}])},[s("div",Ze,[s("header",Re,[et,s("div",tt,[s("div",{ref_key:"themeMenuRef",ref:X,class:"relative"},[s("button",{type:"button",class:"inline-flex items-center gap-1.5 px-2.5 h-8 rounded-lg border border-slate-300 bg-white/80 text-slate-600 hover:border-slate-400 hover:text-slate-800 transition-colors",title:"Choisir le thème du journal",onClick:Ee},[m(f(Qe),{class:"w-4 h-4"}),s("span",st,d(Je.value),1)]),y.value?(o(),n("div",rt,[(o(),n(N,null,q(Y,a=>s("button",{key:a.key,type:"button",class:w(["w-full text-left px-2.5 py-1.5 rounded-md text-xs transition-colors",_.value===a.key?"bg-slate-100 text-slate-800":"text-slate-600 hover:bg-slate-50"]),onClick:i=>$e(a.key)},d(a.label),11,at)),64))])):$("",!0)],512),m(l,{to:e.fullscreen?"/me/home":"/me/journal-pad",class:"inline-flex items-center justify-center w-8 h-8 rounded-lg border border-slate-300 bg-white/80 text-slate-600 hover:border-slate-400 hover:text-slate-800 transition-colors",title:e.fullscreen?"Fermer et revenir vers accueil":"Ouvrir en plein écran","aria-label":e.fullscreen?"Fermer et revenir vers accueil":"Ouvrir le journal en plein écran"},{default:re(()=>[e.fullscreen?(o(),K(f(Ue),{key:0,class:"w-4 h-4"})):(o(),K(f(We),{key:1,class:"w-4 h-4"}))]),_:1},8,["to","title","aria-label"])])]),s("div",lt,[(o(!0),n(N,null,q(O.value,a=>{var i,F;return o(),n("button",{key:a.id,type:"button",onClick:G=>me(a),class:w(["px-3 py-1.5 rounded-xl border text-xs whitespace-nowrap transition-all duration-200 shadow-sm",h.value===(a.resource_id??((i=a.resource)==null?void 0:i.id))?"border-sky-500 bg-sky-100 text-sky-900":"border-slate-300 bg-white/80 text-slate-600 hover:border-slate-400"])},d(((F=a.resource)==null?void 0:F.title)||"Sans titre"),11,ot)}),128)),s("button",{type:"button",disabled:k.value,onClick:pe,class:w(["inline-flex items-center gap-1.5 px-3 py-1.5 rounded-xl border text-xs whitespace-nowrap transition-all duration-200 shadow-sm",k.value?"border-slate-300 bg-slate-100 text-slate-400 cursor-wait":"border-slate-300 border-dashed bg-white/80 text-slate-600 hover:border-slate-400"])},[m(f(Ge),{class:"w-3.5 h-3.5"}),s("span",null,d(k.value?"Création...":"Nouveau journal"),1)],10,nt)]),s("div",it,[Q.value?(o(),n("div",ut,"Chargement...")):v.value?(o(),n("div",{key:2,class:w(["journal-canvas h-full",`theme-${W.value}`])},[s("div",dt,[s("div",vt,d(((r=v.value.resource)==null?void 0:r.title)||"Nouveau journal"),1),s("button",{type:"button",disabled:I.value||!h.value,onClick:be,class:"inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md border border-slate-300 bg-white/85 text-[11px] text-slate-700 hover:border-slate-400 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",title:"Importer un fichier texte dans ce journal"},[m(f(He),{class:"w-3.5 h-3.5"}),s("span",null,d(I.value?"Import...":"Importer .txt/.md"),1)],8,ft),s("input",{ref_key:"importFileInput",ref:D,type:"file",accept:".txt,.md,text/plain,text/markdown",class:"hidden",onChange:_e},null,544)]),s("div",ht,[s("div",{class:w(["paper-content space-y-6",`theme-${W.value}`])},[s("div",null,[ae(s("textarea",{"onUpdate:modelValue":t[0]||(t[0]=a=>x.value=a),rows:"3",placeholder:he.value,disabled:E.value||J.value,class:"w-full rounded-xl border border-amber-200 bg-white/75 text-slate-700 text-base p-4 placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-300 font-georgia disabled:opacity-70"},null,8,mt),[[le,x.value]]),s("div",pt,[s("button",{type:"button",disabled:E.value||J.value||!x.value.trim()||!h.value,class:"px-2.5 py-1 text-xs rounded-md border border-slate-300 bg-white/85 text-slate-700 hover:border-slate-400 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",onClick:ye},d(E.value?"Envoi...":"Valider"),9,bt)])]),J.value?(o(),n("div",xt," Chargement des traces... ")):p.value.length>0?(o(!0),n(N,{key:1},q(p.value,a=>(o(),n("article",{key:a.id,class:"trace-entry text-[17px] text-slate-700 whitespace-pre-line leading-[2]"},[s("div",_t,[s("div",yt,d(ge(a.interaction_date||a.created_at)),1),s("div",gt,[ee(a)?(o(),K(l,{key:0,to:ee(a),class:"inline-flex items-center justify-center w-6 h-6 rounded border border-slate-300 bg-white/80 text-slate-600 hover:border-slate-400 hover:text-slate-800 transition-colors",title:"Ouvrir l'analyse de cette trace","aria-label":"Ouvrir l'analyse de cette trace"},{default:re(()=>[m(f(Ke),{class:"w-3.5 h-3.5"})]),_:2},1032,["to"])):$("",!0),s("button",{type:"button",class:"inline-flex items-center justify-center w-6 h-6 rounded border border-slate-300 bg-white/80 text-slate-600 hover:border-slate-400 hover:text-slate-800 transition-colors",title:"Poser une question sur cette trace","aria-label":"Poser une question sur cette trace",onClick:i=>ke(a)},[m(f(Xe),{class:"w-3.5 h-3.5"})],8,wt),s("button",{type:"button",class:"inline-flex items-center justify-center w-6 h-6 rounded border border-slate-300 bg-white/80 text-slate-600 hover:border-slate-400 hover:text-slate-800 transition-colors",title:"Voir le chat de cette trace","aria-label":"Voir le chat de cette trace",onClick:i=>Ce(a)},[m(f(Ye),{class:"w-3.5 h-3.5"})],8,kt)])]),s("div",jt,d(T(a).first),1),T(a).rest?(o(),n("div",Ct,d(T(a).rest),1)):$("",!0)]))),128)):(o(),n("div",Tt," Aucune trace pour ce journal "))],2)])],2)):(o(),n("div",ct,"Aucun journal trouve"))])]),Jt,A.value?(o(),n("div",{key:0,class:"fixed inset-0 z-[120] bg-slate-900/50 flex items-center justify-center p-4",onClick:V},[s("div",{class:"w-full max-w-lg rounded-xl border border-slate-700 bg-slate-900 text-slate-100 p-4 shadow-2xl",onClick:t[2]||(t[2]=oe(()=>{},["stop"]))},[s("div",It,[s("div",null,[Et,s("p",Ft,d(T(A.value).first||"Trace sans titre"),1)]),s("button",{type:"button",class:"inline-flex items-center justify-center w-7 h-7 rounded border border-slate-700 text-slate-400 hover:text-slate-200 hover:border-slate-500 transition-colors",onClick:V,"aria-label":"Fermer"},[m(f(ie),{class:"w-4 h-4"})])]),ae(s("textarea",{"onUpdate:modelValue":t[1]||(t[1]=a=>C.value=a),rows:"4",placeholder:"Posez une question sur cette trace...",class:"w-full rounded-lg border border-slate-700 bg-slate-950/70 p-3 text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-slate-600"},null,512),[[le,C.value]]),s("div",$t,[s("button",{type:"button",class:"px-2.5 py-1 text-xs rounded-md border border-slate-700 text-slate-300 hover:text-slate-100 hover:border-slate-500 transition-colors",onClick:V}," Annuler "),s("button",{type:"button",class:"px-2.5 py-1 text-xs rounded-md border border-slate-600 bg-slate-700 text-slate-100 hover:bg-slate-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",disabled:!C.value.trim(),onClick:je}," Envoyer ",8,Mt)])])])):$("",!0),j.value?(o(),n("div",{key:1,class:"fixed inset-0 z-[120] bg-slate-900/50 flex items-center justify-center p-4",onClick:te},[s("div",{class:"w-full max-w-xl rounded-xl border border-slate-700 bg-slate-900 text-slate-100 p-4 shadow-2xl",onClick:t[3]||(t[3]=oe(()=>{},["stop"]))},[s("div",zt,[s("div",null,[Dt,s("p",St,d(T(j.value).first||"Trace sans titre"),1)]),s("button",{type:"button",class:"inline-flex items-center justify-center w-7 h-7 rounded border border-slate-700 text-slate-400 hover:text-slate-200 hover:border-slate-500 transition-colors",onClick:te,"aria-label":"Fermer"},[m(f(ie),{class:"w-4 h-4"})])]),s("div",At,[(o(!0),n(N,null,q(Te.value,a=>(o(),n("div",{key:a.id,class:w(["rounded-lg px-3 py-2 text-xs leading-5",a.from==="you"?"bg-slate-700/70 text-slate-100 ml-10":"bg-slate-800/80 text-slate-200 mr-10"])},[s("div",Lt,d(a.author),1),s("div",null,d(a.content),1)],2))),128))])])])):$("",!0)],2)}}});const Pt=Be(Ot,[["__scopeId","data-v-6021c20d"]]);export{Pt as J};
