import{O as M,Q as ct,d as dt,x as ut,r as b,j as g,o as _t,y as gt,a as pt,c as l,l as r,t as _,m as O,e as N,k as h,F as w,g as D,b as o,h as V,w as E,f as Y,S as mt,U as vt,n as ht,M as ft}from"./index-ae4d109a.js";import{_ as H}from"./HeatmapDisplay.vue_vue_type_script_setup_true_lang-79485d76.js";import{_ as yt}from"./TransactionElementsList.vue_vue_type_script_setup_true_lang-a38339c4.js";const{launchSnackbar:xt}=ct(),kt=async v=>{try{return(await M.get("/landmarks/"+v)).data}catch(f){throw xt(`Error getting landmark: ${f}`,"error"),f}};function bt(){return{getLandmark:kt}}const m=v=>(mt("data-v-db348a0c"),v=v(),vt(),v),wt={class:"p-4 md:px-24"},St={key:0,class:"text-center text-2xl pt-10"},Lt={key:1},Dt=m(()=>r("h1",{class:"text-3xl font-bold mb-6"},"Landmark Details",-1)),Ct={class:"mb-6"},Tt={class:"rounded-xl border border-slate-800 bg-slate-900/60 p-4"},Nt={class:"flex items-start justify-between gap-4"},$t={class:"min-w-0"},Ut={class:"text-2xl font-bold text-slate-100 break-words"},At={class:"mt-1 text-[11px] uppercase tracking-wide text-slate-400"},Et={key:0},Mt={key:0,class:"mt-4 border-t border-slate-800 pt-3"},Pt={class:"whitespace-pre-wrap text-sm leading-6 text-slate-300"},Ft={key:0,class:"mb-6"},Bt=m(()=>r("h2",{class:"text-xl font-semibold mb-4"},"Related Elements Activity",-1)),Wt={class:"border border-slate-300 dark:border-zinc-700 rounded-lg p-4"},jt={key:1,class:"mb-6"},Rt=m(()=>r("h2",{class:"text-xl font-semibold mb-4"},"Parent Landmarks",-1)),zt={class:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"},Jt=m(()=>r("div",{class:"text-sm font-semibold text-gray-600 dark:text-gray-400 mb-1"},"Parent",-1)),It={class:"text-base font-medium"},Ot={class:"mb-6 grid grid-cols-1 xl:grid-cols-3 gap-6"},Vt={class:"xl:col-span-1 font-inter"},Yt=m(()=>r("h2",{class:"text-lg font-semibold text-slate-300 mb-2"},"Activité récente",-1)),Ht={class:"mt-6"},Kt=m(()=>r("h2",{class:"text-lg font-semibold text-slate-300 mb-2"},"Landmarks liés",-1)),Qt={class:"space-y-1.5 text-sm leading-5 text-slate-300"},qt={class:"text-xs text-slate-500"},Gt={key:0,class:"text-xs leading-4 text-slate-500 mt-0.5 whitespace-pre-wrap"},Xt={key:1,class:"text-sm text-slate-500"},Zt={key:0,class:"xl:col-span-2"},te=m(()=>r("h2",{class:"text-lg font-semibold text-slate-300 mb-4"},"Journal des éléments",-1)),ee={class:"journal-canvas min-h-[360px]"},se={class:"traces-scroll h-full overflow-y-auto pr-2"},ae={class:"paper-content"},re={class:"flex flex-col md:flex-row md:items-center md:justify-between gap-2 mb-1"},ne={class:"text-xs text-slate-500"},oe={class:"flex flex-wrap gap-1.5 md:justify-end"},le={key:1,class:"xl:col-span-2"},ie=m(()=>r("h2",{class:"text-lg font-semibold text-slate-300 mb-2"},"Journal des éléments",-1)),ce=m(()=>r("div",{class:"text-sm text-slate-500"},"Aucun élément lié",-1)),de=[ie,ce],ue={key:2,class:"text-center text-2xl pt-10 text-red-600"},_e=6,ge=dt({__name:"SeeLandmarkPage",props:{id:{}},setup(v){const f=v,{isMobile:P}=ht(),{getLandmark:K}=bt(),F=ut(),c=b(null),$=b(!0),C=b(!1),T=b(!1),B=["Mo","Tu","We","Th","Fr","Sa","Su"],y=b({}),x=b({}),Q=()=>{if(window.history.length>1){F.back();return}F.push("/me")},U=g(()=>{var t;return((t=c.value)==null?void 0:t.parent_landmarks)??[]}),q=g(()=>C.value?U.value:U.value.slice(0,4)),G=g(()=>U.value.length>4),X=t=>{const e=t.getUTCFullYear(),s=String(t.getUTCMonth()+1).padStart(2,"0"),a=String(t.getUTCDate()).padStart(2,"0");return`${e}-${s}-${a}`},Z=t=>{if(!t)return null;const e=new Date(String(t));if(Number.isNaN(e.getTime()))return null;const s=new Date(Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate()));return Number.isNaN(s.getTime())?null:s},S=g(()=>{const t=new Date,e=new Date(Date.UTC(t.getUTCFullYear(),t.getUTCMonth(),t.getUTCDate()));return{start:new Date(Date.UTC(e.getUTCFullYear(),e.getUTCMonth()-(_e-1),1)),end:e}}),tt=g(()=>{var n;const t=new Map,e=((n=c.value)==null?void 0:n.related_elements)??[],{start:s,end:a}=S.value;for(const i of e){const d=i.interaction_date??i.created_at,u=Z(d);if(!u||u<s||u>a)continue;const L=X(u);t.set(L,(t.get(L)??0)+1)}return t}),W=g(()=>Array.from(tt.value.entries()).map(([t,e])=>({day:t,value:e}))),j=g(()=>{var a,n;const t=(a=c.value)!=null&&a.id?String(c.value.id).trim():"";if(!t)return[];const e=new Map,s=((n=c.value)==null?void 0:n.related_elements)??[];for(const i of s){const d=z(i);if(!d)continue;const u=y.value[d]??[],L=new Set;for(const p of u){const k=(p==null?void 0:p.id)!=null?String(p.id).trim():"";if(!k||k===t||L.has(k))continue;L.add(k);const it=typeof(p==null?void 0:p.title)=="string"&&p.title.trim().length>0?p.title.trim():"Sans titre",I=e.get(k);I?I.count+=1:e.set(k,{title:it,count:1})}}return Array.from(e.entries()).map(([i,d])=>({id:i,title:d.title,count:d.count})).sort((i,d)=>d.count!==i.count?d.count-i.count:i.title.localeCompare(d.title,"fr-FR"))}),et=(t,e=180)=>{if(typeof t!="string")return"";const s=t.replace(/\s+/g," ").trim();return s?s.length<=e?s:`${s.slice(0,e)}...`:""},A=g(()=>j.value.map(t=>{var e,s;return{id:t.id,title:((e=x.value[t.id])==null?void 0:e.title)??t.title,count:t.count,preview:et((s=x.value[t.id])==null?void 0:s.content)}})),R=g(()=>T.value?A.value:A.value.slice(0,4)),st=g(()=>A.value.length>4),z=t=>{const e=t==null?void 0:t.id;if(e==null)return null;const s=String(e).trim();return s.length>0?s:null},at=t=>{if(typeof t!="string")return null;let e=t.trim();if(!e)return null;for(let s=0;s<3;s++){if(typeof e!="string")return e;const a=e.trim();if(!a)return null;if(!(a.startsWith("{")||a.startsWith("[")||a.startsWith('"')))return s===0?null:e;try{e=JSON.parse(a)}catch{return s===0?null:e}}return e},rt=t=>{var n;const e=(t==null?void 0:t.spans)??(t==null?void 0:t.span);if(Array.isArray(e)){const i=e.map(d=>typeof d=="string"?d.trim():"").filter(d=>d.length>0);if(i.length>0)return i}else if(typeof e=="string"&&e.trim().length>0)return[e.trim()];const s=at((t==null?void 0:t.content)??((n=t==null?void 0:t.resource)==null?void 0:n.content)??"");if(s&&typeof s=="object"){const i=s.spans??s.span;if(Array.isArray(i)){const d=i.map(u=>typeof u=="string"?u.trim():"").filter(u=>u.length>0);if(d.length>0)return d}else if(typeof i=="string"&&i.trim().length>0)return[i.trim()]}return[typeof(t==null?void 0:t.title)=="string"&&t.title.trim().length>0?t.title.trim():"Élément"]},nt=t=>{const e=(t==null?void 0:t.interaction_date)??(t==null?void 0:t.interactionDate)??(t==null?void 0:t.created_at)??(t==null?void 0:t.createdAt);if(!e)return"Date inconnue";const s=new Date(String(e));return Number.isNaN(s.getTime())?String(e):s.toLocaleString("fr-FR",{weekday:"short",year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})},ot=async t=>{if(t&&y.value[t]==null)try{const e=await M.get(`/elements/${t}/landmarks`);y.value[t]=Array.isArray(e.data)?e.data:[]}catch(e){console.error(`Error fetching landmarks for element ${t}:`,e),y.value[t]=[]}},lt=async t=>{if(t&&x.value[t]==null)try{const e=await M.get(`/landmarks/${t}`);x.value[t]=e.data??null}catch(e){console.error(`Error fetching co-occurring landmark ${t}:`,e),x.value[t]=null}},J=async()=>{var t;try{$.value=!0,C.value=!1,T.value=!1,y.value={},x.value={},c.value=await K(f.id);const s=(((t=c.value)==null?void 0:t.related_elements)??[]).map(n=>z(n)).filter(n=>!!n);await Promise.all(s.map(n=>ot(n)));const a=j.value.map(n=>n.id);await Promise.all(a.map(n=>lt(n)))}catch(e){console.error("Error loading landmark:",e)}finally{$.value=!1}};return _t(async()=>{await J()}),gt(()=>f.id,async()=>{await J()}),(t,e)=>{const s=pt("router-link");return o(),l("div",wt,[$.value?(o(),l("div",St,"Loading...")):c.value?(o(),l("div",Lt,[r("div",{class:"mb-6"},[r("button",{type:"button",onClick:Q,class:"text-sm underline text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200"}," ← Back ")]),Dt,r("div",Ct,[r("div",Tt,[r("div",Nt,[r("div",$t,[r("div",Ut,_(c.value.title||"Sans titre"),1),r("div",At,_(c.value.landmark_type||"UNKNOWN"),1)]),O(P)?h("",!0):(o(),l("div",Et,[N(H,{days:W.value,"range-start":S.value.start,"range-end":S.value.end,"empty-text":"No dated elements found","month-locale":"en-US","weekday-labels":B,"show-legend":!1,"show-max":!1},null,8,["days","range-start","range-end"])]))]),c.value.content?(o(),l("div",Mt,[r("div",Pt,_(c.value.content),1)])):h("",!0)])]),O(P)&&c.value.related_elements&&c.value.related_elements.length>0?(o(),l("div",Ft,[Bt,r("div",Wt,[N(H,{days:W.value,"range-start":S.value.start,"range-end":S.value.end,"empty-text":"No dated elements found","month-locale":"en-US","weekday-labels":B,"legend-less-label":"Less","legend-more-label":"More"},null,8,["days","range-start","range-end"])])])):h("",!0),c.value.parent_landmarks&&c.value.parent_landmarks.length>0?(o(),l("div",jt,[Rt,r("div",zt,[(o(!0),l(w,null,D(q.value,a=>(o(),V(s,{key:a.id,to:`/app/landmarks/${a.id}`,class:"border border-slate-300 dark:border-zinc-700 rounded-lg p-3 hover:bg-gray-50 dark:hover:bg-zinc-800 transition-colors"},{default:E(()=>[Jt,r("div",It,_(a.title||"Untitled"),1)]),_:2},1032,["to"]))),128))]),G.value&&!C.value?(o(),l("button",{key:0,type:"button",class:"mt-3 text-sm underline text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200",onClick:e[0]||(e[0]=a=>C.value=!0)}," Show all ")):h("",!0)])):h("",!0),r("div",Ot,[r("section",Vt,[r("div",null,[Yt,N(yt,{elements:c.value.related_elements??[]},null,8,["elements"])]),r("div",Ht,[Kt,R.value.length>0?(o(),l(w,{key:0},[r("ul",Qt,[(o(!0),l(w,null,D(R.value,a=>(o(),l("li",{key:a.id,class:"list-disc ml-4"},[N(s,{to:`/app/landmarks/${a.id}`,class:"underline text-slate-300 hover:text-slate-100 transition-colors"},{default:E(()=>[Y(_(a.title),1)]),_:2},1032,["to"]),r("span",qt," · "+_(a.count)+" relation"+_(a.count>1?"s":""),1),a.preview?(o(),l("div",Gt,_(a.preview),1)):h("",!0)]))),128))]),st.value&&!T.value?(o(),l("button",{key:0,type:"button",class:"mt-2 text-xs underline text-slate-400 hover:text-slate-200 transition-colors",onClick:e[1]||(e[1]=a=>T.value=!0)}," voir plus ")):h("",!0)],64)):(o(),l("div",Xt,"Aucun landmark lié"))])]),c.value.related_elements&&c.value.related_elements.length>0?(o(),l("section",Zt,[te,r("div",ee,[r("div",se,[r("div",ae,[(o(!0),l(w,null,D(c.value.related_elements,a=>(o(),l("div",{key:`journal-${a.id}`,class:"journal-element-entry py-2 border-b border-slate-300/40 last:border-b-0"},[r("div",re,[r("div",ne,_(nt(a)),1),r("div",oe,[(o(!0),l(w,null,D(y.value[a.id]??[],n=>(o(),V(s,{key:`chip-${a.id}-${n.id??n.title}`,to:`/app/landmarks/${n.id}`,class:"text-[10px] px-1.5 py-0.5 rounded-full border border-slate-400/70 text-slate-600 bg-white/65 hover:border-slate-500 hover:text-slate-800 transition-colors"},{default:E(()=>[Y(_(n.title||"Sans nom"),1)]),_:2},1032,["to"]))),128))])]),(o(!0),l(w,null,D(rt(a),(n,i)=>(o(),l("div",{key:`span-${a.id}-${i}`,class:"font-georgia text-[15px] text-slate-700 leading-relaxed whitespace-pre-wrap"},_(n),1))),128))]))),128))])])])])):(o(),l("section",le,de))])])):(o(),l("div",ue,"Landmark not found"))])}}});const he=ft(ge,[["__scopeId","data-v-db348a0c"]]);export{he as default};
