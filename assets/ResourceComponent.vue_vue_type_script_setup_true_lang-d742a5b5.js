import{_ as ue,a as pe,u as Oe,r as Pe}from"./useThoughtInputs-bd738ecd.js";import{_ as Ve,u as Le}from"./useArticle-aa9cb673.js";/* empty css                                                          */import{o as t,f as r,a as _,d as U,h as F,n as w,t as $,i as v,s as we,C as je,q as H,b as f,k as ie,D as ge,e as ee,E as qe,F as le,g as se,p as P,G as xe,c as R,A as Te,r as ye,w as E,m as de,H as ze,x as ae,u as fe,_ as re,I as Me,J as Ne,j as We,l as He}from"./index-b3501787.js";import{_ as L}from"./ActionButton.vue_vue_type_script_setup_true_lang-a9b68c0c.js";import{a as Je,_ as Ke}from"./SelectionTextInterface.vue_vue_type_script_setup_true_lang-1d8376a0.js";import"./SelectionTextInterface.vue_vue_type_style_index_0_lang-f9547dbc.js";import{_ as Ue}from"./ProgressBar.vue_vue_type_script_setup_true_lang-66f0421f.js";import{_ as Z}from"./TextInput.vue_vue_type_script_setup_true_lang-d2b7ba12.js";import{u as _e}from"./useResource-b1cef00d.js";import{_ as Ae}from"./UserPicker.vue_vue_type_script_setup_true_lang-a9577ee1.js";import{u as De}from"./useResourceRelations-1687cc60.js";import{u as Ge}from"./useProblem-4f93b81a.js";function Xe(h,l){return t(),r("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true"},[_("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M9 8.25H7.5a2.25 2.25 0 00-2.25 2.25v9a2.25 2.25 0 002.25 2.25h9a2.25 2.25 0 002.25-2.25v-9a2.25 2.25 0 00-2.25-2.25H15M9 12l3 3m0 0l3-3m-3 3V2.25"})])}function Ye(h,l){return t(),r("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true"},[_("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M7.217 10.907a2.25 2.25 0 100 2.186m0-2.186c.18.324.283.696.283 1.093s-.103.77-.283 1.093m0-2.186l9.566-5.314m-9.566 7.5l9.566 5.314m0 0a2.25 2.25 0 103.935 2.186 2.25 2.25 0 00-3.935-2.186zm0-12.814a2.25 2.25 0 103.933-2.185 2.25 2.25 0 00-3.933 2.185z"})])}function Qe(h,l){return t(),r("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true"},[_("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M21.75 6.75a4.5 4.5 0 01-4.884 4.484c-1.076-.091-2.264.071-2.95.904l-7.152 8.684a2.548 2.548 0 11-3.586-3.586l8.684-7.152c.833-.686.995-1.874.904-2.95a4.5 4.5 0 016.336-4.486l-3.276 3.276a3.004 3.004 0 002.25 2.25l3.276-3.276c.256.565.398 1.192.398 1.852z"}),_("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M4.867 19.125h.008v.008h-.008v-.008z"})])}const Ze={class:"bg-slate-100 border p-1 m-1 rounded shadow-xl"},et={class:"flex"},tt={key:0,class:"text-xs mt-0.5 mb-1 font-bold flex"},ot=["src"],lt={class:"my-auto"},st={class:"text-2xs italic ml-auto mr-1 my-auto"},at={key:0},nt=["value"],rt={class:"flex"},ut={key:1,class:"text-xs mt-0.5"},be=U({__name:"CommentCard",props:{editing:{type:Boolean},modelValue:{},author:{},createdAt:{}},emits:["update:modelValue","validate","abort"],setup(h,{emit:l}){const s=h,d=F(()=>s.createdAt?s.createdAt.toLocaleString("fr-FR",{hour:"numeric",weekday:"short",day:"numeric",month:"short",year:"2-digit"}):""),o=e=>{l("update:modelValue",e.target.value)},p=()=>{l("validate")},m=()=>{l("abort")};return(e,u)=>(t(),r("div",Ze,[_("div",et,[e.author?(t(),r("div",tt,[e.author.profile_picture_url?(t(),r("img",{key:0,class:"h-5 w-5 rounded-full mr-1",src:e.author.profile_picture_url},null,8,ot)):w("",!0),_("div",lt,$(e.author.first_name)+" "+$(e.author.last_name),1)])):w("",!0),_("div",st,$(d.value),1)]),e.editing?(t(),r("div",at,[_("textarea",{class:"w-full text-xs rounded-xl p-2",value:e.modelValue,onInput:o},null,40,nt),_("div",rt,[v(L,{onClick:p,class:"text-sm",rounded:"",size:"2xs",text:"Commenter",type:"valid"}),v(L,{onClick:m,class:"text-sm",rounded:"",size:"2xs",text:"Annuler",type:"abort"})])])):(t(),r("div",ut,$(e.modelValue),1))]))}}),{launchSnackbar:ke}=je(),it=async(h,l,s,d)=>{const{user:o}=H(),p={start_index:l,end_index:l,content:s,editing:d};try{const m=await we.post("/resources/"+h+"/comments",p),e=$e(m.data);return o.value&&e.author_id==o.value.id&&(e.author=o.value),e}catch(m){throw console.log("error : ",m),ke(`Error creating comment : ${m}`,"error"),m}},$e=h=>(h.updated_at=new Date(h.updated_at.split(".")[0]),h.created_at=new Date(h.created_at.split(".")[0]),h),ct=async(h,l=!0)=>{const s=l?"?author=true":"";try{return(await we.get("/resources/"+h+"/comments"+s)).data.map(o=>$e(o))}catch(d){throw console.log("error : ",d),ke(`Error getting comments : ${d}`,"error"),d}},Ee=async h=>{try{const l=await we.put("/comments/"+h.id,h);return $e(l.data)}catch(l){console.log("error : ",l),ke(`Error updating comment : ${l}`,"error")}},dt=async h=>{console.log("comments : ",h),h.map(l=>Ee(l))};function Ce(){return{createComment:it,getCommentsForThoughtOutput:ct,updateComment:Ee,batchUpdateComments:dt}}const vt={class:"relative"},mt={key:0},pt=_("div",{class:"text-sm align-middle flex items-center p-2",style:{height:"50px"}}," Corriger une faute ",-1),ft={class:"flex mx-auto max-w-full"},_t={class:"w-full"},ht={key:0,class:"flex"},gt=_("div",{class:"w-6"},[_("div",{class:"rounded-full ml-4 mr-2 mt-2 h-1 w-1 bg-black"})],-1),xt=[gt],yt={class:"flex flex-wrap flex-1"},bt=["onClick","onContextmenu"],wt={key:0,style:{width:"5px"}},kt={key:1,style:{height:"25px"}},$t={key:2},Ct=["onClick"],Rt={key:1,class:"absolute h-full",style:{right:"-2%",width:"27%"}},It={key:0,style:{width:"33%"}},Vt=U({__name:"TextInterface",props:{resourceId:{},fullText:{},extComments:{default:()=>[]},editable:{type:Boolean,default:!0}},emits:["change","changeComments"],setup(h,{emit:l}){const s=h,d=n=>{console.log("selectCursorPosition letter : ",n),s.editable&&(o.value={id:n.id,char:n.char})},o=f(null),p=f([]),m=f([]),e=async()=>{let n=[{id:0,words:[{id:0,text:[]}],comments:[]}],c=0,k=0;for(var T=0;T<p.value.length;T++){p.value[T].char==`
`&&(c+=1,k=0,n.push({id:c,words:[{id:0,text:[]}],lineStyle:T<p.value.length-1?p.value[T+1].char:null,comments:[]}));const A=S.value.find(W=>W.start_index==T);A&&n[c].comments.push(A),n[c].words[k].text.push({id:T,char:p.value[T].char,comment:A}),p.value[T].char==" "&&(k+=1,n[c].words.push({id:k,text:[]}))}return n},u=n=>{n==1?S.value.forEach(c=>{o.value&&c.start_index>o.value.id&&(c.start_index+=1),o.value&&c.end_index>o.value.id&&(c.end_index+=1)}):n==-1&&S.value.forEach(c=>{o.value&&c.start_index>=o.value.id&&(c.start_index-=1),o.value&&c.end_index>=o.value.id&&(c.end_index-=1)})},a=n=>{console.log("insertChar : ",n),o.value&&(console.log("insertChar with cursor set : ",n),p.value.filter(c=>o.value&&c.id>=o.value.id+1).forEach(c=>c.id+=1),p.value.splice(o.value.id+1,0,{id:o.value.id+1,char:n}),u(1),o.value.id+=1)},i=n=>{if(console.log("Writes : ",n.key),o.value===null)return;const c=n.key;if(g.value&&c=="v"){b();return}if(c.length==1)n.preventDefault(),a(c);else if(c=="Backspace")p.value.splice(o.value.id,1),p.value.filter(k=>o.value&&k.id>o.value.id).forEach(k=>k.id-=1),u(-1),o.value.id-=1;else if(c=="Enter")a(`
`);else if(c=="ArrowRight"){let k=o.value.id;k<p.value.length-1&&d(p.value[k+1])}else if(c=="ArrowLeft"){let k=o.value.id;k>0&&d(p.value[k-1])}else c=="Control"&&(console.log("Control"),g.value=!0)},g=f(!1),b=async()=>{try{let c=await navigator.clipboard.readText();console.log("Clippedtext : ",c);for(var n=0;n<c.length;n++)a(c[n])}catch(c){console.log("Error with clippboard : ",c)}},j=n=>{n.key=="Control"&&(g.value=!1)},{createComment:J,batchUpdateComments:K}=Ce(),{isMobile:te}=Te(),S=f([]),G=f(null),M=async n=>{S.value=n.filter(c=>c.start_index!=null)},N=async()=>{if(console.log("Add Comment"),console.log(s.resourceId),console.log(q.value),!s.resourceId||!q.value)return;console.log("Add Comment 2");const n=await J(s.resourceId,q.value);S.value.push(n)};ie(S,async(n,c)=>{console.log("Watch comments triggered : ",n),y.value&&(console.log("Comments : ",n),l("changeComments",n),G.value!==null&&clearTimeout(G.value),G.value=setTimeout(()=>K(n),1e3)),console.log(`Old comments lenght : ${c.length} new length: ${n.length}`),console.log("OldComments : ",c),console.log("NewComments : ",n),c.length===0&&n.length>0&&(console.log("Finally loading comments"),m.value=await e())},{deep:!0}),ie(ge(s).extComments,async n=>{await M(n)});const X=f(!1),q=f(null),Y=f({position:"absolute","z-index":90,top:"0px",left:"0px",height:"106px",width:"260px"}),{user:oe}=H(),I=(n,c)=>{n.preventDefault(),oe.value&&(o.value=null,Y.value.top=`${n.layerY}px`,Y.value.left=`${n.layerX}px`,X.value=!0,q.value=c,console.log("event : ",n),console.log("Have a new right click"))},V=n=>{if(p.value=[],n===void 0||n==""){p.value=[{id:0,char:`
`}],d({id:0,char:`
`});return}for(var c=0;c<n.length;c++){const k=S.value.find(T=>T.start_index==c);p.value.push({id:c,char:n[c],comment:k})}},B=n=>n.reduce((c,k)=>c+k.char,""),y=f(!1);return ee(async()=>{await M(s.extComments),await V(s.fullText),await new Promise(n=>setTimeout(n,10)),m.value=await e(),y.value=!0}),ie(p,async n=>{console.log("Watch triggered : ",n),y.value&&(l("change",B(n)),m.value=await e())},{deep:!0}),(n,c)=>(t(),r("div",vt,[v(Je,{text:n.fullText,class:"absolute z-10 h-6 right-2"},null,8,["text"]),y.value?(t(),r("div",{key:1,id:"main-interface",class:"relative md:p-4",tabindex:"0",onKeydown:i,onKeyup:j,onClick:c[0]||(c[0]=k=>X.value=!1)},[X.value?(t(),r("div",{key:0,class:"bg-white border-4",style:qe(Y.value)},[_("div",{onClick:N,class:"text-sm border-b-2 flex items-center p-2",style:{height:"50px"}}," Ajouter un commentaire "),pt],4)):w("",!0),_("div",ft,[_("div",_t,[(t(!0),r(le,null,se(m.value,(k,T)=>(t(),r("div",{key:T,class:"flex"},[k.lineStyle=="*"?(t(),r("div",ht,xt)):w("",!0),_("div",yt,[(t(!0),r(le,null,se(k.words,(A,W)=>(t(),r("div",{key:W,class:"flex flex-wrap"},[(t(!0),r(le,null,se(A.text,(D,ve)=>{var ne;return t(),r("div",{key:ve,class:xe(["border-blue-400",{"border-r-2":D.id==((ne=o.value)==null?void 0:ne.id),"bg-yellow-400":D.comment}]),onClick:me=>d(D),onContextmenu:me=>I(me,D.id)},[D.char==" "?(t(),r("div",wt)):D.char==`
`?(t(),r("div",kt)):(D.char=="#"||D.char=="*")&&W==0?(t(),r("div",$t)):(t(),r("div",{key:3,class:xe({"font-bold":k.lineStyle=="#"})},[_("div",null,$(D.char),1)],2))],42,bt)}),128))]))),128)),_("div",{class:"flex-1",onClick:A=>d(k.words.slice(-1)[0].text.slice(-1)[0])},null,8,Ct)]),S.value.length>0&&!P(te)?(t(),r("div",Rt,[(t(!0),r(le,null,se(k.comments,(A,W)=>(t(),R(be,{key:W,class:"w-full",modelValue:A.content,"onUpdate:modelValue":D=>A.content=D,editing:A.editing,onValidate:D=>A.editing=!1,author:A.author,"created-at":A.created_at},null,8,["modelValue","onUpdate:modelValue","editing","onValidate","author","created-at"]))),128))])):w("",!0)]))),128))]),S.value.length>0&&!P(te)?(t(),r("div",It)):w("",!0)])],32)):(t(),r("div",mt,[_("span",null,$(n.fullText),1)]))]))}}),Tt=_("hr",{class:"border-top border-zinc-400 my-4"},null,-1),Ut=_("div",{class:"text-xs italic"},"Raison de la lecture",-1),At=U({__name:"SeeThoughtInput",props:{thoughtInput:{}},setup(h){const l=h,{getUserById:s,user:d}=H(),o=f(null),p=F(()=>d.value?l.thoughtInput.interaction_user_id===d.value.id:!1);return ee(async()=>{l.thoughtInput.interaction_user_id&&(o.value=await s(l.thoughtInput.interaction_user_id))}),(m,e)=>(t(),r("div",null,[v(Oo,{id:m.thoughtInput.resource_id,"second-level":""},null,8,["id"]),Tt,Ut,v(Vt,{"full-text":m.thoughtInput.interaction_comment,editable:p.value},null,8,["full-text","editable"])]))}}),Dt={class:"w-full md:w-96"},Et={key:0,class:"text-xs italic mb-2 bg-white"},Ft={class:"flex flex-wrap"},St={key:1,class:"text-2xs italic ml-2"},Bt={key:2,class:"ml-auto m-1 w-1/3"},Ot={key:0,class:"border shadow-lg rounded p-4 md:w-96 bg-white"},Pt={class:"flex"},Lt=["src"],jt={class:"flex flex-wrap w-full",style:{"margin-top":"-8px"}},qt={class:"text-2xs"},zt={class:"flex flex-wrap"},Mt={key:0,class:"text-2xs italic"},Nt=U({__name:"ThoughtInputCard",props:{contextualResource:{},isDisabled:{type:Boolean,default:!1}},setup(h){const l=h,{getUserById:s}=H(),{getAuthorInteractionForResource:d}=_e(),o=f(null),p=f(null),m=f(null);ee(async()=>{l.contextualResource.user_id&&(m.value=await s(l.contextualResource.user_id)),l.contextualResource.resource&&(p.value=await d(l.contextualResource.resource.id)),p.value&&(o.value=await s(p.value.interaction_user_id))});const e=a=>a?a.toLocaleString("fr-FR",{hour:"numeric",weekday:"short",day:"numeric",month:"short",year:"2-digit"}):"",u=a=>a.length>200?a.slice(0,150)+"...":a;return(a,i)=>{const g=ye("router-link");return t(),r("div",Dt,[a.contextualResource.context_comment?(t(),r("div",Et,[_("div",null,$(a.contextualResource.context_comment),1),_("div",Ft,[m.value?(t(),R(g,{key:0,to:"/users/"+m.value.id,class:"text-2xs underline"},{default:E(()=>[de($(m.value.first_name)+" "+$(m.value.last_name),1)]),_:1},8,["to"])):w("",!0),a.contextualResource.date?(t(),r("div",St,$(e(a.contextualResource.date)),1)):w("",!0),a.contextualResource.progress?(t(),r("div",Bt,[v(Ue,{"progress-value":a.contextualResource.progress},null,8,["progress-value"])])):w("",!0)])])):w("",!0),a.contextualResource.resource?(t(),R(ze(a.isDisabled?"span":"vue-router"),{key:1,to:"/resources/"+a.contextualResource.resource.id+"?tab=ctnt"},{default:E(()=>[a.contextualResource.resource?(t(),r("div",Ot,[_("div",Pt,[a.contextualResource.resource?(t(),r("img",{key:0,class:"w-8 h-fit mr-4",src:a.contextualResource.resource.image_url},null,8,Lt)):w("",!0),_("div",null,[_("div",null,$(a.contextualResource.resource.title)+" "+$(a.contextualResource.resource.subtitle),1),_("div",jt,[o.value?(t(),R(g,{key:0,to:"/users/"+o.value.id,class:"text-2xs underline"},{default:E(()=>[de($(o.value.first_name)+" "+$(o.value.last_name),1)]),_:1},8,["to"])):w("",!0)]),_("div",qt,$(u(a.contextualResource.resource.comment)),1)])]),_("div",zt,[a.contextualResource.date?(t(),r("div",Mt,$(e(a.contextualResource.resourcedate)),1)):w("",!0)])])):w("",!0)]),_:1},8,["to"])):w("",!0)])}}}),Wt={class:"w-fit"},Ht=U({__name:"ThoughtInputCardWithPopup",props:{thoughtInput:{},usageReason:{},isDisabled:{type:Boolean,default:!1}},setup(h){const l=f(!1);return(s,d)=>(t(),r("div",Wt,[v(ue,{open:l.value,onClose:d[0]||(d[0]=o=>l.value=!1)},{default:E(()=>[v(At,{"thought-input":s.thoughtInput,"usage-reason":s.usageReason},null,8,["thought-input","usage-reason"])]),_:1},8,["open"]),v(Nt,{class:"md:w-96","contextual-resource":s.thoughtInput,"is-disabled":s.isDisabled},null,8,["contextual-resource","is-disabled"])]))}}),Jt={class:"relative max-w-full"},Kt={key:0,class:"absolute md:border h-full start-1/2 -z-10"},ce=U({__name:"ThoughtInputsList",props:{contextualResources:{},center:{type:Boolean,default:!1},linksDisabled:{type:Boolean,default:!1}},emits:["select"],setup(h,{emit:l}){const s=o=>o.sort((p,m)=>+(m.date>p.date)),d=o=>{console.log("Select"),l("select",o)};return(o,p)=>(t(),r("div",Jt,[o.center?w("",!0):(t(),r("div",Kt)),(t(!0),r(le,null,se(s(o.contextualResources),(m,e)=>(t(),R(Ht,{key:m.id,class:xe(["mb-4 md:mb-1 mx-auto max-w-full max-w-fit p-1",{"md:ml-0":e%2==0&&!o.center,"md:mr-0":!o.center}]),"thought-input":m,onClick:u=>d(m),"is-disabled":o.linksDisabled},null,8,["class","thought-input","onClick","is-disabled"]))),128))]))}}),Gt={key:0,class:"mb-4"},Xt={key:1},Yt={key:1},Qt={key:2},Zt={class:"flex flex-row-reverse"},eo=U({__name:"CreateResourceRelationForm",props:{targetResource:{},originResource:{}},emits:["close","refresh"],setup(h,{emit:l}){const s=h,{user:d}=H(),o=f(),p=I=>{console.log("Event : ",I),o.value=I},m=f([{text:"Externes",value:"extr"},{text:"Internes",value:"artl"},{text:"Problème",value:"pblm"}]),e=f([{text:"Biblio",value:"bibl"},{text:"Résumé",value:"sumr"},{text:"Sujet principal",value:"main"},{text:"Evocation",value:"mino"}]),u=f([]),a=f(null),i=f([]),g=f([]),b=f([]),j=f(""),J=f(""),{createResourceRelation:K}=De(),{getResources:te}=_e(),{getArticles:S}=Le(),{getProblems:G}=Ge(),M=F(()=>u.value.map(I=>({resource:I.resource}))),N=I=>I.map(V=>({resource:V})),X=F(()=>({extr:N(i.value),artl:N(g.value),pblm:N(b.value)})),q=async()=>{if(console.log("create"),!a.value)return;const I={target_resource_id:s.targetResource?s.targetResource.id:a.value.id,origin_resource_id:s.originResource?s.originResource.id:a.value.id,relation_comment:j.value,relation_type:J.value};await K(I),l("refresh"),l("close")},{getUserThoughtInputs:Y}=Oe(),oe=I=>{a.value=I.resource};return ee(async()=>{!d.value||!d.value.id||(s.targetResource&&(u.value=await Y(d.value.id)),s.originResource&&(i.value=await te(),g.value=await S({author:!0}),b.value=await G()))}),(I,V)=>(t(),r("div",null,[P(d)?(t(),r("div",Gt," Nouvelle relation entre ressources par "+$(P(d).first_name)+" "+$(P(d).last_name),1)):w("",!0),a.value?(t(),r("div",Qt,[v(ae,{class:"m-4",label:"Type de lien",choices:e.value,modelValue:J.value,"onUpdate:modelValue":V[2]||(V[2]=B=>J.value=B)},null,8,["choices","modelValue"]),v(pe,{class:"m-4",label:"Pourquoi ajouter cet élément ?",modelValue:j.value,"onUpdate:modelValue":V[3]||(V[3]=B=>j.value=B)},null,8,["modelValue"]),_("div",Zt,[v(L,{type:"valid",onClick:q,text:"Ajouter"}),v(L,{type:"abort",onClick:V[4]||(V[4]=B=>l("close")),text:"Annuler",class:"mr-1"})])])):(t(),r("div",Xt,[I.targetResource?(t(),R(ce,{key:0,"contextual-resources":M.value,center:"","links-disabled":"",onSelect:V[0]||(V[0]=B=>oe(B))},null,8,["contextual-resources"])):(t(),r("div",Yt,[_("div",null,[de(" Choisir une ressource cible "),v(Ve,{center:"",choices:m.value,default:"pblm",onUpdate:p},null,8,["choices"]),v(ce,{"contextual-resources":X.value[o.value]||[],center:"",onSelect:V[1]||(V[1]=B=>oe(B)),"links-disabled":""},null,8,["contextual-resources"])])]))]))]))}}),to={class:"flex flex-wrap"},oo={class:"flex flex-row-reverse"},lo=U({__name:"CreateInteraction",props:{resource:{}},emits:["close","refresh"],setup(h,{emit:l}){const s=h,d=f([{text:"Lecture / Visionage",value:"inpt"},{text:"Envie",value:"wish"}]),{newInteraction:o,createInteractionForResource:p}=fe(),{user:m}=H(),e=f(o());ee(()=>{e.value.interaction_type||(e.value.interaction_type="inpt")});const u=()=>{e.value.resource_id=s.resource.id,e.value.interaction_user_id=m.value.id,p(s.resource.id,e.value),l("refresh"),a()},a=()=>l("close");return(i,g)=>(t(),r("div",null,[_("div",null,"Nouvelle interaction, avec la ressource : "+$(i.resource.title),1),_("div",to,[v(Z,{label:"Avancement de l'ouvrage",class:"my-auto",modelValue:e.value.interaction_progress,"onUpdate:modelValue":g[0]||(g[0]=b=>e.value.interaction_progress=b),type:"number"},null,8,["modelValue"]),v(ae,{label:"Type d'interaction",class:"m-4 w-full md:w-5/12 md:ml-auto",choices:d.value,modelValue:e.value.interaction_type,"onUpdate:modelValue":g[1]||(g[1]=b=>e.value.interaction_type=b)},null,8,["choices","modelValue"])]),v(Z,{label:"Date de lecture",modelValue:e.value.interaction_date,"onUpdate:modelValue":g[2]||(g[2]=b=>e.value.interaction_date=b),type:"date"},null,8,["modelValue"]),v(pe,{label:"Pourquoi s'y être interessé ?",modelValue:e.value.interaction_comment,"onUpdate:modelValue":g[3]||(g[3]=b=>e.value.interaction_comment=b)},null,8,["modelValue"]),_("div",oo,[v(L,{onClick:u,class:"m-4",text:"Valider",type:"valid"}),v(L,{onClick:a,class:"m-4",text:"Annuler",type:"abort"})])]))}}),so=_("div",null,"Demander une Review pour l'article :",-1),ao={class:"flex flex-row-reverse mt-4"},no=U({__name:"CreateReview",props:{resource:{}},emits:["close","refresh"],setup(h,{emit:l}){const s=h,{newInteraction:d,createInteractionForResource:o}=fe(),p=async()=>{const u=d();u.interaction_user_id=e.value,u.resource_id=s.resource.id,u.interaction_type="rvew",u.interaction_comment=m.value,await o(s.resource.id,u),l("refresh"),l("close")},m=f(""),e=f(null);return(u,a)=>(t(),r("div",null,[so,_("div",null,$(u.resource.title),1),v(Ae,{modelValue:e.value,"onUpdate:modelValue":a[0]||(a[0]=i=>e.value=i)},null,8,["modelValue"]),v(pe,{class:"mt-4",label:"Message pour la review",modelValue:m.value,"onUpdate:modelValue":a[1]||(a[1]=i=>m.value=i)},null,8,["modelValue"]),_("div",ao,[v(L,{type:"valid",onClick:p,text:"Ajouter"}),v(L,{type:"abort",onClick:a[2]||(a[2]=i=>l("close")),text:"Annuler",class:"mr-1"})])]))}}),ro=U({__name:"ResourceTools",props:{resource:{},isResourceEditable:{type:Boolean}},emits:["refresh","edit"],setup(h,{emit:l}){const s=f(!1),d=f(!1),o=f(!1),p=f(!1);return(m,e)=>(t(),r("div",null,[m.isResourceEditable&&s.value?(t(),R(re,{key:0,title:"Modifier",onClick:e[0]||(e[0]=u=>l("edit"))},{default:E(()=>[v(P(Pe),{class:"m-1"})]),_:1})):w("",!0),m.isResourceEditable&&s.value?(t(),R(re,{key:1,class:"mt-2",color:"blue",title:"Demander une review",onClick:e[1]||(e[1]=u=>d.value=!0)},{default:E(()=>[v(P(Me),{class:"m-1"})]),_:1})):w("",!0),v(ue,{open:d.value,onClose:e[4]||(e[4]=u=>d.value=!1)},{default:E(()=>[v(no,{onRefresh:e[2]||(e[2]=u=>l("refresh")),onClose:e[3]||(e[3]=u=>d.value=!1),resource:m.resource},null,8,["resource"])]),_:1},8,["open"]),m.isResourceEditable&&s.value?(t(),R(re,{key:2,class:"mt-2",color:"red",title:"Marquer comme lu",onClick:e[5]||(e[5]=u=>o.value=!0)},{default:E(()=>[v(P(Xe),{class:"m-1"})]),_:1})):w("",!0),v(ue,{open:o.value,onClose:e[8]||(e[8]=u=>o.value=!1)},{default:E(()=>[v(lo,{onRefresh:e[6]||(e[6]=u=>l("refresh")),onClose:e[7]||(e[7]=u=>o.value=!1),resource:m.resource},null,8,["resource"])]),_:1},8,["open"]),m.isResourceEditable&&s.value?(t(),R(re,{key:3,class:"mt-2",color:"green",title:"Relier à d'autres ressources",onClick:e[9]||(e[9]=u=>p.value=!0)},{default:E(()=>[v(P(Ye),{class:"m-1"})]),_:1})):w("",!0),v(ue,{open:p.value,onClose:e[12]||(e[12]=u=>p.value=!1)},{default:E(()=>[v(eo,{onRefresh:e[10]||(e[10]=u=>l("refresh")),onClose:e[11]||(e[11]=u=>p.value=!1),"origin-resource":m.resource},null,8,["origin-resource"])]),_:1},8,["open"]),v(re,{class:"mt-2",color:"gray",onClick:e[13]||(e[13]=u=>s.value=!s.value)},{default:E(()=>[v(P(Qe))]),_:1})]))}}),uo=U({__name:"CommentsThread",props:{resourceId:{}},setup(h){const l=h,{user:s}=H(),d=f([]),{createComment:o,getCommentsForThoughtOutput:p}=Ce(),m=async()=>{console.log("Comment thread"),console.log("Props id : ",l.resourceId),d.value=await p(l.resourceId)},e=F(()=>d.value.filter(i=>!i.start_index).sort((i,g)=>i.created_at-g.created_at)),u=f(""),a=async()=>{await o(l.resourceId,null,u.value,!1),u.value="",await m()};return ee(async()=>await m()),(i,g)=>(t(),r("div",null,[(t(!0),r(le,null,se(e.value,b=>(t(),R(be,{key:b.id,class:"w-full",modelValue:b.content,"onUpdate:modelValue":j=>b.content=j,editing:b.editing,onValidate:j=>b.editing=!1,author:b.author,"created-at":b.created_at},null,8,["modelValue","onUpdate:modelValue","editing","onValidate","author","created-at"]))),128)),v(be,{class:"w-full",modelValue:u.value,"onUpdate:modelValue":g[0]||(g[0]=b=>u.value=b),editing:!0,onValidate:a,author:P(s),"created-at":null},null,8,["modelValue","author"])]))}}),io=U({__name:"DateField",props:{date:{}},setup(h){const l=h,s=F(()=>new Date(l.date).toLocaleDateString("fr-FR",{day:"numeric",month:"short",year:"numeric"}));return(d,o)=>(t(),r("div",null,$(s.value),1))}}),co={class:"flex flex-col"},vo={class:"block text-2xs text-slate-800"},mo=["value","placeholder"],po=U({__name:"NumberInput",props:{label:{},modelValue:{},placeholder:{}},emits:["update:modelValue","input"],setup(h,{emit:l}){const s=d=>{l("update:modelValue",d.target.value),l("input",d.target.value)};return(d,o)=>(t(),r("div",co,[_("label",vo,$(d.label),1),_("input",{class:"border border-neutral-400 block h-full w-full rounded-md border-2 p-1 pl-2 text-xs",type:"number",value:d.modelValue,placeholder:d.placeholder,onInput:o[0]||(o[0]=p=>s(p))},null,40,mo)]))}}),fo={class:"grid grid-cols-4 gap-y-2 gap-x-4 auto-rows-auto"},_o=U({__name:"ArticleForm",props:{article:{}},emits:["change"],setup(h,{emit:l}){const s=h,d=f([{text:"Terminé",value:"fnsh"},{text:"Relecture",value:"rvew"},{text:"Idée",value:"idea"}]),{resourceTypeOptions:o}=_e(),{categories:p}=Ne(),m=F(()=>p.value.map(u=>({text:u.display_name,value:u.id}))),e=(u,a)=>{let i={...s.article};i[u]=a,i.is_external&&(i.maturing_state="fnsh"),console.log("Article : ",i),l("change",i)};return(u,a)=>(t(),r("div",fo,[v(Z,{class:"col-span-4",label:"Titre",modelValue:u.article.title,"onUpdate:modelValue":a[0]||(a[0]=i=>e("title",i))},null,8,["modelValue"]),v(Z,{class:"col-span-4",label:"Sous-titre",modelValue:u.article.subtitle,"onUpdate:modelValue":a[1]||(a[1]=i=>e("subtitle",i))},null,8,["modelValue"]),v(Z,{class:"col-span-4 md:col-span-2",label:"Lien contenu externe",modelValue:u.article.external_content_url,"onUpdate:modelValue":a[2]||(a[2]=i=>e("external_content_url",i))},null,8,["modelValue"]),v(Z,{class:"col-span-4 md:col-span-2",label:"Lien image",modelValue:u.article.image_url,"onUpdate:modelValue":a[3]||(a[3]=i=>e("image_url",i))},null,8,["modelValue"]),v(ae,{label:"Catégorie",class:"col-span-4 md:col-span-1",choices:m.value,"model-value":u.article.category_id,"onUpdate:modelValue":a[4]||(a[4]=i=>e("category_id",i))},null,8,["choices","model-value"]),v(ae,{label:"Type de ressource",class:"col-span-4 md:col-span-1",choices:P(o),"onUpdate:modelValue":a[5]||(a[5]=i=>e("resource_type",i)),"model-value":u.article.resource_type},null,8,["choices","model-value"]),v(ae,{label:"Ressource externe",class:"col-span-4 md:col-span-1",choices:[{text:"Oui",value:!0},{text:"Non",value:!1}],"onUpdate:modelValue":a[6]||(a[6]=i=>e("is_external",JSON.parse(i))),"model-value":u.article.is_external},null,8,["model-value"]),v(ae,{label:"Stade d'écriture",class:"col-span-4 md:col-span-1",choices:d.value,"model-value":u.article.maturing_state,"onUpdate:modelValue":a[7]||(a[7]=i=>e("maturing_state",i))},null,8,["choices","model-value"])]))}}),ho={class:"grid grid-cols-3 gap-4"},go=U({__name:"ResourceAuthorPicker",props:{interaction:{},resourceId:{}},emits:["update"],setup(h,{emit:l}){const s=h,d=F(()=>{var i;return(i=s.interaction)==null?void 0:i.interaction_user_id}),{createInteractionForResource:o,newInteraction:p,createInteraction:m,updateInteraction:e}=fe(),u=async i=>{if(console.log(`newUser : ${JSON.stringify(i)}`),s.interaction){const g={...s.interaction};g.interaction_user_id=i,console.log("newUserid : ",i.id),console.log(`Interaction payload : ${JSON.stringify(g)}`),await e(s.interaction.id,g),l("update")}else{console.log("create interaction");const g=p();g.interaction_user_id=i,g.resource_id=s.resourceId,await o(s.resourceId,g),l("update")}},a=async i=>{await e(s.interaction.id,i),l("update")};return(i,g)=>(t(),r("div",ho,[v(Ae,{"model-value":d.value,"onUpdate:modelValue":g[0]||(g[0]=b=>u(b))},null,8,["model-value"]),i.interaction?(t(),R(Z,{key:0,class:"text-2xs",label:"Date d'écriture","model-value":i.interaction.interaction_date?i.interaction.interaction_date.split("T")[0]:null,"onUpdate:modelValue":g[1]||(g[1]=b=>a({...i.interaction,interaction_date:b})),type:"date"},null,8,["model-value"])):w("",!0),i.interaction?(t(),R(po,{key:1,class:"",label:"Progression",modelValue:i.interaction.interaction_progress,"onUpdate:modelValue":g[2]||(g[2]=b=>a({...i.interaction,interaction_progress:b}))},null,8,["modelValue"])):w("",!0)]))}}),xo={key:0,class:"text-center text-2xl pt-10"},yo={key:1},bo={key:0},wo={class:"my-8"},ko=["src"],$o={class:"text-3xl my-3 font-mplus md:text-center text-left"},Co={class:"md:text-center text-left"},Ro={class:"md:text-center text-left"},Io={class:"md:flex my-8"},Vo=["href"],To={key:1,class:"my-2 flex flex-col"},Uo={class:"flex flex-row-reverse mb-4"},Ao=_("hr",{class:"border-top border-zinc-400 my-4"},null,-1),Do={key:2},Eo=_("div",{class:"text-xs italic"},"Contenu",-1),Fo={key:3},So={key:4},Bo={key:5},Oo=U({__name:"ResourceComponent",props:{resourceId:{},secondLevel:{type:Boolean}},setup(h){const l=h,s=We(),d=F(()=>k.value&&c.value||!q.value||y.value.is_local_draft||!m.value),o=F(()=>l.secondLevel?"popup_tab":"tab"),p=F(()=>[{text:"Contenu",value:"ctnt"},{text:"Biblio",value:"bbli",count:g.value.length},{text:"Sujets",value:"pblm",count:M.value.length},{text:"Interactions",value:"inpt",count:K.value.length}]),m=f(!0),e=f(s.query[o.value]&&typeof s.query[o.value]=="string"?s.query[o.value]:"ctnt"),u=f(s.query[o.value]);ie(()=>s.query[o.value],x=>{console.log("new route query",x),typeof x=="string"&&(u.value=x)});const{getResourceRelationsForResource:a,getUsagesForResource:i}=De(),g=f([]),b=f(!1),j=async()=>{g.value=await a(ge(l).resourceId.value)},J=F(()=>g.value.map(x=>({resource:x.origin_resource,date:x.created_at,user_id:x.user_id,context_comment:x.relation_comment,progress:null}))),K=f([]),{getInteractionsForResource:te}=fe(),S=async()=>{K.value=await te(l.resourceId)},G=F(()=>K.value.map(x=>({resource:null,date:x.interaction_date,user_id:x.interaction_user_id,context_comment:x.interaction_comment,progress:x.interaction_progress}))),M=f([]),N=async()=>{M.value=await i(l.resourceId)},X=F(()=>M.value.map(x=>({resource:x.target_resource,date:x.created_at,user_id:x.user_id,context_comment:x.relation_comment,progress:null}))),q=f(!1),{newResource:Y,getResource:oe,updateResource:I,getAuthorInteractionForResource:V}=_e(),B=f(null),y=f(Y()),n=He();ie(()=>s.query.editing,x=>{console.log("Editing : ",x),c.value=x==="false"?!1:!!x});const c=f(!1),{isMobile:k}=Te(),T=x=>{n.push({query:{editing:x.toString()}})},A=()=>{!y.value||!y.value.id||(y.value.publishing_state="pbsh",I(y.value.id,y.value))},W=()=>{!y.value||!y.value.id||(y.value.publishing_state="drft",I(y.value.id,y.value))},D=(x,C)=>{y.value=C,B.value!==null&&clearTimeout(B.value),B.value=setTimeout(async()=>{try{await I(x,y.value)}catch(he){console.log("An error : ",he)}},1e3)},ve=x=>{x!=`
`&&D(ge(l).resourceId.value,{...y.value,content:x})},{user:ne,getUserById:me}=H(),Re=F(()=>y.value.is_external?!0:ne.value?Q.value?Q.value.id==ne.value.id:!0:!1),Q=f(null),z=f(null),Fe=async()=>{z.value=await V(l.resourceId)},{getCommentsForThoughtOutput:Se}=Ce(),Ie=f([]);return ee(async()=>{q.value=!1,y.value=await oe(l.resourceId),q.value=!0,await j(),await S(),await N(),Ie.value=await Se(l.resourceId),z.value=await V(l.resourceId),z.value&&(Q.value=await me(z.value.interaction_user_id));const x=s.query.editing;c.value=x==="false"?!1:!!x}),(x,C)=>{const he=ye("router-link"),Be=ye("CreateResourceRelationForm");return t(),r("div",null,[q.value?(t(),r("div",yo,[c.value?(t(),r("div",To,[v(_o,{article:y.value,class:"",onChange:C[0]||(C[0]=O=>D(y.value.id,O))},null,8,["article"]),v(go,{class:"my-2",interaction:z.value,"resource-id":x.resourceId,onChange:Fe},null,8,["interaction","resource-id"]),_("div",Uo,[v(L,{class:"ml-2",onClick:C[1]||(C[1]=O=>T(!1)),type:"valid",text:"Preview"},{default:E(()=>[de("Ok")]),_:1}),y.value.publishing_state=="drft"?(t(),R(L,{key:0,class:"ml-2",onClick:A,type:"valid",text:"Publier"})):(t(),R(L,{key:1,class:"ml-2",onClick:W,type:"abort",text:"Dépublier"})),v(L,{class:"ml-2",onClick:C[2]||(C[2]=O=>m.value=!m.value),type:"valid",text:m.value?"Text brut":"Editeur"},null,8,["text"])])])):(t(),r("div",bo,[_("div",wo,[_("img",{src:y.value.image_url,class:"border border-slate-300 dark:border-zinc-700 rounded-xl ml-auto mr-auto",style:{"max-height":"20rem"}},null,8,ko)]),_("h1",$o,$(y.value.title),1),_("div",Co,$(y.value.subtitle),1),_("div",Ro,[Q.value?(t(),R(he,{key:0,to:"/users/"+Q.value.id,class:"text-sm underline"},{default:E(()=>[de($(Q.value.first_name)+" "+$(Q.value.last_name),1)]),_:1},8,["to"])):w("",!0),z.value?(t(),R(io,{key:1,date:z.value.interaction_date},null,8,["date"])):w("",!0)]),_("div",Io,[z.value?(t(),R(Ue,{key:0,"progress-value":z.value.interaction_progress,class:"m-2 w-1/3"},null,8,["progress-value"])):w("",!0),y.value.external_content_url?(t(),r("a",{key:1,class:"ml-auto underline",href:y.value.external_content_url,target:"_blank"}," Lien ressource externe ",8,Vo)):w("",!0)])])),_("div",null,[c.value?w("",!0):(t(),R(Ve,{key:0,choices:p.value,default:e.value,"url-key":o.value,url:""},null,8,["choices","default","url-key"]))]),Ao,u.value=="ctnt"?(t(),r("div",Do,[Eo,d.value?(t(),R(pe,{key:0,class:"mt-4 h-96",modelValue:y.value.content,"onUpdate:modelValue":C[3]||(C[3]=O=>ve(O))},null,8,["modelValue"])):(t(),R(Ke,{key:1,class:"min-h-fit","ext-comments":Ie.value,"resource-id":y.value.id,text:y.value.content,editable:Re.value,onChange:C[4]||(C[4]=O=>ve(O))},null,8,["ext-comments","resource-id","text","editable"])),v(uo,{class:"mt-6","resource-id":x.resourceId},null,8,["resource-id"])])):u.value=="bbli"?(t(),r("div",Fo,[v(ue,{open:b.value,onClose:C[6]||(C[6]=O=>b.value=!1)},{default:E(()=>[v(Be,{onRefresh:j,onClose:C[5]||(C[5]=O=>b.value=!1),"target-resource":y.value},null,8,["target-resource"])]),_:1},8,["open"]),_("div",{onClick:C[7]||(C[7]=O=>b.value=!0),class:"text-sm italic underline"}," Ajouter une référence "),v(ce,{"contextual-resources":J.value},null,8,["contextual-resources"])])):u.value=="pblm"?(t(),r("div",So,[v(ce,{"contextual-resources":X.value},null,8,["contextual-resources"])])):u.value=="inpt"?(t(),r("div",Bo,[v(ce,{"contextual-resources":G.value},null,8,["contextual-resources"])])):w("",!0),v(ro,{class:"fixed right-3 bottom-5",resource:y.value,"is-resource-editable":Re.value,onRefresh:C[8]||(C[8]=O=>N()&&S()),onEdit:C[9]||(C[9]=O=>T(!0))},null,8,["resource","is-resource-editable"])])):(t(),r("div",xo,"Loading..."))])}}});export{Oo as _,At as a,ce as b};
