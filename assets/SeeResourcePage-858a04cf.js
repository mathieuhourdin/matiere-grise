import{o as t,c as r,b as v,d as U,k as _,h as $e,p as Ce,l as H,e as x,F as Z,n as ee,a as c,w as $,m as T,t as k,A as j,q as F,z as re,S as ye,i as le,v as Oe,s as xe,g as O,j as C,u as Re,r as Ie,T as je,x as pe,U as ue,K as ie,y as ce,_ as ne,B as qe,V as Le}from"./index-dcfc5be2.js";import{_ as fe}from"./TextAreaInput.vue_vue_type_script_setup_true_lang-027de59d.js";import{a as Me,u as we,_ as Pe}from"./SelectionTextInterface.vue_vue_type_style_index_0_lang-cd925964.js";import{_ as Ve}from"./ProgressBar.vue_vue_type_script_setup_true_lang-6af20b43.js";import{u as Te}from"./useResourceRelations-54988609.js";import{_ as te}from"./TextInput.vue_vue_type_script_setup_true_lang-34261957.js";import{_ as Ue}from"./UserPicker.vue_vue_type_script_setup_true_lang-41953ef9.js";function ze(g,a){return t(),r("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true"},[v("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M9 8.25H7.5a2.25 2.25 0 00-2.25 2.25v9a2.25 2.25 0 002.25 2.25h9a2.25 2.25 0 002.25-2.25v-9a2.25 2.25 0 00-2.25-2.25H15M9 12l3 3m0 0l3-3m-3 3V2.25"})])}function Ne(g,a){return t(),r("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true"},[v("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M19.5 13.5L12 21m0 0l-7.5-7.5M12 21V3"})])}function Ke(g,a){return t(),r("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true"},[v("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M4.5 10.5L12 3m0 0l7.5 7.5M12 3v18"})])}function We(g,a){return t(),r("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true"},[v("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M7.217 10.907a2.25 2.25 0 100 2.186m0-2.186c.18.324.283.696.283 1.093s-.103.77-.283 1.093m0-2.186l9.566-5.314m-9.566 7.5l9.566 5.314m0 0a2.25 2.25 0 103.935 2.186 2.25 2.25 0 00-3.935-2.186zm0-12.814a2.25 2.25 0 103.933-2.185 2.25 2.25 0 00-3.933 2.185z"})])}function Je(g,a){return t(),r("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true"},[v("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M21.75 6.75a4.5 4.5 0 01-4.884 4.484c-1.076-.091-2.264.071-2.95.904l-7.152 8.684a2.548 2.548 0 11-3.586-3.586l8.684-7.152c.833-.686.995-1.874.904-2.95a4.5 4.5 0 016.336-4.486l-3.276 3.276a3.004 3.004 0 002.25 2.25l3.276-3.276c.256.565.398 1.192.398 1.852z"}),v("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M4.867 19.125h.008v.008h-.008v-.008z"})])}const He={class:"justify-items-center mx-auto flex flex-wrap max-w-full"},Ge={key:0,class:"ml-auto"},Qe={key:0,class:"absolute right-0 top-0 w-4 h-4 rounded-square text-2xs bg-green-400 text-center"},Xe=v("div",{class:"mr-auto"},null,-1),Ae=U({__name:"ToggleButtonGroup",props:{choices:{},default:{},urlKey:{},url:{type:Boolean,default:!1},center:{type:Boolean,default:!1}},emits:["update"],setup(g,{emit:a}){const o=g,m=_(null),s=$e(),i=Ce(),d=e=>{if(a("update",e),m.value=e,o.url){const n=i.query,f=i.path,u=o.urlKey??"tab";console.log(u);const h={};h[u]=e;const b={...n,...h};s.push({path:f,query:b}),console.log(`route : ${JSON.stringify(i)}`)}};return H(()=>d(o.default??"")),(e,n)=>(t(),r("div",He,[e.center?(t(),r("div",Ge)):x("",!0),(t(!0),r(Z,null,ee(e.choices,f=>(t(),r("div",{class:"relative",key:f.value},[c(j,{class:"w-30 my-1 mx-1",onClick:u=>d(f.value),type:f.value==m.value?"valid":"abort"},{default:$(()=>[T(k(f.text),1)]),_:2},1032,["onClick","type"]),f.count?(t(),r("div",Qe,k(f.count),1)):x("",!0)]))),128)),Xe]))}});const Ye={class:"bg-slate-100 border p-1 m-1 rounded shadow-xl"},Ze={class:"flex"},et={key:0,class:"text-xs mt-0.5 mb-1 font-bold flex"},tt=["src"],lt={class:"my-auto"},ot={class:"text-2xs italic ml-auto mr-1 my-auto"},st={key:0},at=["value"],nt={class:"flex"},rt={key:1,class:"text-xs mt-0.5"},be=U({__name:"CommentCard",props:{editing:{type:Boolean},modelValue:{},author:{},createdAt:{}},emits:["update:modelValue","validate","abort"],setup(g,{emit:a}){const o=g,m=F(()=>o.createdAt?o.createdAt.toLocaleString("fr-FR",{hour:"numeric",weekday:"short",day:"numeric",month:"short",year:"2-digit"}):""),s=e=>{a("update:modelValue",e.target.value)},i=()=>{a("validate")},d=()=>{a("abort")};return(e,n)=>(t(),r("div",Ye,[v("div",Ze,[e.author?(t(),r("div",et,[e.author.profile_picture_url?(t(),r("img",{key:0,class:"h-5 w-5 rounded-full mr-1",src:e.author.profile_picture_url},null,8,tt)):x("",!0),v("div",lt,k(e.author.first_name)+" "+k(e.author.last_name),1)])):x("",!0),v("div",ot,k(m.value),1)]),e.editing?(t(),r("div",st,[v("textarea",{class:"w-full text-xs rounded-xl p-2",value:e.modelValue,onInput:s},null,40,at),v("div",nt,[c(j,{onClick:i,class:"text-sm",rounded:"",size:"2xs",type:"valid"},{default:$(()=>[T("Commenter")]),_:1}),c(j,{onClick:d,class:"text-sm",rounded:"",size:"2xs",type:"abort"},{default:$(()=>[T("Annuler")]),_:1})])])):(t(),r("div",rt,k(e.modelValue),1))]))}}),ut={class:"relative"},it={key:0},ct=v("div",{class:"text-sm align-middle flex items-center p-2",style:{height:"50px"}}," Corriger une faute ",-1),dt={class:"flex mx-auto max-w-full"},vt={class:"w-full"},mt={key:0,class:"flex"},pt=v("div",{class:"w-6"},[v("div",{class:"rounded-full ml-4 mr-2 mt-2 h-1 w-1 bg-black"})],-1),ft=[pt],_t={class:"flex flex-wrap flex-1"},ht=["onClick","onContextmenu"],gt={key:0,style:{width:"5px"}},yt={key:1,style:{height:"25px"}},xt={key:2},bt=["onClick"],wt={key:1,class:"absolute h-full",style:{right:"-2%",width:"27%"}},kt={key:0,style:{width:"33%"}},$t=U({__name:"TextInterface",props:{resourceId:{},fullText:{},extComments:{default:()=>[]},editable:{type:Boolean,default:!0}},emits:["change","changeComments"],setup(g,{emit:a}){const o=g,m=l=>{console.log("selectCursorPosition letter : ",l),o.editable&&(s.value={id:l.id,char:l.char})},s=_(null),i=_([]),d=_([]),e=async()=>{let l=[{id:0,words:[{id:0,text:[]}],comments:[]}],p=0,w=0;for(var D=0;D<i.value.length;D++){i.value[D].char==`
`&&(p+=1,w=0,l.push({id:p,words:[{id:0,text:[]}],lineStyle:D<i.value.length-1?i.value[D+1].char:null,comments:[]}));const B=E.value.find(N=>N.start_index==D);B&&l[p].comments.push(B),l[p].words[w].text.push({id:D,char:i.value[D].char,comment:B}),i.value[D].char==" "&&(w+=1,l[p].words.push({id:w,text:[]}))}return l},n=l=>{l==1?E.value.forEach(p=>{s.value&&p.start_index>s.value.id&&(p.start_index+=1),s.value&&p.end_index>s.value.id&&(p.end_index+=1)}):l==-1&&E.value.forEach(p=>{s.value&&p.start_index>=s.value.id&&(p.start_index-=1),s.value&&p.end_index>=s.value.id&&(p.end_index-=1)})},f=l=>{console.log("insertChar : ",l),s.value&&(console.log("insertChar with cursor set : ",l),i.value.filter(p=>s.value&&p.id>=s.value.id+1).forEach(p=>p.id+=1),i.value.splice(s.value.id+1,0,{id:s.value.id+1,char:l}),n(1),s.value.id+=1)},u=l=>{if(console.log("Writes : ",l.key),s.value===null)return;const p=l.key;if(h.value&&p=="v"){b();return}if(p.length==1)l.preventDefault(),f(p);else if(p=="Backspace")i.value.splice(s.value.id,1),i.value.filter(w=>s.value&&w.id>s.value.id).forEach(w=>w.id-=1),n(-1),s.value.id-=1;else if(p=="Enter")f(`
`);else if(p=="ArrowRight"){let w=s.value.id;w<i.value.length-1&&m(i.value[w+1])}else if(p=="ArrowLeft"){let w=s.value.id;w>0&&m(i.value[w-1])}else p=="Control"&&(console.log("Control"),h.value=!0)},h=_(!1),b=async()=>{try{let p=await navigator.clipboard.readText();console.log("Clippedtext : ",p);for(var l=0;l<p.length;l++)f(p[l])}catch(p){console.log("Error with clippboard : ",p)}},q=l=>{l.key=="Control"&&(h.value=!1)},{createComment:G,batchUpdateComments:Q}=we(),{isMobile:K}=Re(),E=_([]),z=_(null),oe=async l=>{E.value=l.filter(p=>p.start_index!=null)},X=async()=>{if(console.log("Add Comment"),console.log(o.resourceId),console.log(P.value),!o.resourceId||!P.value)return;console.log("Add Comment 2");const l=await G(o.resourceId,P.value,P.value);E.value.push(l)};re(E,async(l,p)=>{console.log("Watch comments triggered : ",l),J.value&&(console.log("Comments : ",l),a("changeComments",l),z.value!==null&&clearTimeout(z.value),z.value=setTimeout(()=>Q(l),1e3)),console.log(`Old comments lenght : ${p.length} new length: ${l.length}`),console.log("OldComments : ",p),console.log("NewComments : ",l),p.length===0&&l.length>0&&(console.log("Finally loading comments"),d.value=await e())},{deep:!0}),re(ye(o).extComments,async l=>{await oe(l)});const W=_(!1),P=_(null),I=_({position:"absolute","z-index":90,top:"0px",left:"0px",height:"106px",width:"260px"}),{user:A}=le(),L=(l,p)=>{l.preventDefault(),A.value&&(s.value=null,I.value.top=`${l.layerY}px`,I.value.left=`${l.layerX}px`,W.value=!0,P.value=p,console.log("event : ",l),console.log("Have a new right click"))},_e=l=>{if(i.value=[],l===void 0||l==""){i.value=[{id:0,char:`
`}],m({id:0,char:`
`});return}for(var p=0;p<l.length;p++){const w=E.value.find(D=>D.start_index==p);i.value.push({id:p,char:l[p],comment:w})}},de=l=>l.reduce((p,w)=>p+w.char,""),J=_(!1);return H(async()=>{await oe(o.extComments),await _e(o.fullText),await new Promise(l=>setTimeout(l,10)),d.value=await e(),J.value=!0}),re(i,async l=>{console.log("Watch triggered : ",l),J.value&&(a("change",de(l)),d.value=await e())},{deep:!0}),(l,p)=>(t(),r("div",ut,[c(Me,{text:l.fullText,class:"absolute z-10 h-6 right-2"},null,8,["text"]),J.value?(t(),r("div",{key:1,id:"main-interface",class:"relative md:p-4",tabindex:"0",onKeydown:u,onKeyup:q,onClick:p[0]||(p[0]=w=>W.value=!1)},[W.value?(t(),r("div",{key:0,class:"bg-white border-4",style:Oe(I.value)},[v("div",{onClick:X,class:"text-sm border-b-2 flex items-center p-2",style:{height:"50px"}}," Ajouter un commentaire "),ct],4)):x("",!0),v("div",dt,[v("div",vt,[(t(!0),r(Z,null,ee(d.value,(w,D)=>(t(),r("div",{key:D,class:"flex"},[w.lineStyle=="*"?(t(),r("div",mt,ft)):x("",!0),v("div",_t,[(t(!0),r(Z,null,ee(w.words,(B,N)=>(t(),r("div",{key:N,class:"flex flex-wrap"},[(t(!0),r(Z,null,ee(B.text,(S,ve)=>{var me;return t(),r("div",{key:ve,class:xe(["border-blue-400",{"border-r-2":S.id==((me=s.value)==null?void 0:me.id),"bg-yellow-400":S.comment}]),onClick:ae=>m(S),onContextmenu:ae=>L(ae,S.id)},[S.char==" "?(t(),r("div",gt)):S.char==`
`?(t(),r("div",yt)):(S.char=="#"||S.char=="*")&&N==0?(t(),r("div",xt)):(t(),r("div",{key:3,class:xe({"font-bold":w.lineStyle=="#"})},[v("div",null,k(S.char),1)],2))],42,ht)}),128))]))),128)),v("div",{class:"flex-1",onClick:B=>m(w.words.slice(-1)[0].text.slice(-1)[0])},null,8,bt)]),E.value.length>0&&!O(K)?(t(),r("div",wt,[(t(!0),r(Z,null,ee(w.comments,(B,N)=>(t(),C(be,{key:N,class:"w-full",modelValue:B.content,"onUpdate:modelValue":S=>B.content=S,editing:B.editing,onValidate:S=>B.editing=!1,author:B.author,"created-at":B.created_at},null,8,["modelValue","onUpdate:modelValue","editing","onValidate","author","created-at"]))),128))])):x("",!0)]))),128))]),E.value.length>0&&!O(K)?(t(),r("div",kt)):x("",!0)])],32)):(t(),r("div",it,[v("span",null,k(l.fullText),1)]))]))}}),Ct=v("hr",{class:"border-top border-zinc-400 my-4"},null,-1),Rt=v("div",{class:"text-xs italic"},"Raison de la lecture",-1),It=U({__name:"SeeThoughtInput",props:{thoughtInput:{}},setup(g){const a=g,{getUserById:o,user:m}=le(),s=_(null),i=F(()=>m.value?a.thoughtInput.interaction_user_id===m.value.id:!1);return H(async()=>{a.thoughtInput.interaction_user_id&&(s.value=await o(a.thoughtInput.interaction_user_id))}),(d,e)=>(t(),r("div",null,[c(De,{id:d.thoughtInput.resource_id,"second-level":""},null,8,["id"]),Ct,Rt,c($t,{"full-text":d.thoughtInput.interaction_comment,editable:i.value},null,8,["full-text","editable"])]))}}),Vt={class:"w-full md:w-96"},Tt={key:0,class:"border shadow-lg rounded p-4 pl-2 md:w-96 bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-600 text-gray-900 dark:text-gray-100"},Ut={class:"flex"},At={class:"flex flex-col mr-1"},Bt=["src"],Dt={key:0,class:"text-gray-500 dark:text-gray-400 text-xs"},St={class:"flex flex-wrap w-full mt-auto"},Et={class:"text-2xs"},Ft={class:"flex flex-wrap"},Ot={key:0,class:"text-2xs italic"},jt={key:1,class:"text-xs italic p-1 mt-2 mb-3 bg-white dark:bg-transparent text-gray-900 dark:text-gray-100"},qt={class:"flex flex-wrap"},Lt={key:1,class:"text-2xs italic ml-2"},Mt={key:2,class:"ml-auto m-1 w-1/3"},Pt=U({__name:"ThoughtInputCard",props:{contextualResource:{},isDisabled:{type:Boolean,default:!1},open:{type:Boolean}},setup(g){const a=g,o=_(!1),{getUserById:m}=le(),{getAuthorInteractionForResource:s}=pe(),i=_(null),d=_(null),e=_(null);H(async()=>{o.value=a.open,a.contextualResource.user_id&&(e.value=await m(a.contextualResource.user_id)),a.contextualResource.resource&&(d.value=await s(a.contextualResource.resource.id)),d.value&&(i.value=await m(d.value.interaction_user_id))});const n=u=>u?u.toLocaleString("fr-FR",{hour:"numeric",weekday:"short",day:"numeric",month:"short",year:"2-digit"}):"",f=u=>u.length>200?u.slice(0,150)+"...":u;return(u,h)=>{const b=Ie("router-link");return t(),r("div",Vt,[u.contextualResource.resource?(t(),C(je(u.isDisabled?"span":"vue-router"),{key:0,to:"/app/resources/"+u.contextualResource.resource.id+"?tab=ctnt"},{default:$(()=>[u.contextualResource.resource?(t(),r("div",Tt,[v("div",Ut,[v("div",At,[u.contextualResource.resource?(t(),r("img",{key:0,class:"w-8 h-fit",src:u.contextualResource.resource.image_url},null,8,Bt)):x("",!0),v("div",{class:"w-4 h-4 mt-auto",onClick:h[0]||(h[0]=q=>o.value=!o.value)},[o.value?(t(),C(O(Ke),{key:1})):(t(),C(O(Ne),{key:0}))])]),v("div",null,[v("div",null,[T(k(u.contextualResource.resource.title)+" ",1),u.contextualResource.resource.subtitle?(t(),r("div",Dt,k(u.contextualResource.resource.subtitle),1)):x("",!0)]),v("div",St,[i.value?(t(),C(b,{key:0,to:"/social/users/"+i.value.id,class:"text-2xs underline"},{default:$(()=>[T(k(i.value.first_name)+" "+k(i.value.last_name),1)]),_:1},8,["to"])):x("",!0)]),v("div",Et,k(f(u.contextualResource.resource.comment)),1)])]),v("div",Ft,[u.contextualResource.date?(t(),r("div",Ot,k(n(u.contextualResource.resourcedate)),1)):x("",!0)])])):x("",!0)]),_:1},8,["to"])):x("",!0),u.contextualResource.context_comment&&o.value?(t(),r("div",jt,[v("div",null,k(u.contextualResource.context_comment),1),v("div",qt,[e.value?(t(),C(b,{key:0,to:"/users/"+e.value.id,class:"text-2xs underline"},{default:$(()=>[T(k(e.value.first_name)+" "+k(e.value.last_name),1)]),_:1},8,["to"])):x("",!0),u.contextualResource.date?(t(),r("div",Lt,k(n(u.contextualResource.date)),1)):x("",!0),u.contextualResource.progress?(t(),r("div",Mt,[c(Ve,{"progress-value":u.contextualResource.progress},null,8,["progress-value"])])):x("",!0)])])):x("",!0)])}}}),zt={class:"w-fit"},Nt=U({__name:"ThoughtInputCardWithPopup",props:{thoughtInput:{},usageReason:{},isDisabled:{type:Boolean,default:!1},open:{type:Boolean}},setup(g){const a=_(!1);return(o,m)=>(t(),r("div",zt,[c(ue,{open:a.value,onClose:m[0]||(m[0]=s=>a.value=!1)},{default:$(()=>[c(It,{"thought-input":o.thoughtInput,"usage-reason":o.usageReason},null,8,["thought-input","usage-reason"])]),_:1},8,["open"]),c(Pt,{class:"md:w-96","contextual-resource":o.thoughtInput,"is-disabled":o.isDisabled,open:o.open},null,8,["contextual-resource","is-disabled","open"])]))}}),Kt={class:"relative max-w-full"},Wt={key:0,class:"absolute md:border h-full start-1/2 -z-10 border-gray-300 dark:border-gray-600"},se=U({__name:"ThoughtInputsList",props:{contextualResources:{},center:{type:Boolean,default:!1},linksDisabled:{type:Boolean,default:!1},open:{type:Boolean,default:!1}},emits:["select"],setup(g,{emit:a}){const o=s=>s.sort((i,d)=>+(d.date>i.date)),m=s=>{console.log("Select"),a("select",s)};return(s,i)=>(t(),r("div",Kt,[s.center?x("",!0):(t(),r("div",Wt)),(t(!0),r(Z,null,ee(o(s.contextualResources),(d,e)=>(t(),C(Nt,{key:d.id,class:xe(["mb-4 md:mb-1 mx-auto max-w-full max-w-fit p-1",{"md:ml-0":e%2==0&&!s.center,"md:mr-0":!s.center}]),"thought-input":d,onClick:n=>m(d),"is-disabled":s.linksDisabled,open:s.open},null,8,["class","thought-input","onClick","is-disabled","open"]))),128))]))}}),Jt={key:0,class:"mb-4"},Ht={key:1},Gt={key:1},Qt={key:2},Xt={class:"flex flex-row-reverse"},Be=U({__name:"CreateResourceRelationForm",props:{targetResource:{},originResource:{}},emits:["close","refresh"],setup(g,{emit:a}){const o=g,{user:m}=le(),s=_(),i=I=>{console.log("Event : ",I),s.value=I},d=_([{text:"Externes",value:"extr"},{text:"Internes",value:"artl"},{text:"Problème",value:"pblm"}]),e=_([{text:"Biblio",value:"bibl"},{text:"Résumé",value:"sumr"},{text:"Sujet principal",value:"main"},{text:"Evocation",value:"mino"}]),n=_([]),f=_(null),u=_([]),h=_([]),b=_([]),q=_(""),G=_(""),{createResourceRelation:Q}=Te(),{getResources:K}=pe(),E=F(()=>n.value.map(I=>({resource:I.resource}))),z=I=>I.map(A=>({resource:A})),oe=F(()=>({extr:z(u.value),artl:z(h.value),pblm:z(b.value)})),X=async()=>{if(console.log("create"),!f.value)return;const I={target_resource_id:o.targetResource?o.targetResource.id:f.value.id,origin_resource_id:o.originResource?o.originResource.id:f.value.id,relation_comment:q.value,relation_type:G.value};await Q(I),a("refresh"),a("close")},{getUserInteractions:W}=ce(),P=I=>{f.value=I.resource};return H(async()=>{!m.value||!m.value.id||(o.targetResource&&(n.value=await W(m.value.id)),o.originResource&&(u.value=await K({is_external:!0}),h.value=await K({is_external:!1,resource_type:"oatc"}),b.value=await K({is_external:!1,resource_type:"pblm"})))}),(I,A)=>(t(),r("div",null,[O(m)?(t(),r("div",Jt," Nouvelle relation entre ressources par "+k(O(m).first_name)+" "+k(O(m).last_name),1)):x("",!0),f.value?(t(),r("div",Qt,[c(ie,{class:"m-4",label:"Type de lien",choices:e.value,modelValue:G.value,"onUpdate:modelValue":A[2]||(A[2]=L=>G.value=L)},null,8,["choices","modelValue"]),c(fe,{class:"m-4",label:"Pourquoi ajouter cet élément ?",modelValue:q.value,"onUpdate:modelValue":A[3]||(A[3]=L=>q.value=L)},null,8,["modelValue"]),v("div",Xt,[c(j,{type:"valid",onClick:X},{default:$(()=>[T("Ajouter")]),_:1}),c(j,{type:"abort",onClick:A[4]||(A[4]=L=>a("close")),class:"mr-1"},{default:$(()=>[T("Annuler")]),_:1})])])):(t(),r("div",Ht,[I.targetResource?(t(),C(se,{key:0,"contextual-resources":E.value,center:"","links-disabled":"",onSelect:A[0]||(A[0]=L=>P(L))},null,8,["contextual-resources"])):(t(),r("div",Gt,[v("div",null,[T(" Choisir une ressource cible "),c(Ae,{center:"",choices:d.value,default:"pblm",onUpdate:i},null,8,["choices"]),c(se,{"contextual-resources":oe.value[s.value]||[],center:"",onSelect:A[1]||(A[1]=L=>P(L)),"links-disabled":""},null,8,["contextual-resources"])])]))]))]))}}),Yt={class:"flex flex-wrap"},Zt={class:"flex flex-row-reverse"},el=U({__name:"CreateInteraction",props:{resource:{}},emits:["close","refresh"],setup(g,{emit:a}){const o=g,m=_([{text:"Lecture / Visionage",value:"inpt"},{text:"Envie",value:"wish"}]),{newInteraction:s,createInteractionForResource:i}=ce(),{user:d}=le(),e=_(s());H(()=>{e.value.interaction_type||(e.value.interaction_type="inpt")});const n=()=>{e.value.resource_id=o.resource.id,e.value.interaction_user_id=d.value.id,i(o.resource.id,e.value),a("refresh"),f()},f=()=>a("close");return(u,h)=>(t(),r("div",null,[v("div",null,"Nouvelle interaction, avec la ressource : "+k(u.resource.title),1),v("div",Yt,[c(te,{label:"Avancement de l'ouvrage",class:"my-auto",modelValue:e.value.interaction_progress,"onUpdate:modelValue":h[0]||(h[0]=b=>e.value.interaction_progress=b),type:"number"},null,8,["modelValue"]),c(ie,{label:"Type d'interaction",class:"m-4 w-full md:w-5/12 md:ml-auto",choices:m.value,modelValue:e.value.interaction_type,"onUpdate:modelValue":h[1]||(h[1]=b=>e.value.interaction_type=b)},null,8,["choices","modelValue"])]),c(te,{label:"Date de lecture",modelValue:e.value.interaction_date,"onUpdate:modelValue":h[2]||(h[2]=b=>e.value.interaction_date=b),type:"date"},null,8,["modelValue"]),c(fe,{label:"Pourquoi s'y être interessé ?",modelValue:e.value.interaction_comment,"onUpdate:modelValue":h[3]||(h[3]=b=>e.value.interaction_comment=b)},null,8,["modelValue"]),v("div",Zt,[c(j,{onClick:n,class:"m-4",type:"valid"},{default:$(()=>[T("Valider")]),_:1}),c(j,{onClick:f,class:"m-4",type:"abort"},{default:$(()=>[T("Annuler")]),_:1})])]))}}),tl=v("div",null,"Demander une Review pour l'article :",-1),ll={class:"flex flex-row-reverse mt-4"},ol=U({__name:"CreateReview",props:{resource:{}},emits:["close","refresh"],setup(g,{emit:a}){const o=g,{newInteraction:m,createInteractionForResource:s}=ce(),i=async()=>{const n=m();n.interaction_user_id=e.value,n.resource_id=o.resource.id,n.interaction_type="rvew",n.interaction_comment=d.value,await s(o.resource.id,n),a("refresh"),a("close")},d=_(""),e=_(null);return(n,f)=>(t(),r("div",null,[tl,v("div",null,k(n.resource.title),1),c(Ue,{modelValue:e.value,"onUpdate:modelValue":f[0]||(f[0]=u=>e.value=u)},null,8,["modelValue"]),c(fe,{class:"mt-4",label:"Message pour la review",modelValue:d.value,"onUpdate:modelValue":f[1]||(f[1]=u=>d.value=u)},null,8,["modelValue"]),v("div",ll,[c(j,{type:"valid",onClick:i},{default:$(()=>[T("Ajouter")]),_:1}),c(j,{type:"abort",onClick:f[2]||(f[2]=u=>a("close")),class:"mr-1"},{default:$(()=>[T("Annuler")]),_:1})])]))}}),sl=U({__name:"ResourceTools",props:{resource:{},isResourceEditable:{type:Boolean}},emits:["refresh","edit"],setup(g,{emit:a}){const o=_(!1),m=_(!1),s=_(!1),i=_(!1);return(d,e)=>(t(),r("div",null,[d.isResourceEditable&&o.value?(t(),C(ne,{key:0,title:"Modifier",onClick:e[0]||(e[0]=n=>a("edit"))},{default:$(()=>[c(O(qe),{class:"m-1"})]),_:1})):x("",!0),d.isResourceEditable&&o.value?(t(),C(ne,{key:1,class:"mt-2",color:"blue",title:"Demander une review",onClick:e[1]||(e[1]=n=>m.value=!0)},{default:$(()=>[c(O(Le),{class:"m-1"})]),_:1})):x("",!0),c(ue,{open:m.value,onClose:e[4]||(e[4]=n=>m.value=!1)},{default:$(()=>[c(ol,{onRefresh:e[2]||(e[2]=n=>a("refresh")),onClose:e[3]||(e[3]=n=>m.value=!1),resource:d.resource},null,8,["resource"])]),_:1},8,["open"]),d.isResourceEditable&&o.value?(t(),C(ne,{key:2,class:"mt-2",color:"red",title:"Marquer comme lu",onClick:e[5]||(e[5]=n=>s.value=!0)},{default:$(()=>[c(O(ze),{class:"m-1"})]),_:1})):x("",!0),c(ue,{open:s.value,onClose:e[8]||(e[8]=n=>s.value=!1)},{default:$(()=>[c(el,{onRefresh:e[6]||(e[6]=n=>a("refresh")),onClose:e[7]||(e[7]=n=>s.value=!1),resource:d.resource},null,8,["resource"])]),_:1},8,["open"]),d.isResourceEditable&&o.value?(t(),C(ne,{key:3,class:"mt-2",color:"green",title:"Relier à d'autres ressources",onClick:e[9]||(e[9]=n=>i.value=!0)},{default:$(()=>[c(O(We),{class:"m-1"})]),_:1})):x("",!0),c(ue,{open:i.value,onClose:e[12]||(e[12]=n=>i.value=!1)},{default:$(()=>[c(Be,{onRefresh:e[10]||(e[10]=n=>a("refresh")),onClose:e[11]||(e[11]=n=>i.value=!1),"origin-resource":d.resource},null,8,["origin-resource"])]),_:1},8,["open"]),c(ne,{class:"mt-2",color:"gray",onClick:e[13]||(e[13]=n=>o.value=!o.value)},{default:$(()=>[c(O(Je))]),_:1})]))}}),al=U({__name:"CommentsThread",props:{resourceId:{}},setup(g){const a=g,{user:o}=le(),m=_([]),{createComment:s,getCommentsForThoughtOutput:i}=we(),d=async()=>{console.log("Comment thread"),console.log("Props id : ",a.resourceId),m.value=await i(a.resourceId)},e=F(()=>m.value.filter(u=>!u.start_index).sort((u,h)=>u.created_at-h.created_at)),n=_(""),f=async()=>{await s(a.resourceId,null,null,n.value,!1),n.value="",await d()};return H(async()=>await d()),(u,h)=>(t(),r("div",null,[(t(!0),r(Z,null,ee(e.value,b=>(t(),C(be,{key:b.id,class:"w-full",modelValue:b.content,"onUpdate:modelValue":q=>b.content=q,editing:b.editing,onValidate:q=>b.editing=!1,author:b.author,"created-at":b.created_at},null,8,["modelValue","onUpdate:modelValue","editing","onValidate","author","created-at"]))),128)),c(be,{class:"w-full",modelValue:n.value,"onUpdate:modelValue":h[0]||(h[0]=b=>n.value=b),editing:!0,onValidate:f,author:O(o),"created-at":null},null,8,["modelValue","author"])]))}}),nl=U({__name:"DateField",props:{date:{}},setup(g){const a=g,o=F(()=>new Date(a.date).toLocaleDateString("fr-FR",{day:"numeric",month:"short",year:"numeric"}));return(m,s)=>(t(),r("div",null,k(o.value),1))}}),rl={class:"flex flex-col"},ul={class:"block text-2xs text-slate-800"},il=["value","placeholder"],cl=U({__name:"NumberInput",props:{label:{},modelValue:{},placeholder:{}},emits:["update:modelValue","input"],setup(g,{emit:a}){const o=m=>{a("update:modelValue",m.target.value),a("input",m.target.value)};return(m,s)=>(t(),r("div",rl,[v("label",ul,k(m.label),1),v("input",{class:"border border-neutral-400 block h-full w-full rounded-md border-2 p-1 pl-2 text-xs",type:"number",value:m.modelValue,placeholder:m.placeholder,onInput:s[0]||(s[0]=i=>o(i))},null,40,il)]))}}),dl={class:"grid grid-cols-4 gap-y-2 gap-x-4 auto-rows-auto"},vl=U({__name:"ResourceForm",props:{article:{}},emits:["change"],setup(g,{emit:a}){const o=g,m=_([{text:"Terminé",value:"fnsh"},{text:"Relecture",value:"rvew"},{text:"Brouillon",value:"drft"},{text:"Poubelle",value:"trsh"}]),{resourceTypeOptions:s}=pe(),i=(d,e)=>{let n={...o.article};n[d]=e,n.is_external&&(n.maturing_state="fnsh"),console.log("Article : ",n),a("change",n)};return(d,e)=>(t(),r("div",dl,[c(te,{class:"col-span-4",label:"Titre",modelValue:d.article.title,"onUpdate:modelValue":e[0]||(e[0]=n=>i("title",n))},null,8,["modelValue"]),c(te,{class:"col-span-4",label:"Sous-titre",modelValue:d.article.subtitle,"onUpdate:modelValue":e[1]||(e[1]=n=>i("subtitle",n))},null,8,["modelValue"]),c(te,{class:"col-span-4 md:col-span-2",label:"Lien contenu externe",modelValue:d.article.external_content_url,"onUpdate:modelValue":e[2]||(e[2]=n=>i("external_content_url",n))},null,8,["modelValue"]),c(te,{class:"col-span-4 md:col-span-2",label:"Lien image",modelValue:d.article.image_url,"onUpdate:modelValue":e[3]||(e[3]=n=>i("image_url",n))},null,8,["modelValue"]),c(ie,{label:"Type de ressource",class:"col-span-4 md:col-span-2",choices:O(s),"onUpdate:modelValue":e[4]||(e[4]=n=>i("resource_type",n)),"model-value":d.article.resource_type},null,8,["choices","model-value"]),c(ie,{label:"Ressource externe",class:"col-span-4 md:col-span-1",choices:[{text:"Oui",value:!0},{text:"Non",value:!1}],"onUpdate:modelValue":e[5]||(e[5]=n=>i("is_external",JSON.parse(n))),"model-value":d.article.is_external},null,8,["model-value"]),c(ie,{label:"Stade d'écriture",class:"col-span-4 md:col-span-1",choices:m.value,"model-value":d.article.maturing_state,"onUpdate:modelValue":e[6]||(e[6]=n=>i("maturing_state",n))},null,8,["choices","model-value"])]))}}),ml={class:"grid grid-cols-3 gap-4"},pl=U({__name:"ResourceAuthorPicker",props:{interaction:{},resourceId:{}},emits:["update"],setup(g,{emit:a}){const o=g,m=F(()=>{var f;return(f=o.interaction)==null?void 0:f.interaction_user_id}),{createInteractionForResource:s,newInteraction:i,updateInteraction:d}=ce(),e=async f=>{if(console.log(`newUser : ${JSON.stringify(f)}`),o.interaction){const u={...o.interaction};u.interaction_user_id=f,console.log("newUserid : ",f.id),console.log(`Interaction payload : ${JSON.stringify(u)}`),await d(o.interaction.id,u),a("update")}else{console.log("create interaction");const u=i();u.interaction_user_id=f,u.resource_id=o.resourceId,await s(o.resourceId,u),a("update")}},n=async f=>{await d(o.interaction.id,f),a("update")};return(f,u)=>(t(),r("div",ml,[c(Ue,{"model-value":m.value,"onUpdate:modelValue":u[0]||(u[0]=h=>e(h))},null,8,["model-value"]),f.interaction?(t(),C(te,{key:0,class:"text-2xs",label:"Date d'écriture","model-value":f.interaction.interaction_date?f.interaction.interaction_date.split("T")[0]:null,"onUpdate:modelValue":u[1]||(u[1]=h=>n({...f.interaction,interaction_date:h})),type:"date"},null,8,["model-value"])):x("",!0),f.interaction?(t(),C(cl,{key:1,class:"",label:"Progression",modelValue:f.interaction.interaction_progress,"onUpdate:modelValue":u[2]||(u[2]=h=>n({...f.interaction,interaction_progress:h}))},null,8,["modelValue"])):x("",!0)]))}}),fl={key:0,class:"text-center text-2xl pt-10"},_l={key:1},hl={key:0},gl={class:"my-8"},yl=["src"],xl={class:"text-3xl my-3 font-mplus md:text-center text-left"},bl={class:"md:text-center text-left"},wl={class:"md:text-center text-left"},kl={class:"md:flex my-8"},$l=["href"],Cl={key:1,class:"my-2 flex flex-col"},Rl={class:"flex flex-row-reverse mb-4"},Il=v("hr",{class:"border-top border-zinc-400 my-4"},null,-1),Vl={key:2},Tl={class:"mb-4"},Ul=v("div",{class:"text-xs italic"},"Sujets",-1),Al=v("div",{class:"text-xs italic"},"Contenu",-1),Bl={key:3},Dl={key:4},Sl={key:5},De=U({__name:"ResourceComponent",props:{resourceId:{},secondLevel:{type:Boolean}},setup(g){const a=g,o=Ce(),m=F(()=>D.value&&w.value||!I.value||l.value.is_local_draft||!d.value),s=F(()=>a.secondLevel?"popup_tab":"tab"),i=F(()=>[{text:"Contenu",value:"ctnt"},{text:"Biblio",value:"bbli",count:h.value.length},{text:"Sujets",value:"pblm",count:X.value.length},{text:"Interactions",value:"inpt",count:Q.value.length}]),d=_(!0),e=_(o.query[s.value]&&typeof o.query[s.value]=="string"?o.query[s.value]:"ctnt"),n=_(o.query[s.value]);re(()=>o.query[s.value],y=>{console.log("new route query",y),typeof y=="string"&&(n.value=y)});const{getResourceRelationsForResource:f,getUsagesForResource:u}=Te(),h=_([]),b=_(!1),q=async()=>{h.value=await f(ye(a).resourceId.value)},G=F(()=>h.value.map(y=>({resource:y.origin_resource,date:y.created_at,user_id:y.user_id,context_comment:y.relation_comment,progress:null}))),Q=_([]),{getInteractionsForResource:K,updateInteraction:E}=ce(),z=async()=>{Q.value=await K(a.resourceId)},oe=F(()=>Q.value.map(y=>({resource:null,date:y.interaction_date,user_id:y.interaction_user_id,context_comment:y.interaction_comment,progress:y.interaction_progress}))),X=_([]),W=async()=>{X.value=await u(a.resourceId)},P=F(()=>X.value.map(y=>({resource:y.target_resource,date:y.created_at,user_id:y.user_id,context_comment:y.relation_comment,progress:null}))),I=_(!1),{newResource:A,getResource:L,updateResource:_e,getAuthorInteractionForResource:de}=pe(),J=_(null),l=_(A()),p=$e();re(()=>o.query.editing,y=>{console.log("Editing : ",y),w.value=y==="false"?!1:!!y});const w=_(!1),{isMobile:D}=Re(),B=y=>{p.push({query:{editing:y.toString()}})},N=(y,R)=>{l.value=R,J.value!==null&&clearTimeout(J.value),J.value=setTimeout(async()=>{try{await _e(y,l.value)}catch(ge){console.log("An error : ",ge)}},1e3)},S=y=>{y!=`
`&&N(ye(a).resourceId.value,{...l.value,content:y})},{user:ve,getUserById:me}=le(),ae=F(()=>l.value.is_external?!0:ve.value?Y.value?Y.value.id==ve.value.id:!0:!1),Y=_(null),V=_(null),he=async()=>{V.value=await de(a.resourceId)},Se=async()=>{!V.value||!V.value.id||(await E(V.value.id,{...V.value,interaction_is_public:!0}),he())},Ee=async()=>{!V.value||!V.value.id||(await E(V.value.id,{...V.value,interaction_is_public:!1}),he())},{getCommentsForThoughtOutput:Fe}=we(),ke=_([]);return H(async()=>{I.value=!1,l.value=await L(a.resourceId),I.value=!0,await q(),await z(),await W(),ke.value=await Fe(a.resourceId),V.value=await de(a.resourceId),V.value&&(Y.value=await me(V.value.interaction_user_id));const y=o.query.editing;w.value=y==="false"?!1:!!y}),(y,R)=>{const ge=Ie("router-link");return t(),r("div",null,[I.value?(t(),r("div",_l,[w.value?(t(),r("div",Cl,[c(vl,{article:l.value,class:"",onChange:R[0]||(R[0]=M=>N(l.value.id,M))},null,8,["article"]),c(pl,{class:"my-2",interaction:V.value,"resource-id":y.resourceId,onChange:he},null,8,["interaction","resource-id"]),v("div",Rl,[c(j,{class:"ml-2",onClick:R[1]||(R[1]=M=>B(!1)),type:"valid"},{default:$(()=>[T("Ok")]),_:1}),V.value&&!V.value.interaction_is_public?(t(),C(j,{key:0,class:"ml-2",onClick:Se,type:"valid"},{default:$(()=>[T("Publier")]),_:1})):V.value?(t(),C(j,{key:1,class:"ml-2",onClick:Ee,type:"abort"},{default:$(()=>[T("Dépublier")]),_:1})):x("",!0),c(j,{class:"ml-2",onClick:R[2]||(R[2]=M=>d.value=!d.value),type:"valid"},{default:$(()=>[T(k(d.value?"Text brut":"Editeur"),1)]),_:1})])])):(t(),r("div",hl,[v("div",gl,[v("img",{src:l.value.image_url,class:"border border-slate-300 dark:border-zinc-700 rounded-xl ml-auto mr-auto",style:{"max-height":"20rem"}},null,8,yl)]),v("h1",xl,k(l.value.title),1),v("div",bl,k(l.value.subtitle),1),v("div",wl,[Y.value?(t(),C(ge,{key:0,to:"/social/users/"+Y.value.id,class:"text-sm underline"},{default:$(()=>[T(k(Y.value.first_name)+" "+k(Y.value.last_name),1)]),_:1},8,["to"])):x("",!0),V.value?(t(),C(nl,{key:1,date:V.value.interaction_date},null,8,["date"])):x("",!0)]),v("div",kl,[V.value?(t(),C(Ve,{key:0,"progress-value":V.value.interaction_progress,class:"m-2 w-1/3"},null,8,["progress-value"])):x("",!0),l.value.external_content_url?(t(),r("a",{key:1,class:"ml-auto underline",href:l.value.external_content_url,target:"_blank"}," Lien ressource externe ",8,$l)):x("",!0)])])),v("div",null,[w.value?x("",!0):(t(),C(Ae,{key:0,choices:i.value,default:e.value,"url-key":s.value,url:""},null,8,["choices","default","url-key"]))]),Il,n.value=="ctnt"?(t(),r("div",Vl,[v("div",Tl,[Ul,c(se,{"contextual-resources":P.value},null,8,["contextual-resources"])]),Al,m.value?(t(),C(fe,{key:0,class:"mt-4 h-96",modelValue:l.value.content,"onUpdate:modelValue":R[3]||(R[3]=M=>S(M))},null,8,["modelValue"])):(t(),C(Pe,{key:1,class:"min-h-fit","ext-comments":ke.value,"resource-id":l.value.id,text:l.value.content,editable:ae.value,onChange:R[4]||(R[4]=M=>S(M))},null,8,["ext-comments","resource-id","text","editable"])),c(al,{class:"mt-6","resource-id":y.resourceId},null,8,["resource-id"])])):n.value=="bbli"?(t(),r("div",Bl,[c(ue,{open:b.value,onClose:R[6]||(R[6]=M=>b.value=!1)},{default:$(()=>[c(Be,{onRefresh:q,onClose:R[5]||(R[5]=M=>b.value=!1),"target-resource":l.value},null,8,["target-resource"])]),_:1},8,["open"]),v("div",{onClick:R[7]||(R[7]=M=>b.value=!0),class:"text-sm italic underline"}," Ajouter une référence "),c(se,{"contextual-resources":G.value},null,8,["contextual-resources"])])):n.value=="pblm"?(t(),r("div",Dl,[c(se,{"contextual-resources":P.value},null,8,["contextual-resources"])])):n.value=="inpt"?(t(),r("div",Sl,[c(se,{"contextual-resources":oe.value},null,8,["contextual-resources"])])):x("",!0),c(sl,{class:"fixed right-3 bottom-5",resource:l.value,"is-resource-editable":ae.value,onRefresh:R[8]||(R[8]=M=>W()&&z()),onEdit:R[9]||(R[9]=M=>B(!0))},null,8,["resource","is-resource-editable"])])):(t(),r("div",fl,"Loading..."))])}}}),Pl=U({__name:"SeeResourcePage",props:{id:{}},setup(g){return(a,o)=>(t(),r("div",null,[c(De,{class:"md:px-8 px-4","resource-id":a.id},null,8,["resource-id"])]))}});export{Pl as default};
