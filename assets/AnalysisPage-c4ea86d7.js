import{d as xe,Z as Ye,r as S,j as y,y as _e,a as De,b as r,c,l as d,t as V,p as ie,k as O,e as ye,m as ve,K as Xe,F as ae,g as fe,h as he,w as Le,f as Se,q as $e,O as G,o as Te,S as Fe,U as je,M as Ie,B as Pe,Q as ze,u as Ve,$ as Ce,a0 as Qe,a1 as Ee,P as Ze,T as et,J as tt,a2 as st,i as nt,x as rt,n as at}from"./index-23800723.js";import{r as Ue,a as Ne,b as Je,c as ot}from"./PlayIcon-9708c36b.js";import{_ as lt}from"./LlmCallCard.vue_vue_type_script_setup_true_lang-945eb113.js";import{r as it}from"./ClipboardIcon-83a3c9d7.js";import{u as ct}from"./useJournal-c6cde84e.js";import{u as Oe}from"./useLens-2cf04266.js";import{r as ut}from"./XMarkIcon-a2b00390.js";import{_ as dt}from"./HeatmapDisplay.vue_vue_type_script_setup_true_lang-6ae57eb1.js";const ft={class:"flex items-start justify-between gap-2"},pt={class:"min-w-0"},ht={class:"text-sm font-semibold leading-5 break-words"},vt={key:0,class:"mt-2"},gt={key:1,class:"mt-2 flex flex-wrap gap-1.5"},yt={key:2,class:"mt-2 flex flex-wrap gap-1.5"},mt={class:"uppercase tracking-wide opacity-80"},_t=xe({__name:"ElementDisplayCard",props:{element:{},associatedLandmarks:{default:()=>[]},accentColor:{default:""},showId:{type:Boolean,default:!1},initiallyExpanded:{type:Boolean,default:!1},tone:{default:"dark"}},setup(U){const m=U,F=Ye(),w=S(m.initiallyExpanded),k=S([]),L=S(0),N=y(()=>!!F.meta),R=y(()=>(Array.isArray(m.associatedLandmarks)?m.associatedLandmarks:[]).map((i,u)=>{const a=(i==null?void 0:i.id)!=null?String(i.id).trim():"",Y=(typeof(i==null?void 0:i.title)=="string"?i.title.trim():"")||"Sans nom",ne=a||`${Y}-${u}`;return{id:a,title:Y,key:ne}}).filter(i=>i.title.length>0)),I=y(()=>{var i,u,a,P,Y;const t=[(i=m.element)==null?void 0:i.id,(a=(u=m.element)==null?void 0:u.resource)==null?void 0:a.id,(P=m.element)==null?void 0:P.element_id,(Y=m.element)==null?void 0:Y.elementId];for(const ne of t){if(ne==null)continue;const Q=String(ne).trim();if(Q.length>0)return Q}return""}),J=t=>t==null?"":String(t).trim(),K=t=>{var u,a;const i=[t==null?void 0:t.relation_type,t==null?void 0:t.relationType,t==null?void 0:t.type,(u=t==null?void 0:t.relation)==null?void 0:u.relation_type,(a=t==null?void 0:t.relation)==null?void 0:a.relationType,t==null?void 0:t.element_type,t==null?void 0:t.elementType].map(P=>J(P)).find(P=>P.length>0);return i?i.replace(/[_-]+/g," "):"relation"},$=t=>{var u,a,P,Y,ne,Q,de,be,ge,me;return!t||typeof t!="object"?"":[t==null?void 0:t.title,t==null?void 0:t.name,t==null?void 0:t.display_name,t==null?void 0:t.displayName,t==null?void 0:t.mention,(u=t==null?void 0:t.resource)==null?void 0:u.title,(a=t==null?void 0:t.element)==null?void 0:a.title,(P=t==null?void 0:t.target_resource)==null?void 0:P.title,(Y=t==null?void 0:t.origin_resource)==null?void 0:Y.title,(ne=t==null?void 0:t.target_element)==null?void 0:ne.title,(Q=t==null?void 0:t.origin_element)==null?void 0:Q.title,(de=t==null?void 0:t.data)==null?void 0:de.title,(be=t==null?void 0:t.landmark)==null?void 0:be.title,(ge=t==null?void 0:t.target_landmark)==null?void 0:ge.title,(me=t==null?void 0:t.related_landmark)==null?void 0:me.title].map(s=>J(s)).find(s=>s.length>0)??""},p=y(()=>{const t=new Set,i=[];return k.value.forEach((u,a)=>{const P=typeof u=="string"?u.trim():$(u);if(!P)return;const Y=typeof u=="string"?"relation":K(u),ne=(u==null?void 0:u.id)!=null?String(u.id).trim():"",Q=ne||`${Y}-${P}-${a}`,de=`${ne}|${Y}|${P}`;t.has(de)||(t.add(de),i.push({key:Q,relationType:Y,title:P}))}),i}),D=t=>{if(Array.isArray(t))return t;if(!t||typeof t!="object")return[];const i=[t==null?void 0:t.relations,t==null?void 0:t.data,t==null?void 0:t.items,t==null?void 0:t.results];for(const a of i)if(Array.isArray(a))return a;if(t!=null&&t.data&&typeof t.data=="object"){const a=t.data,P=[a==null?void 0:a.data,a==null?void 0:a.relations,a==null?void 0:a.items,a==null?void 0:a.results];for(const Y of P)if(Array.isArray(Y))return Y;if((a==null?void 0:a.id)!=null||(a==null?void 0:a.title)!=null||(a==null?void 0:a.relation_type)!=null||(a==null?void 0:a.type)!=null)return[a]}if((t==null?void 0:t.id)!=null||(t==null?void 0:t.title)!=null||(t==null?void 0:t.relation_type)!=null||(t==null?void 0:t.type)!=null)return[t];const u=Object.values(t).filter(a=>a&&typeof a=="object");return u.length>0?u:[]},H=async t=>{if(!t){k.value=[];return}const i=L.value+1;L.value=i;try{const u=await G.get(`/elements/${t}/relations`),a=D(u==null?void 0:u.data);if(L.value!==i)return;k.value=a}catch{if(L.value!==i)return;k.value=[]}};_e(I,t=>{H(t)},{immediate:!0});const le=y(()=>{if(m.accentColor)return{borderColor:m.accentColor}}),Z=t=>{if(typeof t!="string")return null;let i=t.trim();if(!i)return null;for(let u=0;u<3;u++){if(typeof i!="string")return i;const a=i.trim();if(!a)return null;if(!(a.startsWith("{")||a.startsWith("[")||a.startsWith('"')))return u===0?null:i;try{i=JSON.parse(a)}catch{return u===0?null:i}}return i},C=y(()=>{var t,i,u;return Z(((t=m.element)==null?void 0:t.content)??((u=(i=m.element)==null?void 0:i.resource)==null?void 0:u.content)??"")}),T=(t,i)=>{var a,P;const u=C.value;if(u&&typeof u=="object"){if(u[t]!=null)return u[t];if(i&&u[i]!=null)return u[i]}return((a=m.element)==null?void 0:a[t])!=null?m.element[t]:i&&((P=m.element)==null?void 0:P[i])!=null?m.element[i]:null},q=y(()=>{const t=T("spans")??T("span");return Array.isArray(t)?t.map(i=>typeof i=="string"?i.trim():"").filter(i=>i.length>0):typeof t=="string"&&t.trim().length>0?[t.trim()]:[]}),X=y(()=>{const t=T("status");return typeof t=="string"?t.trim().toUpperCase():""}),ee=y(()=>{const t=T("verb");return typeof t=="string"?t.trim():""}),te=y(()=>{const t=T("target");return typeof t=="string"?t.trim():""}),ce=y(()=>{if(!ee.value&&!te.value)return"";const t=[ee.value,te.value].filter(Boolean).join(" ").trim();return t?X.value==="DONE"?`J'ai ${t}`:X.value==="IN_PROGRESS"?`Je suis en train de ${t}`:X.value==="INTENDED"?`Je voudrais ${t}`:t:""}),ue=y(()=>{var i,u,a;const t=((i=m.element)==null?void 0:i.title)??((a=(u=m.element)==null?void 0:u.resource)==null?void 0:a.title)??"";return typeof t=="string"&&t.trim().length>0?t.trim():""}),_=y(()=>{var i,u,a;if(ue.value)return ue.value;if(ce.value)return ce.value;if(q.value.length>0)return q.value[0];const t=((i=m.element)==null?void 0:i.title)??((a=(u=m.element)==null?void 0:u.resource)==null?void 0:a.title)??"";return typeof t=="string"&&t.trim().length>0?t.trim():"Élément"}),E=y(()=>{if(q.value.length===0)return"";const t=q.value[0];return!t||t.trim()===_.value.trim()?"":t}),z=y(()=>{const t=T("theme"),i=T("kind");return[t,i].map(a=>typeof a=="string"?a.trim():"").filter(a=>a.length>0).join(" · ")}),f=y(()=>{const t=T("interaction_date","interactionDate")??T("created_at","createdAt");if(!t)return"";const i=new Date(String(t));if(!Number.isNaN(i.getTime()))return`interaction: ${i.toLocaleString()}`;const u=String(t).trim();return u?`interaction: ${u}`:""}),x=t=>{if(t==null)return"";if(Array.isArray(t))return t.map(u=>x(u)).filter(u=>u.length>0).join(", ");if(typeof t=="object")try{return JSON.stringify(t)}catch{return""}return String(t).trim()},j=y(()=>{const t=[],i=x(T("id")),u=x(T("element_type","elementType")),a=x(T("element_subtype","elementSubtype")),P=x(T("status")),Y=x(T("verb")),ne=x(T("target")),Q=x(T("theme")),de=x(T("scope")),be=x(T("life_domain","lifeDomain")),ge=x(T("date_offset","dateOffset")),me=x(T("references_tags_id","referencesTagsId"));return m.showId&&i&&t.push(`id: ${i}`),u&&a?t.push(`type: ${u} / ${a}`):u?t.push(`type: ${u}`):a&&t.push(`type: ${a}`),P&&t.push(`status: ${P}`),Y&&t.push(`verbe: ${Y}`),ne&&t.push(`cible: ${ne}`),Q&&t.push(`thème: ${Q}`),de&&t.push(`scope: ${de}`),be&&t.push(`domaine: ${be}`),ge&&t.push(`temporalité: ${ge}`),f.value&&t.push(f.value),me&&t.push(`references_tags_id: ${me}`),q.value.length>1&&t.push(`spans: ${q.value.slice(1).join(" | ")}`),t});return(t,i)=>{const u=De("router-link");return r(),c("article",{class:ie(["h-full p-3 rounded-lg border",t.tone==="light"?"border-slate-300 bg-white text-slate-800":"border-slate-700 bg-slate-800/40 text-slate-200"]),style:$e(le.value)},[d("div",ft,[d("div",pt,[d("div",ht,V(_.value),1),E.value?(r(),c("div",{key:0,class:ie(["mt-1 text-xs leading-5 whitespace-pre-wrap break-words",t.tone==="light"?"text-slate-700":"text-slate-200"])},V(E.value),3)):O("",!0),z.value?(r(),c("div",{key:1,class:ie(["mt-1 text-xs",t.tone==="light"?"text-slate-500":"text-slate-400"])},V(z.value),3)):O("",!0),f.value?(r(),c("div",{key:2,class:ie(["mt-1 text-xs",t.tone==="light"?"text-slate-500":"text-slate-400"])},V(f.value),3)):O("",!0)]),j.value.length>0?(r(),c("button",{key:0,type:"button",class:ie(["inline-flex items-center justify-center w-6 h-6 rounded transition-colors flex-none",t.tone==="light"?"text-slate-500 hover:text-slate-700 hover:bg-slate-100":"text-slate-400 hover:text-slate-200 hover:bg-slate-700/60"]),onClick:i[0]||(i[0]=a=>w.value=!w.value)},[ye(ve(Ue),{class:ie(["w-4 h-4 transition-transform",w.value?"rotate-180":""])},null,8,["class"])],2)):O("",!0)]),N.value?(r(),c("div",vt,[Xe(t.$slots,"meta")])):O("",!0),R.value.length>0?(r(),c("div",gt,[(r(!0),c(ae,null,fe(R.value,a=>(r(),c(ae,{key:a.key},[a.id?(r(),he(u,{key:0,to:`/app/landmarks/${a.id}`,class:ie(["text-[10px] px-1.5 py-0.5 rounded-full border transition-colors",t.tone==="light"?"border-slate-300 text-slate-600 bg-slate-100/70 hover:border-slate-400 hover:text-slate-800":"border-slate-600 text-slate-300 bg-slate-900/60 hover:border-slate-500 hover:text-slate-100"])},{default:Le(()=>[Se(V(a.title),1)]),_:2},1032,["to","class"])):(r(),c("span",{key:1,class:ie(["text-[10px] px-1.5 py-0.5 rounded-full border",t.tone==="light"?"border-slate-300 text-slate-600 bg-slate-100/70":"border-slate-600 text-slate-300 bg-slate-900/60"])},V(a.title),3))],64))),128))])):O("",!0),p.value.length>0?(r(),c("div",yt,[(r(!0),c(ae,null,fe(p.value,a=>(r(),c("span",{key:a.key,class:ie(["inline-flex items-center gap-1 text-[10px] px-1.5 py-0.5 rounded-full border",t.tone==="light"?"border-slate-300 text-slate-600 bg-slate-100/70":"border-slate-600 text-slate-300 bg-slate-900/60"])},[d("span",mt,V(a.relationType),1),d("span",{class:ie(t.tone==="light"?"text-slate-700 font-medium":"text-slate-100 font-medium")},V(a.title),3)],2))),128))])):O("",!0),w.value&&j.value.length>0?(r(),c("div",{key:3,class:ie(["mt-2 space-y-1 text-xs",t.tone==="light"?"text-slate-600":"text-slate-300"])},[(r(!0),c(ae,null,fe(j.value,(a,P)=>(r(),c("div",{key:`line-${P}`},V(a),1))),128))],2)):O("",!0)],6)}}}),qe=U=>(Fe("data-v-66dccf8e"),U=U(),je(),U),xt={key:0,class:"text-center text-2xl pt-10"},bt={key:1},wt={class:"mt-8 grid grid-cols-1 xl:grid-cols-2 gap-6"},kt={class:"xl:col-span-1"},$t=qe(()=>d("h3",{class:"text-xl font-bold mb-4"},"Trace brute",-1)),Tt={class:"journal-canvas min-h-[420px]"},Lt={class:"traces-scroll h-full overflow-y-auto pr-2"},St={class:"paper-content"},Ct={key:0,class:"text-xs text-slate-500 mb-2"},At={class:"trace-entry text-[17px] text-slate-700 whitespace-pre-line leading-[2]"},Et={key:0,class:"font-georgia whitespace-pre-wrap"},Dt={key:1,class:"text-sm text-slate-500"},Mt={class:"xl:col-span-1 space-y-8 font-inter"},Rt=qe(()=>d("h3",{class:"text-xl font-bold mb-4"},"Elements détectés",-1)),Ft={class:"space-y-3"},jt=["onClick"],It={class:"text-xs uppercase tracking-wide text-slate-300 font-semibold"},Pt={class:"inline-flex items-center gap-2"},Ot={class:"text-xs text-slate-400"},Bt={key:0,class:"mt-2 pl-1"},Wt={key:0,class:"grid grid-cols-1 gap-3"},zt={key:1,class:"text-xs text-slate-500"},Vt=xe({__name:"TraceFocusView",props:{id:{}},setup(U){const m=U,F=S(null),w=S(null),k=S([]),L=S("transactions"),N=S({}),R=S({}),I=[{accent:"#f97316",highlight:"rgba(249, 115, 22, 0.32)"},{accent:"#22c55e",highlight:"rgba(34, 197, 94, 0.30)"},{accent:"#0ea5e9",highlight:"rgba(14, 165, 233, 0.30)"},{accent:"#a855f7",highlight:"rgba(168, 85, 247, 0.30)"},{accent:"#eab308",highlight:"rgba(234, 179, 8, 0.30)"},{accent:"#ef4444",highlight:"rgba(239, 68, 68, 0.28)"},{accent:"#14b8a6",highlight:"rgba(20, 184, 166, 0.30)"},{accent:"#f43f5e",highlight:"rgba(244, 63, 94, 0.28)"}],J=async()=>{var e;try{const n=await G.get(`/analysis/${m.id}`);F.value=((e=n.data)==null?void 0:e.analysis)??n.data??null}catch(n){console.error("Error fetching analysis:",n),F.value=null}},K=async e=>{try{const n=await G.get(`/trace_mirrors/${e}`);w.value=n.data}catch(n){console.error("Error fetching trace:",n),w.value=null}},$=async()=>{try{const e=await G.get(`/analysis/${m.id}/elements`);k.value=Array.isArray(e.data)?e.data:[]}catch(e){console.error("Error fetching analysis elements:",e),k.value=[]}},p=e=>{var h;const n=(e==null?void 0:e.content)??((h=e==null?void 0:e.resource)==null?void 0:h.content);if(typeof n!="string")return null;let l=n.trim();if(!l)return null;for(let M=0;M<3&&typeof l=="string";M++){const b=l.trim();if(!b||!(b.startsWith("{")||b.startsWith("[")||b.startsWith('"')))return null;try{l=JSON.parse(b)}catch{return null}}return l&&typeof l=="object"&&!Array.isArray(l)?l:null},D=e=>{const n=String(e??"").trim().toLowerCase();return n?n==="transaction"||n.startsWith("transaction")?"transactions":n==="descriptive"||n.startsWith("descriptive")?"descriptives":n==="evaluative"||n.startsWith("evaluative")?"evaluatives":n==="normative"||n.startsWith("normative")?"normatives":null:null},H=e=>{const n=String(e??"").trim().toLowerCase();return n?["input","output","transformation","question"].includes(n)?"transactions":["unit","theme"].includes(n)?"descriptives":["emotion","energy","quality","interest"].includes(n)?"evaluatives":["plan","obligation","recommendation","principle"].includes(n)?"normatives":null:null},le=e=>{var M,b,B,W;const n=p(e),l=[e==null?void 0:e.element_type,e==null?void 0:e.elementType,(M=e==null?void 0:e.resource)==null?void 0:M.element_type,(b=e==null?void 0:e.resource)==null?void 0:b.elementType,n==null?void 0:n.element_type,n==null?void 0:n.elementType,n==null?void 0:n.type];for(const pe of l){const re=D(pe);if(re)return re}const h=[e==null?void 0:e.element_subtype,e==null?void 0:e.elementSubtype,(B=e==null?void 0:e.resource)==null?void 0:B.element_subtype,(W=e==null?void 0:e.resource)==null?void 0:W.elementSubtype,n==null?void 0:n.element_subtype,n==null?void 0:n.elementSubtype,n==null?void 0:n.subtype,n==null?void 0:n.kind];for(const pe of h){const re=H(pe);if(re)return re}return null},Z=y(()=>k.value.filter(e=>le(e)==="transactions")),C=y(()=>k.value.filter(e=>le(e)==="descriptives")),T=y(()=>k.value.filter(e=>le(e)==="evaluatives")),q=y(()=>k.value.filter(e=>le(e)==="normatives")),X=y(()=>[{key:"transactions",title:"Transactions",items:Z.value},{key:"descriptives",title:"Descriptives",items:C.value},{key:"evaluatives",title:"Evaluatives",items:T.value},{key:"normatives",title:"Normatives",items:q.value}]),ee=y(()=>{if(!L.value)return[];const e=X.value.find(n=>n.key===L.value);return(e==null?void 0:e.items)??[]}),te=e=>{L.value=L.value===e?null:e},ce=y(()=>{const e=w.value;return(e==null?void 0:e.interaction_date)??(e==null?void 0:e.interactionDate)??(e==null?void 0:e.created_at)??(e==null?void 0:e.createdAt)??void 0}),ue=y(()=>{const e=w.value;return String((e==null?void 0:e.content)||(e==null?void 0:e.title)||"Trace sans contenu")}),_=y(()=>{const e=ue.value,n=e.indexOf(`
`);return n<0?{first:e,rest:"",restOffset:e.length}:{first:e.slice(0,n),rest:e.slice(n+1),restOffset:n+1}}),E=y(()=>_.value.first.length>200),z=e=>{if(typeof e=="string")return e;if(e==null||typeof e!="object")return"";const n=[e.extraction,e.text,e.value,e.content,e.title];for(const l of n)if(typeof l=="string")return l;return""},f=e=>{if(!e)return null;let n=e.trim();if(!n)return null;for(let l=0;l<3;l++){if(typeof n!="string")return n;const h=n.trim();if(!h)return null;if(!(h.startsWith("{")||h.startsWith("[")||h.startsWith('"')))return l===0?null:n;try{n=JSON.parse(h)}catch{return l===0?null:n}}return n},x=e=>{if(typeof e=="string")return[e];if(Array.isArray(e))return e.flatMap(h=>x(h)).map(h=>h.trim()).filter(h=>h.length>0);if(e==null||typeof e!="object")return[];const n=[e.text,e.value,e.content,e.extraction,e.title],l=[];for(const h of n)typeof h=="string"&&h.trim().length>0?l.push(h.trim()):Array.isArray(h)&&l.push(...x(h));return l},j=(e,n)=>{if(e!=null){if(Array.isArray(e)){for(const l of e)j(l,n);return}if(typeof e=="object"){"spans"in e?n.push(...x(e.spans)):"span"in e&&n.push(...x(e.span));for(const l of Object.values(e))l==null||typeof l!="object"||j(l,n)}}},t=e=>{const n=f(e);if(n==null)return[];const l=[];j(n,l);const h=new Set,M=[];for(const b of l){const B=b.trim();if(B.length<2)continue;const W=B.toLowerCase();h.has(W)||(h.add(W),M.push(B))}return M},i=e=>{if(!e)return[];const n=e.match(/Extractions\s*:\s*(\[[\s\S]*?\])/i);if(!n||!n[1])return[];const l=n[1].trim();if(!l.startsWith("[")||!l.endsWith("]"))return[];try{const B=JSON.parse(l);if(Array.isArray(B))return B.map(W=>typeof W=="string"?W.trim():"").filter(W=>W.length>0)}catch{}const h=[],M=/"((?:\\.|[^"\\])*)"/g;let b=null;for(;(b=M.exec(l))!==null;){const B=b[1].replace(/\\"/g,'"').trim();B.length>0&&h.push(B)}return h},u=e=>{var pe,re;const n=new Set,l=[],h=String((e==null?void 0:e.content)??((pe=e==null?void 0:e.resource)==null?void 0:pe.content)??""),M=t(h);for(const oe of M){const se=oe.toLowerCase();n.has(se)||(n.add(se),l.push(oe))}if(l.length>0)return l;const b=i(h);for(const oe of b){const se=oe.toLowerCase();n.has(se)||(n.add(se),l.push(oe))}if(l.length>0)return l;const B=(e==null?void 0:e.extractions)??((re=e==null?void 0:e.resource)==null?void 0:re.extractions)??[],W=Array.isArray(B)?B:[B];for(const oe of W){const se=z(oe).trim();if(se.length<2)continue;const o=se.toLowerCase();n.has(o)||(n.add(o),l.push(se))}return l},a=y(()=>{const e={};return ee.value.forEach((n,l)=>{const h=ge(n);h&&(e[h]=I[l%I.length])}),e}),P=(e,n=0)=>{const l=ge(e);return l&&a.value[l]?a.value[l]:I[n%I.length]},Y=y(()=>{const e=ue.value;if(!e)return[];const n=e.toLowerCase(),l=[],h=new Set;ee.value.forEach((b,B)=>{const W=u(b);if(W.length===0)return;const pe=P(b,B).highlight;for(const re of W){const oe=re.toLowerCase();let se=0;for(;se<n.length;){const o=n.indexOf(oe,se);if(o===-1)break;const v=o+oe.length,A=`${o}-${v}-${pe}`;h.has(A)||(l.push({start:o,end:v,color:pe,length:oe.length}),h.add(A)),se=v}}}),l.sort((b,B)=>b.start!==B.start?b.start-B.start:B.length-b.length);const M=[];for(const b of l)M.some(W=>!(b.end<=W.start||b.start>=W.end))||M.push({start:b.start,end:b.end,color:b.color});return M.sort((b,B)=>b.start-B.start)}),ne=(e,n)=>{if(!e)return[];const l=n,h=n+e.length,M=Y.value.filter(W=>W.end>l&&W.start<h).map(W=>({start:Math.max(W.start,l)-l,end:Math.min(W.end,h)-l,color:W.color})).sort((W,pe)=>W.start-pe.start);if(M.length===0)return[{text:e,color:null}];const b=[];let B=0;for(const W of M)W.start>B&&b.push({text:e.slice(B,W.start),color:null}),b.push({text:e.slice(W.start,W.end),color:W.color}),B=W.end;return B<e.length&&b.push({text:e.slice(B),color:null}),b},Q=y(()=>ne(_.value.first,0)),de=y(()=>ne(_.value.rest,_.value.restOffset)),be=e=>e?(e instanceof Date?e:new Date(e)).toLocaleDateString("fr-FR",{day:"numeric",month:"long",year:"numeric"}):"",ge=e=>{const n=e==null?void 0:e.id;if(n==null)return null;const l=String(n).trim();return l.length>0?l:null},me=async e=>{if(e&&N.value[e]==null&&!R.value[e]){R.value[e]=!0;try{const n=await G.get(`/elements/${e}/landmarks`);N.value[e]=Array.isArray(n.data)?n.data:[]}catch(n){console.error(`Error fetching landmarks for element ${e}:`,n),N.value[e]=[]}finally{R.value[e]=!1}}};_e(()=>ee.value.map(e=>ge(e)).filter(Boolean).join(","),async()=>{const e=ee.value.map(n=>ge(n)).filter(n=>!!n);await Promise.all(e.map(n=>me(n)))},{immediate:!0});const s=e=>{if(!e)return null;const n=e.trace_mirror_id??e.traceMirrorId;if(n==null)return null;const l=String(n).trim();return l.length>0?l:null},g=async()=>{L.value="transactions",N.value={},R.value={},k.value=[],w.value=null,await J();const e=F.value;if(e){const n=s(e);n&&await K(n)}await $()};return Te(async()=>{await g()}),_e(()=>m.id,async()=>{await g()}),(e,n)=>F.value?(r(),c("div",bt,[d("div",wt,[d("section",kt,[$t,d("div",Tt,[d("div",Lt,[d("div",St,[w.value?(r(),c(ae,{key:0},[ce.value?(r(),c("div",Ct,V(be(ce.value)),1)):O("",!0),d("article",At,[d("div",{class:ie(["mb-2 text-slate-800 whitespace-pre-wrap",E.value?"font-georgia text-lg leading-relaxed":"font-handwritten text-4xl leading-tight"])},[(r(!0),c(ae,null,fe(Q.value,(l,h)=>(r(),c("span",{key:`first-${h}`,style:$e(l.color?{backgroundColor:l.color}:void 0),class:"rounded-[3px] px-[1px]"},V(l.text),5))),128))],2),_.value.rest?(r(),c("div",Et,[(r(!0),c(ae,null,fe(de.value,(l,h)=>(r(),c("span",{key:`rest-${h}`,style:$e(l.color?{backgroundColor:l.color}:void 0),class:"rounded-[3px] px-[1px]"},V(l.text),5))),128))])):O("",!0)])],64)):(r(),c("div",Dt,"Aucune trace"))])])])]),d("section",Mt,[d("div",null,[Rt,d("div",Ft,[(r(!0),c(ae,null,fe(X.value,l=>(r(),c("div",{key:l.key},[d("button",{type:"button",class:"w-full flex items-center justify-between rounded-lg border border-slate-700 bg-slate-900/50 px-3 py-2 hover:bg-slate-800/60 transition-colors",onClick:h=>te(l.key)},[d("span",It,V(l.title),1),d("span",Pt,[d("span",Ot,V(l.items.length),1),ye(ve(Ue),{class:ie(["w-4 h-4 text-slate-400 transition-transform",L.value===l.key?"rotate-180":""])},null,8,["class"])])],8,jt),L.value===l.key?(r(),c("div",Bt,[l.items.length>0?(r(),c("div",Wt,[(r(!0),c(ae,null,fe(l.items,(h,M)=>(r(),he(_t,{key:h.id??`${l.key}-${M}`,element:h,"accent-color":P(h,M).accent,"associated-landmarks":N.value[ge(h)||""]??[]},null,8,["element","accent-color","associated-landmarks"]))),128))])):(r(),c("div",zt,"Aucun élément"))])):O("",!0)]))),128))])])])])])):(r(),c("div",xt,"Loading..."))}});const Ut=Ie(Vt,[["__scopeId","data-v-66dccf8e"]]),He=U=>(Fe("data-v-90b8813c"),U=U(),je(),U),Nt={key:0,class:"text-center text-2xl pt-10"},Jt={key:1},qt={class:"mt-8 grid grid-cols-1 xl:grid-cols-2 gap-6"},Ht={class:"xl:col-span-1"},Kt=He(()=>d("h3",{class:"text-xl font-bold mb-4"},"Trace miroir",-1)),Gt={class:"journal-canvas min-h-[420px]"},Yt={class:"traces-scroll h-full overflow-y-auto pr-2"},Xt={class:"paper-content"},Qt={key:0,class:"text-xs text-slate-500 mb-2"},Zt={class:"trace-entry text-[17px] text-slate-700 whitespace-pre-line leading-[2]"},es={key:0,class:"font-georgia whitespace-pre-wrap"},ts={key:1,class:"text-sm text-slate-500"},ss={class:"xl:col-span-1 space-y-8 font-inter"},ns=He(()=>d("h3",{class:"text-xl font-bold mb-4"},"Références détectées",-1)),rs={key:0,class:"text-sm text-slate-500"},as={key:1,class:"grid grid-cols-1 gap-3"},os={class:"text-sm font-semibold text-slate-200 line-clamp-2 flex items-start gap-2"},ls={key:0,class:"mt-1 text-xs text-slate-400"},is={key:1,class:"mt-2 text-xs text-slate-300 whitespace-pre-wrap"},cs={key:2,class:"text-sm text-slate-500"},us=xe({__name:"TraceMirrorFocusView",props:{id:{}},setup(U){const m=U,F=S(null),w=S(null),k=S([]),L=S([]),N=S({}),R=S({}),I=S({}),J=S(!1),K=S(!1),$=S(typeof window<"u"?window.innerWidth:1280),p=[{accent:"#f97316",highlight:"rgba(249, 115, 22, 0.32)"},{accent:"#22c55e",highlight:"rgba(34, 197, 94, 0.30)"},{accent:"#0ea5e9",highlight:"rgba(14, 165, 233, 0.30)"},{accent:"#a855f7",highlight:"rgba(168, 85, 247, 0.30)"},{accent:"#eab308",highlight:"rgba(234, 179, 8, 0.30)"},{accent:"#ef4444",highlight:"rgba(239, 68, 68, 0.28)"},{accent:"#14b8a6",highlight:"rgba(20, 184, 166, 0.30)"},{accent:"#f43f5e",highlight:"rgba(244, 63, 94, 0.28)"}],D=s=>{const g=(s==null?void 0:s.trace_mirror_id)??(s==null?void 0:s.traceMirrorId);if(g==null)return null;const e=String(g).trim();return e.length>0?e:null},H=async()=>{var s;try{const g=await G.get(`/analysis/${m.id}`);F.value=((s=g.data)==null?void 0:s.analysis)??g.data??null}catch(g){console.error("Error fetching analysis:",g),F.value=null}},le=async s=>{try{const g=await G.get(`/trace_mirrors/${s}`);w.value=g.data??null}catch(g){console.error("Error fetching trace mirror:",g),w.value=null}},Z=async s=>{J.value=!0;try{const g=await G.get(`/trace_mirrors/${s}/references`);k.value=Array.isArray(g.data)?g.data:[];const e=Array.from(new Set(k.value.map(n=>z(n)).filter(n=>!!n)));await Promise.all(e.map(n=>f(n))),L.value=k.value.map(n=>{const l=z(n),h=l?R.value[l]??null:null;return{...n,landmark:h}})}catch(g){console.error("Error fetching trace mirror references:",g),k.value=[],L.value=[]}finally{J.value=!1}},C=async()=>{K.value=!1,k.value=[],L.value=[],w.value=null,await H();const s=D(F.value);s&&await Promise.all([le(s),Z(s)])},T=y(()=>{const s=w.value;return(s==null?void 0:s.interaction_date)??(s==null?void 0:s.interactionDate)??(s==null?void 0:s.created_at)??(s==null?void 0:s.createdAt)??void 0}),q=y(()=>{const s=w.value;return String((s==null?void 0:s.content)||(s==null?void 0:s.title)||"Trace miroir sans contenu")}),X=y(()=>{const s=q.value,g=s.indexOf(`
`);return g<0?{first:s,rest:"",restOffset:s.length}:{first:s.slice(0,g),rest:s.slice(g+1),restOffset:g+1}}),ee=y(()=>X.value.first.length>200),te=y(()=>$.value>=1280?3:$.value>=768?2:1),ce=y(()=>K.value?L.value:L.value.slice(0,te.value)),ue=y(()=>!K.value&&L.value.length>te.value),_=s=>{var n;const g=(s==null?void 0:s.id)??((n=s==null?void 0:s.resource)==null?void 0:n.id);if(g==null)return null;const e=String(g).trim();return e.length>0?e:null},E=s=>{const g=(s==null?void 0:s.tag_id)??(s==null?void 0:s.tagId);if(g==null)return null;const e=String(g).trim();return e.length>0?e:null},z=s=>{const g=(s==null?void 0:s.landmark_id)??(s==null?void 0:s.landmarkId);if(g==null)return null;const e=String(g).trim();return e.length>0?e:null},f=async s=>{if(s&&N.value[s]==null&&!I.value[s]){I.value[s]=!0;try{const e=(await G.get(`/landmarks/${s}`)).data??null;R.value[s]=e,N.value[s]=e!=null&&e.title?String(e.title):"Landmark"}catch(g){console.error(`Error fetching landmark ${s}:`,g),R.value[s]=null,N.value[s]="Landmark"}finally{I.value[s]=!1}}},x=s=>{var g;return(s==null?void 0:s.mention)??(s==null?void 0:s.title)??((g=s==null?void 0:s.resource)==null?void 0:g.title)??""},j=s=>{const g=String((s==null?void 0:s.mention)??"").trim(),e=E(s);return!g||!e?"":`${g}[id:${e}]`},t=s=>{var e;if((e=s==null?void 0:s.landmark)!=null&&e.title)return String(s.landmark.title);const g=z(s);return g?N.value[g]?N.value[g]:I.value[g]?"Chargement...":"":""},i=s=>{if(s==null)return"";if(Array.isArray(s))return s.map(e=>i(e)).filter(e=>e.length>0).join(", ");if(typeof s=="object")try{return JSON.stringify(s)}catch{return""}return String(s).trim()},u=s=>{const g=i((s==null?void 0:s.tag_id)??(s==null?void 0:s.tagId)),e=i((s==null?void 0:s.reference_variants)??(s==null?void 0:s.referenceVariants)),n=i((s==null?void 0:s.reference_type)??(s==null?void 0:s.referenceType)),l=i((s==null?void 0:s.context_tag)??(s==null?void 0:s.contextTag)),h=i((s==null?void 0:s.landmark_id)??(s==null?void 0:s.landmarkId)),M=[];return g&&M.push(`tag_id: ${g}`),e&&M.push(`reference_variants: ${e}`),n&&M.push(`reference_type: ${n}`),l&&M.push(`context_tag: ${l}`),h&&M.push(`landmark_id: ${h}`),M},a=s=>{const g=_(s);if(g)return g;const e=String((s==null?void 0:s.mention)??"").trim(),n=E(s);return!e||!n?null:`${e}::${n}`},P=y(()=>{const s={};return L.value.forEach((g,e)=>{const n=a(g)??`__index_${e}`;s[n]||(s[n]=p[e%p.length])}),s}),Y=(s,g=0)=>{const e=a(s);if(e&&P.value[e])return P.value[e];const n=L.value.findIndex(l=>l===s);if(n>=0){const l=`__index_${n}`;return P.value[l]?P.value[l]:p[n%p.length]}return p[g%p.length]},ne=y(()=>{const s=q.value;if(!s)return[];const g=[],e=new Set,n=s.toLowerCase();L.value.forEach((h,M)=>{const b=j(h);if(!b)return;const B=Y(h,M).highlight;let W=0,pe=!1;for(;W<s.length;){const re=s.indexOf(b,W);if(re===-1)break;pe=!0;const oe=re+b.length,se=`${re}-${oe}-${B}`;e.has(se)||(g.push({start:re,end:oe,color:B,length:b.length}),e.add(se)),W=oe}if(!pe){const re=b.toLowerCase();let oe=0;for(;oe<n.length;){const se=n.indexOf(re,oe);if(se===-1)break;const o=se+re.length,v=`${se}-${o}-${B}`;e.has(v)||(g.push({start:se,end:o,color:B,length:re.length}),e.add(v)),oe=o}}}),g.sort((h,M)=>h.start!==M.start?h.start-M.start:M.length-h.length);const l=[];for(const h of g)l.some(b=>!(h.end<=b.start||h.start>=b.end))||l.push({start:h.start,end:h.end,color:h.color});return l.sort((h,M)=>h.start-M.start)}),Q=(s,g)=>{if(!s)return[];const e=g,n=g+s.length,l=ne.value.filter(b=>b.end>e&&b.start<n).map(b=>({start:Math.max(b.start,e)-e,end:Math.min(b.end,n)-e,color:b.color})).sort((b,B)=>b.start-B.start);if(l.length===0)return[{text:s,color:null}];const h=[];let M=0;for(const b of l)b.start>M&&h.push({text:s.slice(M,b.start),color:null}),h.push({text:s.slice(b.start,b.end),color:b.color}),M=b.end;return M<s.length&&h.push({text:s.slice(M),color:null}),h},de=y(()=>Q(X.value.first,0)),be=y(()=>Q(X.value.rest,X.value.restOffset)),ge=s=>s?(s instanceof Date?s:new Date(s)).toLocaleDateString("fr-FR",{day:"numeric",month:"long",year:"numeric"}):"",me=()=>{typeof window>"u"||($.value=window.innerWidth)};return Te(async()=>{me(),window.addEventListener("resize",me),await C()}),Pe(()=>{window.removeEventListener("resize",me)}),_e(()=>m.id,async()=>{await C()}),(s,g)=>F.value?(r(),c("div",Jt,[d("div",qt,[d("section",Ht,[Kt,d("div",Gt,[d("div",Yt,[d("div",Xt,[w.value?(r(),c(ae,{key:0},[T.value?(r(),c("div",Qt,V(ge(T.value)),1)):O("",!0),d("article",Zt,[d("div",{class:ie(["mb-2 text-slate-800 whitespace-pre-wrap",ee.value?"font-georgia text-lg leading-relaxed":"font-handwritten text-4xl leading-tight"])},[(r(!0),c(ae,null,fe(de.value,(e,n)=>(r(),c("span",{key:`first-${n}`,style:$e(e.color?{backgroundColor:e.color}:void 0),class:"rounded-[3px] px-[1px]"},V(e.text),5))),128))],2),X.value.rest?(r(),c("div",es,[(r(!0),c(ae,null,fe(be.value,(e,n)=>(r(),c("span",{key:`rest-${n}`,style:$e(e.color?{backgroundColor:e.color}:void 0),class:"rounded-[3px] px-[1px]"},V(e.text),5))),128))])):O("",!0)])],64)):(r(),c("div",ts,"Aucune trace miroir"))])])])]),d("section",ss,[d("div",null,[ns,J.value?(r(),c("div",rs,"Chargement...")):ce.value.length>0?(r(),c("div",as,[(r(!0),c(ae,null,fe(ce.value,(e,n)=>(r(),c("div",{key:_(e)??n,class:"h-full p-3 rounded-lg border border-slate-700 bg-slate-800/40",style:$e({borderColor:Y(e,n).accent})},[d("div",os,[d("span",{class:"w-2 h-2 rounded-full mt-1.5 flex-none",style:$e({backgroundColor:Y(e,n).accent})},null,4),Se(" "+V(x(e)||"Sans titre"),1)]),t(e)?(r(),c("div",ls,V(t(e)),1)):O("",!0),u(e).length?(r(),c("div",is,[(r(!0),c(ae,null,fe(u(e),(l,h)=>(r(),c("div",{key:`${_(e)??n}-detail-${h}`},V(l),1))),128))])):O("",!0)],4))),128))])):(r(),c("div",cs,"Aucune référence")),ue.value?(r(),c("button",{key:3,type:"button",class:"mt-3 text-sm underline text-slate-400 hover:text-slate-200 transition-colors",onClick:g[0]||(g[0]=e=>K.value=!0)}," voir plus ")):O("",!0)])])])])):(r(),c("div",Nt,"Loading..."))}});const ds=Ie(us,[["__scopeId","data-v-90b8813c"]]),fs={class:"mt-8"},ps={class:"mb-2 flex items-center justify-between gap-2"},hs=d("h3",{class:"text-xl font-bold"},"Contexte d'extraction grammaticale",-1),vs=["disabled"],gs={class:"rounded-lg border border-slate-700 bg-slate-900/40 p-3 h-52 overflow-y-auto"},ys={key:0,class:"text-sm text-slate-500"},ms={key:1,class:"text-xs leading-5 text-slate-200 whitespace-pre-wrap break-words"},_s={key:2,class:"text-sm text-slate-500"},xs={class:"mt-8"},bs=d("h3",{class:"text-xl font-bold mb-4"},"Fonctionnement de l'analyse",-1),ws={class:"space-y-4"},ks={key:0,class:"text-sm text-slate-500"},$s=xe({__name:"AnalysisFocusView",props:{id:{}},setup(U){const m=U,{launchSnackbar:F}=ze(),w=S([]),k=S(null),L=S(null),N=S([]),R=S([]),I=S(!1),J=C=>{const T=(C==null?void 0:C.trace_mirror_id)??(C==null?void 0:C.traceMirrorId);if(T==null)return null;const q=String(T).trim();return q.length>0?q:null},K=C=>{const T=C==null?void 0:C.id;if(T==null)return null;const q=String(T).trim();return q.length>0?q:null},$=async C=>{R.value=[];try{const T=await G.get(`/analysis/${C}/parents`),X=(Array.isArray(T.data)?T.data:[])[0]??null,ee=K(X);if(!ee)return;const te=await G.get(`/analysis/${ee}/landmarks`);R.value=Array.isArray(te.data)?te.data:[]}catch(T){console.error("Error loading previous landscape landmarks:",T),R.value=[]}},p=async()=>{var C;I.value=!0,k.value=null,L.value=null,N.value=[],R.value=[];try{const T=await G.get(`/analysis/${m.id}`);k.value=((C=T.data)==null?void 0:C.analysis)??T.data??null;const q=K(k.value)??m.id,X=$(q),ee=J(k.value);if(!ee){await X;return}const[te,ce]=await Promise.all([G.get(`/trace_mirrors/${ee}`),G.get(`/trace_mirrors/${ee}/references`)]);L.value=te.data??null;const ue=Array.isArray(ce.data)?ce.data:[],_=Array.from(new Set(ue.map(f=>(f==null?void 0:f.landmark_id)??(f==null?void 0:f.landmarkId)).filter(f=>f!=null&&String(f).trim().length>0).map(f=>String(f).trim()))),z=(await Promise.all(_.map(async f=>{try{const x=await G.get(`/landmarks/${f}`);return[f,x.data??null]}catch(x){return console.error(`Error fetching landmark ${f}:`,x),[f,null]}}))).reduce((f,[x,j])=>(f[x]=j,f),{});N.value=ue.map(f=>{const x=(f==null?void 0:f.landmark_id)??(f==null?void 0:f.landmarkId),j=x!=null?String(x).trim():"";return{...f,landmark:j?z[j]??null:null}}),await X}catch(T){console.error("Error loading grammatical extraction context:",T),k.value=null,L.value=null,N.value=[],R.value=[]}finally{I.value=!1}},D=y(()=>{var C,T;return L.value?{tagged_text:((C=L.value)==null?void 0:C.content)??((T=L.value)==null?void 0:T.title)??"",references:N.value,previous_landscape_landmarks:R.value}:null}),H=y(()=>D.value?JSON.stringify(D.value,null,2):""),le=async()=>{if(H.value)try{await navigator.clipboard.writeText(H.value),F("Contexte copié dans le presse-papiers","success")}catch(C){console.error("Failed to copy grammatical extraction context:",C),F("Échec de la copie","error")}},Z=async()=>{try{const C=await G.get(`/analysis/${m.id}/llm_calls`);w.value=Array.isArray(C.data)?C.data:[]}catch(C){console.error("Error fetching analysis llm_calls:",C),w.value=[]}};return Te(async()=>{await Promise.all([Z(),p()])}),_e(()=>m.id,async()=>{await Promise.all([Z(),p()])}),(C,T)=>(r(),c("div",null,[d("div",fs,[d("div",ps,[hs,d("button",{type:"button",class:"inline-flex items-center justify-center w-8 h-8 rounded border border-slate-700 bg-slate-900/60 text-slate-300 hover:text-slate-100 hover:bg-slate-800/70 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",disabled:!H.value,title:"Copier le JSON",onClick:le},[ye(ve(it),{class:"w-4 h-4"})],8,vs)]),d("div",gs,[I.value?(r(),c("div",ys," Chargement... ")):H.value?(r(),c("pre",ms,V(H.value),1)):(r(),c("div",_s," Aucun contexte disponible "))])]),d("div",xs,[bs,d("div",ws,[(r(!0),c(ae,null,fe(w.value,q=>(r(),he(lt,{key:q.id,"llm-call":q},null,8,["llm-call"]))),128))]),w.value.length===0?(r(),c("div",ks," Aucun appel LLM ")):O("",!0)])]))}}),Ts={class:"flex flex-wrap items-center gap-2"},Ls={class:"text-sm font-semibold text-slate-200"},Ss={key:0,class:"text-[10px] px-1.5 py-0.5 rounded-full border border-slate-600 text-slate-400"},Cs={key:0,class:"text-xs text-slate-400 mt-1"},As={key:1,class:"text-xs text-slate-300 mt-1.5 whitespace-pre-line line-clamp-3"},Es=xe({__name:"LandmarkCard",props:{title:{default:""},subtitle:{default:""},content:{default:""},badge:{default:""},linkTo:{default:null}},setup(U){const m=U,F=y(()=>{const w="h-full p-3 rounded-lg border border-slate-700 bg-slate-800/40",k=m.linkTo?"hover:border-slate-600 transition-colors":"";return`${w} ${k}`.trim()});return(w,k)=>{const L=De("router-link");return r(),c("div",{class:ie(F.value)},[d("div",Ts,[d("div",Ls,V(w.title),1),w.badge?(r(),c("span",Ss,V(w.badge),1)):O("",!0)]),w.subtitle?(r(),c("div",Cs,V(w.subtitle),1)):O("",!0),w.content?(r(),c("div",As,V(w.content),1)):O("",!0),w.linkTo?(r(),he(L,{key:2,to:w.linkTo,class:"inline-block mt-2 text-xs underline text-slate-400 hover:text-slate-200 transition-colors"},{default:Le(()=>[Se(" voir plus ")]),_:1},8,["to"])):O("",!0)],2)}}}),Ds={key:0,class:"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-3"},Ms={key:2,class:"text-sm text-slate-500"},Be=xe({__name:"LandmarksDisplayGrid",props:{landmarks:{},emptyText:{default:"Aucun landmark"},contentMax:{default:200}},setup(U){const m=U,F=S(!1),w=S(typeof window<"u"?window.innerWidth:1280),k=y(()=>w.value>=1280?3:w.value>=768?2:1),L=y(()=>F.value?m.landmarks:m.landmarks.slice(0,k.value)),N=y(()=>!F.value&&m.landmarks.length>k.value),R=p=>{if(!p)return"";const D=p.trim().toLowerCase();return D==="rsrc"?"Ressource":D==="autr"?"Auteur":D==="them"?"Thème":D==="task"?"Tâche":D==="qest"?"Question":D==="dlvr"?"Livrable":D==="proc"?"Processus":D==="topic"?"Sujet":D==="project"?"Projet":D==="person"?"Personne":p.trim()},I=p=>{if(!p)return"";const D=p.replace(/\s+/g," ").trim();return D.length<=m.contentMax?D:`${D.slice(0,m.contentMax)}...`},J=p=>typeof p.display_badge=="string"?p.display_badge:R(p.landmark_type??p.landmarkType),K=p=>{if(typeof p.display_content=="string")return I(p.display_content);const D=I(p.content??p.description??p.summary);return D||(typeof p.count=="number"?`${p.count} co-occurrences`:"")},$=()=>{typeof window>"u"||(w.value=window.innerWidth)};return _e(()=>m.landmarks.map(p=>String((p==null?void 0:p.id)??"")).join(","),()=>{F.value=!1}),Te(()=>{$(),window.addEventListener("resize",$)}),Pe(()=>{window.removeEventListener("resize",$)}),(p,D)=>(r(),c("div",null,[p.landmarks.length>0?(r(),c("div",Ds,[(r(!0),c(ae,null,fe(L.value,(H,le)=>(r(),he(Es,{key:H.id??le,title:H.title??"",subtitle:H.display_subtitle??H.subtitle,content:K(H),badge:J(H),"link-to":H.id?`/app/landmarks/${H.id}`:null},null,8,["title","subtitle","content","badge","link-to"]))),128))])):O("",!0),N.value?(r(),c("button",{key:1,type:"button",class:"mt-3 text-sm underline text-slate-400 hover:text-slate-200 transition-colors",onClick:D[0]||(D[0]=H=>F.value=!0)}," voir plus ")):O("",!0),p.landmarks.length===0?(r(),c("div",Ms,V(p.emptyText),1)):O("",!0)]))}}),{launchSnackbar:Rs}=ze(),{user:Ae}=Ve(),Me=S([]),Re=S(!1);async function Fs(U){try{return(await G.get(`/traces/${U}`)).data}catch(m){return console.error(`Error fetching trace ${U}:`,m),null}}async function js(){var U;if(console.log("[useTrace] loadUserTraces called, user:",Ae.value),!((U=Ae.value)!=null&&U.id)){console.warn("[useTrace] User not found, skipping loadUserTraces");return}Re.value=!0;try{console.log("[useTrace] Fetching traces for user:",Ae.value.id);const F=(await G.get(`/users/${Ae.value.id}/traces`)).data;console.log("[useTrace] Traces list loaded:",F);const w=await Promise.all(F.map(async k=>k.id&&await Fs(k.id)||k));Me.value=w.filter(k=>k!==null),console.log("[useTrace] Full traces loaded:",Me.value)}catch(m){console.error("Error loading traces:",m),Rs(`Error loading traces: ${m}`,"error")}finally{Re.value=!1}}function Is(){return{traces:Me,isLoadingTraces:Re,loadUserTraces:js}}const Ps=U=>(Fe("data-v-9fa1ce8f"),U=U(),je(),U),Os={key:0,class:"text-slate-500 text-sm"},Bs={key:1,class:"text-slate-500 text-sm"},Ws={key:2,class:"relative"},zs={class:"relative"},Vs={class:"mt-2 flex items-center justify-between px-1"},Us={key:1,class:"h-5 w-5"},Ns=Ps(()=>d("div",{class:"flex-1"},null,-1)),Js={key:3,class:"h-5 w-5"},qs={class:"relative"},Hs={key:0,class:"pointer-events-none absolute left-0 top-0 bottom-0 z-20 w-12 bg-gradient-to-r from-white/95 to-transparent dark:from-gray-900/90"},Ks={key:1,class:"pointer-events-none absolute right-0 top-0 bottom-0 z-20 w-12 bg-gradient-to-l from-white/95 to-transparent dark:from-gray-900/90"},Gs={key:0,class:"absolute top-12 left-12 h-0.5 bg-slate-700 z-0",style:{width:"calc(100% + 1.5rem)"}},Ys={class:"relative pt-6 flex flex-col items-center"},Xs=["onClick"],Qs=["title","onContextmenu"],Zs={key:0},en={key:1},tn={key:2},sn={class:"mt-2 text-center max-w-[120px] group-hover:max-w-none transition-all duration-300"},nn=["title"],rn=["title"],an={class:"text-xs text-slate-500 mt-1"},on=["onClick"],ln=120,cn=xe({__name:"TracesSection",setup(U,{expose:m}){const{traces:F,isLoadingTraces:w,loadUserTraces:k}=Is(),{userJournals:L,loadUserJournal:N}=ct(),{currentLens:R,displayLandscapeAnalysis:I,headLandscapeAnalysis:J,headLandscapeAnalysisParents:K,updateDisplayLandscapeAnalysis:$,updateLensCurrentTrace:p,updateLensProcessingState:D,createLens:H,loadUserLenses:le}=Oe(),Z=y(()=>[...F.value].sort((o,v)=>{const A=new Date(o.interaction_date||o.created_at||0).getTime(),we=new Date(v.interaction_date||v.created_at||0).getTime();return A-we})),C=o=>{if(o.title)return o.title;if(o.content){const v=o.content.split(`
`)[0].trim();return v.length>30?v.substring(0,30)+"...":v}return"Trace "+o.id.slice(0,8)},T=o=>{var A;if(!o.journal_id)return null;const v=L.value.find(we=>we.resource_id===o.journal_id);return((A=v==null?void 0:v.resource)==null?void 0:A.title)||null},q=o=>{var v;return((v=I.value)==null?void 0:v.analyzed_trace_id)===o.id},X=[{from:"from-blue-500",to:"to-cyan-600",border:"border-blue-400"},{from:"from-purple-500",to:"to-pink-600",border:"border-purple-400"},{from:"from-indigo-500",to:"to-blue-600",border:"border-indigo-400"},{from:"from-rose-500",to:"to-red-600",border:"border-rose-400"},{from:"from-amber-500",to:"to-orange-600",border:"border-amber-400"},{from:"from-emerald-500",to:"to-teal-600",border:"border-emerald-400"},{from:"from-violet-500",to:"to-purple-600",border:"border-violet-400"},{from:"from-sky-500",to:"to-blue-600",border:"border-sky-400"},{from:"from-fuchsia-500",to:"to-pink-600",border:"border-fuchsia-400"},{from:"from-lime-500",to:"to-green-600",border:"border-lime-400"}],ee=o=>{let v=0;for(let A=0;A<o.length;A++){const we=o.charCodeAt(A);v=(v<<5)-v+we,v=v&v}return Math.abs(v)},te=o=>{if(q(o))return{from:"from-green-500",to:"to-emerald-600",border:"border-green-400"};if(!o.journal_id)return{from:"from-blue-500",to:"to-purple-600",border:"border-slate-800"};const A=ee(o.journal_id)%X.length;return X[A]},ce=o=>{var v,A;return((v=I.value)==null?void 0:v.analyzed_trace_id)===o.id?I.value:((A=J.value)==null?void 0:A.analyzed_trace_id)===o.id?J.value:K.value.find(we=>we.analyzed_trace_id===o.id)??null},ue=o=>{var v;return((v=ce(o))==null?void 0:v.processing_state)==="fnsh"},_=o=>K.value.find(v=>v.analyzed_trace_id===o.id),E=o=>{const v=o.interaction_date??o.created_at;return v?new Date(v).getTime():0},z=S(null),f=S({}),x=S(!1),j=S(!1),t=S(0),i=S(!1),u=S(null),a=S({x:0,y:0}),P=S(null),Y=(o,v)=>{f.value[o]=v},ne=()=>{const o=z.value;if(!o){t.value=0;return}t.value=Math.max(0,Math.round(o.clientWidth/2-ln/2))},Q=()=>{const o=z.value;if(!o){x.value=!1,j.value=!1,t.value=0;return}if(ne(),!(o.scrollWidth-o.clientWidth>1)){x.value=!1,j.value=!1;return}x.value=o.scrollLeft>1,j.value=o.scrollLeft+o.clientWidth<o.scrollWidth-1},de=()=>{i.value=!1,u.value=null},be=(o,v)=>{o.preventDefault(),o.stopPropagation();const A=170,we=40,ke=8,Ke=window.innerWidth-A-ke,Ge=window.innerHeight-we-ke;a.value={x:Math.max(ke,Math.min(o.clientX,Ke)),y:Math.max(ke,Math.min(o.clientY,Ge))},u.value=v,i.value=!0},ge=async()=>{const o=u.value;de(),o!=null&&o.id&&await H(o.id)},me=o=>{if(!i.value)return;const v=o.target;P.value&&v&&P.value.contains(v)||de()},s=o=>{o.key==="Escape"&&de()},g=()=>{Q(),i.value&&de()},e=y(()=>{var v;const o=(v=I.value)==null?void 0:v.analyzed_trace_id;return o?Z.value.find(A=>A.id===o)??null:null}),n=y(()=>Z.value.length===0?null:Z.value[Z.value.length-1]??null),l=o=>{const v=e.value;return v?E(o)>=E(v):!0},h=async o=>{if(!o)return;await Ce();const v=f.value[o];v&&(v.scrollIntoView({behavior:"smooth",inline:"center",block:"nearest"}),requestAnimationFrame(Q))},M=async()=>{var o;await h((o=e.value)==null?void 0:o.id)},b=async()=>{var o;await h((o=e.value)==null?void 0:o.id)},B=async()=>{await Ce();const o=z.value;o&&(ne(),o.scrollTo({left:o.scrollWidth,behavior:"smooth"}),requestAnimationFrame(Q))},W=o=>{const v=z.value;if(!v)return;const A=Math.max(220,Math.round(v.clientWidth*.7));v.scrollBy({left:A*o,behavior:"smooth"}),requestAnimationFrame(Q)},pe=async o=>{if(q(o)){R.value&&await D("rply");return}R.value?await p(o.id):(await H(o.id),await le());const v=_(o);v&&$(v.id)},re=o=>o?(typeof o=="string"?new Date(o):o).toLocaleDateString("fr-FR",{day:"numeric",month:"short"}):"";return Te(async()=>{await Promise.all([k(),N()]),await Ce(),Q(),await M(),window.addEventListener("resize",Q),window.addEventListener("pointerdown",me),window.addEventListener("keydown",s)}),Qe(()=>{window.removeEventListener("resize",Q),window.removeEventListener("pointerdown",me),window.removeEventListener("keydown",s)}),_e(()=>Z.value.map(o=>o.id).join(","),async()=>{await Ce(),Q()}),_e(e,async(o,v)=>{o!=null&&o.id&&o.id!==(v==null?void 0:v.id)&&(await M(),Q())}),m({scrollToFocus:b,scrollToToday:B,hasFocusTarget:()=>!!e.value,hasTodayTarget:()=>!!n.value}),(o,v)=>(r(),c("div",null,[ve(w)?(r(),c("div",Os," Chargement... ")):!ve(w)&&Z.value.length===0?(r(),c("div",Bs," Aucune trace disponible ")):(r(),c("div",Ws,[d("div",zs,[d("div",Vs,[x.value?(r(),c("button",{key:0,type:"button",class:"h-5 w-5 flex items-center justify-center text-slate-500 hover:text-slate-300",title:"Défiler à gauche",onClick:v[0]||(v[0]=A=>W(-1))},[ye(ve(Ne),{class:"w-5 h-5"})])):(r(),c("div",Us)),Ns,j.value?(r(),c("button",{key:2,type:"button",class:"h-5 w-5 flex items-center justify-center text-slate-500 hover:text-slate-300",title:"Défiler à droite",onClick:v[1]||(v[1]=A=>W(1))},[ye(ve(Je),{class:"w-5 h-5"})])):(r(),c("div",Js))]),d("div",qs,[x.value?(r(),c("div",Hs)):O("",!0),j.value?(r(),c("div",Ks)):O("",!0),d("div",{ref_key:"scrollContainer",ref:z,class:"flex items-start gap-6 overflow-x-auto pb-4",onScroll:g},[(r(!0),c(ae,null,fe(Z.value,(A,we)=>(r(),c("div",{key:A.id,ref_for:!0,ref:ke=>Y(A.id,ke),class:"trace-item flex flex-col items-center flex-shrink-0 relative group",style:{"min-width":"120px"}},[we<Z.value.length-1?(r(),c("div",Gs)):O("",!0),d("div",Ys,[l(A)?(r(),c("button",{key:0,type:"button",class:"absolute top-0 left-1/2 -translate-x-1/2 z-20 flex items-center justify-center w-8 h-8 rounded-full bg-slate-700 text-slate-300 opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer hover:bg-slate-600 hover:text-white focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-offset-2 focus:ring-offset-slate-900",title:"Voir l'analyse",onClick:Ee(ke=>pe(A),["stop"])},[ye(ve(ot),{class:"w-4 h-4"})],8,Xs)):O("",!0),d("div",{class:ie(["w-12 h-12 rounded-full border-2 flex items-center justify-center text-white font-semibold text-sm shadow-lg hover:scale-110 transition-transform relative z-10",`bg-gradient-to-br ${te(A).from} ${te(A).to}`,te(A).border,q(A)?"ring-4 ring-amber-300 ring-offset-4 ring-offset-slate-900 shadow-[0_0_22px_rgba(251,191,36,0.95)]":ue(A)?"ring-2 ring-green-400 ring-offset-2 ring-offset-slate-900":_(A)?"ring-2 ring-yellow-400 ring-offset-2 ring-offset-slate-900":""]),title:A.content||C(A),onContextmenu:Ee(ke=>be(ke,A),["prevent","stop"])},[A.title?(r(),c("span",Zs,V(A.title.charAt(0).toUpperCase()),1)):A.content?(r(),c("span",en,V(A.content.charAt(0).toUpperCase()),1)):(r(),c("span",tn,"T"))],42,Qs)]),d("div",sn,[d("div",{class:"text-sm font-medium text-slate-300 truncate group-hover:whitespace-normal group-hover:break-words",title:A.content||C(A)},V(C(A)),9,nn),T(A)?(r(),c("div",{key:0,class:"text-xs text-slate-400 truncate mt-0.5 group-hover:whitespace-normal group-hover:break-words",title:T(A)??void 0},V(T(A)),9,rn)):O("",!0),d("div",an,V(re(A.interaction_date||A.created_at)),1)])]))),128)),t.value>0?(r(),c("div",{key:0,class:"flex-shrink-0",style:$e({width:`${t.value}px`})},null,4)):O("",!0)],544)])])])),(r(),he(Ze,{to:"body"},[i.value?(r(),c("div",{key:0,ref_key:"contextMenuRef",ref:P,class:"fixed z-[120] min-w-[170px] rounded-md border border-slate-700 bg-slate-900/95 shadow-xl backdrop-blur-sm p-1",style:$e({left:`${a.value.x}px`,top:`${a.value.y}px`})},[d("button",{type:"button",class:"w-full text-left rounded px-2 py-1.5 text-xs text-slate-200 hover:bg-slate-800 transition-colors",onClick:Ee(ge,["stop"])}," Launch new lens ",8,on)],4)):O("",!0)]))]))}});const un=Ie(cn,[["__scopeId","data-v-9fa1ce8f"]]),dn={class:"flex gap-2 overflow-x-auto pb-1 min-w-0"},fn=["onClick"],pn=["onClick"],hn={class:"text-xs font-medium"},vn={class:"text-[10px] text-slate-500 mt-0.5"},gn={key:0,class:"flex-shrink-0 px-3 py-2 rounded-lg border border-dashed border-slate-700 text-slate-500 text-xs"},yn={key:1,class:"flex-shrink-0 px-3 py-2 text-slate-500 text-xs"},mn=xe({__name:"LensSelectorBar",setup(U){const{lenses:m,currentLens:F,isLoadingLenses:w,loadUserLenses:k,selectLens:L,deleteLens:N}=Oe(),R=y(()=>[...m.value].sort((J,K)=>{const $=new Date(J.created_at||0).getTime();return new Date(K.created_at||0).getTime()-$})),I=J=>J?(typeof J=="string"?new Date(J):J).toLocaleDateString("fr-FR",{day:"numeric",month:"short"}):"";return Te(async()=>{await k()}),(J,K)=>(r(),c("div",dn,[(r(!0),c(ae,null,fe(R.value,$=>{var p;return r(),c("div",{key:$.id,onClick:D=>ve(L)($),class:ie(["relative flex-shrink-0 px-3 py-2 pr-7 rounded-lg border cursor-pointer transition-all duration-200",((p=ve(F))==null?void 0:p.id)===$.id?"border-blue-500 bg-blue-500/20 text-blue-300":"border-slate-700 bg-slate-900/60 hover:border-slate-500 text-slate-300"])},[d("button",{onClick:Ee(D=>ve(N)($.id),["stop"]),class:"absolute top-1.5 right-1.5 p-0.5 rounded hover:bg-red-500/20 text-slate-500 hover:text-red-400 transition-colors",title:"Supprimer cette lens"},[ye(ve(ut),{class:"w-3.5 h-3.5"})],8,pn),d("div",hn,V($.title||"Lens "+$.id.slice(0,8)),1),d("div",vn,V(I($.created_at)),1)],10,fn)}),128)),!ve(w)&&R.value.length===0?(r(),c("div",gn," Aucune lens ")):O("",!0),ve(w)?(r(),c("div",yn," Chargement... ")):O("",!0)]))}}),_n={class:"h-full overflow-y-auto border-l border-slate-800 bg-slate-950/95 backdrop-blur-sm p-4 shadow-2xl"},xn={class:"mb-5 flex items-center justify-between gap-3"},bn=d("h4",{class:"text-sm font-semibold uppercase tracking-wide text-slate-300"}," Atelier ",-1),wn={class:"mb-5"},kn=d("h5",{class:"mb-2 text-xs font-semibold uppercase tracking-wide text-slate-500"}," Lens ",-1),$n={class:"mb-5 rounded-xl border border-slate-800 bg-slate-900/70 p-3"},Tn=d("h5",{class:"mb-2 text-xs font-semibold uppercase tracking-wide text-slate-500"}," Analyse ",-1),Ln={class:"mb-3 flex items-center gap-2"},Sn=["disabled"],Cn=["disabled"],An={class:"flex flex-col gap-2 text-sm"},En=d("button",{type:"button",class:"text-left text-slate-300 hover:text-slate-100 transition-colors"}," Run next step ",-1),Dn=d("button",{type:"button",class:"text-left text-slate-300 hover:text-slate-100 transition-colors"}," Replay trace ",-1),Mn=d("button",{type:"button",class:"text-left text-slate-300 hover:text-slate-100 transition-colors"}," View steps ",-1),Rn=d("section",{class:"rounded-xl border border-slate-800 bg-slate-900/70 p-3"},[d("h5",{class:"mb-2 text-xs font-semibold uppercase tracking-wide text-slate-500"}," Debug "),d("button",{type:"button",class:"text-left text-sm text-slate-300 hover:text-slate-100 transition-colors"}," Errors / retries ")],-1),Fn=xe({__name:"AtelierDrawer",props:{canFocus:{type:Boolean,default:!0},canToday:{type:Boolean,default:!0}},emits:["close","focus","today"],setup(U){return(m,F)=>{const w=De("router-link");return r(),c("aside",_n,[d("div",xn,[bn,d("button",{type:"button",class:"text-sm text-slate-400 underline hover:text-slate-200 transition-colors",onClick:F[0]||(F[0]=k=>m.$emit("close"))}," Fermer ")]),d("section",wn,[kn,ye(mn)]),d("section",$n,[Tn,d("div",Ln,[d("button",{type:"button",class:"px-2 py-1 text-xs rounded border border-slate-700 text-slate-300 hover:bg-slate-800 disabled:opacity-40 disabled:cursor-not-allowed",disabled:!m.canFocus,onClick:F[1]||(F[1]=k=>m.$emit("focus"))}," Focus ",8,Sn),d("button",{type:"button",class:"px-2 py-1 text-xs rounded border border-slate-700 text-slate-300 hover:bg-slate-800 disabled:opacity-40 disabled:cursor-not-allowed",disabled:!m.canToday,onClick:F[2]||(F[2]=k=>m.$emit("today"))}," Aujourd'hui ",8,Cn)]),d("div",An,[En,Dn,Mn,ye(w,{to:"/app/llm-calls",class:"text-left text-slate-300 hover:text-slate-100 transition-colors"},{default:Le(()=>[Se(" LLM calls ")]),_:1})])]),Rn])}}}),jn={class:"mt-2"},In={class:"mb-4 flex items-center justify-end gap-2"},Pn=d("span",null,"Atelier",-1),On={key:0,"aria-hidden":"true"},Bn={class:"relative overflow-hidden"},Wn=d("h3",{class:"text-xl font-bold mb-4"},"Entités de l'analyse",-1),zn=d("h3",{class:"text-xl font-bold mt-8 mb-4"},"Landmarks actuels",-1),Vn=xe({__name:"LandscapeFocusView",props:{id:{}},setup(U){const m=U,F=S([]),w=S([]),k=S(!1),L=S(null),N=y(()=>{var $,p;return((p=($=L.value)==null?void 0:$.hasFocusTarget)==null?void 0:p.call($))??!1}),R=y(()=>{var $,p;return((p=($=L.value)==null?void 0:$.hasTodayTarget)==null?void 0:p.call($))??!1}),I=async()=>{var $,p;await((p=($=L.value)==null?void 0:$.scrollToFocus)==null?void 0:p.call($))},J=async()=>{var $,p;await((p=($=L.value)==null?void 0:$.scrollToToday)==null?void 0:p.call($))},K=async()=>{const $=typeof m.id=="string"?m.id.trim():"";if(!$){F.value=[],w.value=[];return}const[p,D]=await Promise.allSettled([G.get(`/analysis/${$}/landmarks?kind=context`),G.get(`/analysis/${$}/landmarks?kind=mentioned`)]);p.status==="fulfilled"?F.value=Array.isArray(p.value.data)?p.value.data:[]:(console.error("Error fetching context landmarks:",p.reason),F.value=[]),D.status==="fulfilled"?w.value=Array.isArray(D.value.data)?D.value.data:[]:(console.error("Error fetching current landmarks:",D.reason),w.value=[])};return Te(async()=>{await K()}),_e(()=>m.id,async()=>{await K()}),($,p)=>(r(),c("div",jn,[d("div",In,[d("button",{type:"button",class:"inline-flex items-center gap-2 px-3 py-1.5 rounded-lg border border-slate-700 bg-slate-900/60 text-slate-200 hover:bg-slate-800/70 transition-colors",onClick:p[0]||(p[0]=D=>k.value=!k.value)},[Pn,k.value?(r(),c("span",On,"✓")):O("",!0)]),k.value?(r(),c("button",{key:0,type:"button",class:"px-3 py-1.5 rounded-lg border border-slate-700 bg-slate-900/60 text-slate-300 hover:bg-slate-800/70 hover:text-slate-100 transition-colors",onClick:p[1]||(p[1]=D=>k.value=!1)}," Fermer ")):O("",!0)]),d("div",Bn,[d("div",{class:ie(["transition-[padding] duration-300",k.value?"lg:pr-[15rem]":""])},[k.value?(r(),he(un,{key:0,ref_key:"traceSectionRef",ref:L,class:"mb-8"},null,512)):O("",!0),Wn,ye(Be,{landmarks:F.value,"empty-text":"Aucune entité"},null,8,["landmarks"]),zn,ye(Be,{landmarks:w.value,"empty-text":"Aucun landmark actuel"},null,8,["landmarks"])],2),ye(et,{"enter-active-class":"transition-transform duration-300 ease-out","enter-from-class":"translate-x-full","enter-to-class":"translate-x-0","leave-active-class":"transition-transform duration-200 ease-in","leave-from-class":"translate-x-0","leave-to-class":"translate-x-full"},{default:Le(()=>[k.value?(r(),he(Fn,{key:0,class:"fixed inset-y-0 right-0 z-40 w-full max-w-[15rem] lg:absolute","can-focus":N.value,"can-today":R.value,onFocus:I,onToday:J,onClose:p[2]||(p[2]=D=>k.value=!1)},null,8,["can-focus","can-today"])):O("",!0)]),_:1})])]))}}),Un={class:"mt-2"},Nn={class:"mb-4 ml-auto flex flex-col gap-2 w-full xl:w-1/4"},Jn=d("label",{for:"context-landmark-select",class:"text-sm text-slate-300"}," Landmark ",-1),qn=["disabled"],Hn={value:""},Kn=["value"],Gn={class:"rounded-2xl border border-slate-800 bg-slate-900/60 p-4"},Yn=8,We=44,Xn=xe({__name:"StatisticsFocusView",props:{id:{}},setup(U){const m=U,{user:F}=Ve(),w=S([]),k=S({}),L=S(!1),N=S(!1),R=S([]),I=S(""),J=_=>{if(!_)return null;const E=new Date(String(_));return Number.isNaN(E.getTime())?null:new Date(Date.UTC(E.getUTCFullYear(),E.getUTCMonth(),E.getUTCDate()))},K=_=>{const E=_.getUTCFullYear(),z=String(_.getUTCMonth()+1).padStart(2,"0"),f=String(_.getUTCDate()).padStart(2,"0");return`${E}-${z}-${f}`},$=y(()=>{const _=new Date,E=new Date(Date.UTC(_.getUTCFullYear(),_.getUTCMonth(),_.getUTCDate()));return{start:new Date(Date.UTC(E.getUTCFullYear(),E.getUTCMonth()-(Yn-1),1)),end:E}}),p=_=>{const E=(_||"Sans titre").replace(/\s+/g," ").trim();return E.length<=We?E:`${E.slice(0,We-3)}...`},D=y(()=>{var E;const _={};for(const z of w.value){const f=((E=k.value[z.id])==null?void 0:E.related_elements)??[];_[z.id]=f.length}return _}),H=y(()=>[...w.value].sort((_,E)=>{const z=D.value[_.id]??0,f=D.value[E.id]??0;return f!==z?f-z:(_.title||"").localeCompare(E.title||"","fr",{sensitivity:"base"})})),le=y(()=>I.value?k.value[I.value]??null:null),Z=y(()=>{var x;const _=new Map,E=((x=le.value)==null?void 0:x.related_elements)??[],{start:z,end:f}=$.value;for(const j of E){const t=j.interaction_date??j.created_at,i=J(t);if(!i||i<z||i>f)continue;const u=K(i);_.set(u,(_.get(u)??0)+1)}return Array.from(_.entries()).map(([j,t])=>({day:j,value:t}))}),C=y(()=>I.value?Z.value:R.value),T=y(()=>I.value?L.value:N.value),q=y(()=>I.value?$.value.start:null),X=y(()=>I.value?$.value.end:null),ee=y(()=>I.value?"Aucun élément daté pour ce landmark":"Aucune donnée"),te=_=>Array.isArray(_)?_:_&&typeof _=="object"&&Array.isArray(_.data)?_.data:[],ce=async()=>{L.value=!0;try{const[_,E,z]=await Promise.allSettled([G.get(`/analysis/${m.id}/landmarks`),G.get(`/analysis/${m.id}/landmarks?kind=context`),G.get(`/analysis/${m.id}/landmarks?kind=current`)]),f=_.status==="fulfilled"?te(_.value.data):[],x=E.status==="fulfilled"?te(E.value.data):[],j=z.status==="fulfilled"?te(z.value.data):[],t=new Map;for(const u of[...f,...x,...j])u!=null&&u.id&&t.set(u.id,u);w.value=Array.from(t.values());const i=await Promise.all(w.value.map(async u=>{try{const a=await G.get(`/landmarks/${u.id}`);return[u.id,a.data]}catch(a){return console.error(`Error loading landmark detail ${u.id}:`,a),[u.id,{id:u.id,related_elements:[]}]}}));k.value=Object.fromEntries(i)}catch(_){console.error("Error fetching context landmarks:",_),w.value=[],k.value={}}finally{L.value=!1}},ue=async _=>{if(_){N.value=!0;try{const E=await G.get(`/users/${_}/heatmaps`);R.value=Array.isArray(E.data)?E.data:[]}catch(E){console.error("Error fetching user heatmaps:",E),R.value=[]}finally{N.value=!1}}};return _e(()=>H.value.map(_=>_.id).join(","),()=>{if(!I.value)return;H.value.some(E=>E.id===I.value)||(I.value="")},{immediate:!0}),_e(()=>m.id,async()=>{I.value="",await ce()}),_e(()=>{var _;return(_=F.value)==null?void 0:_.id},async _=>{if(!_){R.value=[],N.value=!1;return}await ue(_)},{immediate:!0}),Te(async()=>{await ce()}),(_,E)=>(r(),c("div",Un,[d("div",Nn,[Jn,tt(d("select",{id:"context-landmark-select","onUpdate:modelValue":E[0]||(E[0]=z=>I.value=z),class:"w-full rounded-lg border border-slate-700 bg-slate-900/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-600",disabled:L.value},[d("option",Hn,V(L.value?"Chargement...":"Heatmap globale"),1),(r(!0),c(ae,null,fe(H.value,z=>(r(),c("option",{key:z.id,value:z.id},V(p(z.title))+" ("+V(D.value[z.id]??0)+") ",9,Kn))),128))],8,qn),[[st,I.value]])]),d("div",Gn,[ye(dt,{days:C.value,"range-start":q.value,"range-end":X.value,loading:T.value,title:"Activité","empty-text":ee.value,"month-locale":"fr-FR"},null,8,["days","range-start","range-end","loading","empty-text"])])]))}}),Qn={class:"min-h-screen text-slate-100 p-2 md:p-10 md:w-11/12 mx-auto"},Zn={key:0,class:"mb-6"},er={class:"flex justify-between items-start mb-1 gap-3"},tr={class:"text-lg font-bold"},sr={class:"flex items-center gap-4 text-sm"},nr=d("span",null,"Précédent",-1),rr=d("span",null,"Suivant",-1),ar={class:"mb-6"},or={class:"inline-flex rounded-lg border border-slate-700 bg-slate-900/60 p-0.5"},lr=["onClick"],ir={key:3,class:"text-sm text-slate-400"},yr=xe({__name:"AnalysisPage",setup(U){const m=nt(),F=rt(),{headLandscapeAnalysis:w,headLandscapeAnalysisParents:k,loadUserLenses:L}=Oe(),{headerValue:N}=at(),R=S(null),I=S(null),J=S(null),K=y(()=>{var t;const f=(t=w.value)==null?void 0:t.id,x=(k.value??[]).map(i=>i.id);return(f?[f,...x]:[...x]).filter(Boolean)}),$=f=>{const x=Array.isArray(f)?f[0]:f;if(typeof x!="string")return null;const j=x.trim();return j.length>0?j:null},p=y(()=>$(m.query.id)),D=y(()=>{const f=p.value;if(!f)return-1;const x=K.value.indexOf(f);return x>=0?x:-1}),H=y(()=>{const f=D.value;return f<0?null:K.value[f+1]??null}),le=y(()=>{const f=D.value;return f<0?null:f>0?K.value[f-1]:null}),Z=[{id:"current",label:"Focus Trace"},{id:"mirror",label:"Focus Mirror"},{id:"summary",label:"Analyse"},{id:"compare",label:"Paysage global"},{id:"timeline",label:"Statistiques"}],C=S("current"),T=new Set(Z.map(f=>f.id)),q=Z[0].id,X=f=>({name:"analysis",query:{id:f,tab:C.value}}),ee=y(()=>H.value?X(H.value):null),te=y(()=>le.value?X(le.value):null),ce=async f=>{var x,j,t;if(!f){R.value=null,I.value=null,J.value=null;return}try{const i=await G.get(`/analysis/${f}`);R.value=((x=i.data)==null?void 0:x.analysis)??i.data??null;const u=await G.get(`/trace_mirrors/${(j=R.value)==null?void 0:j.trace_mirror_id}`);I.value=u.data??null;const a=await G.get(`/traces/${(t=R.value)==null?void 0:t.analyzed_trace_id}`);J.value=a.data??null}catch(i){console.error("Error fetching analysis:",i),R.value=null}},ue=y(()=>{var j,t;const f=((j=R.value)==null?void 0:j.replayed_from_id)??((t=R.value)==null?void 0:t.replayedFromId);if(f==null)return null;const x=String(f).trim();return x.length>0?x:null}),_=y(()=>ue.value?X(ue.value):null),E=async f=>{if(!T.has(f))return;C.value=f;const x={tab:f};p.value&&(x.id=p.value),await F.replace({name:"analysis",query:x})},z=f=>f?(f instanceof Date?f:new Date(f)).toLocaleDateString("fr-FR",{weekday:"long",day:"numeric",month:"long",year:"numeric"}):"";return _e(p,async f=>{var x,j;await Promise.all([L(),ce(f)]),(x=R.value)!=null&&x.id&&((j=R.value)!=null&&j.title)?N.value={text:R.value.title,link:`/me/analysis?id=${R.value.id}`}:N.value={text:"Analyse",link:"/me/analysis"}},{immediate:!0}),_e(()=>[m.name,m.query.tab,m.query.view],([f,x,j])=>{if(f!=="analysis")return;const t=$(x),i=$(j),u=!!(t&&T.has(t)),a=t??i;if(a&&T.has(a)){if(C.value=a,!t&&i){const P={tab:C.value};p.value&&(P.id=p.value),F.replace({name:"analysis",query:P})}return}if(C.value=q,!u){const P={tab:q};p.value&&(P.id=p.value),F.replace({name:"analysis",query:P})}},{immediate:!0}),Pe(()=>{N.value=null}),(f,x)=>{var t,i,u;const j=De("router-link");return r(),c("div",Qn,[R.value?(r(),c("div",Zn,[d("div",er,[d("div",tr,V(z(((t=J.value)==null?void 0:t.interaction_date)??((i=J.value)==null?void 0:i.created_at)))+" - "+V(((u=I.value)==null?void 0:u.title)??R.value.title),1),_.value?(r(),he(j,{key:0,to:_.value,class:"flex items-center gap-2 px-3 py-1.5 rounded-lg border border-slate-600 bg-slate-800/60 text-slate-300 hover:bg-slate-700/60 hover:text-white transition-colors text-sm"},{default:Le(()=>[Se(" Analyse source ")]),_:1},8,["to"])):O("",!0)]),d("div",sr,[ee.value?(r(),he(j,{key:0,to:ee.value,class:"inline-flex items-center gap-1 text-slate-400 hover:text-slate-200 underline transition-colors"},{default:Le(()=>[ye(ve(Ne),{class:"w-4 h-4"}),nr]),_:1},8,["to"])):O("",!0),te.value?(r(),he(j,{key:1,to:te.value,class:"inline-flex items-center gap-1 text-slate-400 hover:text-slate-200 underline transition-colors"},{default:Le(()=>[rr,ye(ve(Je),{class:"w-4 h-4"})]),_:1},8,["to"])):O("",!0)])])):O("",!0),d("div",ar,[d("div",or,[(r(),c(ae,null,fe(Z,a=>d("button",{key:a.id,type:"button",class:ie(["px-3 py-1.5 text-xs rounded-md transition-colors",C.value===a.id?"bg-slate-700 text-slate-100":"text-slate-400 hover:text-slate-200"]),onClick:P=>E(a.id)},V(a.label),11,lr)),64))])]),C.value==="compare"?(r(),he(Vn,{key:1,id:p.value??""},null,8,["id"])):p.value?(r(),c(ae,{key:2},[C.value==="current"?(r(),he(Ut,{key:0,id:p.value},null,8,["id"])):O("",!0),C.value==="mirror"?(r(),he(ds,{key:1,id:p.value},null,8,["id"])):O("",!0),C.value==="summary"?(r(),he($s,{key:2,id:p.value},null,8,["id"])):O("",!0),C.value==="timeline"?(r(),he(Xn,{key:3,id:p.value},null,8,["id"])):O("",!0)],64)):(r(),c("div",ir," Aucune analyse sélectionnée. "))])}}});export{yr as default};
