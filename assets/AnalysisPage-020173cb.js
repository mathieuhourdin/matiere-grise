import{d as ge,r as w,j as y,y as he,o as $e,c,l as o,F as re,t as q,k as W,p as ke,g as fe,b as a,q as xe,e as ue,m as le,h as de,S as De,U as Fe,O as z,M as Re,B as Be,f as Ie,Q as We,u as Ue,Z as Ce,$ as Ye,a0 as Se,P as Ge,a as ze,w as Le,T as Xe,J as Qe,a1 as Ze,i as et,x as tt,n as nt}from"./index-4b296900.js";import{_ as st,a as Pe}from"./LandmarksDisplayGrid.vue_vue_type_script_setup_true_lang-251adc1c.js";import{r as rt}from"./ChevronDownIcon-a0ca7dee.js";import{_ as at}from"./LlmCallCard.vue_vue_type_script_setup_true_lang-679204c6.js";import{r as ot}from"./ClipboardIcon-13c9def3.js";import{u as lt}from"./useJournal-4b1fd9eb.js";import{u as je}from"./useLens-1cb87d25.js";import{r as Ve,a as Ne,b as it,c as ct}from"./XMarkIcon-6c4cd98e.js";import{_ as ut}from"./HeatmapDisplay.vue_vue_type_script_setup_true_lang-2cb167f3.js";const Je=P=>(De("data-v-6bab4e9a"),P=P(),Fe(),P),dt={key:0,class:"text-center text-2xl pt-10"},ft={key:1},ht={class:"mt-8 grid grid-cols-1 xl:grid-cols-2 gap-6"},vt={class:"xl:col-span-1"},pt=Je(()=>o("h3",{class:"text-xl font-bold mb-4"},"Trace brute",-1)),yt={class:"journal-canvas min-h-[420px]"},gt={class:"traces-scroll h-full overflow-y-auto pr-2"},_t={class:"paper-content"},mt={key:0,class:"text-xs text-slate-500 mb-2"},xt={class:"trace-entry text-[17px] text-slate-700 whitespace-pre-line leading-[2]"},bt={key:0,class:"font-georgia whitespace-pre-wrap"},wt={key:1,class:"text-sm text-slate-500"},kt={class:"xl:col-span-1 space-y-8 font-inter"},$t=Je(()=>o("h3",{class:"text-xl font-bold mb-4"},"Elements détectés",-1)),Tt={class:"space-y-3"},Lt=["onClick"],Ct={class:"text-xs uppercase tracking-wide text-slate-300 font-semibold"},At={class:"inline-flex items-center gap-2"},St={class:"text-xs text-slate-400"},Et={key:0,class:"mt-2 pl-1"},Mt={key:0,class:"grid grid-cols-1 gap-3"},Dt={key:1,class:"text-xs text-slate-500"},Ft=ge({__name:"TraceFocusView",props:{id:{}},setup(P){const T=P,D=w(null),E=w(null),_=w([]),$=w(null),O=w({}),L=w({}),M=[{accent:"#f97316",highlight:"rgba(249, 115, 22, 0.32)"},{accent:"#22c55e",highlight:"rgba(34, 197, 94, 0.30)"},{accent:"#0ea5e9",highlight:"rgba(14, 165, 233, 0.30)"},{accent:"#a855f7",highlight:"rgba(168, 85, 247, 0.30)"},{accent:"#eab308",highlight:"rgba(234, 179, 8, 0.30)"},{accent:"#ef4444",highlight:"rgba(239, 68, 68, 0.28)"},{accent:"#14b8a6",highlight:"rgba(20, 184, 166, 0.30)"},{accent:"#f43f5e",highlight:"rgba(244, 63, 94, 0.28)"}],U=async()=>{var e;try{const n=await z.get(`/analysis/${T.id}`);D.value=((e=n.data)==null?void 0:e.analysis)??n.data??null}catch(n){console.error("Error fetching analysis:",n),D.value=null}},V=async e=>{try{const n=await z.get(`/trace_mirrors/${e}`);E.value=n.data}catch(n){console.error("Error fetching trace:",n),E.value=null}},p=async()=>{try{const e=await z.get(`/analysis/${T.id}/elements`);_.value=Array.isArray(e.data)?e.data:[]}catch(e){console.error("Error fetching analysis elements:",e),_.value=[]}},v=e=>{var i;const n=(e==null?void 0:e.content)??((i=e==null?void 0:e.resource)==null?void 0:i.content);if(typeof n!="string")return null;let r=n.trim();if(!r)return null;for(let b=0;b<3&&typeof r=="string";b++){const h=r.trim();if(!h||!(h.startsWith("{")||h.startsWith("[")||h.startsWith('"')))return null;try{r=JSON.parse(h)}catch{return null}}return r&&typeof r=="object"&&!Array.isArray(r)?r:null},N=e=>{const n=String(e??"").trim().toLowerCase();return n?n==="transaction"||n.startsWith("transaction")?"transactions":n==="descriptive"||n.startsWith("descriptive")?"descriptives":n==="evaluative"||n.startsWith("evaluative")?"evaluatives":n==="normative"||n.startsWith("normative")?"normatives":null:null},te=e=>{const n=String(e??"").trim().toLowerCase();return n?["input","output","transformation","question"].includes(n)?"transactions":["unit","theme"].includes(n)?"descriptives":["emotion","energy","quality","interest"].includes(n)?"evaluatives":["plan","obligation","recommendation","principle"].includes(n)?"normatives":null:null},ae=e=>{var b,h,A,S;const n=v(e),r=[e==null?void 0:e.element_type,e==null?void 0:e.elementType,(b=e==null?void 0:e.resource)==null?void 0:b.element_type,(h=e==null?void 0:e.resource)==null?void 0:h.elementType,n==null?void 0:n.element_type,n==null?void 0:n.elementType,n==null?void 0:n.type];for(const se of r){const X=N(se);if(X)return X}const i=[e==null?void 0:e.element_subtype,e==null?void 0:e.elementSubtype,(A=e==null?void 0:e.resource)==null?void 0:A.element_subtype,(S=e==null?void 0:e.resource)==null?void 0:S.elementSubtype,n==null?void 0:n.element_subtype,n==null?void 0:n.elementSubtype,n==null?void 0:n.subtype,n==null?void 0:n.kind];for(const se of i){const X=te(se);if(X)return X}return null},G=y(()=>_.value.filter(e=>ae(e)==="transactions")),x=y(()=>_.value.filter(e=>ae(e)==="descriptives")),R=y(()=>_.value.filter(e=>ae(e)==="evaluatives")),J=y(()=>_.value.filter(e=>ae(e)==="normatives")),K=y(()=>[{key:"transactions",title:"Transactions",items:G.value},{key:"descriptives",title:"Descriptives",items:x.value},{key:"evaluatives",title:"Evaluatives",items:R.value},{key:"normatives",title:"Normatives",items:J.value}]),Q=y(()=>{if(!$.value)return[];const e=K.value.find(n=>n.key===$.value);return(e==null?void 0:e.items)??[]}),Z=e=>{$.value=$.value===e?null:e},oe=y(()=>{const e=E.value;return(e==null?void 0:e.interaction_date)??(e==null?void 0:e.interactionDate)??(e==null?void 0:e.created_at)??(e==null?void 0:e.createdAt)??void 0}),ie=y(()=>{const e=E.value;return String((e==null?void 0:e.content)||(e==null?void 0:e.title)||"Trace sans contenu")}),f=y(()=>{const e=ie.value,n=e.indexOf(`
`);return n<0?{first:e,rest:"",restOffset:e.length}:{first:e.slice(0,n),rest:e.slice(n+1),restOffset:n+1}}),k=y(()=>f.value.first.length>200),F=e=>{if(typeof e=="string")return e;if(e==null||typeof e!="object")return"";const n=[e.extraction,e.text,e.value,e.content,e.title];for(const r of n)if(typeof r=="string")return r;return""},l=e=>{if(!e)return null;let n=e.trim();if(!n)return null;for(let r=0;r<3;r++){if(typeof n!="string")return n;const i=n.trim();if(!i)return null;if(!(i.startsWith("{")||i.startsWith("[")||i.startsWith('"')))return r===0?null:n;try{n=JSON.parse(i)}catch{return r===0?null:n}}return n},g=e=>{if(typeof e=="string")return[e];if(Array.isArray(e))return e.flatMap(i=>g(i)).map(i=>i.trim()).filter(i=>i.length>0);if(e==null||typeof e!="object")return[];const n=[e.text,e.value,e.content,e.extraction,e.title],r=[];for(const i of n)typeof i=="string"&&i.trim().length>0?r.push(i.trim()):Array.isArray(i)&&r.push(...g(i));return r},C=(e,n)=>{if(e!=null){if(Array.isArray(e)){for(const r of e)C(r,n);return}if(typeof e=="object"){"spans"in e?n.push(...g(e.spans)):"span"in e&&n.push(...g(e.span));for(const r of Object.values(e))r==null||typeof r!="object"||C(r,n)}}},I=e=>{const n=l(e);if(n==null)return[];const r=[];C(n,r);const i=new Set,b=[];for(const h of r){const A=h.trim();if(A.length<2)continue;const S=A.toLowerCase();i.has(S)||(i.add(S),b.push(A))}return b},j=e=>{if(!e)return[];const n=e.match(/Extractions\s*:\s*(\[[\s\S]*?\])/i);if(!n||!n[1])return[];const r=n[1].trim();if(!r.startsWith("[")||!r.endsWith("]"))return[];try{const A=JSON.parse(r);if(Array.isArray(A))return A.map(S=>typeof S=="string"?S.trim():"").filter(S=>S.length>0)}catch{}const i=[],b=/"((?:\\.|[^"\\])*)"/g;let h=null;for(;(h=b.exec(r))!==null;){const A=h[1].replace(/\\"/g,'"').trim();A.length>0&&i.push(A)}return i},B=e=>{var se,X;const n=new Set,r=[],i=String((e==null?void 0:e.content)??((se=e==null?void 0:e.resource)==null?void 0:se.content)??""),b=I(i);for(const ee of b){const Y=ee.toLowerCase();n.has(Y)||(n.add(Y),r.push(ee))}if(r.length>0)return r;const h=j(i);for(const ee of h){const Y=ee.toLowerCase();n.has(Y)||(n.add(Y),r.push(ee))}if(r.length>0)return r;const A=(e==null?void 0:e.extractions)??((X=e==null?void 0:e.resource)==null?void 0:X.extractions)??[],S=Array.isArray(A)?A:[A];for(const ee of S){const Y=F(ee).trim();if(Y.length<2)continue;const s=Y.toLowerCase();n.has(s)||(n.add(s),r.push(Y))}return r},H=y(()=>{const e={};return Q.value.forEach((n,r)=>{const i=pe(n);i&&(e[i]=M[r%M.length])}),e}),ne=(e,n=0)=>{const r=pe(e);return r&&H.value[r]?H.value[r]:M[n%M.length]},be=y(()=>{const e=ie.value;if(!e)return[];const n=e.toLowerCase(),r=[],i=new Set;Q.value.forEach((h,A)=>{const S=B(h);if(S.length===0)return;const se=ne(h,A).highlight;for(const X of S){const ee=X.toLowerCase();let Y=0;for(;Y<n.length;){const s=n.indexOf(ee,Y);if(s===-1)break;const u=s+ee.length,m=`${s}-${u}-${se}`;i.has(m)||(r.push({start:s,end:u,color:se,length:ee.length}),i.add(m)),Y=u}}}),r.sort((h,A)=>h.start!==A.start?h.start-A.start:A.length-h.length);const b=[];for(const h of r)b.some(S=>!(h.end<=S.start||h.start>=S.end))||b.push({start:h.start,end:h.end,color:h.color});return b.sort((h,A)=>h.start-A.start)}),we=(e,n)=>{if(!e)return[];const r=n,i=n+e.length,b=be.value.filter(S=>S.end>r&&S.start<i).map(S=>({start:Math.max(S.start,r)-r,end:Math.min(S.end,i)-r,color:S.color})).sort((S,se)=>S.start-se.start);if(b.length===0)return[{text:e,color:null}];const h=[];let A=0;for(const S of b)S.start>A&&h.push({text:e.slice(A,S.start),color:null}),h.push({text:e.slice(S.start,S.end),color:S.color}),A=S.end;return A<e.length&&h.push({text:e.slice(A),color:null}),h},ce=y(()=>we(f.value.first,0)),_e=y(()=>we(f.value.rest,f.value.restOffset)),Te=e=>e?(e instanceof Date?e:new Date(e)).toLocaleDateString("fr-FR",{day:"numeric",month:"long",year:"numeric"}):"",pe=e=>{const n=e==null?void 0:e.id;if(n==null)return null;const r=String(n).trim();return r.length>0?r:null},me=async e=>{if(e&&O.value[e]==null&&!L.value[e]){L.value[e]=!0;try{const n=await z.get(`/elements/${e}/landmarks`);O.value[e]=Array.isArray(n.data)?n.data:[]}catch(n){console.error(`Error fetching landmarks for element ${e}:`,n),O.value[e]=[]}finally{L.value[e]=!1}}};he(()=>Q.value.map(e=>pe(e)).filter(Boolean).join(","),async()=>{const e=Q.value.map(n=>pe(n)).filter(n=>!!n);await Promise.all(e.map(n=>me(n)))},{immediate:!0});const t=e=>{if(!e)return null;const n=e.trace_mirror_id??e.traceMirrorId;if(n==null)return null;const r=String(n).trim();return r.length>0?r:null},d=async()=>{$.value=null,O.value={},L.value={},_.value=[],E.value=null,await U();const e=D.value;if(e){const n=t(e);n&&await V(n)}await p()};return $e(async()=>{await d()}),he(()=>T.id,async()=>{await d()}),(e,n)=>D.value?(a(),c("div",ft,[o("div",ht,[o("section",vt,[pt,o("div",yt,[o("div",gt,[o("div",_t,[E.value?(a(),c(re,{key:0},[oe.value?(a(),c("div",mt,q(Te(oe.value)),1)):W("",!0),o("article",xt,[o("div",{class:ke(["mb-2 text-slate-800 whitespace-pre-wrap",k.value?"font-georgia text-lg leading-relaxed":"font-handwritten text-4xl leading-tight"])},[(a(!0),c(re,null,fe(ce.value,(r,i)=>(a(),c("span",{key:`first-${i}`,style:xe(r.color?{backgroundColor:r.color}:void 0),class:"rounded-[3px] px-[1px]"},q(r.text),5))),128))],2),f.value.rest?(a(),c("div",bt,[(a(!0),c(re,null,fe(_e.value,(r,i)=>(a(),c("span",{key:`rest-${i}`,style:xe(r.color?{backgroundColor:r.color}:void 0),class:"rounded-[3px] px-[1px]"},q(r.text),5))),128))])):W("",!0)])],64)):(a(),c("div",wt,"Aucune trace"))])])])]),o("section",kt,[o("div",null,[$t,o("div",Tt,[(a(!0),c(re,null,fe(K.value,r=>(a(),c("div",{key:r.key},[o("button",{type:"button",class:"w-full flex items-center justify-between rounded-lg border border-slate-700 bg-slate-900/50 px-3 py-2 hover:bg-slate-800/60 transition-colors",onClick:i=>Z(r.key)},[o("span",Ct,q(r.title),1),o("span",At,[o("span",St,q(r.items.length),1),ue(le(rt),{class:ke(["w-4 h-4 text-slate-400 transition-transform",$.value===r.key?"rotate-180":""])},null,8,["class"])])],8,Lt),$.value===r.key?(a(),c("div",Et,[r.items.length>0?(a(),c("div",Mt,[(a(!0),c(re,null,fe(r.items,(i,b)=>(a(),de(st,{key:i.id??`${r.key}-${b}`,element:i,"accent-color":ne(i,b).accent,"associated-landmarks":O.value[pe(i)||""]??[]},null,8,["element","accent-color","associated-landmarks"]))),128))])):(a(),c("div",Dt,"Aucun élément"))])):W("",!0)]))),128))])])])])])):(a(),c("div",dt,"Loading..."))}});const Rt=Re(Ft,[["__scopeId","data-v-6bab4e9a"]]),qe=P=>(De("data-v-90b8813c"),P=P(),Fe(),P),It={key:0,class:"text-center text-2xl pt-10"},jt={key:1},Pt={class:"mt-8 grid grid-cols-1 xl:grid-cols-2 gap-6"},Ot={class:"xl:col-span-1"},Bt=qe(()=>o("h3",{class:"text-xl font-bold mb-4"},"Trace miroir",-1)),Wt={class:"journal-canvas min-h-[420px]"},Ut={class:"traces-scroll h-full overflow-y-auto pr-2"},zt={class:"paper-content"},Vt={key:0,class:"text-xs text-slate-500 mb-2"},Nt={class:"trace-entry text-[17px] text-slate-700 whitespace-pre-line leading-[2]"},Jt={key:0,class:"font-georgia whitespace-pre-wrap"},qt={key:1,class:"text-sm text-slate-500"},Ht={class:"xl:col-span-1 space-y-8 font-inter"},Kt=qe(()=>o("h3",{class:"text-xl font-bold mb-4"},"Références détectées",-1)),Yt={key:0,class:"text-sm text-slate-500"},Gt={key:1,class:"grid grid-cols-1 gap-3"},Xt={class:"text-sm font-semibold text-slate-200 line-clamp-2 flex items-start gap-2"},Qt={key:0,class:"mt-1 text-xs text-slate-400"},Zt={key:1,class:"mt-2 text-xs text-slate-300 whitespace-pre-wrap"},en={key:2,class:"text-sm text-slate-500"},tn=ge({__name:"TraceMirrorFocusView",props:{id:{}},setup(P){const T=P,D=w(null),E=w(null),_=w([]),$=w([]),O=w({}),L=w({}),M=w({}),U=w(!1),V=w(!1),p=w(typeof window<"u"?window.innerWidth:1280),v=[{accent:"#f97316",highlight:"rgba(249, 115, 22, 0.32)"},{accent:"#22c55e",highlight:"rgba(34, 197, 94, 0.30)"},{accent:"#0ea5e9",highlight:"rgba(14, 165, 233, 0.30)"},{accent:"#a855f7",highlight:"rgba(168, 85, 247, 0.30)"},{accent:"#eab308",highlight:"rgba(234, 179, 8, 0.30)"},{accent:"#ef4444",highlight:"rgba(239, 68, 68, 0.28)"},{accent:"#14b8a6",highlight:"rgba(20, 184, 166, 0.30)"},{accent:"#f43f5e",highlight:"rgba(244, 63, 94, 0.28)"}],N=t=>{const d=(t==null?void 0:t.trace_mirror_id)??(t==null?void 0:t.traceMirrorId);if(d==null)return null;const e=String(d).trim();return e.length>0?e:null},te=async()=>{var t;try{const d=await z.get(`/analysis/${T.id}`);D.value=((t=d.data)==null?void 0:t.analysis)??d.data??null}catch(d){console.error("Error fetching analysis:",d),D.value=null}},ae=async t=>{try{const d=await z.get(`/trace_mirrors/${t}`);E.value=d.data??null}catch(d){console.error("Error fetching trace mirror:",d),E.value=null}},G=async t=>{U.value=!0;try{const d=await z.get(`/trace_mirrors/${t}/references`);_.value=Array.isArray(d.data)?d.data:[];const e=Array.from(new Set(_.value.map(n=>F(n)).filter(n=>!!n)));await Promise.all(e.map(n=>l(n))),$.value=_.value.map(n=>{const r=F(n),i=r?L.value[r]??null:null;return{...n,landmark:i}})}catch(d){console.error("Error fetching trace mirror references:",d),_.value=[],$.value=[]}finally{U.value=!1}},x=async()=>{V.value=!1,_.value=[],$.value=[],E.value=null,await te();const t=N(D.value);t&&await Promise.all([ae(t),G(t)])},R=y(()=>{const t=E.value;return(t==null?void 0:t.interaction_date)??(t==null?void 0:t.interactionDate)??(t==null?void 0:t.created_at)??(t==null?void 0:t.createdAt)??void 0}),J=y(()=>{const t=E.value;return String((t==null?void 0:t.content)||(t==null?void 0:t.title)||"Trace miroir sans contenu")}),K=y(()=>{const t=J.value,d=t.indexOf(`
`);return d<0?{first:t,rest:"",restOffset:t.length}:{first:t.slice(0,d),rest:t.slice(d+1),restOffset:d+1}}),Q=y(()=>K.value.first.length>200),Z=y(()=>p.value>=1280?3:p.value>=768?2:1),oe=y(()=>V.value?$.value:$.value.slice(0,Z.value)),ie=y(()=>!V.value&&$.value.length>Z.value),f=t=>{var n;const d=(t==null?void 0:t.id)??((n=t==null?void 0:t.resource)==null?void 0:n.id);if(d==null)return null;const e=String(d).trim();return e.length>0?e:null},k=t=>{const d=(t==null?void 0:t.tag_id)??(t==null?void 0:t.tagId);if(d==null)return null;const e=String(d).trim();return e.length>0?e:null},F=t=>{const d=(t==null?void 0:t.landmark_id)??(t==null?void 0:t.landmarkId);if(d==null)return null;const e=String(d).trim();return e.length>0?e:null},l=async t=>{if(t&&O.value[t]==null&&!M.value[t]){M.value[t]=!0;try{const e=(await z.get(`/landmarks/${t}`)).data??null;L.value[t]=e,O.value[t]=e!=null&&e.title?String(e.title):"Landmark"}catch(d){console.error(`Error fetching landmark ${t}:`,d),L.value[t]=null,O.value[t]="Landmark"}finally{M.value[t]=!1}}},g=t=>{var d;return(t==null?void 0:t.mention)??(t==null?void 0:t.title)??((d=t==null?void 0:t.resource)==null?void 0:d.title)??""},C=t=>{const d=String((t==null?void 0:t.mention)??"").trim(),e=k(t);return!d||!e?"":`${d}[id:${e}]`},I=t=>{var e;if((e=t==null?void 0:t.landmark)!=null&&e.title)return String(t.landmark.title);const d=F(t);return d?O.value[d]?O.value[d]:M.value[d]?"Chargement...":"":""},j=t=>{if(t==null)return"";if(Array.isArray(t))return t.map(e=>j(e)).filter(e=>e.length>0).join(", ");if(typeof t=="object")try{return JSON.stringify(t)}catch{return""}return String(t).trim()},B=t=>{const d=j((t==null?void 0:t.tag_id)??(t==null?void 0:t.tagId)),e=j((t==null?void 0:t.reference_variants)??(t==null?void 0:t.referenceVariants)),n=j((t==null?void 0:t.reference_type)??(t==null?void 0:t.referenceType)),r=j((t==null?void 0:t.context_tag)??(t==null?void 0:t.contextTag)),i=j((t==null?void 0:t.landmark_id)??(t==null?void 0:t.landmarkId)),b=[];return d&&b.push(`tag_id: ${d}`),e&&b.push(`reference_variants: ${e}`),n&&b.push(`reference_type: ${n}`),r&&b.push(`context_tag: ${r}`),i&&b.push(`landmark_id: ${i}`),b},H=t=>{const d=f(t);if(d)return d;const e=String((t==null?void 0:t.mention)??"").trim(),n=k(t);return!e||!n?null:`${e}::${n}`},ne=y(()=>{const t={};return $.value.forEach((d,e)=>{const n=H(d)??`__index_${e}`;t[n]||(t[n]=v[e%v.length])}),t}),be=(t,d=0)=>{const e=H(t);if(e&&ne.value[e])return ne.value[e];const n=$.value.findIndex(r=>r===t);if(n>=0){const r=`__index_${n}`;return ne.value[r]?ne.value[r]:v[n%v.length]}return v[d%v.length]},we=y(()=>{const t=J.value;if(!t)return[];const d=[],e=new Set,n=t.toLowerCase();$.value.forEach((i,b)=>{const h=C(i);if(!h)return;const A=be(i,b).highlight;let S=0,se=!1;for(;S<t.length;){const X=t.indexOf(h,S);if(X===-1)break;se=!0;const ee=X+h.length,Y=`${X}-${ee}-${A}`;e.has(Y)||(d.push({start:X,end:ee,color:A,length:h.length}),e.add(Y)),S=ee}if(!se){const X=h.toLowerCase();let ee=0;for(;ee<n.length;){const Y=n.indexOf(X,ee);if(Y===-1)break;const s=Y+X.length,u=`${Y}-${s}-${A}`;e.has(u)||(d.push({start:Y,end:s,color:A,length:X.length}),e.add(u)),ee=s}}}),d.sort((i,b)=>i.start!==b.start?i.start-b.start:b.length-i.length);const r=[];for(const i of d)r.some(h=>!(i.end<=h.start||i.start>=h.end))||r.push({start:i.start,end:i.end,color:i.color});return r.sort((i,b)=>i.start-b.start)}),ce=(t,d)=>{if(!t)return[];const e=d,n=d+t.length,r=we.value.filter(h=>h.end>e&&h.start<n).map(h=>({start:Math.max(h.start,e)-e,end:Math.min(h.end,n)-e,color:h.color})).sort((h,A)=>h.start-A.start);if(r.length===0)return[{text:t,color:null}];const i=[];let b=0;for(const h of r)h.start>b&&i.push({text:t.slice(b,h.start),color:null}),i.push({text:t.slice(h.start,h.end),color:h.color}),b=h.end;return b<t.length&&i.push({text:t.slice(b),color:null}),i},_e=y(()=>ce(K.value.first,0)),Te=y(()=>ce(K.value.rest,K.value.restOffset)),pe=t=>t?(t instanceof Date?t:new Date(t)).toLocaleDateString("fr-FR",{day:"numeric",month:"long",year:"numeric"}):"",me=()=>{typeof window>"u"||(p.value=window.innerWidth)};return $e(async()=>{me(),window.addEventListener("resize",me),await x()}),Be(()=>{window.removeEventListener("resize",me)}),he(()=>T.id,async()=>{await x()}),(t,d)=>D.value?(a(),c("div",jt,[o("div",Pt,[o("section",Ot,[Bt,o("div",Wt,[o("div",Ut,[o("div",zt,[E.value?(a(),c(re,{key:0},[R.value?(a(),c("div",Vt,q(pe(R.value)),1)):W("",!0),o("article",Nt,[o("div",{class:ke(["mb-2 text-slate-800 whitespace-pre-wrap",Q.value?"font-georgia text-lg leading-relaxed":"font-handwritten text-4xl leading-tight"])},[(a(!0),c(re,null,fe(_e.value,(e,n)=>(a(),c("span",{key:`first-${n}`,style:xe(e.color?{backgroundColor:e.color}:void 0),class:"rounded-[3px] px-[1px]"},q(e.text),5))),128))],2),K.value.rest?(a(),c("div",Jt,[(a(!0),c(re,null,fe(Te.value,(e,n)=>(a(),c("span",{key:`rest-${n}`,style:xe(e.color?{backgroundColor:e.color}:void 0),class:"rounded-[3px] px-[1px]"},q(e.text),5))),128))])):W("",!0)])],64)):(a(),c("div",qt,"Aucune trace miroir"))])])])]),o("section",Ht,[o("div",null,[Kt,U.value?(a(),c("div",Yt,"Chargement...")):oe.value.length>0?(a(),c("div",Gt,[(a(!0),c(re,null,fe(oe.value,(e,n)=>(a(),c("div",{key:f(e)??n,class:"h-full p-3 rounded-lg border border-slate-700 bg-slate-800/40",style:xe({borderColor:be(e,n).accent})},[o("div",Xt,[o("span",{class:"w-2 h-2 rounded-full mt-1.5 flex-none",style:xe({backgroundColor:be(e,n).accent})},null,4),Ie(" "+q(g(e)||"Sans titre"),1)]),I(e)?(a(),c("div",Qt,q(I(e)),1)):W("",!0),B(e).length?(a(),c("div",Zt,[(a(!0),c(re,null,fe(B(e),(r,i)=>(a(),c("div",{key:`${f(e)??n}-detail-${i}`},q(r),1))),128))])):W("",!0)],4))),128))])):(a(),c("div",en,"Aucune référence")),ie.value?(a(),c("button",{key:3,type:"button",class:"mt-3 text-sm underline text-slate-400 hover:text-slate-200 transition-colors",onClick:d[0]||(d[0]=e=>V.value=!0)}," voir plus ")):W("",!0)])])])])):(a(),c("div",It,"Loading..."))}});const nn=Re(tn,[["__scopeId","data-v-90b8813c"]]),sn={class:"mt-8"},rn={class:"mb-2 flex items-center justify-between gap-2"},an=o("h3",{class:"text-xl font-bold"},"Contexte d'extraction grammaticale",-1),on=["disabled"],ln={class:"rounded-lg border border-slate-700 bg-slate-900/40 p-3 h-52 overflow-y-auto"},cn={key:0,class:"text-sm text-slate-500"},un={key:1,class:"text-xs leading-5 text-slate-200 whitespace-pre-wrap break-words"},dn={key:2,class:"text-sm text-slate-500"},fn={class:"mt-8"},hn=o("h3",{class:"text-xl font-bold mb-4"},"Fonctionnement de l'analyse",-1),vn={class:"space-y-4"},pn={key:0,class:"text-sm text-slate-500"},yn=ge({__name:"AnalysisFocusView",props:{id:{}},setup(P){const T=P,{launchSnackbar:D}=We(),E=w([]),_=w(null),$=w(null),O=w([]),L=w([]),M=w(!1),U=x=>{const R=(x==null?void 0:x.trace_mirror_id)??(x==null?void 0:x.traceMirrorId);if(R==null)return null;const J=String(R).trim();return J.length>0?J:null},V=x=>{const R=x==null?void 0:x.id;if(R==null)return null;const J=String(R).trim();return J.length>0?J:null},p=async x=>{L.value=[];try{const R=await z.get(`/analysis/${x}/parents`),K=(Array.isArray(R.data)?R.data:[])[0]??null,Q=V(K);if(!Q)return;const Z=await z.get(`/analysis/${Q}/landmarks`);L.value=Array.isArray(Z.data)?Z.data:[]}catch(R){console.error("Error loading previous landscape landmarks:",R),L.value=[]}},v=async()=>{var x;M.value=!0,_.value=null,$.value=null,O.value=[],L.value=[];try{const R=await z.get(`/analysis/${T.id}`);_.value=((x=R.data)==null?void 0:x.analysis)??R.data??null;const J=V(_.value)??T.id,K=p(J),Q=U(_.value);if(!Q){await K;return}const[Z,oe]=await Promise.all([z.get(`/trace_mirrors/${Q}`),z.get(`/trace_mirrors/${Q}/references`)]);$.value=Z.data??null;const ie=Array.isArray(oe.data)?oe.data:[],f=Array.from(new Set(ie.map(l=>(l==null?void 0:l.landmark_id)??(l==null?void 0:l.landmarkId)).filter(l=>l!=null&&String(l).trim().length>0).map(l=>String(l).trim()))),F=(await Promise.all(f.map(async l=>{try{const g=await z.get(`/landmarks/${l}`);return[l,g.data??null]}catch(g){return console.error(`Error fetching landmark ${l}:`,g),[l,null]}}))).reduce((l,[g,C])=>(l[g]=C,l),{});O.value=ie.map(l=>{const g=(l==null?void 0:l.landmark_id)??(l==null?void 0:l.landmarkId),C=g!=null?String(g).trim():"";return{...l,landmark:C?F[C]??null:null}}),await K}catch(R){console.error("Error loading grammatical extraction context:",R),_.value=null,$.value=null,O.value=[],L.value=[]}finally{M.value=!1}},N=y(()=>{var x,R;return $.value?{tagged_text:((x=$.value)==null?void 0:x.content)??((R=$.value)==null?void 0:R.title)??"",references:O.value,previous_landscape_landmarks:L.value}:null}),te=y(()=>N.value?JSON.stringify(N.value,null,2):""),ae=async()=>{if(te.value)try{await navigator.clipboard.writeText(te.value),D("Contexte copié dans le presse-papiers","success")}catch(x){console.error("Failed to copy grammatical extraction context:",x),D("Échec de la copie","error")}},G=async()=>{try{const x=await z.get(`/analysis/${T.id}/llm_calls`);E.value=Array.isArray(x.data)?x.data:[]}catch(x){console.error("Error fetching analysis llm_calls:",x),E.value=[]}};return $e(async()=>{await Promise.all([G(),v()])}),he(()=>T.id,async()=>{await Promise.all([G(),v()])}),(x,R)=>(a(),c("div",null,[o("div",sn,[o("div",rn,[an,o("button",{type:"button",class:"inline-flex items-center justify-center w-8 h-8 rounded border border-slate-700 bg-slate-900/60 text-slate-300 hover:text-slate-100 hover:bg-slate-800/70 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",disabled:!te.value,title:"Copier le JSON",onClick:ae},[ue(le(ot),{class:"w-4 h-4"})],8,on)]),o("div",ln,[M.value?(a(),c("div",cn," Chargement... ")):te.value?(a(),c("pre",un,q(te.value),1)):(a(),c("div",dn," Aucun contexte disponible "))])]),o("div",fn,[hn,o("div",vn,[(a(!0),c(re,null,fe(E.value,J=>(a(),de(at,{key:J.id,"llm-call":J},null,8,["llm-call"]))),128))]),E.value.length===0?(a(),c("div",pn," Aucun appel LLM ")):W("",!0)])]))}}),{launchSnackbar:gn}=We(),{user:Ae}=Ue(),Ee=w([]),Me=w(!1);async function _n(P){try{return(await z.get(`/traces/${P}`)).data}catch(T){return console.error(`Error fetching trace ${P}:`,T),null}}async function mn(){var P;if(console.log("[useTrace] loadUserTraces called, user:",Ae.value),!((P=Ae.value)!=null&&P.id)){console.warn("[useTrace] User not found, skipping loadUserTraces");return}Me.value=!0;try{console.log("[useTrace] Fetching traces for user:",Ae.value.id);const D=(await z.get(`/users/${Ae.value.id}/traces`)).data;console.log("[useTrace] Traces list loaded:",D);const E=await Promise.all(D.map(async _=>_.id&&await _n(_.id)||_));Ee.value=E.filter(_=>_!==null),console.log("[useTrace] Full traces loaded:",Ee.value)}catch(T){console.error("Error loading traces:",T),gn(`Error loading traces: ${T}`,"error")}finally{Me.value=!1}}function xn(){return{traces:Ee,isLoadingTraces:Me,loadUserTraces:mn}}const bn=P=>(De("data-v-9fa1ce8f"),P=P(),Fe(),P),wn={key:0,class:"text-slate-500 text-sm"},kn={key:1,class:"text-slate-500 text-sm"},$n={key:2,class:"relative"},Tn={class:"relative"},Ln={class:"mt-2 flex items-center justify-between px-1"},Cn={key:1,class:"h-5 w-5"},An=bn(()=>o("div",{class:"flex-1"},null,-1)),Sn={key:3,class:"h-5 w-5"},En={class:"relative"},Mn={key:0,class:"pointer-events-none absolute left-0 top-0 bottom-0 z-20 w-12 bg-gradient-to-r from-white/95 to-transparent dark:from-gray-900/90"},Dn={key:1,class:"pointer-events-none absolute right-0 top-0 bottom-0 z-20 w-12 bg-gradient-to-l from-white/95 to-transparent dark:from-gray-900/90"},Fn={key:0,class:"absolute top-12 left-12 h-0.5 bg-slate-700 z-0",style:{width:"calc(100% + 1.5rem)"}},Rn={class:"relative pt-6 flex flex-col items-center"},In=["onClick"],jn=["title","onContextmenu"],Pn={key:0},On={key:1},Bn={key:2},Wn={class:"mt-2 text-center max-w-[120px] group-hover:max-w-none transition-all duration-300"},Un=["title"],zn=["title"],Vn={class:"text-xs text-slate-500 mt-1"},Nn=["onClick"],Jn=120,qn=ge({__name:"TracesSection",setup(P,{expose:T}){const{traces:D,isLoadingTraces:E,loadUserTraces:_}=xn(),{userJournals:$,loadUserJournal:O}=lt(),{currentLens:L,displayLandscapeAnalysis:M,headLandscapeAnalysis:U,headLandscapeAnalysisParents:V,updateDisplayLandscapeAnalysis:p,updateLensCurrentTrace:v,updateLensProcessingState:N,createLens:te,loadUserLenses:ae}=je(),G=y(()=>[...D.value].sort((s,u)=>{const m=new Date(s.interaction_date||s.created_at||0).getTime(),ve=new Date(u.interaction_date||u.created_at||0).getTime();return m-ve})),x=s=>{if(s.title)return s.title;if(s.content){const u=s.content.split(`
`)[0].trim();return u.length>30?u.substring(0,30)+"...":u}return"Trace "+s.id.slice(0,8)},R=s=>{var m;if(!s.journal_id)return null;const u=$.value.find(ve=>ve.resource_id===s.journal_id);return((m=u==null?void 0:u.resource)==null?void 0:m.title)||null},J=s=>{var u;return((u=M.value)==null?void 0:u.analyzed_trace_id)===s.id},K=[{from:"from-blue-500",to:"to-cyan-600",border:"border-blue-400"},{from:"from-purple-500",to:"to-pink-600",border:"border-purple-400"},{from:"from-indigo-500",to:"to-blue-600",border:"border-indigo-400"},{from:"from-rose-500",to:"to-red-600",border:"border-rose-400"},{from:"from-amber-500",to:"to-orange-600",border:"border-amber-400"},{from:"from-emerald-500",to:"to-teal-600",border:"border-emerald-400"},{from:"from-violet-500",to:"to-purple-600",border:"border-violet-400"},{from:"from-sky-500",to:"to-blue-600",border:"border-sky-400"},{from:"from-fuchsia-500",to:"to-pink-600",border:"border-fuchsia-400"},{from:"from-lime-500",to:"to-green-600",border:"border-lime-400"}],Q=s=>{let u=0;for(let m=0;m<s.length;m++){const ve=s.charCodeAt(m);u=(u<<5)-u+ve,u=u&u}return Math.abs(u)},Z=s=>{if(J(s))return{from:"from-green-500",to:"to-emerald-600",border:"border-green-400"};if(!s.journal_id)return{from:"from-blue-500",to:"to-purple-600",border:"border-slate-800"};const m=Q(s.journal_id)%K.length;return K[m]},oe=s=>{var u,m;return((u=M.value)==null?void 0:u.analyzed_trace_id)===s.id?M.value:((m=U.value)==null?void 0:m.analyzed_trace_id)===s.id?U.value:V.value.find(ve=>ve.analyzed_trace_id===s.id)??null},ie=s=>{var u;return((u=oe(s))==null?void 0:u.processing_state)==="fnsh"},f=s=>V.value.find(u=>u.analyzed_trace_id===s.id),k=s=>{const u=s.interaction_date??s.created_at;return u?new Date(u).getTime():0},F=w(null),l=w({}),g=w(!1),C=w(!1),I=w(0),j=w(!1),B=w(null),H=w({x:0,y:0}),ne=w(null),be=(s,u)=>{l.value[s]=u},we=()=>{const s=F.value;if(!s){I.value=0;return}I.value=Math.max(0,Math.round(s.clientWidth/2-Jn/2))},ce=()=>{const s=F.value;if(!s){g.value=!1,C.value=!1,I.value=0;return}if(we(),!(s.scrollWidth-s.clientWidth>1)){g.value=!1,C.value=!1;return}g.value=s.scrollLeft>1,C.value=s.scrollLeft+s.clientWidth<s.scrollWidth-1},_e=()=>{j.value=!1,B.value=null},Te=(s,u)=>{s.preventDefault(),s.stopPropagation();const m=170,ve=40,ye=8,He=window.innerWidth-m-ye,Ke=window.innerHeight-ve-ye;H.value={x:Math.max(ye,Math.min(s.clientX,He)),y:Math.max(ye,Math.min(s.clientY,Ke))},B.value=u,j.value=!0},pe=async()=>{const s=B.value;_e(),s!=null&&s.id&&await te(s.id)},me=s=>{if(!j.value)return;const u=s.target;ne.value&&u&&ne.value.contains(u)||_e()},t=s=>{s.key==="Escape"&&_e()},d=()=>{ce(),j.value&&_e()},e=y(()=>{var u;const s=(u=M.value)==null?void 0:u.analyzed_trace_id;return s?G.value.find(m=>m.id===s)??null:null}),n=y(()=>G.value.length===0?null:G.value[G.value.length-1]??null),r=s=>{const u=e.value;return u?k(s)>=k(u):!0},i=async s=>{if(!s)return;await Ce();const u=l.value[s];u&&(u.scrollIntoView({behavior:"smooth",inline:"center",block:"nearest"}),requestAnimationFrame(ce))},b=async()=>{var s;await i((s=e.value)==null?void 0:s.id)},h=async()=>{var s;await i((s=e.value)==null?void 0:s.id)},A=async()=>{await Ce();const s=F.value;s&&(we(),s.scrollTo({left:s.scrollWidth,behavior:"smooth"}),requestAnimationFrame(ce))},S=s=>{const u=F.value;if(!u)return;const m=Math.max(220,Math.round(u.clientWidth*.7));u.scrollBy({left:m*s,behavior:"smooth"}),requestAnimationFrame(ce)},se=async s=>{if(J(s)){L.value&&await N("rply");return}L.value?await v(s.id):(await te(s.id),await ae());const u=f(s);u&&p(u.id)},X=s=>s?(typeof s=="string"?new Date(s):s).toLocaleDateString("fr-FR",{day:"numeric",month:"short"}):"";return $e(async()=>{await Promise.all([_(),O()]),await Ce(),ce(),await b(),window.addEventListener("resize",ce),window.addEventListener("pointerdown",me),window.addEventListener("keydown",t)}),Ye(()=>{window.removeEventListener("resize",ce),window.removeEventListener("pointerdown",me),window.removeEventListener("keydown",t)}),he(()=>G.value.map(s=>s.id).join(","),async()=>{await Ce(),ce()}),he(e,async(s,u)=>{s!=null&&s.id&&s.id!==(u==null?void 0:u.id)&&(await b(),ce())}),T({scrollToFocus:h,scrollToToday:A,hasFocusTarget:()=>!!e.value,hasTodayTarget:()=>!!n.value}),(s,u)=>(a(),c("div",null,[le(E)?(a(),c("div",wn," Chargement... ")):!le(E)&&G.value.length===0?(a(),c("div",kn," Aucune trace disponible ")):(a(),c("div",$n,[o("div",Tn,[o("div",Ln,[g.value?(a(),c("button",{key:0,type:"button",class:"h-5 w-5 flex items-center justify-center text-slate-500 hover:text-slate-300",title:"Défiler à gauche",onClick:u[0]||(u[0]=m=>S(-1))},[ue(le(Ve),{class:"w-5 h-5"})])):(a(),c("div",Cn)),An,C.value?(a(),c("button",{key:2,type:"button",class:"h-5 w-5 flex items-center justify-center text-slate-500 hover:text-slate-300",title:"Défiler à droite",onClick:u[1]||(u[1]=m=>S(1))},[ue(le(Ne),{class:"w-5 h-5"})])):(a(),c("div",Sn))]),o("div",En,[g.value?(a(),c("div",Mn)):W("",!0),C.value?(a(),c("div",Dn)):W("",!0),o("div",{ref_key:"scrollContainer",ref:F,class:"flex items-start gap-6 overflow-x-auto pb-4",onScroll:d},[(a(!0),c(re,null,fe(G.value,(m,ve)=>(a(),c("div",{key:m.id,ref_for:!0,ref:ye=>be(m.id,ye),class:"trace-item flex flex-col items-center flex-shrink-0 relative group",style:{"min-width":"120px"}},[ve<G.value.length-1?(a(),c("div",Fn)):W("",!0),o("div",Rn,[r(m)?(a(),c("button",{key:0,type:"button",class:"absolute top-0 left-1/2 -translate-x-1/2 z-20 flex items-center justify-center w-8 h-8 rounded-full bg-slate-700 text-slate-300 opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer hover:bg-slate-600 hover:text-white focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-offset-2 focus:ring-offset-slate-900",title:"Voir l'analyse",onClick:Se(ye=>se(m),["stop"])},[ue(le(it),{class:"w-4 h-4"})],8,In)):W("",!0),o("div",{class:ke(["w-12 h-12 rounded-full border-2 flex items-center justify-center text-white font-semibold text-sm shadow-lg hover:scale-110 transition-transform relative z-10",`bg-gradient-to-br ${Z(m).from} ${Z(m).to}`,Z(m).border,J(m)?"ring-4 ring-amber-300 ring-offset-4 ring-offset-slate-900 shadow-[0_0_22px_rgba(251,191,36,0.95)]":ie(m)?"ring-2 ring-green-400 ring-offset-2 ring-offset-slate-900":f(m)?"ring-2 ring-yellow-400 ring-offset-2 ring-offset-slate-900":""]),title:m.content||x(m),onContextmenu:Se(ye=>Te(ye,m),["prevent","stop"])},[m.title?(a(),c("span",Pn,q(m.title.charAt(0).toUpperCase()),1)):m.content?(a(),c("span",On,q(m.content.charAt(0).toUpperCase()),1)):(a(),c("span",Bn,"T"))],42,jn)]),o("div",Wn,[o("div",{class:"text-sm font-medium text-slate-300 truncate group-hover:whitespace-normal group-hover:break-words",title:m.content||x(m)},q(x(m)),9,Un),R(m)?(a(),c("div",{key:0,class:"text-xs text-slate-400 truncate mt-0.5 group-hover:whitespace-normal group-hover:break-words",title:R(m)??void 0},q(R(m)),9,zn)):W("",!0),o("div",Vn,q(X(m.interaction_date||m.created_at)),1)])]))),128)),I.value>0?(a(),c("div",{key:0,class:"flex-shrink-0",style:xe({width:`${I.value}px`})},null,4)):W("",!0)],544)])])])),(a(),de(Ge,{to:"body"},[j.value?(a(),c("div",{key:0,ref_key:"contextMenuRef",ref:ne,class:"fixed z-[120] min-w-[170px] rounded-md border border-slate-700 bg-slate-900/95 shadow-xl backdrop-blur-sm p-1",style:xe({left:`${H.value.x}px`,top:`${H.value.y}px`})},[o("button",{type:"button",class:"w-full text-left rounded px-2 py-1.5 text-xs text-slate-200 hover:bg-slate-800 transition-colors",onClick:Se(pe,["stop"])}," Launch new lens ",8,Nn)],4)):W("",!0)]))]))}});const Hn=Re(qn,[["__scopeId","data-v-9fa1ce8f"]]),Kn={class:"flex gap-2 overflow-x-auto pb-1 min-w-0"},Yn=["onClick"],Gn=["onClick"],Xn={class:"text-xs font-medium"},Qn={class:"text-[10px] text-slate-500 mt-0.5"},Zn={key:0,class:"flex-shrink-0 px-3 py-2 rounded-lg border border-dashed border-slate-700 text-slate-500 text-xs"},es={key:1,class:"flex-shrink-0 px-3 py-2 text-slate-500 text-xs"},ts=ge({__name:"LensSelectorBar",setup(P){const{lenses:T,currentLens:D,isLoadingLenses:E,loadUserLenses:_,selectLens:$,deleteLens:O}=je(),L=y(()=>[...T.value].sort((U,V)=>{const p=new Date(U.created_at||0).getTime();return new Date(V.created_at||0).getTime()-p})),M=U=>U?(typeof U=="string"?new Date(U):U).toLocaleDateString("fr-FR",{day:"numeric",month:"short"}):"";return $e(async()=>{await _()}),(U,V)=>(a(),c("div",Kn,[(a(!0),c(re,null,fe(L.value,p=>{var v;return a(),c("div",{key:p.id,onClick:N=>le($)(p),class:ke(["relative flex-shrink-0 px-3 py-2 pr-7 rounded-lg border cursor-pointer transition-all duration-200",((v=le(D))==null?void 0:v.id)===p.id?"border-blue-500 bg-blue-500/20 text-blue-300":"border-slate-700 bg-slate-900/60 hover:border-slate-500 text-slate-300"])},[o("button",{onClick:Se(N=>le(O)(p.id),["stop"]),class:"absolute top-1.5 right-1.5 p-0.5 rounded hover:bg-red-500/20 text-slate-500 hover:text-red-400 transition-colors",title:"Supprimer cette lens"},[ue(le(ct),{class:"w-3.5 h-3.5"})],8,Gn),o("div",Xn,q(p.title||"Lens "+p.id.slice(0,8)),1),o("div",Qn,q(M(p.created_at)),1)],10,Yn)}),128)),!le(E)&&L.value.length===0?(a(),c("div",Zn," Aucune lens ")):W("",!0),le(E)?(a(),c("div",es," Chargement... ")):W("",!0)]))}}),ns={class:"h-full overflow-y-auto border-l border-slate-800 bg-slate-950/95 backdrop-blur-sm p-4 shadow-2xl"},ss={class:"mb-5 flex items-center justify-between gap-3"},rs=o("h4",{class:"text-sm font-semibold uppercase tracking-wide text-slate-300"}," Atelier ",-1),as={class:"mb-5"},os=o("h5",{class:"mb-2 text-xs font-semibold uppercase tracking-wide text-slate-500"}," Lens ",-1),ls={class:"mb-5 rounded-xl border border-slate-800 bg-slate-900/70 p-3"},is=o("h5",{class:"mb-2 text-xs font-semibold uppercase tracking-wide text-slate-500"}," Analyse ",-1),cs={class:"mb-3 flex items-center gap-2"},us=["disabled"],ds=["disabled"],fs={class:"flex flex-col gap-2 text-sm"},hs=o("button",{type:"button",class:"text-left text-slate-300 hover:text-slate-100 transition-colors"}," Run next step ",-1),vs=o("button",{type:"button",class:"text-left text-slate-300 hover:text-slate-100 transition-colors"}," Replay trace ",-1),ps=o("button",{type:"button",class:"text-left text-slate-300 hover:text-slate-100 transition-colors"}," View steps ",-1),ys=o("section",{class:"rounded-xl border border-slate-800 bg-slate-900/70 p-3"},[o("h5",{class:"mb-2 text-xs font-semibold uppercase tracking-wide text-slate-500"}," Debug "),o("button",{type:"button",class:"text-left text-sm text-slate-300 hover:text-slate-100 transition-colors"}," Errors / retries ")],-1),gs=ge({__name:"AtelierDrawer",props:{canFocus:{type:Boolean,default:!0},canToday:{type:Boolean,default:!0}},emits:["close","focus","today"],setup(P){return(T,D)=>{const E=ze("router-link");return a(),c("aside",ns,[o("div",ss,[rs,o("button",{type:"button",class:"text-sm text-slate-400 underline hover:text-slate-200 transition-colors",onClick:D[0]||(D[0]=_=>T.$emit("close"))}," Fermer ")]),o("section",as,[os,ue(ts)]),o("section",ls,[is,o("div",cs,[o("button",{type:"button",class:"px-2 py-1 text-xs rounded border border-slate-700 text-slate-300 hover:bg-slate-800 disabled:opacity-40 disabled:cursor-not-allowed",disabled:!T.canFocus,onClick:D[1]||(D[1]=_=>T.$emit("focus"))}," Focus ",8,us),o("button",{type:"button",class:"px-2 py-1 text-xs rounded border border-slate-700 text-slate-300 hover:bg-slate-800 disabled:opacity-40 disabled:cursor-not-allowed",disabled:!T.canToday,onClick:D[2]||(D[2]=_=>T.$emit("today"))}," Aujourd'hui ",8,ds)]),o("div",fs,[hs,vs,ps,ue(E,{to:"/app/llm-calls",class:"text-left text-slate-300 hover:text-slate-100 transition-colors"},{default:Le(()=>[Ie(" LLM calls ")]),_:1})])]),ys])}}}),_s={class:"mt-2"},ms={class:"mb-4 flex items-center justify-end gap-2"},xs=o("span",null,"Atelier",-1),bs={key:0,"aria-hidden":"true"},ws={class:"relative overflow-hidden"},ks=o("h3",{class:"text-xl font-bold mb-4"},"Entités de l'analyse",-1),$s=o("h3",{class:"text-xl font-bold mt-8 mb-4"},"Landmarks actuels",-1),Ts=ge({__name:"LandscapeFocusView",props:{id:{}},setup(P){const T=P,D=w([]),E=w([]),_=w(!1),$=w(null),O=y(()=>{var p,v;return((v=(p=$.value)==null?void 0:p.hasFocusTarget)==null?void 0:v.call(p))??!1}),L=y(()=>{var p,v;return((v=(p=$.value)==null?void 0:p.hasTodayTarget)==null?void 0:v.call(p))??!1}),M=async()=>{var p,v;await((v=(p=$.value)==null?void 0:p.scrollToFocus)==null?void 0:v.call(p))},U=async()=>{var p,v;await((v=(p=$.value)==null?void 0:p.scrollToToday)==null?void 0:v.call(p))},V=async()=>{const p=typeof T.id=="string"?T.id.trim():"";if(!p){D.value=[],E.value=[];return}const[v,N]=await Promise.allSettled([z.get(`/analysis/${p}/landmarks?kind=context`),z.get(`/analysis/${p}/landmarks?kind=mentioned`)]);v.status==="fulfilled"?D.value=Array.isArray(v.value.data)?v.value.data:[]:(console.error("Error fetching context landmarks:",v.reason),D.value=[]),N.status==="fulfilled"?E.value=Array.isArray(N.value.data)?N.value.data:[]:(console.error("Error fetching current landmarks:",N.reason),E.value=[])};return $e(async()=>{await V()}),he(()=>T.id,async()=>{await V()}),(p,v)=>(a(),c("div",_s,[o("div",ms,[o("button",{type:"button",class:"inline-flex items-center gap-2 px-3 py-1.5 rounded-lg border border-slate-700 bg-slate-900/60 text-slate-200 hover:bg-slate-800/70 transition-colors",onClick:v[0]||(v[0]=N=>_.value=!_.value)},[xs,_.value?(a(),c("span",bs,"✓")):W("",!0)]),_.value?(a(),c("button",{key:0,type:"button",class:"px-3 py-1.5 rounded-lg border border-slate-700 bg-slate-900/60 text-slate-300 hover:bg-slate-800/70 hover:text-slate-100 transition-colors",onClick:v[1]||(v[1]=N=>_.value=!1)}," Fermer ")):W("",!0)]),o("div",ws,[o("div",{class:ke(["transition-[padding] duration-300",_.value?"lg:pr-[15rem]":""])},[_.value?(a(),de(Hn,{key:0,ref_key:"traceSectionRef",ref:$,class:"mb-8"},null,512)):W("",!0),ks,ue(Pe,{landmarks:D.value,"empty-text":"Aucune entité"},null,8,["landmarks"]),$s,ue(Pe,{landmarks:E.value,"empty-text":"Aucun landmark actuel"},null,8,["landmarks"])],2),ue(Xe,{"enter-active-class":"transition-transform duration-300 ease-out","enter-from-class":"translate-x-full","enter-to-class":"translate-x-0","leave-active-class":"transition-transform duration-200 ease-in","leave-from-class":"translate-x-0","leave-to-class":"translate-x-full"},{default:Le(()=>[_.value?(a(),de(gs,{key:0,class:"fixed inset-y-0 right-0 z-40 w-full max-w-[15rem] lg:absolute","can-focus":O.value,"can-today":L.value,onFocus:M,onToday:U,onClose:v[2]||(v[2]=N=>_.value=!1)},null,8,["can-focus","can-today"])):W("",!0)]),_:1})])]))}}),Ls={class:"mt-2"},Cs={class:"mb-4 ml-auto flex flex-col gap-2 w-full xl:w-1/4"},As=o("label",{for:"context-landmark-select",class:"text-sm text-slate-300"}," Landmark ",-1),Ss=["disabled"],Es={value:""},Ms=["value"],Ds={class:"rounded-2xl border border-slate-800 bg-slate-900/60 p-4"},Fs=8,Oe=44,Rs=ge({__name:"StatisticsFocusView",props:{id:{}},setup(P){const T=P,{user:D}=Ue(),E=w([]),_=w({}),$=w(!1),O=w(!1),L=w([]),M=w(""),U=f=>{if(!f)return null;const k=new Date(String(f));return Number.isNaN(k.getTime())?null:new Date(Date.UTC(k.getUTCFullYear(),k.getUTCMonth(),k.getUTCDate()))},V=f=>{const k=f.getUTCFullYear(),F=String(f.getUTCMonth()+1).padStart(2,"0"),l=String(f.getUTCDate()).padStart(2,"0");return`${k}-${F}-${l}`},p=y(()=>{const f=new Date,k=new Date(Date.UTC(f.getUTCFullYear(),f.getUTCMonth(),f.getUTCDate()));return{start:new Date(Date.UTC(k.getUTCFullYear(),k.getUTCMonth()-(Fs-1),1)),end:k}}),v=f=>{const k=(f||"Sans titre").replace(/\s+/g," ").trim();return k.length<=Oe?k:`${k.slice(0,Oe-3)}...`},N=y(()=>{var k;const f={};for(const F of E.value){const l=((k=_.value[F.id])==null?void 0:k.related_elements)??[];f[F.id]=l.length}return f}),te=y(()=>[...E.value].sort((f,k)=>{const F=N.value[f.id]??0,l=N.value[k.id]??0;return l!==F?l-F:(f.title||"").localeCompare(k.title||"","fr",{sensitivity:"base"})})),ae=y(()=>M.value?_.value[M.value]??null:null),G=y(()=>{var g;const f=new Map,k=((g=ae.value)==null?void 0:g.related_elements)??[],{start:F,end:l}=p.value;for(const C of k){const I=C.interaction_date??C.created_at,j=U(I);if(!j||j<F||j>l)continue;const B=V(j);f.set(B,(f.get(B)??0)+1)}return Array.from(f.entries()).map(([C,I])=>({day:C,value:I}))}),x=y(()=>M.value?G.value:L.value),R=y(()=>M.value?$.value:O.value),J=y(()=>M.value?p.value.start:null),K=y(()=>M.value?p.value.end:null),Q=y(()=>M.value?"Aucun élément daté pour ce landmark":"Aucune donnée"),Z=f=>Array.isArray(f)?f:f&&typeof f=="object"&&Array.isArray(f.data)?f.data:[],oe=async()=>{$.value=!0;try{const[f,k,F]=await Promise.allSettled([z.get(`/analysis/${T.id}/landmarks`),z.get(`/analysis/${T.id}/landmarks?kind=context`),z.get(`/analysis/${T.id}/landmarks?kind=current`)]),l=f.status==="fulfilled"?Z(f.value.data):[],g=k.status==="fulfilled"?Z(k.value.data):[],C=F.status==="fulfilled"?Z(F.value.data):[],I=new Map;for(const B of[...l,...g,...C])B!=null&&B.id&&I.set(B.id,B);E.value=Array.from(I.values());const j=await Promise.all(E.value.map(async B=>{try{const H=await z.get(`/landmarks/${B.id}`);return[B.id,H.data]}catch(H){return console.error(`Error loading landmark detail ${B.id}:`,H),[B.id,{id:B.id,related_elements:[]}]}}));_.value=Object.fromEntries(j)}catch(f){console.error("Error fetching context landmarks:",f),E.value=[],_.value={}}finally{$.value=!1}},ie=async f=>{if(f){O.value=!0;try{const k=await z.get(`/users/${f}/heatmaps`);L.value=Array.isArray(k.data)?k.data:[]}catch(k){console.error("Error fetching user heatmaps:",k),L.value=[]}finally{O.value=!1}}};return he(()=>te.value.map(f=>f.id).join(","),()=>{if(!M.value)return;te.value.some(k=>k.id===M.value)||(M.value="")},{immediate:!0}),he(()=>T.id,async()=>{M.value="",await oe()}),he(()=>{var f;return(f=D.value)==null?void 0:f.id},async f=>{if(!f){L.value=[],O.value=!1;return}await ie(f)},{immediate:!0}),$e(async()=>{await oe()}),(f,k)=>(a(),c("div",Ls,[o("div",Cs,[As,Qe(o("select",{id:"context-landmark-select","onUpdate:modelValue":k[0]||(k[0]=F=>M.value=F),class:"w-full rounded-lg border border-slate-700 bg-slate-900/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-600",disabled:$.value},[o("option",Es,q($.value?"Chargement...":"Heatmap globale"),1),(a(!0),c(re,null,fe(te.value,F=>(a(),c("option",{key:F.id,value:F.id},q(v(F.title))+" ("+q(N.value[F.id]??0)+") ",9,Ms))),128))],8,Ss),[[Ze,M.value]])]),o("div",Ds,[ue(ut,{days:x.value,"range-start":J.value,"range-end":K.value,loading:R.value,title:"Activité","empty-text":Q.value,"month-locale":"fr-FR"},null,8,["days","range-start","range-end","loading","empty-text"])])]))}}),Is={class:"min-h-screen text-slate-100 p-2 md:p-10 md:w-11/12 mx-auto"},js={key:0,class:"mb-6"},Ps={class:"flex justify-between items-start mb-1 gap-3"},Os={class:"text-lg font-bold"},Bs={class:"flex items-center gap-4 text-sm"},Ws=o("span",null,"Précédent",-1),Us=o("span",null,"Suivant",-1),zs={class:"mb-6"},Vs={class:"inline-flex rounded-lg border border-slate-700 bg-slate-900/60 p-0.5"},Ns=["onClick"],Js={key:3,class:"text-sm text-slate-400"},tr=ge({__name:"AnalysisPage",setup(P){const T=et(),D=tt(),{headLandscapeAnalysis:E,headLandscapeAnalysisParents:_,loadUserLenses:$}=je(),{headerValue:O}=nt(),L=w(null),M=w(null),U=w(null),V=y(()=>{var I;const l=(I=E.value)==null?void 0:I.id,g=(_.value??[]).map(j=>j.id);return(l?[l,...g]:[...g]).filter(Boolean)}),p=l=>{const g=Array.isArray(l)?l[0]:l;if(typeof g!="string")return null;const C=g.trim();return C.length>0?C:null},v=y(()=>p(T.query.id)),N=y(()=>{const l=v.value;if(!l)return-1;const g=V.value.indexOf(l);return g>=0?g:-1}),te=y(()=>{const l=N.value;return l<0?null:V.value[l+1]??null}),ae=y(()=>{const l=N.value;return l<0?null:l>0?V.value[l-1]:null}),G=[{id:"current",label:"Focus Trace"},{id:"mirror",label:"Focus Mirror"},{id:"summary",label:"Analyse"},{id:"compare",label:"Paysage global"},{id:"timeline",label:"Statistiques"}],x=w("current"),R=new Set(G.map(l=>l.id)),J=G[0].id,K=l=>({name:"analysis",query:{id:l,tab:x.value}}),Q=y(()=>te.value?K(te.value):null),Z=y(()=>ae.value?K(ae.value):null),oe=async l=>{var g,C,I;if(!l){L.value=null,M.value=null,U.value=null;return}try{const j=await z.get(`/analysis/${l}`);L.value=((g=j.data)==null?void 0:g.analysis)??j.data??null;const B=await z.get(`/trace_mirrors/${(C=L.value)==null?void 0:C.trace_mirror_id}`);M.value=B.data??null;const H=await z.get(`/traces/${(I=L.value)==null?void 0:I.analyzed_trace_id}`);U.value=H.data??null}catch(j){console.error("Error fetching analysis:",j),L.value=null}},ie=y(()=>{var C,I;const l=((C=L.value)==null?void 0:C.replayed_from_id)??((I=L.value)==null?void 0:I.replayedFromId);if(l==null)return null;const g=String(l).trim();return g.length>0?g:null}),f=y(()=>ie.value?K(ie.value):null),k=async l=>{if(!R.has(l))return;x.value=l;const g={tab:l};v.value&&(g.id=v.value),await D.replace({name:"analysis",query:g})},F=l=>l?(l instanceof Date?l:new Date(l)).toLocaleDateString("fr-FR",{weekday:"long",day:"numeric",month:"long",year:"numeric"}):"";return he(v,async l=>{var g,C;await Promise.all([$(),oe(l)]),(g=L.value)!=null&&g.id&&((C=L.value)!=null&&C.title)?O.value={text:L.value.title,link:`/me/analysis?id=${L.value.id}`}:O.value={text:"Analyse",link:"/me/analysis"}},{immediate:!0}),he(()=>[T.name,T.query.tab,T.query.view],([l,g,C])=>{if(l!=="analysis")return;const I=p(g),j=p(C),B=!!(I&&R.has(I)),H=I??j;if(H&&R.has(H)){if(x.value=H,!I&&j){const ne={tab:x.value};v.value&&(ne.id=v.value),D.replace({name:"analysis",query:ne})}return}if(x.value=J,!B){const ne={tab:J};v.value&&(ne.id=v.value),D.replace({name:"analysis",query:ne})}},{immediate:!0}),Be(()=>{O.value=null}),(l,g)=>{var I,j,B;const C=ze("router-link");return a(),c("div",Is,[L.value?(a(),c("div",js,[o("div",Ps,[o("div",Os,q(F(((I=U.value)==null?void 0:I.interaction_date)??((j=U.value)==null?void 0:j.created_at)))+" - "+q(((B=M.value)==null?void 0:B.title)??L.value.title),1),f.value?(a(),de(C,{key:0,to:f.value,class:"flex items-center gap-2 px-3 py-1.5 rounded-lg border border-slate-600 bg-slate-800/60 text-slate-300 hover:bg-slate-700/60 hover:text-white transition-colors text-sm"},{default:Le(()=>[Ie(" Analyse source ")]),_:1},8,["to"])):W("",!0)]),o("div",Bs,[Q.value?(a(),de(C,{key:0,to:Q.value,class:"inline-flex items-center gap-1 text-slate-400 hover:text-slate-200 underline transition-colors"},{default:Le(()=>[ue(le(Ve),{class:"w-4 h-4"}),Ws]),_:1},8,["to"])):W("",!0),Z.value?(a(),de(C,{key:1,to:Z.value,class:"inline-flex items-center gap-1 text-slate-400 hover:text-slate-200 underline transition-colors"},{default:Le(()=>[Us,ue(le(Ne),{class:"w-4 h-4"})]),_:1},8,["to"])):W("",!0)])])):W("",!0),o("div",zs,[o("div",Vs,[(a(),c(re,null,fe(G,H=>o("button",{key:H.id,type:"button",class:ke(["px-3 py-1.5 text-xs rounded-md transition-colors",x.value===H.id?"bg-slate-700 text-slate-100":"text-slate-400 hover:text-slate-200"]),onClick:ne=>k(H.id)},q(H.label),11,Ns)),64))])]),x.value==="compare"?(a(),de(Ts,{key:1,id:v.value??""},null,8,["id"])):v.value?(a(),c(re,{key:2},[x.value==="current"?(a(),de(Rt,{key:0,id:v.value},null,8,["id"])):W("",!0),x.value==="mirror"?(a(),de(nn,{key:1,id:v.value},null,8,["id"])):W("",!0),x.value==="summary"?(a(),de(yn,{key:2,id:v.value},null,8,["id"])):W("",!0),x.value==="timeline"?(a(),de(Rs,{key:3,id:v.value},null,8,["id"])):W("",!0)],64)):(a(),c("div",Js," Aucune analyse sélectionnée. "))])}}});export{tr as default};
