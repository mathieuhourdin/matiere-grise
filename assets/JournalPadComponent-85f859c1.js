import{d as X,u as Y,r as d,j,y as B,o as Z,a as R,b as o,c as u,l as r,e as V,w as ee,h as z,m as D,F as O,g as U,p as I,t as h,J as te,a2 as ae,k as se,O as re,S as le,U as oe,s as ne,v as ie,Q as ue,M as ce}from"./index-feeccd59.js";import{u as de}from"./useJournal-7bf2b09e.js";import{a as ve,r as _e,b as fe}from"./PlusIcon-b9d888db.js";const $=x=>(le("data-v-49bb37d6"),x=x(),oe(),x),pe={class:"ipad-screen"},he={class:"mb-4 flex items-start justify-between gap-3"},me=$(()=>r("div",null,[r("h2",{class:"text-xl font-semibold text-slate-800"},"Vos journaux"),r("p",{class:"text-xs text-slate-500"},"Consultez ce que vous avez ecrit et ajoutez de nouvelles traces")],-1)),be={class:"journal-tabs flex gap-2 overflow-x-auto pb-1"},xe=["onClick"],ye=["disabled"],ge={class:"mt-4 flex-1 min-h-0"},we={key:0,class:"text-sm text-slate-500"},ke={key:1,class:"text-sm text-slate-500"},je={key:2,class:"journal-canvas h-full"},Je={class:"traces-scroll flex-1 min-h-0 overflow-y-auto pr-2"},Ce={class:"paper-content space-y-6"},Te=["placeholder","disabled"],Ee={class:"mt-2 flex justify-end"},De=["disabled"],Ie={key:0,class:"text-sm text-slate-500"},Se={class:"text-xs text-slate-500 mb-1"},Ne={class:"font-handwritten text-4xl mb-2 leading-tight text-slate-800"},Fe={key:0,class:"font-georgia"},Be={key:2,class:"text-sm text-slate-500"},Ve=$(()=>r("div",{class:"ipad-home-indicator"},null,-1)),ze=X({__name:"JournalPadComponent",props:{fullscreen:{type:Boolean,default:!1}},setup(x){const{userJournals:y,loadUserJournal:J}=de(),{createResource:A,createTrace:L,updateResource:M}=ne(),{createInteractionForResource:P}=ie(),{user:q}=Y(),{launchSnackbar:v}=ue(),C=d(!1),m=d(!1),_=d(""),c=d([]),f=d(!1),b=d(!1),g=d({});let w=0;const k=j(()=>y.value.length?[...y.value].sort((t,a)=>{var l,i;const s=new Date(((l=t.resource)==null?void 0:l.created_at)||t.created_at||0).getTime(),e=new Date(((i=a.resource)==null?void 0:i.created_at)||a.created_at||0).getTime();return s-e}):[]),n=d(null),p=j(()=>{var t,a,s;return((t=n.value)==null?void 0:t.resource_id)??((s=(a=n.value)==null?void 0:a.resource)==null?void 0:s.id)??null}),S=j(()=>{var s,e;const t=p.value;if(!t||g.value[t]||c.value.length>0)return!1;const a=(((e=(s=n.value)==null?void 0:s.resource)==null?void 0:e.title)??"").trim();return a.length===0||a==="Nouveau journal"}),Q=j(()=>S.value?"Titre du journal":"Ecrire une nouvelle trace..."),W=t=>{n.value=t},G=async()=>{var t;if(!f.value){if(!((t=q.value)!=null&&t.id)){v("Utilisateur non trouvé","error");return}f.value=!0;try{const s=await A({title:"Nouveau journal",subtitle:"",content:"",external_content_url:"",comment:"",image_url:"",maturing_state:"drft",publishing_state:"",resource_type:"jrnl",is_local_draft:!1});await P(s.id,{interaction_progress:0,interaction_date:new Date,interaction_comment:"",interaction_is_public:!1}),await J();const e=y.value.find(l=>{var i;return(l.resource_id??((i=l.resource)==null?void 0:i.id))===s.id});e&&(n.value=e),g.value[s.id]=!1,v("Nouveau journal créé","success")}catch(a){console.error("Error creating new journal:",a),v("Erreur lors de la création du journal","error")}finally{f.value=!1}}},H=async()=>{var s;const t=_.value.trim(),a=p.value;if(!(!t||!a)){b.value=!0;try{if(S.value){const e=(s=n.value)==null?void 0:s.resource,l={title:t,subtitle:(e==null?void 0:e.subtitle)??"",content:(e==null?void 0:e.content)??"",external_content_url:(e==null?void 0:e.external_content_url)??"",comment:(e==null?void 0:e.comment)??"",image_url:(e==null?void 0:e.image_url)??"",maturing_state:(e==null?void 0:e.maturing_state)??"drft",publishing_state:(e==null?void 0:e.publishing_state)??"",resource_type:"jrnl",is_local_draft:!1};await M(a,l),g.value[a]=!0,await J();const i=y.value.find(E=>{var F;return(E.resource_id??((F=E.resource)==null?void 0:F.id))===a});i&&(n.value=i),v("Titre du journal mis à jour","success")}else await L({content:t,journal_id:a}),await N(a),v("Trace ajoutée","success");_.value=""}catch(e){console.error("Error submitting journal entry:",e),v("Erreur lors de l'envoi","error")}finally{b.value=!1}}},N=async t=>{const a=++w;m.value=!0;try{const s=await re.get(`/journals/${t}/traces`);if(a!==w)return;const e=Array.isArray(s.data)?s.data:[];c.value=e,e.length>0&&(g.value[t]=!0)}catch(s){if(a!==w)return;console.error("Error loading traces for journal:",s),v(`Error loading journal traces: ${s}`,"error"),c.value=[]}finally{if(a!==w)return;m.value=!1}},K=t=>t?(typeof t=="string"?new Date(t):t).toLocaleDateString("fr-FR",{day:"numeric",month:"short",year:"numeric"}):"",T=t=>{const s=(t.content||t.title||"Trace sans contenu").split(`
`),e=s.shift()??"",l=s.join(`
`).trim();return{first:e,rest:l}};return B(k,t=>{if(!t.length){n.value=null,c.value=[];return}const a=p.value;t.find(e=>{var l;return(e.resource_id??((l=e.resource)==null?void 0:l.id))===a})||(n.value=t[0])}),B(p,async t=>{if(!t){c.value=[],_.value="";return}c.value=[],_.value="",await N(t)}),Z(async()=>{C.value=!0;try{await J(),!n.value&&k.value.length>0&&(n.value=k.value[0])}finally{C.value=!1}}),(t,a)=>{const s=R("router-link");return o(),u("section",{class:I(["ipad-shell",{"ipad-shell-fullscreen":t.fullscreen}])},[r("div",pe,[r("header",he,[me,V(s,{to:t.fullscreen?"/me/home":"/me/journal-pad",class:"inline-flex items-center justify-center w-8 h-8 rounded-lg border border-slate-300 bg-white/80 text-slate-600 hover:border-slate-400 hover:text-slate-800 transition-colors",title:t.fullscreen?"Fermer et revenir vers accueil":"Ouvrir en plein écran","aria-label":t.fullscreen?"Fermer et revenir vers accueil":"Ouvrir le journal en plein écran"},{default:ee(()=>[t.fullscreen?(o(),z(D(ve),{key:0,class:"w-4 h-4"})):(o(),z(D(_e),{key:1,class:"w-4 h-4"}))]),_:1},8,["to","title","aria-label"])]),r("div",be,[(o(!0),u(O,null,U(k.value,e=>{var l,i;return o(),u("button",{key:e.id,type:"button",onClick:E=>W(e),class:I(["px-3 py-1.5 rounded-xl border text-xs whitespace-nowrap transition-all duration-200 shadow-sm",p.value===(e.resource_id??((l=e.resource)==null?void 0:l.id))?"border-sky-500 bg-sky-100 text-sky-900":"border-slate-300 bg-white/80 text-slate-600 hover:border-slate-400"])},h(((i=e.resource)==null?void 0:i.title)||"Sans titre"),11,xe)}),128)),r("button",{type:"button",disabled:f.value,onClick:G,class:I(["inline-flex items-center gap-1.5 px-3 py-1.5 rounded-xl border text-xs whitespace-nowrap transition-all duration-200 shadow-sm",f.value?"border-slate-300 bg-slate-100 text-slate-400 cursor-wait":"border-slate-300 border-dashed bg-white/80 text-slate-600 hover:border-slate-400"])},[V(D(fe),{class:"w-3.5 h-3.5"}),r("span",null,h(f.value?"Création...":"Nouveau journal"),1)],10,ye)]),r("div",ge,[C.value?(o(),u("div",we,"Chargement...")):n.value?(o(),u("div",je,[r("div",Je,[r("div",Ce,[r("div",null,[te(r("textarea",{"onUpdate:modelValue":a[0]||(a[0]=e=>_.value=e),rows:"3",placeholder:Q.value,disabled:b.value||m.value,class:"w-full rounded-xl border border-amber-200 bg-white/75 text-slate-700 text-base p-4 placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-300 font-georgia disabled:opacity-70"},null,8,Te),[[ae,_.value]]),r("div",Ee,[r("button",{type:"button",disabled:b.value||m.value||!_.value.trim()||!p.value,class:"px-2.5 py-1 text-xs rounded-md border border-slate-300 bg-white/85 text-slate-700 hover:border-slate-400 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",onClick:H},h(b.value?"Envoi...":"Valider"),9,De)])]),m.value?(o(),u("div",Ie," Chargement des traces... ")):c.value.length>0?(o(!0),u(O,{key:1},U(c.value,e=>(o(),u("article",{key:e.id,class:"trace-entry text-[17px] text-slate-700 whitespace-pre-line leading-[2]"},[r("div",Se,h(K(e.interaction_date||e.created_at)),1),r("div",Ne,h(T(e).first),1),T(e).rest?(o(),u("div",Fe,h(T(e).rest),1)):se("",!0)]))),128)):(o(),u("div",Be," Aucune trace pour ce journal "))])])])):(o(),u("div",ke,"Aucun journal trouve"))])]),Ve],2)}}});const Ae=ce(ze,[["__scopeId","data-v-49bb37d6"]]);export{Ae as J};
