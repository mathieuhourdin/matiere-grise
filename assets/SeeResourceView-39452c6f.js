import{o as t,h as u,b as v,d as V,f,g as N,E as Fe,G as se,H as pe,D as Le,I as Me,l as je,p as y,s as $e,C as Ce,F as Y,i as Z,j as d,t as k,c as S,q as te,e as qe,n as ye,v as O,a as $,B as Re,r as Ie,w as E,m as ne,J as Pe,_ as ue,u as ce,K as re,L as ze,M as Ne}from"./index-c1fd03af.js";import{a as F,_ as ee}from"./ActionButton.vue_vue_type_script_setup_true_lang-50cca4c5.js";import{_ as fe}from"./TextAreaInput.vue_vue_type_script_setup_true_lang-c855d44e.js";import{a as Ke,u as be,_ as Je}from"./SelectionTextInterface.vue_vue_type_style_index_0_lang-077281a9.js";import{_ as Ve}from"./ProgressBar.vue_vue_type_script_setup_true_lang-a96dd65c.js";import{u as _e}from"./useResource-b48d82c5.js";import{u as Te}from"./useResourceRelations-d0d94fd4.js";import{_ as Ue}from"./UserPicker.vue_vue_type_script_setup_true_lang-66225970.js";function We(h,n){return t(),u("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true"},[v("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M9 8.25H7.5a2.25 2.25 0 00-2.25 2.25v9a2.25 2.25 0 002.25 2.25h9a2.25 2.25 0 002.25-2.25v-9a2.25 2.25 0 00-2.25-2.25H15M9 12l3 3m0 0l3-3m-3 3V2.25"})])}function He(h,n){return t(),u("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true"},[v("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M19.5 13.5L12 21m0 0l-7.5-7.5M12 21V3"})])}function Ge(h,n){return t(),u("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true"},[v("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M4.5 10.5L12 3m0 0l7.5 7.5M12 3v18"})])}function Qe(h,n){return t(),u("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true"},[v("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M7.217 10.907a2.25 2.25 0 100 2.186m0-2.186c.18.324.283.696.283 1.093s-.103.77-.283 1.093m0-2.186l9.566-5.314m-9.566 7.5l9.566 5.314m0 0a2.25 2.25 0 103.935 2.186 2.25 2.25 0 00-3.935-2.186zm0-12.814a2.25 2.25 0 103.933-2.185 2.25 2.25 0 00-3.933 2.185z"})])}function Xe(h,n){return t(),u("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true"},[v("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M21.75 6.75a4.5 4.5 0 01-4.884 4.484c-1.076-.091-2.264.071-2.95.904l-7.152 8.684a2.548 2.548 0 11-3.586-3.586l8.684-7.152c.833-.686.995-1.874.904-2.95a4.5 4.5 0 016.336-4.486l-3.276 3.276a3.004 3.004 0 002.25 2.25l3.276-3.276c.256.565.398 1.192.398 1.852z"}),v("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M4.867 19.125h.008v.008h-.008v-.008z"})])}const Ye={class:"flex"},ie=V({__name:"ModalSheet",props:{open:{type:Boolean,default:!1}},emits:["close"],setup(h,{emit:n}){const a=h,m=f(!1);return N(()=>{m.value=a.open}),Fe(()=>{const l=r=>{(r.key==="Escape"||r.key==="Enter"||r.key==="Esc"||r.keyCode===27)&&n("close")};return window.addEventListener("keydown",l),()=>{window.removeEventListener("keydown",l)}}),se(pe(a).open,l=>m.value=l),(l,r)=>m.value?(t(),u("div",{key:0,tabindex:"0",onKeyup:r[2]||(r[2]=je(c=>n("close"),["esc"])),class:"fixed top-0 left-0 w-full h-full z-10 bg-slate-500/50",onClick:r[3]||(r[3]=c=>n("close"))},[v("div",{class:"max-w-xl overflow-y-scroll max-h-screen mb-10 bg-white mx-auto mt-6 p-4 rounded shadow",onClick:r[1]||(r[1]=Me(()=>{},["stop"]))},[v("div",Ye,[v("div",{class:"ml-auto",onClick:r[0]||(r[0]=c=>n("close"))},"x")]),Le(l.$slots,"default")])],32)):y("",!0)}}),Ze={class:"justify-items-center mx-auto flex flex-wrap max-w-full"},et={key:0,class:"ml-auto"},tt={key:0,class:"absolute right-0 top-0 w-4 h-4 rounded-square text-2xs bg-green-400 text-center"},lt=v("div",{class:"mr-auto"},null,-1),Ae=V({__name:"ToggleButtonGroup",props:{choices:{},default:{},urlKey:{},url:{type:Boolean,default:!1},center:{type:Boolean,default:!1}},emits:["update"],setup(h,{emit:n}){const a=h,m=f(null),l=$e(),r=Ce(),c=e=>{if(n("update",e),m.value=e,a.url){const i=r.query,o=r.path,_=a.urlKey??"tab";console.log(_);const g={};g[_]=e;const b={...i,...g};l.push({path:o,query:b}),console.log(`route : ${JSON.stringify(r)}`)}};return N(()=>c(a.default??"")),(e,i)=>(t(),u("div",Ze,[e.center?(t(),u("div",et)):y("",!0),(t(!0),u(Y,null,Z(e.choices,o=>(t(),u("div",{class:"relative",key:o.value},[d(F,{class:"w-30 my-1 mx-1",text:o.text,onClick:_=>c(o.value),type:o.value==m.value?"valid":"abort"},null,8,["text","onClick","type"]),o.count?(t(),u("div",tt,k(o.count),1)):y("",!0)]))),128)),lt]))}});const ot={class:"bg-slate-100 border p-1 m-1 rounded shadow-xl"},st={class:"flex"},nt={key:0,class:"text-xs mt-0.5 mb-1 font-bold flex"},at=["src"],rt={class:"my-auto"},ut={class:"text-2xs italic ml-auto mr-1 my-auto"},it={key:0},ct=["value"],dt={class:"flex"},vt={key:1,class:"text-xs mt-0.5"},we=V({__name:"CommentCard",props:{editing:{type:Boolean},modelValue:{},author:{},createdAt:{}},emits:["update:modelValue","validate","abort"],setup(h,{emit:n}){const a=h,m=S(()=>a.createdAt?a.createdAt.toLocaleString("fr-FR",{hour:"numeric",weekday:"short",day:"numeric",month:"short",year:"2-digit"}):""),l=e=>{n("update:modelValue",e.target.value)},r=()=>{n("validate")},c=()=>{n("abort")};return(e,i)=>(t(),u("div",ot,[v("div",st,[e.author?(t(),u("div",nt,[e.author.profile_picture_url?(t(),u("img",{key:0,class:"h-5 w-5 rounded-full mr-1",src:e.author.profile_picture_url},null,8,at)):y("",!0),v("div",rt,k(e.author.first_name)+" "+k(e.author.last_name),1)])):y("",!0),v("div",ut,k(m.value),1)]),e.editing?(t(),u("div",it,[v("textarea",{class:"w-full text-xs rounded-xl p-2",value:e.modelValue,onInput:l},null,40,ct),v("div",dt,[d(F,{onClick:r,class:"text-sm",rounded:"",size:"2xs",text:"Commenter",type:"valid"}),d(F,{onClick:c,class:"text-sm",rounded:"",size:"2xs",text:"Annuler",type:"abort"})])])):(t(),u("div",vt,k(e.modelValue),1))]))}}),mt={class:"relative"},pt={key:0},ft=v("div",{class:"text-sm align-middle flex items-center p-2",style:{height:"50px"}}," Corriger une faute ",-1),_t={class:"flex mx-auto max-w-full"},ht={class:"w-full"},gt={key:0,class:"flex"},xt=v("div",{class:"w-6"},[v("div",{class:"rounded-full ml-4 mr-2 mt-2 h-1 w-1 bg-black"})],-1),yt=[xt],wt={class:"flex flex-wrap flex-1"},bt=["onClick","onContextmenu"],kt={key:0,style:{width:"5px"}},$t={key:1,style:{height:"25px"}},Ct={key:2},Rt=["onClick"],It={key:1,class:"absolute h-full",style:{right:"-2%",width:"27%"}},Vt={key:0,style:{width:"33%"}},Tt=V({__name:"TextInterface",props:{resourceId:{},fullText:{},extComments:{default:()=>[]},editable:{type:Boolean,default:!0}},emits:["change","changeComments"],setup(h,{emit:n}){const a=h,m=s=>{console.log("selectCursorPosition letter : ",s),a.editable&&(l.value={id:s.id,char:s.char})},l=f(null),r=f([]),c=f([]),e=async()=>{let s=[{id:0,words:[{id:0,text:[]}],comments:[]}],p=0,w=0;for(var A=0;A<r.value.length;A++){r.value[A].char==`
`&&(p+=1,w=0,s.push({id:p,words:[{id:0,text:[]}],lineStyle:A<r.value.length-1?r.value[A+1].char:null,comments:[]}));const U=D.value.find(z=>z.start_index==A);U&&s[p].comments.push(U),s[p].words[w].text.push({id:A,char:r.value[A].char,comment:U}),r.value[A].char==" "&&(w+=1,s[p].words.push({id:w,text:[]}))}return s},i=s=>{s==1?D.value.forEach(p=>{l.value&&p.start_index>l.value.id&&(p.start_index+=1),l.value&&p.end_index>l.value.id&&(p.end_index+=1)}):s==-1&&D.value.forEach(p=>{l.value&&p.start_index>=l.value.id&&(p.start_index-=1),l.value&&p.end_index>=l.value.id&&(p.end_index-=1)})},o=s=>{console.log("insertChar : ",s),l.value&&(console.log("insertChar with cursor set : ",s),r.value.filter(p=>l.value&&p.id>=l.value.id+1).forEach(p=>p.id+=1),r.value.splice(l.value.id+1,0,{id:l.value.id+1,char:s}),i(1),l.value.id+=1)},_=s=>{if(console.log("Writes : ",s.key),l.value===null)return;const p=s.key;if(g.value&&p=="v"){b();return}if(p.length==1)s.preventDefault(),o(p);else if(p=="Backspace")r.value.splice(l.value.id,1),r.value.filter(w=>l.value&&w.id>l.value.id).forEach(w=>w.id-=1),i(-1),l.value.id-=1;else if(p=="Enter")o(`
`);else if(p=="ArrowRight"){let w=l.value.id;w<r.value.length-1&&m(r.value[w+1])}else if(p=="ArrowLeft"){let w=l.value.id;w>0&&m(r.value[w-1])}else p=="Control"&&(console.log("Control"),g.value=!0)},g=f(!1),b=async()=>{try{let p=await navigator.clipboard.readText();console.log("Clippedtext : ",p);for(var s=0;s<p.length;s++)o(p[s])}catch(p){console.log("Error with clippboard : ",p)}},j=s=>{s.key=="Control"&&(g.value=!1)},{createComment:H,batchUpdateComments:G}=be(),{isMobile:K}=Re(),D=f([]),P=f(null),le=async s=>{D.value=s.filter(p=>p.start_index!=null)},Q=async()=>{if(console.log("Add Comment"),console.log(a.resourceId),console.log(q.value),!a.resourceId||!q.value)return;console.log("Add Comment 2");const s=await H(a.resourceId,q.value,q.value);D.value.push(s)};se(D,async(s,p)=>{console.log("Watch comments triggered : ",s),W.value&&(console.log("Comments : ",s),n("changeComments",s),P.value!==null&&clearTimeout(P.value),P.value=setTimeout(()=>G(s),1e3)),console.log(`Old comments lenght : ${p.length} new length: ${s.length}`),console.log("OldComments : ",p),console.log("NewComments : ",s),p.length===0&&s.length>0&&(console.log("Finally loading comments"),c.value=await e())},{deep:!0}),se(pe(a).extComments,async s=>{await le(s)});const J=f(!1),q=f(null),R=f({position:"absolute","z-index":90,top:"0px",left:"0px",height:"106px",width:"260px"}),{user:T}=te(),L=(s,p)=>{s.preventDefault(),T.value&&(l.value=null,R.value.top=`${s.layerY}px`,R.value.left=`${s.layerX}px`,J.value=!0,q.value=p,console.log("event : ",s),console.log("Have a new right click"))},he=s=>{if(r.value=[],s===void 0||s==""){r.value=[{id:0,char:`
`}],m({id:0,char:`
`});return}for(var p=0;p<s.length;p++){const w=D.value.find(A=>A.start_index==p);r.value.push({id:p,char:s[p],comment:w})}},de=s=>s.reduce((p,w)=>p+w.char,""),W=f(!1);return N(async()=>{await le(a.extComments),await he(a.fullText),await new Promise(s=>setTimeout(s,10)),c.value=await e(),W.value=!0}),se(r,async s=>{console.log("Watch triggered : ",s),W.value&&(n("change",de(s)),c.value=await e())},{deep:!0}),(s,p)=>(t(),u("div",mt,[d(Ke,{text:s.fullText,class:"absolute z-10 h-6 right-2"},null,8,["text"]),W.value?(t(),u("div",{key:1,id:"main-interface",class:"relative md:p-4",tabindex:"0",onKeydown:_,onKeyup:j,onClick:p[0]||(p[0]=w=>J.value=!1)},[J.value?(t(),u("div",{key:0,class:"bg-white border-4",style:qe(R.value)},[v("div",{onClick:Q,class:"text-sm border-b-2 flex items-center p-2",style:{height:"50px"}}," Ajouter un commentaire "),ft],4)):y("",!0),v("div",_t,[v("div",ht,[(t(!0),u(Y,null,Z(c.value,(w,A)=>(t(),u("div",{key:A,class:"flex"},[w.lineStyle=="*"?(t(),u("div",gt,yt)):y("",!0),v("div",wt,[(t(!0),u(Y,null,Z(w.words,(U,z)=>(t(),u("div",{key:z,class:"flex flex-wrap"},[(t(!0),u(Y,null,Z(U.text,(B,ve)=>{var me;return t(),u("div",{key:ve,class:ye(["border-blue-400",{"border-r-2":B.id==((me=l.value)==null?void 0:me.id),"bg-yellow-400":B.comment}]),onClick:ae=>m(B),onContextmenu:ae=>L(ae,B.id)},[B.char==" "?(t(),u("div",kt)):B.char==`
`?(t(),u("div",$t)):(B.char=="#"||B.char=="*")&&z==0?(t(),u("div",Ct)):(t(),u("div",{key:3,class:ye({"font-bold":w.lineStyle=="#"})},[v("div",null,k(B.char),1)],2))],42,bt)}),128))]))),128)),v("div",{class:"flex-1",onClick:U=>m(w.words.slice(-1)[0].text.slice(-1)[0])},null,8,Rt)]),D.value.length>0&&!O(K)?(t(),u("div",It,[(t(!0),u(Y,null,Z(w.comments,(U,z)=>(t(),$(we,{key:z,class:"w-full",modelValue:U.content,"onUpdate:modelValue":B=>U.content=B,editing:U.editing,onValidate:B=>U.editing=!1,author:U.author,"created-at":U.created_at},null,8,["modelValue","onUpdate:modelValue","editing","onValidate","author","created-at"]))),128))])):y("",!0)]))),128))]),D.value.length>0&&!O(K)?(t(),u("div",Vt)):y("",!0)])],32)):(t(),u("div",pt,[v("span",null,k(s.fullText),1)]))]))}}),Ut=v("hr",{class:"border-top border-zinc-400 my-4"},null,-1),At=v("div",{class:"text-xs italic"},"Raison de la lecture",-1),Bt=V({__name:"SeeThoughtInput",props:{thoughtInput:{}},setup(h){const n=h,{getUserById:a,user:m}=te(),l=f(null),r=S(()=>m.value?n.thoughtInput.interaction_user_id===m.value.id:!1);return N(async()=>{n.thoughtInput.interaction_user_id&&(l.value=await a(n.thoughtInput.interaction_user_id))}),(c,e)=>(t(),u("div",null,[d(Ee,{id:c.thoughtInput.resource_id,"second-level":""},null,8,["id"]),Ut,At,d(Tt,{"full-text":c.thoughtInput.interaction_comment,editable:r.value},null,8,["full-text","editable"])]))}}),Et={class:"w-full md:w-96"},Dt={key:0,class:"border shadow-lg rounded p-4 pl-2 md:w-96 bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-600 text-gray-900 dark:text-gray-100"},St={class:"flex"},Ot={class:"flex flex-col mr-1"},Ft=["src"],Lt={key:0,class:"text-gray-500 dark:text-gray-400 text-xs"},Mt={class:"flex flex-wrap w-full mt-auto"},jt={class:"text-2xs"},qt={class:"flex flex-wrap"},Pt={key:0,class:"text-2xs italic"},zt={key:1,class:"text-xs italic p-1 mt-2 mb-3 bg-white dark:bg-transparent text-gray-900 dark:text-gray-100"},Nt={class:"flex flex-wrap"},Kt={key:1,class:"text-2xs italic ml-2"},Jt={key:2,class:"ml-auto m-1 w-1/3"},Wt=V({__name:"ThoughtInputCard",props:{contextualResource:{},isDisabled:{type:Boolean,default:!1},open:{type:Boolean}},setup(h){const n=h,{getUserById:a}=te(),{getAuthorInteractionForResource:m}=_e(),l=f(null),r=f(null),c=f(null);N(async()=>{n.contextualResource.user_id&&(c.value=await a(n.contextualResource.user_id)),n.contextualResource.resource&&(r.value=await m(n.contextualResource.resource.id)),r.value&&(l.value=await a(r.value.interaction_user_id))});const e=o=>o?o.toLocaleString("fr-FR",{hour:"numeric",weekday:"short",day:"numeric",month:"short",year:"2-digit"}):"",i=o=>o.length>200?o.slice(0,150)+"...":o;return(o,_)=>{const g=Ie("router-link");return t(),u("div",Et,[o.contextualResource.resource?(t(),$(Pe(o.isDisabled?"span":"vue-router"),{key:0,to:"/resources/"+o.contextualResource.resource.id+"?tab=ctnt"},{default:E(()=>[o.contextualResource.resource?(t(),u("div",Dt,[v("div",St,[v("div",Ot,[o.contextualResource.resource?(t(),u("img",{key:0,class:"w-8 h-fit",src:o.contextualResource.resource.image_url},null,8,Ft)):y("",!0),v("div",{class:"w-4 h-4 mt-auto",onClick:_[0]||(_[0]=b=>o.open=!o.open)},[o.open?(t(),$(O(Ge),{key:1})):(t(),$(O(He),{key:0}))])]),v("div",null,[v("div",null,[ne(k(o.contextualResource.resource.title)+" ",1),o.contextualResource.resource.subtitle?(t(),u("div",Lt,k(o.contextualResource.resource.subtitle),1)):y("",!0)]),v("div",Mt,[l.value?(t(),$(g,{key:0,to:"/users/"+l.value.id,class:"text-2xs underline"},{default:E(()=>[ne(k(l.value.first_name)+" "+k(l.value.last_name),1)]),_:1},8,["to"])):y("",!0)]),v("div",jt,k(i(o.contextualResource.resource.comment)),1)])]),v("div",qt,[o.contextualResource.date?(t(),u("div",Pt,k(e(o.contextualResource.resourcedate)),1)):y("",!0)])])):y("",!0)]),_:1},8,["to"])):y("",!0),o.contextualResource.context_comment&&o.open?(t(),u("div",zt,[v("div",null,k(o.contextualResource.context_comment),1),v("div",Nt,[c.value?(t(),$(g,{key:0,to:"/users/"+c.value.id,class:"text-2xs underline"},{default:E(()=>[ne(k(c.value.first_name)+" "+k(c.value.last_name),1)]),_:1},8,["to"])):y("",!0),o.contextualResource.date?(t(),u("div",Kt,k(e(o.contextualResource.date)),1)):y("",!0),o.contextualResource.progress?(t(),u("div",Jt,[d(Ve,{"progress-value":o.contextualResource.progress},null,8,["progress-value"])])):y("",!0)])])):y("",!0)])}}}),Ht={class:"w-fit"},Gt=V({__name:"ThoughtInputCardWithPopup",props:{thoughtInput:{},usageReason:{},isDisabled:{type:Boolean,default:!1},open:{type:Boolean}},setup(h){const n=f(!1);return(a,m)=>(t(),u("div",Ht,[d(ie,{open:n.value,onClose:m[0]||(m[0]=l=>n.value=!1)},{default:E(()=>[d(Bt,{"thought-input":a.thoughtInput,"usage-reason":a.usageReason},null,8,["thought-input","usage-reason"])]),_:1},8,["open"]),d(Wt,{class:"md:w-96","contextual-resource":a.thoughtInput,"is-disabled":a.isDisabled,open:a.open},null,8,["contextual-resource","is-disabled","open"])]))}}),Qt={class:"relative max-w-full"},Xt={key:0,class:"absolute md:border h-full start-1/2 -z-10 border-gray-300 dark:border-gray-600"},oe=V({__name:"ThoughtInputsList",props:{contextualResources:{},center:{type:Boolean,default:!1},linksDisabled:{type:Boolean,default:!1},open:{type:Boolean,default:!1}},emits:["select"],setup(h,{emit:n}){const a=l=>l.sort((r,c)=>+(c.date>r.date)),m=l=>{console.log("Select"),n("select",l)};return(l,r)=>(t(),u("div",Qt,[l.center?y("",!0):(t(),u("div",Xt)),(t(!0),u(Y,null,Z(a(l.contextualResources),(c,e)=>(t(),$(Gt,{key:c.id,class:ye(["mb-4 md:mb-1 mx-auto max-w-full max-w-fit p-1",{"md:ml-0":e%2==0&&!l.center,"md:mr-0":!l.center}]),"thought-input":c,onClick:i=>m(c),"is-disabled":l.linksDisabled,open:l.open},null,8,["class","thought-input","onClick","is-disabled","open"]))),128))]))}}),Yt={key:0,class:"mb-4"},Zt={key:1},el={key:1},tl={key:2},ll={class:"flex flex-row-reverse"},Be=V({__name:"CreateResourceRelationForm",props:{targetResource:{},originResource:{}},emits:["close","refresh"],setup(h,{emit:n}){const a=h,{user:m}=te(),l=f(),r=R=>{console.log("Event : ",R),l.value=R},c=f([{text:"Externes",value:"extr"},{text:"Internes",value:"artl"},{text:"Problème",value:"pblm"}]),e=f([{text:"Biblio",value:"bibl"},{text:"Résumé",value:"sumr"},{text:"Sujet principal",value:"main"},{text:"Evocation",value:"mino"}]),i=f([]),o=f(null),_=f([]),g=f([]),b=f([]),j=f(""),H=f(""),{createResourceRelation:G}=Te(),{getResources:K}=_e(),D=S(()=>i.value.map(R=>({resource:R.resource}))),P=R=>R.map(T=>({resource:T})),le=S(()=>({extr:P(_.value),artl:P(g.value),pblm:P(b.value)})),Q=async()=>{if(console.log("create"),!o.value)return;const R={target_resource_id:a.targetResource?a.targetResource.id:o.value.id,origin_resource_id:a.originResource?a.originResource.id:o.value.id,relation_comment:j.value,relation_type:H.value};await G(R),n("refresh"),n("close")},{getUserInteractions:J}=ce(),q=R=>{o.value=R.resource};return N(async()=>{!m.value||!m.value.id||(a.targetResource&&(i.value=await J(m.value.id)),a.originResource&&(_.value=await K({is_external:!0}),g.value=await K({is_external:!1,resource_type:"oatc"}),b.value=await K({is_external:!1,resource_type:"pblm"})))}),(R,T)=>(t(),u("div",null,[O(m)?(t(),u("div",Yt," Nouvelle relation entre ressources par "+k(O(m).first_name)+" "+k(O(m).last_name),1)):y("",!0),o.value?(t(),u("div",tl,[d(ue,{class:"m-4",label:"Type de lien",choices:e.value,modelValue:H.value,"onUpdate:modelValue":T[2]||(T[2]=L=>H.value=L)},null,8,["choices","modelValue"]),d(fe,{class:"m-4",label:"Pourquoi ajouter cet élément ?",modelValue:j.value,"onUpdate:modelValue":T[3]||(T[3]=L=>j.value=L)},null,8,["modelValue"]),v("div",ll,[d(F,{type:"valid",onClick:Q,text:"Ajouter"}),d(F,{type:"abort",onClick:T[4]||(T[4]=L=>n("close")),text:"Annuler",class:"mr-1"})])])):(t(),u("div",Zt,[R.targetResource?(t(),$(oe,{key:0,"contextual-resources":D.value,center:"","links-disabled":"",onSelect:T[0]||(T[0]=L=>q(L))},null,8,["contextual-resources"])):(t(),u("div",el,[v("div",null,[ne(" Choisir une ressource cible "),d(Ae,{center:"",choices:c.value,default:"pblm",onUpdate:r},null,8,["choices"]),d(oe,{"contextual-resources":le.value[l.value]||[],center:"",onSelect:T[1]||(T[1]=L=>q(L)),"links-disabled":""},null,8,["contextual-resources"])])]))]))]))}}),ol={class:"flex flex-wrap"},sl={class:"flex flex-row-reverse"},nl=V({__name:"CreateInteraction",props:{resource:{}},emits:["close","refresh"],setup(h,{emit:n}){const a=h,m=f([{text:"Lecture / Visionage",value:"inpt"},{text:"Envie",value:"wish"}]),{newInteraction:l,createInteractionForResource:r}=ce(),{user:c}=te(),e=f(l());N(()=>{e.value.interaction_type||(e.value.interaction_type="inpt")});const i=()=>{e.value.resource_id=a.resource.id,e.value.interaction_user_id=c.value.id,r(a.resource.id,e.value),n("refresh"),o()},o=()=>n("close");return(_,g)=>(t(),u("div",null,[v("div",null,"Nouvelle interaction, avec la ressource : "+k(_.resource.title),1),v("div",ol,[d(ee,{label:"Avancement de l'ouvrage",class:"my-auto",modelValue:e.value.interaction_progress,"onUpdate:modelValue":g[0]||(g[0]=b=>e.value.interaction_progress=b),type:"number"},null,8,["modelValue"]),d(ue,{label:"Type d'interaction",class:"m-4 w-full md:w-5/12 md:ml-auto",choices:m.value,modelValue:e.value.interaction_type,"onUpdate:modelValue":g[1]||(g[1]=b=>e.value.interaction_type=b)},null,8,["choices","modelValue"])]),d(ee,{label:"Date de lecture",modelValue:e.value.interaction_date,"onUpdate:modelValue":g[2]||(g[2]=b=>e.value.interaction_date=b),type:"date"},null,8,["modelValue"]),d(fe,{label:"Pourquoi s'y être interessé ?",modelValue:e.value.interaction_comment,"onUpdate:modelValue":g[3]||(g[3]=b=>e.value.interaction_comment=b)},null,8,["modelValue"]),v("div",sl,[d(F,{onClick:i,class:"m-4",text:"Valider",type:"valid"}),d(F,{onClick:o,class:"m-4",text:"Annuler",type:"abort"})])]))}}),al=v("div",null,"Demander une Review pour l'article :",-1),rl={class:"flex flex-row-reverse mt-4"},ul=V({__name:"CreateReview",props:{resource:{}},emits:["close","refresh"],setup(h,{emit:n}){const a=h,{newInteraction:m,createInteractionForResource:l}=ce(),r=async()=>{const i=m();i.interaction_user_id=e.value,i.resource_id=a.resource.id,i.interaction_type="rvew",i.interaction_comment=c.value,await l(a.resource.id,i),n("refresh"),n("close")},c=f(""),e=f(null);return(i,o)=>(t(),u("div",null,[al,v("div",null,k(i.resource.title),1),d(Ue,{modelValue:e.value,"onUpdate:modelValue":o[0]||(o[0]=_=>e.value=_)},null,8,["modelValue"]),d(fe,{class:"mt-4",label:"Message pour la review",modelValue:c.value,"onUpdate:modelValue":o[1]||(o[1]=_=>c.value=_)},null,8,["modelValue"]),v("div",rl,[d(F,{type:"valid",onClick:r,text:"Ajouter"}),d(F,{type:"abort",onClick:o[2]||(o[2]=_=>n("close")),text:"Annuler",class:"mr-1"})])]))}}),il=V({__name:"ResourceTools",props:{resource:{},isResourceEditable:{type:Boolean}},emits:["refresh","edit"],setup(h,{emit:n}){const a=f(!1),m=f(!1),l=f(!1),r=f(!1);return(c,e)=>(t(),u("div",null,[c.isResourceEditable&&a.value?(t(),$(re,{key:0,title:"Modifier",onClick:e[0]||(e[0]=i=>n("edit"))},{default:E(()=>[d(O(ze),{class:"m-1"})]),_:1})):y("",!0),c.isResourceEditable&&a.value?(t(),$(re,{key:1,class:"mt-2",color:"blue",title:"Demander une review",onClick:e[1]||(e[1]=i=>m.value=!0)},{default:E(()=>[d(O(Ne),{class:"m-1"})]),_:1})):y("",!0),d(ie,{open:m.value,onClose:e[4]||(e[4]=i=>m.value=!1)},{default:E(()=>[d(ul,{onRefresh:e[2]||(e[2]=i=>n("refresh")),onClose:e[3]||(e[3]=i=>m.value=!1),resource:c.resource},null,8,["resource"])]),_:1},8,["open"]),c.isResourceEditable&&a.value?(t(),$(re,{key:2,class:"mt-2",color:"red",title:"Marquer comme lu",onClick:e[5]||(e[5]=i=>l.value=!0)},{default:E(()=>[d(O(We),{class:"m-1"})]),_:1})):y("",!0),d(ie,{open:l.value,onClose:e[8]||(e[8]=i=>l.value=!1)},{default:E(()=>[d(nl,{onRefresh:e[6]||(e[6]=i=>n("refresh")),onClose:e[7]||(e[7]=i=>l.value=!1),resource:c.resource},null,8,["resource"])]),_:1},8,["open"]),c.isResourceEditable&&a.value?(t(),$(re,{key:3,class:"mt-2",color:"green",title:"Relier à d'autres ressources",onClick:e[9]||(e[9]=i=>r.value=!0)},{default:E(()=>[d(O(Qe),{class:"m-1"})]),_:1})):y("",!0),d(ie,{open:r.value,onClose:e[12]||(e[12]=i=>r.value=!1)},{default:E(()=>[d(Be,{onRefresh:e[10]||(e[10]=i=>n("refresh")),onClose:e[11]||(e[11]=i=>r.value=!1),"origin-resource":c.resource},null,8,["origin-resource"])]),_:1},8,["open"]),d(re,{class:"mt-2",color:"gray",onClick:e[13]||(e[13]=i=>a.value=!a.value)},{default:E(()=>[d(O(Xe))]),_:1})]))}}),cl=V({__name:"CommentsThread",props:{resourceId:{}},setup(h){const n=h,{user:a}=te(),m=f([]),{createComment:l,getCommentsForThoughtOutput:r}=be(),c=async()=>{console.log("Comment thread"),console.log("Props id : ",n.resourceId),m.value=await r(n.resourceId)},e=S(()=>m.value.filter(_=>!_.start_index).sort((_,g)=>_.created_at-g.created_at)),i=f(""),o=async()=>{await l(n.resourceId,null,null,i.value,!1),i.value="",await c()};return N(async()=>await c()),(_,g)=>(t(),u("div",null,[(t(!0),u(Y,null,Z(e.value,b=>(t(),$(we,{key:b.id,class:"w-full",modelValue:b.content,"onUpdate:modelValue":j=>b.content=j,editing:b.editing,onValidate:j=>b.editing=!1,author:b.author,"created-at":b.created_at},null,8,["modelValue","onUpdate:modelValue","editing","onValidate","author","created-at"]))),128)),d(we,{class:"w-full",modelValue:i.value,"onUpdate:modelValue":g[0]||(g[0]=b=>i.value=b),editing:!0,onValidate:o,author:O(a),"created-at":null},null,8,["modelValue","author"])]))}}),dl=V({__name:"DateField",props:{date:{}},setup(h){const n=h,a=S(()=>new Date(n.date).toLocaleDateString("fr-FR",{day:"numeric",month:"short",year:"numeric"}));return(m,l)=>(t(),u("div",null,k(a.value),1))}}),vl={class:"flex flex-col"},ml={class:"block text-2xs text-slate-800"},pl=["value","placeholder"],fl=V({__name:"NumberInput",props:{label:{},modelValue:{},placeholder:{}},emits:["update:modelValue","input"],setup(h,{emit:n}){const a=m=>{n("update:modelValue",m.target.value),n("input",m.target.value)};return(m,l)=>(t(),u("div",vl,[v("label",ml,k(m.label),1),v("input",{class:"border border-neutral-400 block h-full w-full rounded-md border-2 p-1 pl-2 text-xs",type:"number",value:m.modelValue,placeholder:m.placeholder,onInput:l[0]||(l[0]=r=>a(r))},null,40,pl)]))}}),_l={class:"grid grid-cols-4 gap-y-2 gap-x-4 auto-rows-auto"},hl=V({__name:"ResourceForm",props:{article:{}},emits:["change"],setup(h,{emit:n}){const a=h,m=f([{text:"Terminé",value:"fnsh"},{text:"Relecture",value:"rvew"},{text:"Brouillon",value:"drft"},{text:"Poubelle",value:"trsh"}]),{resourceTypeOptions:l}=_e(),r=(c,e)=>{let i={...a.article};i[c]=e,i.is_external&&(i.maturing_state="fnsh"),console.log("Article : ",i),n("change",i)};return(c,e)=>(t(),u("div",_l,[d(ee,{class:"col-span-4",label:"Titre",modelValue:c.article.title,"onUpdate:modelValue":e[0]||(e[0]=i=>r("title",i))},null,8,["modelValue"]),d(ee,{class:"col-span-4",label:"Sous-titre",modelValue:c.article.subtitle,"onUpdate:modelValue":e[1]||(e[1]=i=>r("subtitle",i))},null,8,["modelValue"]),d(ee,{class:"col-span-4 md:col-span-2",label:"Lien contenu externe",modelValue:c.article.external_content_url,"onUpdate:modelValue":e[2]||(e[2]=i=>r("external_content_url",i))},null,8,["modelValue"]),d(ee,{class:"col-span-4 md:col-span-2",label:"Lien image",modelValue:c.article.image_url,"onUpdate:modelValue":e[3]||(e[3]=i=>r("image_url",i))},null,8,["modelValue"]),d(ue,{label:"Type de ressource",class:"col-span-4 md:col-span-2",choices:O(l),"onUpdate:modelValue":e[4]||(e[4]=i=>r("resource_type",i)),"model-value":c.article.resource_type},null,8,["choices","model-value"]),d(ue,{label:"Ressource externe",class:"col-span-4 md:col-span-1",choices:[{text:"Oui",value:!0},{text:"Non",value:!1}],"onUpdate:modelValue":e[5]||(e[5]=i=>r("is_external",JSON.parse(i))),"model-value":c.article.is_external},null,8,["model-value"]),d(ue,{label:"Stade d'écriture",class:"col-span-4 md:col-span-1",choices:m.value,"model-value":c.article.maturing_state,"onUpdate:modelValue":e[6]||(e[6]=i=>r("maturing_state",i))},null,8,["choices","model-value"])]))}}),gl={class:"grid grid-cols-3 gap-4"},xl=V({__name:"ResourceAuthorPicker",props:{interaction:{},resourceId:{}},emits:["update"],setup(h,{emit:n}){const a=h,m=S(()=>{var o;return(o=a.interaction)==null?void 0:o.interaction_user_id}),{createInteractionForResource:l,newInteraction:r,updateInteraction:c}=ce(),e=async o=>{if(console.log(`newUser : ${JSON.stringify(o)}`),a.interaction){const _={...a.interaction};_.interaction_user_id=o,console.log("newUserid : ",o.id),console.log(`Interaction payload : ${JSON.stringify(_)}`),await c(a.interaction.id,_),n("update")}else{console.log("create interaction");const _=r();_.interaction_user_id=o,_.resource_id=a.resourceId,await l(a.resourceId,_),n("update")}},i=async o=>{await c(a.interaction.id,o),n("update")};return(o,_)=>(t(),u("div",gl,[d(Ue,{"model-value":m.value,"onUpdate:modelValue":_[0]||(_[0]=g=>e(g))},null,8,["model-value"]),o.interaction?(t(),$(ee,{key:0,class:"text-2xs",label:"Date d'écriture","model-value":o.interaction.interaction_date?o.interaction.interaction_date.split("T")[0]:null,"onUpdate:modelValue":_[1]||(_[1]=g=>i({...o.interaction,interaction_date:g})),type:"date"},null,8,["model-value"])):y("",!0),o.interaction?(t(),$(fl,{key:1,class:"",label:"Progression",modelValue:o.interaction.interaction_progress,"onUpdate:modelValue":_[2]||(_[2]=g=>i({...o.interaction,interaction_progress:g}))},null,8,["modelValue"])):y("",!0)]))}}),yl={key:0,class:"text-center text-2xl pt-10"},wl={key:1},bl={key:0},kl={class:"my-8"},$l=["src"],Cl={class:"text-3xl my-3 font-mplus md:text-center text-left"},Rl={class:"md:text-center text-left"},Il={class:"md:text-center text-left"},Vl={class:"md:flex my-8"},Tl=["href"],Ul={key:1,class:"my-2 flex flex-col"},Al={class:"flex flex-row-reverse mb-4"},Bl=v("hr",{class:"border-top border-zinc-400 my-4"},null,-1),El={key:2},Dl={class:"mb-4"},Sl=v("div",{class:"text-xs italic"},"Sujets",-1),Ol=v("div",{class:"text-xs italic"},"Contenu",-1),Fl={key:3},Ll={key:4},Ml={key:5},Ee=V({__name:"ResourceComponent",props:{resourceId:{},secondLevel:{type:Boolean}},setup(h){const n=h,a=Ce(),m=S(()=>A.value&&w.value||!R.value||s.value.is_local_draft||!c.value),l=S(()=>n.secondLevel?"popup_tab":"tab"),r=S(()=>[{text:"Contenu",value:"ctnt"},{text:"Biblio",value:"bbli",count:g.value.length},{text:"Sujets",value:"pblm",count:Q.value.length},{text:"Interactions",value:"inpt",count:G.value.length}]),c=f(!0),e=f(a.query[l.value]&&typeof a.query[l.value]=="string"?a.query[l.value]:"ctnt"),i=f(a.query[l.value]);se(()=>a.query[l.value],x=>{console.log("new route query",x),typeof x=="string"&&(i.value=x)});const{getResourceRelationsForResource:o,getUsagesForResource:_}=Te(),g=f([]),b=f(!1),j=async()=>{g.value=await o(pe(n).resourceId.value)},H=S(()=>g.value.map(x=>({resource:x.origin_resource,date:x.created_at,user_id:x.user_id,context_comment:x.relation_comment,progress:null}))),G=f([]),{getInteractionsForResource:K,updateInteraction:D}=ce(),P=async()=>{G.value=await K(n.resourceId)},le=S(()=>G.value.map(x=>({resource:null,date:x.interaction_date,user_id:x.interaction_user_id,context_comment:x.interaction_comment,progress:x.interaction_progress}))),Q=f([]),J=async()=>{Q.value=await _(n.resourceId)},q=S(()=>Q.value.map(x=>({resource:x.target_resource,date:x.created_at,user_id:x.user_id,context_comment:x.relation_comment,progress:null}))),R=f(!1),{newResource:T,getResource:L,updateResource:he,getAuthorInteractionForResource:de}=_e(),W=f(null),s=f(T()),p=$e();se(()=>a.query.editing,x=>{console.log("Editing : ",x),w.value=x==="false"?!1:!!x});const w=f(!1),{isMobile:A}=Re(),U=x=>{p.push({query:{editing:x.toString()}})},z=(x,C)=>{s.value=C,W.value!==null&&clearTimeout(W.value),W.value=setTimeout(async()=>{try{await he(x,s.value)}catch(xe){console.log("An error : ",xe)}},1e3)},B=x=>{x!=`
`&&z(pe(n).resourceId.value,{...s.value,content:x})},{user:ve,getUserById:me}=te(),ae=S(()=>s.value.is_external?!0:ve.value?X.value?X.value.id==ve.value.id:!0:!1),X=f(null),I=f(null),ge=async()=>{I.value=await de(n.resourceId)},De=async()=>{!I.value||!I.value.id||(await D(I.value.id,{...I.value,interaction_is_public:!0}),ge())},Se=async()=>{!I.value||!I.value.id||(await D(I.value.id,{...I.value,interaction_is_public:!1}),ge())},{getCommentsForThoughtOutput:Oe}=be(),ke=f([]);return N(async()=>{R.value=!1,s.value=await L(n.resourceId),R.value=!0,await j(),await P(),await J(),ke.value=await Oe(n.resourceId),I.value=await de(n.resourceId),I.value&&(X.value=await me(I.value.interaction_user_id));const x=a.query.editing;w.value=x==="false"?!1:!!x}),(x,C)=>{const xe=Ie("router-link");return t(),u("div",null,[R.value?(t(),u("div",wl,[w.value?(t(),u("div",Ul,[d(hl,{article:s.value,class:"",onChange:C[0]||(C[0]=M=>z(s.value.id,M))},null,8,["article"]),d(xl,{class:"my-2",interaction:I.value,"resource-id":x.resourceId,onChange:ge},null,8,["interaction","resource-id"]),v("div",Al,[d(F,{class:"ml-2",onClick:C[1]||(C[1]=M=>U(!1)),type:"valid",text:"Preview"},{default:E(()=>[ne("Ok")]),_:1}),I.value&&!I.value.interaction_is_public?(t(),$(F,{key:0,class:"ml-2",onClick:De,type:"valid",text:"Publier"})):I.value?(t(),$(F,{key:1,class:"ml-2",onClick:Se,type:"abort",text:"Dépublier"})):y("",!0),d(F,{class:"ml-2",onClick:C[2]||(C[2]=M=>c.value=!c.value),type:"valid",text:c.value?"Text brut":"Editeur"},null,8,["text"])])])):(t(),u("div",bl,[v("div",kl,[v("img",{src:s.value.image_url,class:"border border-slate-300 dark:border-zinc-700 rounded-xl ml-auto mr-auto",style:{"max-height":"20rem"}},null,8,$l)]),v("h1",Cl,k(s.value.title),1),v("div",Rl,k(s.value.subtitle),1),v("div",Il,[X.value?(t(),$(xe,{key:0,to:"/users/"+X.value.id,class:"text-sm underline"},{default:E(()=>[ne(k(X.value.first_name)+" "+k(X.value.last_name),1)]),_:1},8,["to"])):y("",!0),I.value?(t(),$(dl,{key:1,date:I.value.interaction_date},null,8,["date"])):y("",!0)]),v("div",Vl,[I.value?(t(),$(Ve,{key:0,"progress-value":I.value.interaction_progress,class:"m-2 w-1/3"},null,8,["progress-value"])):y("",!0),s.value.external_content_url?(t(),u("a",{key:1,class:"ml-auto underline",href:s.value.external_content_url,target:"_blank"}," Lien ressource externe ",8,Tl)):y("",!0)])])),v("div",null,[w.value?y("",!0):(t(),$(Ae,{key:0,choices:r.value,default:e.value,"url-key":l.value,url:""},null,8,["choices","default","url-key"]))]),Bl,i.value=="ctnt"?(t(),u("div",El,[v("div",Dl,[Sl,d(oe,{"contextual-resources":q.value},null,8,["contextual-resources"])]),Ol,m.value?(t(),$(fe,{key:0,class:"mt-4 h-96",modelValue:s.value.content,"onUpdate:modelValue":C[3]||(C[3]=M=>B(M))},null,8,["modelValue"])):(t(),$(Je,{key:1,class:"min-h-fit","ext-comments":ke.value,"resource-id":s.value.id,text:s.value.content,editable:ae.value,onChange:C[4]||(C[4]=M=>B(M))},null,8,["ext-comments","resource-id","text","editable"])),d(cl,{class:"mt-6","resource-id":x.resourceId},null,8,["resource-id"])])):i.value=="bbli"?(t(),u("div",Fl,[d(ie,{open:b.value,onClose:C[6]||(C[6]=M=>b.value=!1)},{default:E(()=>[d(Be,{onRefresh:j,onClose:C[5]||(C[5]=M=>b.value=!1),"target-resource":s.value},null,8,["target-resource"])]),_:1},8,["open"]),v("div",{onClick:C[7]||(C[7]=M=>b.value=!0),class:"text-sm italic underline"}," Ajouter une référence "),d(oe,{"contextual-resources":H.value},null,8,["contextual-resources"])])):i.value=="pblm"?(t(),u("div",Ll,[d(oe,{"contextual-resources":q.value},null,8,["contextual-resources"])])):i.value=="inpt"?(t(),u("div",Ml,[d(oe,{"contextual-resources":le.value},null,8,["contextual-resources"])])):y("",!0),d(il,{class:"fixed right-3 bottom-5",resource:s.value,"is-resource-editable":ae.value,onRefresh:C[8]||(C[8]=M=>J()&&P()),onEdit:C[9]||(C[9]=M=>U(!0))},null,8,["resource","is-resource-editable"])])):(t(),u("div",yl,"Loading..."))])}}}),Hl=V({__name:"SeeResourceView",props:{id:{}},setup(h){return(n,a)=>(t(),u("div",null,[d(Ee,{class:"md:px-8 px-4","resource-id":n.id},null,8,["resource-id"])]))}});export{Hl as default};
