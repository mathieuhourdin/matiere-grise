import{d as N,n as O,o as s,c as n,f as m,t as g,a as y,h as W,_ as P,A as D,e as j,r as x,q as w,y as R,j as oe,I as ae,F as k,m as b,H as L,i as le}from"./index-80c66211.js";const se={class:"bg-slate-100 border p-1 m-1 rounded shadow-xl"},ne={class:"flex"},re={key:0,class:"text-xs mt-0.5 font-bold"},ue={class:"text-2xs italic ml-auto mr-1 my-auto"},de={key:0},ie=["value"],ce={class:"flex"},he={key:1,class:"text-xs mt-0.5"},ve=N({__name:"CommentCard",props:{editing:{type:Boolean},modelValue:{},author:{},createdAt:{}},emits:["update:modelValue","validate","abort"],setup(r,{emit:u}){const d=r,c=O(()=>d.createdAt?d.createdAt.toLocaleString("fr-FR",{hour:"numeric",weekday:"short",day:"numeric",month:"short",year:"2-digit"}):""),o=f=>{u("update:modelValue",f.target.value)},l=()=>{u("validate")},$=()=>{u("abort")};return(f,C)=>(s(),n("div",se,[m("div",ne,[f.author?(s(),n("div",re,g(f.author.first_name)+" "+g(f.author.last_name),1)):y("",!0),m("div",ue,g(c.value),1)]),f.editing?(s(),n("div",de,[m("textarea",{class:"w-full text-xs rounded-xl p-2",value:f.modelValue,onInput:o},null,40,ie),m("div",ce,[W(P,{onClick:l,class:"text-sm",rounded:"",size:"2xs",text:"Commenter",type:"valid"}),W(P,{onClick:$,class:"text-sm",rounded:"",size:"2xs",text:"Annuler",type:"abort"})])])):(s(),n("div",he,g(f.modelValue),1))]))}}),me=async(r,u)=>{const{user:d}=j(),c={start_index:u,end_index:u};try{const o=await D.post("/thought_outputs/"+r+"/comments",c),l=F(o.data);return d.value&&l.author_id==d.value.id&&(l.author=d.value),l}catch(o){throw console.log("error : ",o),o}},F=r=>(r.updated_at=new Date(r.updated_at.split(".")[0]),r.created_at=new Date(r.created_at.split(".")[0]),r),fe=async(r,u=!0)=>{const d=u?"?author=true":"";try{return(await D.get("/thought_outputs/"+r+"/comments"+d)).data.map(o=>F(o))}catch(c){throw console.log("error : ",c),c}},H=async r=>{try{const u=await D.put("/comments/"+r.id,r);return F(u.data)}catch(u){console.log("error : ",u)}},pe=async r=>{console.log("comments : ",r),r.map(u=>H(u))};function xe(){return{createComment:me,getCommentsForThoughtOutput:fe,updateComment:H,batchUpdateComments:pe}}const _e=m("div",{class:"text-sm align-middle flex items-center p-2",style:{height:"50px"}}," Corriger une faute ",-1),ge={class:"flex mx-auto max-w-full"},ye={class:"w-full"},Ce={key:0,class:"flex"},we=m("div",{class:"w-6"},[m("div",{class:"rounded-full ml-4 mr-2 mt-2 h-1 w-1 bg-black"})],-1),ke=[we],be={class:"flex flex-wrap"},$e=["onClick","onContextmenu"],Ve={key:0,style:{width:"5px"}},Ae={key:1,style:{height:"25px"}},Te={key:2},Ie={key:1,class:"absolute h-full",style:{right:"-2%",width:"27%"}},Ee={key:0,style:{width:"33%"}},De=N({__name:"TextInterface",props:{resourceId:{},fullText:{},extComments:{default:()=>[]},editable:{type:Boolean,default:!0}},emits:["change","changeComments"],setup(r,{emit:u}){const d=r,c=e=>{console.log("selectCursorPosition letter : ",e),d.editable&&(o.value={id:e.id,char:e.char})},o=x(null),l=x([]),$=O(()=>{let e=[{id:0,words:[{id:0,text:[]}],comments:[]}],t=0,a=0;for(var i=0;i<l.value.length;i++){l.value[i].char==`
`&&(t+=1,a=0,e.push({id:t,words:[{id:0,text:[]}],lineStyle:i<l.value.length-1?l.value[i+1].char:null,comments:[]}));const h=p.value.find(_=>_.start_index==i);h&&e[t].comments.push(h),e[t].words[a].text.push({id:i,char:l.value[i].char,comment:h}),l.value[i].char==" "&&(a+=1,e[t].words.push({id:a,text:[]}))}return e}),f=e=>{e==1?p.value.forEach(t=>{o.value&&t.start_index>o.value.id&&(t.start_index+=1),o.value&&t.end_index>o.value.id&&(t.end_index+=1)}):e==-1&&p.value.forEach(t=>{o.value&&t.start_index>=o.value.id&&(t.start_index-=1),o.value&&t.end_index>=o.value.id&&(t.end_index-=1)})},C=e=>{o.value&&(l.value.filter(t=>o.value&&t.id>=o.value.id+1).forEach(t=>t.id+=1),l.value.splice(o.value.id+1,0,{id:o.value.id+1,char:e}),f(1),o.value.id+=1)},K=e=>{if(console.log("Writes : ",e.key),o.value===null)return;const t=e.key;if(V.value&&t=="v"){q();return}if(t.length==1)e.preventDefault(),C(t);else if(t=="Backspace")l.value.splice(o.value.id,1),l.value.filter(a=>o.value&&a.id>o.value.id).forEach(a=>a.id-=1),f(-1),o.value.id-=1;else if(t=="Enter")C(`
`);else if(t=="ArrowRight"){let a=o.value.id;a<l.value.length-1&&c(l.value[a+1])}else if(t=="ArrowLeft"){let a=o.value.id;a>0&&c(l.value[a-1])}else t=="Control"&&(console.log("Control"),V.value=!0)},V=x(!1),q=async()=>{try{let t=await navigator.clipboard.readText();console.log("Clippedtext : ",t);for(var e=0;e<t.length;e++)C(t[e])}catch(t){console.log("Error with clippboard : ",t)}},M=e=>{e.key=="Control"&&(V.value=!1)},{createComment:X,batchUpdateComments:Y}=xe(),p=x([]),A=x(null),G=e=>{console.log("Comments loading : ",e),p.value=e},J=async()=>{if(console.log("Add Comment"),!d.resourceId||!I.value)return;const e=await X(d.resourceId,I.value);p.value.push(e)};w(p,e=>{console.log("Watch comments triggered : ",e),B.value&&(console.log("Comments : ",e),u("changeComments",e),A.value!==null&&clearTimeout(A.value),A.value=setTimeout(()=>Y(e),1e3))},{deep:!0}),w(R(d).extComments,e=>{p.value=e});const T=x(!1),I=x(null),E=x({position:"absolute","z-index":90,top:"0px",left:"0px",height:"106px",width:"260px"}),{user:Q}=j(),Z=(e,t)=>{e.preventDefault(),Q.value&&(o.value=null,E.value.top=`${e.layerY}px`,E.value.left=`${e.layerX}px`,T.value=!0,I.value=t,console.log("event : ",e),console.log("Have a new right click"))},S=e=>{if(console.log("textArrayFromString textString: ",e),l.value=[],e===void 0||e==""){l.value=[{id:0,char:`
`}],c({id:0,char:`
`});return}for(var t=0;t<e.length;t++){const a=p.value.find(i=>i.start_index==t);l.value.push({id:t,char:e[t],comment:a})}},ee=e=>e.reduce((t,a)=>t+a.char,""),B=x(!1);return oe(()=>{S(d.fullText),G(d.extComments),B.value=!0}),w(l,e=>{console.log("Watch triggered : ",e),B.value&&u("change",ee(e))},{deep:!0}),w(R(d).fullText,e=>{S(e)}),(e,t)=>(s(),n("div",{class:"relative p-4",tabindex:"0",onKeydown:K,onKeyup:M,onClick:t[0]||(t[0]=a=>T.value=!1)},[T.value?(s(),n("div",{key:0,class:"bg-white border-4",style:ae(E.value)},[m("div",{onClick:J,class:"text-sm border-b-2 flex items-center p-2",style:{height:"50px"}}," Ajouter un commentaire "),_e],4)):y("",!0),m("div",ge,[m("div",ye,[(s(!0),n(k,null,b($.value,(a,i)=>(s(),n("div",{key:i,class:"flex"},[a.lineStyle=="*"?(s(),n("div",Ce,ke)):y("",!0),m("div",be,[(s(!0),n(k,null,b(a.words,(h,_)=>(s(),n("div",{key:_,class:"flex flex-wrap"},[(s(!0),n(k,null,b(h.text,(v,te)=>{var z;return s(),n("div",{key:te,class:L(["border-blue-400",{"border-r-2":v.id==((z=o.value)==null?void 0:z.id),"bg-yellow-400":v.comment}]),onClick:U=>c(v),onContextmenu:U=>Z(U,v.id)},[v.char==" "?(s(),n("div",Ve)):v.char==`
`?(s(),n("div",Ae)):(v.char=="#"||v.char=="*")&&_==0?(s(),n("div",Te)):(s(),n("div",{key:3,class:L({"font-bold":a.lineStyle=="#"})},[m("div",null,g(v.char),1)],2))],42,$e)}),128))]))),128))]),p.value.length>0?(s(),n("div",Ie,[(s(!0),n(k,null,b(a.comments,(h,_)=>(s(),le(ve,{key:_,class:"w-full",modelValue:h.content,"onUpdate:modelValue":v=>h.content=v,editing:h.editing,onValidate:v=>h.editing=!1,author:h.author,"created-at":h.created_at},null,8,["modelValue","onUpdate:modelValue","editing","onValidate","author","created-at"]))),128))])):y("",!0)]))),128))]),p.value.length>0?(s(),n("div",Ee)):y("",!0)])],32))}});export{De as _,xe as u};
