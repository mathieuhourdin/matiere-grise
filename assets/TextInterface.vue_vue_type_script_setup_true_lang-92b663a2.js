import{i as R,j,o as n,c as r,a as u,t as _,d as W,_ as L,p as b,v as S,u as Z,r as p,q as C,k as ee,x as te,n as I,F as w,y as k,z as P,e as oe}from"./index-748af54e.js";const ae={class:"bg-slate-100 border p-1 m-1 rounded shadow-xl"},se={class:"flex"},le={class:"text-xs mt-0.5 font-bold"},ne={class:"text-2xs italic ml-auto mr-1 my-auto"},re={key:0},ce=["value"],de={class:"flex"},ie={key:1,class:"text-xs mt-0.5"},ue=R({__name:"CommentCard",props:{editing:{type:Boolean},modelValue:{},author:{},createdAt:{}},emits:["update:modelValue","validate","abort"],setup(m,{emit:c}){const d=m,h=j(()=>{console.log(`date : ${d.createdAt}`),console.log(b(d).createdAt.value.split(".")[0]);const v=new Date(b(d).createdAt.value.split(".")[0]);return console.log(v),v.toLocaleString("fr-FR",{hour:"numeric",weekday:"short",day:"numeric",month:"short",year:"2-digit"})}),s=v=>{c("update:modelValue",v.target.value)},o=()=>{c("validate")},$=()=>{c("abort")};return(v,y)=>(n(),r("div",ae,[u("div",se,[u("div",le,_(v.author.first_name)+" "+_(v.author.last_name),1),u("div",ne,_(h.value),1)]),v.editing?(n(),r("div",re,[u("textarea",{class:"w-full text-xs rounded-xl p-2",value:v.modelValue,onInput:s},null,40,ce),u("div",de,[W(L,{onClick:o,class:"text-sm",rounded:"",size:"2xs",text:"Commenter",type:"valid"}),W(L,{onClick:$,class:"text-sm",rounded:"",size:"2xs",text:"Annuler",type:"abort"})])])):(n(),r("div",ie,_(v.modelValue),1))]))}}),me=async(m,c)=>{const{user:d}=Z(),h={start_index:c,end_index:c};try{const o=(await S.post("/articles/"+m+"/comments",h)).data;return d.value&&o.author_id==d.value.id&&(o.author=d.value),o}catch(s){console.log("error : ",s)}},ve=async(m,c=!0)=>{const d=c?"?author=true":"";try{return(await S.get("/articles/"+m+"/comments"+d)).data}catch(h){console.log("error : ",h)}},N=async m=>{try{return(await S.put("/comments/"+m.id,m)).data}catch(c){console.log("error : ",c)}},he=async m=>{console.log("comments : ",m),m.map(c=>N(c))};function pe(){return{createComment:me,getCommentsForArticle:ve,updateComment:N,batchUpdateComments:he}}const fe=u("div",{class:"text-sm align-middle flex items-center p-2",style:{height:"50px"}}," Corriger une faute ",-1),xe={class:"flex mx-auto max-w-full"},ge={class:"w-full"},_e={key:0,class:"flex"},ye=u("div",{class:"w-6"},[u("div",{class:"rounded-full ml-4 mr-2 mt-2 h-1 w-1 bg-black"})],-1),Ce=[ye],we={class:"flex flex-wrap"},ke=["onClick","onContextmenu"],be={key:0,style:{width:"5px"}},$e={key:1,style:{height:"25px"}},Ve={key:2},Ae={class:"absolute h-full",style:{right:"-2%",width:"27%"}},Te={key:0,style:{width:"33%"}},Ie=R({__name:"TextInterface",props:{ressourceId:{},fullText:{},extComments:{default:()=>[]},editable:{type:Boolean,default:!0}},emits:["change","changeComments"],setup(m,{emit:c}){const d=m,h=e=>{console.log("selectCursorPosition letter : ",e),d.editable&&(s.value={id:e.id,char:e.char})},s=p(null),o=p([]),$=j(()=>v(o.value)),v=e=>{console.log("textArrayFromString textString: ",e);let t=[{id:0,words:[{id:0,text:[]}],comments:[]}],a=0,x=0;for(var l=0;l<o.value.length;l++){o.value[l].char==`
`&&(a+=1,x=0,t.push({id:a,words:[{id:0,text:[]}],lineStyle:l<o.value.length-1?o.value[l+1].char:null,comments:[]}));const g=f.value.find(i=>i.start_index==l);g&&t[a].comments.push(g),t[a].words[x].text.push({id:l,char:o.value[l].char,comment:g}),o.value[l].char==" "&&(x+=1,t[a].words.push({id:x,text:[{id:l,char:o.value[l].char}]}))}return t},y=e=>{o.value.filter(t=>t.id>=s.value.id+1).forEach(t=>t.id+=1),o.value.splice(s.value.id+1,0,{id:s.value.id+1,char:e,line:0}),f.value.forEach(t=>{t.start_index>s.value.id&&(t.start_index+=1),t.end_index>s.value.id&&(t.end_index+=1)}),s.value.id+=1},K=e=>{if(console.log("Writes : ",e.key),s.value===null)return;const t=e.key;if(V.value&&t=="v"){O();return}if(t.length==1)e.preventDefault(),y(t);else if(t=="Backspace")o.value.splice(s.value.id,1),o.value.filter(a=>a.id>s.value.id).forEach(a=>a.id-=1),s.value.id-=1;else if(t=="Enter")y(`
`);else if(t=="ArrowRight"){let a=s.value.id;a<o.value.length-1&&h(o.value[a+1])}else if(t=="ArrowLeft"){let a=s.value.id;a>0&&h(o.value[a-1])}else t=="Control"&&(console.log("Control"),V.value=!0)},V=p(!1),O=async()=>{try{let t=await navigator.clipboard.readText();console.log("Clippedtext : ",t);for(var e=0;e<t.length;e++)y(t[e])}catch(t){console.log("Error with clippboard : ",t)}},q=e=>{e.key=="Control"&&(V.value=!1)},{createComment:H,batchUpdateComments:M}=pe(),f=p([]),B=p(null),X=e=>{console.log("Comments loading : ",e),f.value=e},Y=async()=>{console.log("Add Comment");const e=await H(d.ressourceId,E.value);f.value.push(e)};C(f,e=>{console.log("Watch comments triggered : ",e.value),F.value&&(console.log("Comments : ",e),c("changeComments",e.value),clearTimeout(B.value),B.value=setTimeout(()=>M(e),1e3))},{deep:!0}),C(b(d).extComments,e=>{f.value=e});const A=p(!1),E=p(null),T=p({position:"absolute","z-index":90,top:0,left:0,height:"106px",width:"260px"}),G=(e,t)=>{e.preventDefault(),s.value=null,T.value.top=`${e.layerY}px`,T.value.left=`${e.layerX}px`,A.value=!0,E.value=t,console.log("event : ",e),console.log("Have a new right click")},z=e=>{if(console.log("textArrayFromString textString: ",e),o.value=[],e===void 0||e==""){o.value=[{id:0,char:`
`}],h({id:0,char:`
`});return}for(var t=0;t<e.length;t++){const a=f.value.find(x=>x.start_index==t);o.value.push({id:t,char:e[t],comment:a})}},J=e=>e.reduce((t,a)=>t+a.char,""),F=p(!1);return ee(()=>{z(d.fullText),X(d.extComments),F.value=!0}),C(o,e=>{console.log("Watch triggered : ",e),F.value&&c("change",J(e))},{deep:!0}),C(b(d).fullText,e=>{z(e)}),(e,t)=>(n(),r("div",{class:"relative p-4",tabindex:"0",onKeydown:K,onKeyup:q,onClick:t[0]||(t[0]=a=>A.value=!1)},[A.value?(n(),r("div",{key:0,class:"bg-white border-4",style:te(T.value)},[u("div",{onClick:Y,class:"text-sm border-b-2 flex items-center p-2",style:{height:"50px"}}," Ajouter un commentaire "),fe],4)):I("",!0),u("div",xe,[u("div",ge,[(n(!0),r(w,null,k($.value,(a,x)=>(n(),r("div",{key:x,class:"flex"},[a.lineStyle=="*"?(n(),r("div",_e,Ce)):I("",!0),u("div",we,[(n(!0),r(w,null,k(a.words,(l,g)=>(n(),r("div",{key:g,class:"flex flex-wrap"},[(n(!0),r(w,null,k(l.text,(i,Q)=>{var D;return n(),r("div",{key:Q,class:P(["border-blue-400",{"border-r-2":i.id==((D=s.value)==null?void 0:D.id),"bg-yellow-400":i.comment}]),onClick:U=>h(i),onContextmenu:U=>G(U,i.id)},[i.char==" "?(n(),r("div",be)):i.char==`
`?(n(),r("div",$e)):(i.char=="#"||i.char=="*")&&g==0?(n(),r("div",Ve)):(n(),r("div",{key:3,class:P({"font-bold":a.lineStyle=="#"})},[u("div",null,_(i.char),1)],2))],42,ke)}),128))]))),128))]),u("div",Ae,[(n(!0),r(w,null,k(a.comments,(l,g)=>(n(),oe(ue,{key:g,class:"w-full",modelValue:l.content,"onUpdate:modelValue":i=>l.content=i,editing:l.editing,onValidate:i=>l.editing=!1,author:l.author,"created-at":l.created_at},null,8,["modelValue","onUpdate:modelValue","editing","onValidate","author","created-at"]))),128))])]))),128))]),f.value.length>0?(n(),r("div",Te)):I("",!0)])],32))}});export{Ie as _,pe as u};
