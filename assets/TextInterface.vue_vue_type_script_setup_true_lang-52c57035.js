import{i as j,j as N,o as l,c as r,a as u,t as _,d as L,_ as P,p as k,v as S,u as ee,r as p,q as y,k as te,x as oe,n as I,F as C,y as w,z as R,e as ae}from"./index-3e9a0915.js";const se={class:"bg-slate-100 border p-1 m-1 rounded shadow-xl"},le={class:"flex"},ne={class:"text-xs mt-0.5 font-bold"},re={class:"text-2xs italic ml-auto mr-1 my-auto"},ie={key:0},de=["value"],ce={class:"flex"},ue={key:1,class:"text-xs mt-0.5"},me=j({__name:"CommentCard",props:{editing:{type:Boolean},modelValue:{},author:{},createdAt:{}},emits:["update:modelValue","validate","abort"],setup(m,{emit:i}){const d=m,h=N(()=>{console.log(`date : ${d.createdAt}`),console.log(k(d).createdAt.value.split(".")[0]);const v=new Date(k(d).createdAt.value.split(".")[0]);return console.log(v),v.toLocaleString("fr-FR",{hour:"numeric",weekday:"short",day:"numeric",month:"short",year:"2-digit"})}),s=v=>{i("update:modelValue",v.target.value)},a=()=>{i("validate")},b=()=>{i("abort")};return(v,$)=>(l(),r("div",se,[u("div",le,[u("div",ne,_(v.author.first_name)+" "+_(v.author.last_name),1),u("div",re,_(h.value),1)]),v.editing?(l(),r("div",ie,[u("textarea",{class:"w-full text-xs rounded-xl p-2",value:v.modelValue,onInput:s},null,40,de),u("div",ce,[L(P,{onClick:a,class:"text-sm",rounded:"",size:"2xs",text:"Commenter",type:"valid"}),L(P,{onClick:b,class:"text-sm",rounded:"",size:"2xs",text:"Annuler",type:"abort"})])])):(l(),r("div",ue,_(v.modelValue),1))]))}}),ve=async(m,i)=>{const{user:d}=ee(),h={start_index:i,end_index:i};try{const a=(await S.post("/articles/"+m+"/comments",h)).data;return d.value&&a.author_id==d.value.id&&(a.author=d.value),a}catch(s){console.log("error : ",s)}},he=async(m,i=!0)=>{const d=i?"?author=true":"";try{return(await S.get("/articles/"+m+"/comments"+d)).data}catch(h){console.log("error : ",h)}},K=async m=>{try{return(await S.put("/comments/"+m.id,m)).data}catch(i){console.log("error : ",i)}},fe=async m=>{console.log("comments : ",m),m.map(i=>K(i))};function pe(){return{createComment:ve,getCommentsForArticle:he,updateComment:K,batchUpdateComments:fe}}const xe=u("div",{class:"text-sm align-middle flex items-center p-2",style:{height:"50px"}}," Corriger une faute ",-1),ge={class:"flex mx-auto max-w-full"},_e={class:"w-full"},ye={key:0,class:"flex"},Ce=u("div",{class:"w-6"},[u("div",{class:"rounded-full ml-4 mr-2 mt-2 h-1 w-1 bg-black"})],-1),we=[Ce],ke={class:"flex flex-wrap"},be=["id","onClick","onContextmenu"],$e={key:0,style:{width:"5px"}},Ae={key:1,style:{height:"25px"}},Ve={key:2},Te={class:"absolute h-full",style:{right:"-2%",width:"27%"}},Ee={key:0,style:{width:"33%"}},Ie=j({__name:"TextInterface",props:{ressourceId:{},fullText:{},extComments:{default:()=>[]},editable:{type:Boolean,default:!0}},emits:["change","changeComments"],setup(m,{emit:i}){const d=m,h=e=>{console.log("selectCursorPosition letter : ",e),d.editable&&(s.value={id:e.id,char:e.char})},s=p(null),a=p([]),b=N(()=>v(a.value)),v=e=>{console.log("textArrayFromString textString: ",e);let t=[{id:0,words:[{id:0,text:[]}],comments:[]}],o=0,x=0;for(var n=0;n<a.value.length;n++){a.value[n].char==`
`&&(o+=1,x=0,t.push({id:o,words:[{id:0,text:[]}],lineStyle:n<a.value.length-1?a.value[n+1].char:null,comments:[]}));const g=f.value.find(c=>c.start_index==n);g&&t[o].comments.push(g),t[o].words[x].text.push({id:n,char:a.value[n].char,comment:g}),a.value[n].char==" "&&(x+=1,t[o].words.push({id:x,text:[]}))}return t},$=e=>{e==1?f.value.forEach(t=>{t.start_index>s.value.id&&(t.start_index+=1),t.end_index>s.value.id&&(t.end_index+=1)}):e==-1&&f.value.forEach(t=>{t.start_index>=s.value.id&&(t.start_index-=1),t.end_index>=s.value.id&&(t.end_index-=1)})},A=e=>{a.value.filter(t=>t.id>=s.value.id+1).forEach(t=>t.id+=1),a.value.splice(s.value.id+1,0,{id:s.value.id+1,char:e,line:0}),$(1),s.value.id+=1},O=e=>{if(console.log("Writes : ",e.key),s.value===null)return;const t=e.key;if(V.value&&t=="v"){q();return}if(t.length==1)e.preventDefault(),A(t);else if(t=="Backspace")a.value.splice(s.value.id,1),a.value.filter(o=>o.id>s.value.id).forEach(o=>o.id-=1),$(-1),s.value.id-=1;else if(t=="Enter")A(`
`);else if(t=="ArrowRight"){let o=s.value.id;o<a.value.length-1&&h(a.value[o+1])}else if(t=="ArrowLeft"){let o=s.value.id;o>0&&h(a.value[o-1])}else t=="Control"&&(console.log("Control"),V.value=!0)},V=p(!1),q=async()=>{try{let t=await navigator.clipboard.readText();console.log("Clippedtext : ",t);for(var e=0;e<t.length;e++)A(t[e])}catch(t){console.log("Error with clippboard : ",t)}},H=e=>{e.key=="Control"&&(V.value=!1)},{createComment:M,batchUpdateComments:X}=pe(),f=p([]),B=p(null),Y=e=>{console.log("Comments loading : ",e),f.value=e},G=async()=>{console.log("Add Comment");const e=await M(d.ressourceId,z.value);f.value.push(e)};y(f,e=>{console.log("Watch comments triggered : ",e.value),F.value&&(console.log("Comments : ",e),i("changeComments",e.value),clearTimeout(B.value),B.value=setTimeout(()=>X(e),1e3))},{deep:!0}),y(k(d).extComments,e=>{f.value=e});const T=p(!1),z=p(null),E=p({position:"absolute","z-index":90,top:0,left:0,height:"106px",width:"260px"}),J=(e,t)=>{e.preventDefault(),s.value=null,E.value.top=`${e.layerY}px`,E.value.left=`${e.layerX}px`,T.value=!0,z.value=t,console.log("event : ",e),console.log("Have a new right click")},D=e=>{if(console.log("textArrayFromString textString: ",e),a.value=[],e===void 0||e==""){a.value=[{id:0,char:`
`}],h({id:0,char:`
`});return}for(var t=0;t<e.length;t++){const o=f.value.find(x=>x.start_index==t);a.value.push({id:t,char:e[t],comment:o})}},Q=e=>e.reduce((t,o)=>t+o.char,""),F=p(!1);return te(()=>{D(d.fullText),Y(d.extComments),F.value=!0}),y(a,e=>{console.log("Watch triggered : ",e),F.value&&i("change",Q(e))},{deep:!0}),y(k(d).fullText,e=>{D(e)}),(e,t)=>(l(),r("div",{class:"relative p-4",tabindex:"0",onKeydown:O,onKeyup:H,onClick:t[0]||(t[0]=o=>T.value=!1)},[T.value?(l(),r("div",{key:0,class:"bg-white border-4",style:oe(E.value)},[u("div",{onClick:G,class:"text-sm border-b-2 flex items-center p-2",style:{height:"50px"}}," Ajouter un commentaire "),xe],4)):I("",!0),u("div",ge,[u("div",_e,[(l(!0),r(C,null,w(b.value,(o,x)=>(l(),r("div",{key:x,class:"flex"},[o.lineStyle=="*"?(l(),r("div",ye,we)):I("",!0),u("div",ke,[(l(!0),r(C,null,w(o.words,(n,g)=>(l(),r("div",{key:g,class:"flex flex-wrap"},[(l(!0),r(C,null,w(n.text,(c,Z)=>{var U;return l(),r("div",{id:c.id,key:Z,class:R(["border-blue-400",{"border-r-2":c.id==((U=s.value)==null?void 0:U.id),"bg-yellow-400":c.comment}]),onClick:W=>h(c),onContextmenu:W=>J(W,c.id)},[c.char==" "?(l(),r("div",$e)):c.char==`
`?(l(),r("div",Ae)):(c.char=="#"||c.char=="*")&&g==0?(l(),r("div",Ve)):(l(),r("div",{key:3,class:R({"font-bold":o.lineStyle=="#"})},[u("div",null,_(c.char),1)],2))],42,be)}),128))]))),128))]),u("div",Te,[(l(!0),r(C,null,w(o.comments,(n,g)=>(l(),ae(me,{key:g,class:"w-full",modelValue:n.content,"onUpdate:modelValue":c=>n.content=c,editing:n.editing,onValidate:c=>n.editing=!1,author:n.author,"created-at":n.created_at},null,8,["modelValue","onUpdate:modelValue","editing","onValidate","author","created-at"]))),128))])]))),128))]),f.value.length>0?(l(),r("div",Ee)):I("",!0)])],32))}});export{Ie as _,pe as u};
