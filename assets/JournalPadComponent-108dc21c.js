import{d as re,u as se,r as d,j as J,y as U,o as oe,a as le,b as i,c,l as o,e as z,w as ne,h as V,m as T,F as L,g as O,p as A,t as f,J as ie,a3 as ue,k as ce,O as P,S as de,U as ve,s as pe,v as fe,Q as me,M as _e}from"./index-ae4d109a.js";import{u as he}from"./useJournal-b0ad00fa.js";import{b as be,r as xe,c as ye,a as ge}from"./PlusIcon-a8ce81de.js";const M=g=>(de("data-v-bee3be94"),g=g(),ve(),g),we={class:"ipad-screen"},je={class:"mb-4 flex items-start justify-between gap-3"},ke=M(()=>o("div",null,[o("h2",{class:"text-xl font-semibold text-slate-800"},"Vos journaux"),o("p",{class:"text-xs text-slate-500"},"Consultez ce que vous avez ecrit et ajoutez de nouvelles traces")],-1)),Ce={class:"journal-tabs flex gap-2 overflow-x-auto pb-1"},Ie=["onClick"],Je=["disabled"],Te={class:"mt-4 flex-1 min-h-0"},Ee={key:0,class:"text-sm text-slate-500"},Fe={key:1,class:"text-sm text-slate-500"},De={key:2,class:"journal-canvas h-full"},Se={class:"mb-3 flex items-center justify-between gap-2"},Ne={class:"text-xs text-slate-500 truncate"},ze=["disabled"],Ae={class:"traces-scroll flex-1 min-h-0 overflow-y-auto pr-2"},$e={class:"paper-content space-y-6"},Be=["placeholder","disabled"],Ue={class:"mt-2 flex justify-end"},Ve=["disabled"],Le={key:0,class:"text-sm text-slate-500"},Oe={class:"text-xs text-slate-500 mb-1"},Pe={class:"font-handwritten text-4xl mb-2 leading-tight text-slate-800"},Me={key:0,class:"font-georgia"},We={key:2,class:"text-sm text-slate-500"},qe=M(()=>o("div",{class:"ipad-home-indicator"},null,-1)),Qe=re({__name:"JournalPadComponent",props:{fullscreen:{type:Boolean,default:!1}},setup(g){const{userJournals:w,loadUserJournal:E}=he(),{createResource:W,createTrace:q,updateResource:Q}=pe(),{createInteractionForResource:G}=fe(),{user:H}=se(),{launchSnackbar:u}=me(),F=d(!1),h=d(!1),m=d(""),p=d([]),_=d(!1),b=d(!1),x=d(!1),j=d(null),k=d({});let C=0;const I=J(()=>w.value.length?[...w.value].sort((e,a)=>{var s,n;const r=new Date(((s=e.resource)==null?void 0:s.created_at)||e.created_at||0).getTime(),t=new Date(((n=a.resource)==null?void 0:n.created_at)||a.created_at||0).getTime();return r-t}):[]),l=d(null),v=J(()=>{var e,a,r;return((e=l.value)==null?void 0:e.resource_id)??((r=(a=l.value)==null?void 0:a.resource)==null?void 0:r.id)??null}),$=J(()=>{var r,t;const e=v.value;if(!e||k.value[e]||p.value.length>0)return!1;const a=(((t=(r=l.value)==null?void 0:r.resource)==null?void 0:t.title)??"").trim();return a.length===0||a==="Nouveau journal"}),K=J(()=>$.value?"Titre du journal":"Ecrire une nouvelle trace..."),X=e=>{l.value=e},Y=async()=>{var e;if(!_.value){if(!((e=H.value)!=null&&e.id)){u("Utilisateur non trouvé","error");return}_.value=!0;try{const r=await W({title:"Nouveau journal",subtitle:"",content:"",external_content_url:"",comment:"",image_url:"",maturing_state:"drft",publishing_state:"",resource_type:"jrnl",is_local_draft:!1});await G(r.id,{interaction_progress:0,interaction_date:new Date,interaction_comment:"",interaction_is_public:!1}),await E();const t=w.value.find(s=>{var n;return(s.resource_id??((n=s.resource)==null?void 0:n.id))===r.id});t&&(l.value=t),k.value[r.id]=!1,u("Nouveau journal créé","success")}catch(a){console.error("Error creating new journal:",a),u("Erreur lors de la création du journal","error")}finally{_.value=!1}}},Z=()=>{var e;if(!b.value){if(!v.value){u("Sélectionnez un journal avant import","error");return}(e=j.value)==null||e.click()}},B=()=>{j.value&&(j.value.value="")},R=async e=>{const a=v.value;if(!a){u("Aucun journal sélectionné","error");return}const r=e.name.toLowerCase();if(!(r.endsWith(".txt")||r.endsWith(".md"))){u("Format non supporté. Utilisez un fichier .txt ou .md","error");return}b.value=!0;try{const s=new FormData;s.append("file",e),await P.post(`/journals/${a}/import_text`,s,"multipart/form-data"),await D(a),u("Journal importé avec succès","success")}catch(s){console.error("Error importing journal text:",s),u("Erreur lors de l'import du journal","error")}finally{b.value=!1}},ee=async e=>{var t;const a=e.target,r=(t=a==null?void 0:a.files)==null?void 0:t[0];if(!r){B();return}await R(r),B()},te=async()=>{var r;const e=m.value.trim(),a=v.value;if(!(!e||!a)){x.value=!0;try{if($.value){const t=(r=l.value)==null?void 0:r.resource,s={title:e,subtitle:(t==null?void 0:t.subtitle)??"",content:(t==null?void 0:t.content)??"",external_content_url:(t==null?void 0:t.external_content_url)??"",comment:(t==null?void 0:t.comment)??"",image_url:(t==null?void 0:t.image_url)??"",maturing_state:(t==null?void 0:t.maturing_state)??"drft",publishing_state:(t==null?void 0:t.publishing_state)??"",resource_type:"jrnl",is_local_draft:!1};await Q(a,s),k.value[a]=!0,await E();const n=w.value.find(y=>{var N;return(y.resource_id??((N=y.resource)==null?void 0:N.id))===a});n&&(l.value=n),u("Titre du journal mis à jour","success")}else await q({content:e,journal_id:a}),await D(a),u("Trace ajoutée","success");m.value=""}catch(t){console.error("Error submitting journal entry:",t),u("Erreur lors de l'envoi","error")}finally{x.value=!1}}},D=async e=>{const a=++C;h.value=!0;try{const r=await P.get(`/journals/${e}/traces`);if(a!==C)return;const t=Array.isArray(r.data)?r.data:[];p.value=t,t.length>0&&(k.value[e]=!0)}catch(r){if(a!==C)return;console.error("Error loading traces for journal:",r),u(`Error loading journal traces: ${r}`,"error"),p.value=[]}finally{if(a!==C)return;h.value=!1}},ae=e=>e?(typeof e=="string"?new Date(e):e).toLocaleDateString("fr-FR",{day:"numeric",month:"short",year:"numeric"}):"",S=e=>{const r=(e.content||e.title||"Trace sans contenu").split(`
`),s=(r.shift()??"").replace(/^[#\s]+/,""),n=r.join(`
`).trim();return{first:s,rest:n}};return U(I,e=>{if(!e.length){l.value=null,p.value=[];return}const a=v.value;e.find(t=>{var s;return(t.resource_id??((s=t.resource)==null?void 0:s.id))===a})||(l.value=e[0])}),U(v,async e=>{if(!e){p.value=[],m.value="";return}p.value=[],m.value="",await D(e)}),oe(async()=>{F.value=!0;try{await E(),!l.value&&I.value.length>0&&(l.value=I.value[0])}finally{F.value=!1}}),(e,a)=>{var t;const r=le("router-link");return i(),c("section",{class:A(["ipad-shell",{"ipad-shell-fullscreen":e.fullscreen}])},[o("div",we,[o("header",je,[ke,z(r,{to:e.fullscreen?"/me/home":"/me/journal-pad",class:"inline-flex items-center justify-center w-8 h-8 rounded-lg border border-slate-300 bg-white/80 text-slate-600 hover:border-slate-400 hover:text-slate-800 transition-colors",title:e.fullscreen?"Fermer et revenir vers accueil":"Ouvrir en plein écran","aria-label":e.fullscreen?"Fermer et revenir vers accueil":"Ouvrir le journal en plein écran"},{default:ne(()=>[e.fullscreen?(i(),V(T(be),{key:0,class:"w-4 h-4"})):(i(),V(T(xe),{key:1,class:"w-4 h-4"}))]),_:1},8,["to","title","aria-label"])]),o("div",Ce,[(i(!0),c(L,null,O(I.value,s=>{var n,y;return i(),c("button",{key:s.id,type:"button",onClick:N=>X(s),class:A(["px-3 py-1.5 rounded-xl border text-xs whitespace-nowrap transition-all duration-200 shadow-sm",v.value===(s.resource_id??((n=s.resource)==null?void 0:n.id))?"border-sky-500 bg-sky-100 text-sky-900":"border-slate-300 bg-white/80 text-slate-600 hover:border-slate-400"])},f(((y=s.resource)==null?void 0:y.title)||"Sans titre"),11,Ie)}),128)),o("button",{type:"button",disabled:_.value,onClick:Y,class:A(["inline-flex items-center gap-1.5 px-3 py-1.5 rounded-xl border text-xs whitespace-nowrap transition-all duration-200 shadow-sm",_.value?"border-slate-300 bg-slate-100 text-slate-400 cursor-wait":"border-slate-300 border-dashed bg-white/80 text-slate-600 hover:border-slate-400"])},[z(T(ye),{class:"w-3.5 h-3.5"}),o("span",null,f(_.value?"Création...":"Nouveau journal"),1)],10,Je)]),o("div",Te,[F.value?(i(),c("div",Ee,"Chargement...")):l.value?(i(),c("div",De,[o("div",Se,[o("div",Ne,f(((t=l.value.resource)==null?void 0:t.title)||"Nouveau journal"),1),o("button",{type:"button",disabled:b.value||!v.value,onClick:Z,class:"inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md border border-slate-300 bg-white/85 text-[11px] text-slate-700 hover:border-slate-400 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",title:"Importer un fichier texte dans ce journal"},[z(T(ge),{class:"w-3.5 h-3.5"}),o("span",null,f(b.value?"Import...":"Importer .txt/.md"),1)],8,ze),o("input",{ref_key:"importFileInput",ref:j,type:"file",accept:".txt,.md,text/plain,text/markdown",class:"hidden",onChange:ee},null,544)]),o("div",Ae,[o("div",$e,[o("div",null,[ie(o("textarea",{"onUpdate:modelValue":a[0]||(a[0]=s=>m.value=s),rows:"3",placeholder:K.value,disabled:x.value||h.value,class:"w-full rounded-xl border border-amber-200 bg-white/75 text-slate-700 text-base p-4 placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-300 font-georgia disabled:opacity-70"},null,8,Be),[[ue,m.value]]),o("div",Ue,[o("button",{type:"button",disabled:x.value||h.value||!m.value.trim()||!v.value,class:"px-2.5 py-1 text-xs rounded-md border border-slate-300 bg-white/85 text-slate-700 hover:border-slate-400 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",onClick:te},f(x.value?"Envoi...":"Valider"),9,Ve)])]),h.value?(i(),c("div",Le," Chargement des traces... ")):p.value.length>0?(i(!0),c(L,{key:1},O(p.value,s=>(i(),c("article",{key:s.id,class:"trace-entry text-[17px] text-slate-700 whitespace-pre-line leading-[2]"},[o("div",Oe,f(ae(s.interaction_date||s.created_at)),1),o("div",Pe,f(S(s).first),1),S(s).rest?(i(),c("div",Me,f(S(s).rest),1)):ce("",!0)]))),128)):(i(),c("div",We," Aucune trace pour ce journal "))])])])):(i(),c("div",Fe,"Aucun journal trouve"))])]),qe],2)}}});const Xe=_e(Qe,[["__scopeId","data-v-bee3be94"]]);export{Xe as J};
