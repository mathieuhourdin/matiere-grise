import{_ as Ve,u as Be}from"./useArticle-d7e03ac5.js";import{_ as _e}from"./RoundLinkButton.vue_vue_type_style_index_0_lang-4402b60e.js";import{o as e,f as r,a as p,d as E,h as B,m as $,t as C,i as d,q as xe,A as Ee,p as H,b as m,j as re,B as fe,e as te,C as Oe,F as se,g as ae,n as z,D as he,c as R,y as Pe,r as Te,w as O,l as ie,E as Le,_ as ne,G as Ne,u as qe,k as je}from"./index-f0176bff.js";import{_ as N}from"./ActionButton.vue_vue_type_script_setup_true_lang-3ffe5bb8.js";import{_ as me,a as ye,u as ze,r as Me}from"./useThoughtInputs-b12656d2.js";import{a as We,_ as He}from"./SelectionTextInterface.vue_vue_type_script_setup_true_lang-2823167b.js";import{_ as ee}from"./TextInput.vue_vue_type_script_setup_true_lang-91d7e573.js";import{u as be}from"./useInteraction-13a792ef.js";import"./SelectionTextInterface.vue_vue_type_style_index_0_lang-d12748c4.js";import{_ as Ue}from"./ProgressBar.vue_vue_type_script_setup_true_lang-1ae192bb.js";import{_ as Je}from"./UserPicker.vue_vue_type_script_setup_true_lang-926ad261.js";import{u as we}from"./useResource-0527c66f.js";import{u as Ae}from"./useResourceRelations-4e2dc2f9.js";import{u as Ke}from"./useProblem-44a7b7fb.js";function Ge(f,o){return e(),r("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true"},[p("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M9 8.25H7.5a2.25 2.25 0 00-2.25 2.25v9a2.25 2.25 0 002.25 2.25h9a2.25 2.25 0 002.25-2.25v-9a2.25 2.25 0 00-2.25-2.25H15M9 12l3 3m0 0l3-3m-3 3V2.25"})])}function Xe(f,o){return e(),r("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true"},[p("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M7.217 10.907a2.25 2.25 0 100 2.186m0-2.186c.18.324.283.696.283 1.093s-.103.77-.283 1.093m0-2.186l9.566-5.314m-9.566 7.5l9.566 5.314m0 0a2.25 2.25 0 103.935 2.186 2.25 2.25 0 00-3.935-2.186zm0-12.814a2.25 2.25 0 103.933-2.185 2.25 2.25 0 00-3.933 2.185z"})])}const Ye={class:"bg-slate-100 border p-1 m-1 rounded shadow-xl"},Qe={class:"flex"},Ze={key:0,class:"text-xs mt-0.5 mb-1 font-bold flex"},et=["src"],tt={class:"my-auto"},ot={class:"text-2xs italic ml-auto mr-1 my-auto"},lt={key:0},st=["value"],at={class:"flex"},nt={key:1,class:"text-xs mt-0.5"},ge=E({__name:"CommentCard",props:{editing:{type:Boolean},modelValue:{},author:{},createdAt:{}},emits:["update:modelValue","validate","abort"],setup(f,{emit:o}){const a=f,i=B(()=>a.createdAt?a.createdAt.toLocaleString("fr-FR",{hour:"numeric",weekday:"short",day:"numeric",month:"short",year:"2-digit"}):""),t=n=>{o("update:modelValue",n.target.value)},v=()=>{o("validate")},h=()=>{o("abort")};return(n,y)=>(e(),r("div",Ye,[p("div",Qe,[n.author?(e(),r("div",Ze,[n.author.profile_picture_url?(e(),r("img",{key:0,class:"h-5 w-5 rounded-full mr-1",src:n.author.profile_picture_url},null,8,et)):$("",!0),p("div",tt,C(n.author.first_name)+" "+C(n.author.last_name),1)])):$("",!0),p("div",ot,C(i.value),1)]),n.editing?(e(),r("div",lt,[p("textarea",{class:"w-full text-xs rounded-xl p-2",value:n.modelValue,onInput:t},null,40,st),p("div",at,[d(N,{onClick:v,class:"text-sm",rounded:"",size:"2xs",text:"Commenter",type:"valid"}),d(N,{onClick:h,class:"text-sm",rounded:"",size:"2xs",text:"Annuler",type:"abort"})])])):(e(),r("div",nt,C(n.modelValue),1))]))}}),{launchSnackbar:ke}=Ee(),rt=async(f,o,a,i)=>{const{user:t}=H(),v={start_index:o,end_index:o,content:a,editing:i};try{const h=await xe.post("/resources/"+f+"/comments",v),n=$e(h.data);return t.value&&n.author_id==t.value.id&&(n.author=t.value),n}catch(h){throw console.log("error : ",h),ke(`Error creating comment : ${h}`,"error"),h}},$e=f=>(f.updated_at=new Date(f.updated_at.split(".")[0]),f.created_at=new Date(f.created_at.split(".")[0]),f),ut=async(f,o=!0)=>{const a=o?"?author=true":"";try{return(await xe.get("/resources/"+f+"/comments"+a)).data.map(t=>$e(t))}catch(i){throw console.log("error : ",i),ke(`Error getting comments : ${i}`,"error"),i}},De=async f=>{try{const o=await xe.put("/comments/"+f.id,f);return $e(o.data)}catch(o){console.log("error : ",o),ke(`Error updating comment : ${o}`,"error")}},it=async f=>{console.log("comments : ",f),f.map(o=>De(o))};function Ce(){return{createComment:rt,getCommentsForThoughtOutput:ut,updateComment:De,batchUpdateComments:it}}const ct={class:"relative"},dt={key:0},vt=p("div",{class:"text-sm align-middle flex items-center p-2",style:{height:"50px"}}," Corriger une faute ",-1),mt={class:"flex mx-auto max-w-full"},pt={class:"w-full"},_t={key:0,class:"flex"},ft=p("div",{class:"w-6"},[p("div",{class:"rounded-full ml-4 mr-2 mt-2 h-1 w-1 bg-black"})],-1),ht=[ft],gt={class:"flex flex-wrap flex-1"},xt=["onClick","onContextmenu"],yt={key:0,style:{width:"5px"}},bt={key:1,style:{height:"25px"}},wt={key:2},kt=["onClick"],$t={key:1,class:"absolute h-full",style:{right:"-2%",width:"27%"}},Ct={key:0,style:{width:"33%"}},Rt=E({__name:"TextInterface",props:{resourceId:{},fullText:{},extComments:{default:()=>[]},editable:{type:Boolean,default:!0}},emits:["change","changeComments"],setup(f,{emit:o}){const a=f,i=s=>{console.log("selectCursorPosition letter : ",s),a.editable&&(t.value={id:s.id,char:s.char})},t=m(null),v=m([]),h=m([]),n=async()=>{let s=[{id:0,words:[{id:0,text:[]}],comments:[]}],u=0,k=0;for(var U=0;U<v.value.length;U++){v.value[U].char==`
`&&(u+=1,k=0,s.push({id:u,words:[{id:0,text:[]}],lineStyle:U<v.value.length-1?v.value[U+1].char:null,comments:[]}));const A=F.value.find(q=>q.start_index==U);A&&s[u].comments.push(A),s[u].words[k].text.push({id:U,char:v.value[U].char,comment:A}),v.value[U].char==" "&&(k+=1,s[u].words.push({id:k,text:[]}))}return s},y=s=>{s==1?F.value.forEach(u=>{t.value&&u.start_index>t.value.id&&(u.start_index+=1),t.value&&u.end_index>t.value.id&&(u.end_index+=1)}):s==-1&&F.value.forEach(u=>{t.value&&u.start_index>=t.value.id&&(u.start_index-=1),t.value&&u.end_index>=t.value.id&&(u.end_index-=1)})},l=s=>{console.log("insertChar : ",s),t.value&&(console.log("insertChar with cursor set : ",s),v.value.filter(u=>t.value&&u.id>=t.value.id+1).forEach(u=>u.id+=1),v.value.splice(t.value.id+1,0,{id:t.value.id+1,char:s}),y(1),t.value.id+=1)},c=s=>{if(console.log("Writes : ",s.key),t.value===null)return;const u=s.key;if(_.value&&u=="v"){b();return}if(u.length==1)s.preventDefault(),l(u);else if(u=="Backspace")v.value.splice(t.value.id,1),v.value.filter(k=>t.value&&k.id>t.value.id).forEach(k=>k.id-=1),y(-1),t.value.id-=1;else if(u=="Enter")l(`
`);else if(u=="ArrowRight"){let k=t.value.id;k<v.value.length-1&&i(v.value[k+1])}else if(u=="ArrowLeft"){let k=t.value.id;k>0&&i(v.value[k-1])}else u=="Control"&&(console.log("Control"),_.value=!0)},_=m(!1),b=async()=>{try{let u=await navigator.clipboard.readText();console.log("Clippedtext : ",u);for(var s=0;s<u.length;s++)l(u[s])}catch(u){console.log("Error with clippboard : ",u)}},P=s=>{s.key=="Control"&&(_.value=!1)},{createComment:J,batchUpdateComments:K}=Ce(),{isMobile:oe}=Pe(),F=m([]),G=m(null),M=async s=>{F.value=s.filter(u=>u.start_index!=null)},W=async()=>{if(console.log("Add Comment"),console.log(a.resourceId),console.log(L.value),!a.resourceId||!L.value)return;console.log("Add Comment 2");const s=await J(a.resourceId,L.value);F.value.push(s)};re(F,async(s,u)=>{console.log("Watch comments triggered : ",s),g.value&&(console.log("Comments : ",s),o("changeComments",s),G.value!==null&&clearTimeout(G.value),G.value=setTimeout(()=>K(s),1e3)),console.log(`Old comments lenght : ${u.length} new length: ${s.length}`),console.log("OldComments : ",u),console.log("NewComments : ",s),u.length===0&&s.length>0&&(console.log("Finally loading comments"),h.value=await n())},{deep:!0}),re(fe(a).extComments,async s=>{await M(s)});const X=m(!1),L=m(null),Y=m({position:"absolute","z-index":90,top:"0px",left:"0px",height:"106px",width:"260px"}),{user:le}=H(),I=(s,u)=>{s.preventDefault(),le.value&&(t.value=null,Y.value.top=`${s.layerY}px`,Y.value.left=`${s.layerX}px`,X.value=!0,L.value=u,console.log("event : ",s),console.log("Have a new right click"))},V=s=>{if(v.value=[],s===void 0||s==""){v.value=[{id:0,char:`
`}],i({id:0,char:`
`});return}for(var u=0;u<s.length;u++){const k=F.value.find(U=>U.start_index==u);v.value.push({id:u,char:s[u],comment:k})}},S=s=>s.reduce((u,k)=>u+k.char,""),g=m(!1);return te(async()=>{await M(a.extComments),await V(a.fullText),await new Promise(s=>setTimeout(s,10)),h.value=await n(),g.value=!0}),re(v,async s=>{console.log("Watch triggered : ",s),g.value&&(o("change",S(s)),h.value=await n())},{deep:!0}),(s,u)=>(e(),r("div",ct,[d(We,{text:s.fullText,class:"absolute z-10 h-6 right-2"},null,8,["text"]),g.value?(e(),r("div",{key:1,id:"main-interface",class:"relative md:p-4",tabindex:"0",onKeydown:c,onKeyup:P,onClick:u[0]||(u[0]=k=>X.value=!1)},[X.value?(e(),r("div",{key:0,class:"bg-white border-4",style:Oe(Y.value)},[p("div",{onClick:W,class:"text-sm border-b-2 flex items-center p-2",style:{height:"50px"}}," Ajouter un commentaire "),vt],4)):$("",!0),p("div",mt,[p("div",pt,[(e(!0),r(se,null,ae(h.value,(k,U)=>(e(),r("div",{key:U,class:"flex"},[k.lineStyle=="*"?(e(),r("div",_t,ht)):$("",!0),p("div",gt,[(e(!0),r(se,null,ae(k.words,(A,q)=>(e(),r("div",{key:q,class:"flex flex-wrap"},[(e(!0),r(se,null,ae(A.text,(D,ce)=>{var de;return e(),r("div",{key:ce,class:he(["border-blue-400",{"border-r-2":D.id==((de=t.value)==null?void 0:de.id),"bg-yellow-400":D.comment}]),onClick:Q=>i(D),onContextmenu:Q=>I(Q,D.id)},[D.char==" "?(e(),r("div",yt)):D.char==`
`?(e(),r("div",bt)):(D.char=="#"||D.char=="*")&&q==0?(e(),r("div",wt)):(e(),r("div",{key:3,class:he({"font-bold":k.lineStyle=="#"})},[p("div",null,C(D.char),1)],2))],42,xt)}),128))]))),128)),p("div",{class:"flex-1",onClick:A=>i(k.words.slice(-1)[0].text.slice(-1)[0])},null,8,kt)]),F.value.length>0&&!z(oe)?(e(),r("div",$t,[(e(!0),r(se,null,ae(k.comments,(A,q)=>(e(),R(ge,{key:q,class:"w-full",modelValue:A.content,"onUpdate:modelValue":D=>A.content=D,editing:A.editing,onValidate:D=>A.editing=!1,author:A.author,"created-at":A.created_at},null,8,["modelValue","onUpdate:modelValue","editing","onValidate","author","created-at"]))),128))])):$("",!0)]))),128))]),F.value.length>0&&!z(oe)?(e(),r("div",Ct)):$("",!0)])],32)):(e(),r("div",dt,[p("span",null,C(s.fullText),1)]))]))}}),It=p("hr",{class:"border-top border-zinc-400 my-4"},null,-1),Vt=p("div",{class:"text-xs italic"},"Raison de la lecture",-1),Tt=E({__name:"SeeThoughtInput",props:{thoughtInput:{}},setup(f){const o=f,{getUserById:a,user:i}=H(),t=m(null),v=B(()=>i.value?o.thoughtInput.interaction_user_id===i.value.id:!1);return te(async()=>{o.thoughtInput.interaction_user_id&&(t.value=await a(o.thoughtInput.interaction_user_id))}),(h,n)=>(e(),r("div",null,[d(Ao,{id:h.thoughtInput.resource_id,"second-level":""},null,8,["id"]),It,Vt,d(Rt,{"full-text":h.thoughtInput.interaction_comment,editable:v.value},null,8,["full-text","editable"])]))}}),Ut={class:"w-full md:w-96"},At={key:0,class:"text-xs italic mb-2 bg-white"},Dt={class:"flex flex-wrap"},Ft={key:1,class:"text-2xs italic ml-2"},St={key:2,class:"ml-auto m-1 w-1/3"},Bt={key:0,class:"border shadow-lg rounded p-4 md:w-96 bg-white"},Et={class:"flex"},Ot=["src"],Pt={class:"flex flex-wrap w-full",style:{"margin-top":"-8px"}},Lt={class:"text-2xs"},Nt={class:"flex flex-wrap"},qt={key:0,class:"text-2xs italic"},jt=E({__name:"ThoughtInputCard",props:{contextualResource:{},isDisabled:{type:Boolean,default:!1}},setup(f){const o=f,{getUserById:a}=H(),{getAuthorInteractionForResource:i}=we(),t=m(null),v=m(null),h=m(null);te(async()=>{o.contextualResource.user_id&&(h.value=await a(o.contextualResource.user_id)),o.contextualResource.resource&&(v.value=await i(o.contextualResource.resource.id)),v.value&&(t.value=await a(v.value.interaction_user_id))});const n=l=>l?l.toLocaleString("fr-FR",{hour:"numeric",weekday:"short",day:"numeric",month:"short",year:"2-digit"}):"",y=l=>l.length>200?l.slice(0,150)+"...":l;return(l,c)=>{const _=Te("router-link");return e(),r("div",Ut,[l.contextualResource.context_comment?(e(),r("div",At,[p("div",null,C(l.contextualResource.context_comment),1),p("div",Dt,[h.value?(e(),R(_,{key:0,to:"/users/"+h.value.id,class:"text-2xs underline"},{default:O(()=>[ie(C(h.value.first_name)+" "+C(h.value.last_name),1)]),_:1},8,["to"])):$("",!0),l.contextualResource.date?(e(),r("div",Ft,C(n(l.contextualResource.date)),1)):$("",!0),l.contextualResource.progress?(e(),r("div",St,[d(Ue,{"progress-value":l.contextualResource.progress},null,8,["progress-value"])])):$("",!0)])])):$("",!0),l.contextualResource.resource?(e(),R(Le(l.isDisabled?"span":"vue-router"),{key:1,to:"/resources/"+l.contextualResource.resource.id+"?tab=ctnt"},{default:O(()=>[l.contextualResource.resource?(e(),r("div",Bt,[p("div",Et,[l.contextualResource.resource?(e(),r("img",{key:0,class:"w-8 h-fit mr-4",src:l.contextualResource.resource.image_url},null,8,Ot)):$("",!0),p("div",null,[p("div",null,C(l.contextualResource.resource.title)+" "+C(l.contextualResource.resource.subtitle),1),p("div",Pt,[t.value?(e(),R(_,{key:0,to:"/users/"+t.value.id,class:"text-2xs underline"},{default:O(()=>[ie(C(t.value.first_name)+" "+C(t.value.last_name),1)]),_:1},8,["to"])):$("",!0)]),p("div",Lt,C(y(l.contextualResource.resource.comment)),1)])]),p("div",Nt,[l.contextualResource.date?(e(),r("div",qt,C(n(l.contextualResource.resourcedate)),1)):$("",!0)])])):$("",!0)]),_:1},8,["to"])):$("",!0)])}}}),zt={class:"w-fit"},Mt=E({__name:"ThoughtInputCardWithPopup",props:{thoughtInput:{},usageReason:{},isDisabled:{type:Boolean,default:!1}},setup(f){const o=m(!1);return(a,i)=>(e(),r("div",zt,[d(me,{open:o.value,onClose:i[0]||(i[0]=t=>o.value=!1)},{default:O(()=>[d(Tt,{"thought-input":a.thoughtInput,"usage-reason":a.usageReason},null,8,["thought-input","usage-reason"])]),_:1},8,["open"]),d(jt,{class:"md:w-96","contextual-resource":a.thoughtInput,"is-disabled":a.isDisabled},null,8,["contextual-resource","is-disabled"])]))}}),Wt={class:"relative max-w-full"},Ht={key:0,class:"absolute md:border h-full start-1/2 -z-10"},ue=E({__name:"ThoughtInputsList",props:{contextualResources:{},center:{type:Boolean,default:!1},linksDisabled:{type:Boolean,default:!1}},emits:["select"],setup(f,{emit:o}){const a=t=>t.sort((v,h)=>+(h.date>v.date)),i=t=>{console.log("Select"),o("select",t)};return(t,v)=>(e(),r("div",Wt,[t.center?$("",!0):(e(),r("div",Ht)),(e(!0),r(se,null,ae(a(t.contextualResources),(h,n)=>(e(),R(Mt,{key:h.id,class:he(["mb-4 md:mb-1 mx-auto max-w-full max-w-fit p-1",{"md:ml-0":n%2==0&&!t.center,"md:mr-0":!t.center}]),"thought-input":h,onClick:y=>i(h),"is-disabled":t.linksDisabled},null,8,["class","thought-input","onClick","is-disabled"]))),128))]))}}),Jt={key:0,class:"mb-4"},Kt={key:1},Gt={key:1},Xt={key:2},Yt={class:"flex flex-row-reverse"},Ie=E({__name:"CreateResourceRelationForm",props:{targetResource:{},originResource:{}},emits:["close","refresh"],setup(f,{emit:o}){const a=f,{user:i}=H(),t=m(),v=I=>{console.log("Event : ",I),t.value=I},h=m([{text:"Externes",value:"extr"},{text:"Internes",value:"artl"},{text:"Problème",value:"pblm"}]),n=m([{text:"Biblio",value:"bibl"},{text:"Résumé",value:"sumr"},{text:"Sujet principal",value:"main"},{text:"Evocation",value:"mino"}]),y=m([]),l=m(null),c=m([]),_=m([]),b=m([]),P=m(""),J=m(""),{createResourceRelation:K}=Ae(),{getResources:oe}=we(),{getArticles:F}=Be(),{getProblems:G}=Ke(),M=B(()=>y.value.map(I=>({resource:I.resource}))),W=I=>I.map(V=>({resource:V})),X=B(()=>({extr:W(c.value),artl:W(_.value),pblm:W(b.value)})),L=async()=>{if(console.log("create"),!l.value)return;const I={target_resource_id:a.targetResource?a.targetResource.id:l.value.id,origin_resource_id:a.originResource?a.originResource.id:l.value.id,relation_comment:P.value,relation_type:J.value};await K(I),o("refresh"),o("close")},{getUserThoughtInputs:Y}=ze(),le=I=>{l.value=I.resource};return te(async()=>{!i.value||!i.value.id||(a.targetResource&&(y.value=await Y(i.value.id)),a.originResource&&(c.value=await oe(),_.value=await F({author:!0}),b.value=await G()))}),(I,V)=>(e(),r("div",null,[z(i)?(e(),r("div",Jt," Nouvelle relation entre ressources par "+C(z(i).first_name)+" "+C(z(i).last_name),1)):$("",!0),l.value?(e(),r("div",Xt,[d(ne,{class:"m-4",label:"Type de lien",choices:n.value,modelValue:J.value,"onUpdate:modelValue":V[2]||(V[2]=S=>J.value=S)},null,8,["choices","modelValue"]),d(ye,{class:"m-4",label:"Pourquoi ajouter cet élément ?",modelValue:P.value,"onUpdate:modelValue":V[3]||(V[3]=S=>P.value=S)},null,8,["modelValue"]),p("div",Yt,[d(N,{type:"valid",onClick:L,text:"Ajouter"}),d(N,{type:"abort",onClick:V[4]||(V[4]=S=>o("close")),text:"Annuler",class:"mr-1"})])])):(e(),r("div",Kt,[I.targetResource?(e(),R(ue,{key:0,"contextual-resources":M.value,center:"","links-disabled":"",onSelect:V[0]||(V[0]=S=>le(S))},null,8,["contextual-resources"])):(e(),r("div",Gt,[p("div",null,[ie(" Choisir une ressource cible "),d(Ve,{center:"",choices:h.value,default:"pblm",onUpdate:v},null,8,["choices"]),d(ue,{"contextual-resources":X.value[t.value]||[],center:"",onSelect:V[1]||(V[1]=S=>le(S)),"links-disabled":""},null,8,["contextual-resources"])])]))]))]))}}),Qt=E({__name:"CommentsThread",props:{resourceId:{}},setup(f){const o=f,{user:a}=H(),i=m([]),{createComment:t,getCommentsForThoughtOutput:v}=Ce(),h=async()=>{console.log("Comment thread"),console.log("Props id : ",o.resourceId),i.value=await v(o.resourceId)},n=B(()=>i.value.filter(c=>!c.start_index).sort((c,_)=>c.created_at-_.created_at)),y=m(""),l=async()=>{await t(o.resourceId,null,y.value,!1),y.value="",await h()};return te(async()=>await h()),(c,_)=>(e(),r("div",null,[(e(!0),r(se,null,ae(n.value,b=>(e(),R(ge,{key:b.id,class:"w-full",modelValue:b.content,"onUpdate:modelValue":P=>b.content=P,editing:b.editing,onValidate:P=>b.editing=!1,author:b.author,"created-at":b.created_at},null,8,["modelValue","onUpdate:modelValue","editing","onValidate","author","created-at"]))),128)),d(ge,{class:"w-full",modelValue:y.value,"onUpdate:modelValue":_[0]||(_[0]=b=>y.value=b),editing:!0,onValidate:l,author:z(a),"created-at":null},null,8,["modelValue","author"])]))}}),Zt={class:"flex flex-wrap"},eo={class:"flex flex-row-reverse"},to=E({__name:"CreateInteraction",props:{resource:{}},emits:["close","refresh"],setup(f,{emit:o}){const a=f,i=m([{text:"Lecture / Visionage",value:"inpt"},{text:"Envie",value:"wish"}]),{newInteraction:t,createInteractionForResource:v}=be(),{user:h}=H(),n=m(t());te(()=>{n.value.interaction_type||(n.value.interaction_type="inpt")});const y=()=>{n.value.resource_id=a.resource.id,n.value.interaction_user_id=h.value.id,v(a.resource.id,n.value),o("refresh"),l()},l=()=>o("close");return(c,_)=>(e(),r("div",null,[p("div",null,"Nouvelle interaction, avec la ressource : "+C(c.resource.title),1),p("div",Zt,[d(ee,{label:"Avancement de l'ouvrage",class:"my-auto",modelValue:n.value.interaction_progress,"onUpdate:modelValue":_[0]||(_[0]=b=>n.value.interaction_progress=b),type:"number"},null,8,["modelValue"]),d(ne,{label:"Type d'interaction",class:"m-4 w-full md:w-5/12 md:ml-auto",choices:i.value,modelValue:n.value.interaction_type,"onUpdate:modelValue":_[1]||(_[1]=b=>n.value.interaction_type=b)},null,8,["choices","modelValue"])]),d(ee,{label:"Date de lecture",modelValue:n.value.interaction_date,"onUpdate:modelValue":_[2]||(_[2]=b=>n.value.interaction_date=b),type:"date"},null,8,["modelValue"]),d(ye,{label:"Pourquoi s'y être interessé ?",modelValue:n.value.interaction_comment,"onUpdate:modelValue":_[3]||(_[3]=b=>n.value.interaction_comment=b)},null,8,["modelValue"]),p("div",eo,[d(N,{onClick:y,class:"m-4",text:"Valider",type:"valid"}),d(N,{onClick:l,class:"m-4",text:"Annuler",type:"abort"})])]))}}),oo=E({__name:"DateField",props:{date:{}},setup(f){const o=f,a=B(()=>new Date(o.date).toLocaleDateString("fr-FR",{day:"numeric",month:"short",year:"numeric"}));return(i,t)=>(e(),r("div",null,C(a.value),1))}}),lo={class:"flex flex-col"},so={class:"block text-2xs text-slate-800"},ao=["value","placeholder"],no=E({__name:"NumberInput",props:{label:{},modelValue:{},placeholder:{}},emits:["update:modelValue","input"],setup(f,{emit:o}){const a=i=>{o("update:modelValue",i.target.value),o("input",i.target.value)};return(i,t)=>(e(),r("div",lo,[p("label",so,C(i.label),1),p("input",{class:"border border-neutral-400 block h-full w-full rounded-md border-2 p-1 pl-2 text-xs",type:"number",value:i.modelValue,placeholder:i.placeholder,onInput:t[0]||(t[0]=v=>a(v))},null,40,ao)]))}}),ro={class:"grid grid-cols-4 gap-y-2 gap-x-4 auto-rows-auto"},uo=E({__name:"ArticleForm",props:{article:{}},emits:["change"],setup(f,{emit:o}){const a=f,i=m([{text:"Terminé",value:"fnsh"},{text:"Relecture",value:"rvew"},{text:"Idée",value:"idea"}]),t=m([{text:"Livre",value:"book"},{text:"Fiche de lecture",value:"shet"},{text:"Article de média",value:"natc"},{text:"Article de recherche",value:"ratc"},{text:"Film",value:"movi"},{text:"Podcast",value:"pcst"}]),{categories:v}=Ne(),h=B(()=>v.value.map(y=>({text:y.display_name,value:y.id}))),n=(y,l)=>{let c={...a.article};c[y]=l,c.is_external&&(c.maturing_state="fnsh"),console.log("Article : ",c),o("change",c)};return(y,l)=>(e(),r("div",ro,[d(ee,{class:"col-span-4",label:"Titre",modelValue:y.article.title,"onUpdate:modelValue":l[0]||(l[0]=c=>n("title",c))},null,8,["modelValue"]),d(ee,{class:"col-span-4",label:"Sous-titre",modelValue:y.article.subtitle,"onUpdate:modelValue":l[1]||(l[1]=c=>n("subtitle",c))},null,8,["modelValue"]),d(ee,{class:"col-span-4 md:col-span-2",label:"Lien contenu externe",modelValue:y.article.external_content_url,"onUpdate:modelValue":l[2]||(l[2]=c=>n("external_content_url",c))},null,8,["modelValue"]),d(ee,{class:"col-span-4 md:col-span-2",label:"Lien image",modelValue:y.article.image_url,"onUpdate:modelValue":l[3]||(l[3]=c=>n("image_url",c))},null,8,["modelValue"]),d(ne,{label:"Catégorie",class:"col-span-4 md:col-span-1",choices:h.value,"model-value":y.article.category_id,"onUpdate:modelValue":l[4]||(l[4]=c=>n("category_id",c))},null,8,["choices","model-value"]),d(ne,{label:"Type de ressource",class:"col-span-4 md:col-span-1",choices:t.value,"onUpdate:modelValue":l[5]||(l[5]=c=>n("resource_type",c)),"model-value":y.article.resource_type},null,8,["choices","model-value"]),d(ne,{label:"Ressource externe",class:"col-span-4 md:col-span-1",choices:[{text:"Oui",value:!0},{text:"Non",value:!1}],"onUpdate:modelValue":l[6]||(l[6]=c=>n("is_external",JSON.parse(c))),"model-value":y.article.is_external},null,8,["model-value"]),d(ne,{label:"Stade d'écriture",class:"col-span-4 md:col-span-1",choices:i.value,"model-value":y.article.maturing_state,"onUpdate:modelValue":l[7]||(l[7]=c=>n("maturing_state",c))},null,8,["choices","model-value"])]))}}),io={class:"grid grid-cols-3 gap-4"},co=E({__name:"ResourceAuthorPicker",props:{interaction:{},resourceId:{}},emits:["update"],setup(f,{emit:o}){const a=f,i=B(()=>{var c;return(c=a.interaction)==null?void 0:c.interaction_user_id}),{createInteractionForResource:t,newInteraction:v,createInteraction:h,updateInteraction:n}=be(),y=async c=>{if(console.log(`newUser : ${JSON.stringify(c)}`),a.interaction){const _={...a.interaction};_.interaction_user_id=c,console.log("newUserid : ",c.id),console.log(`Interaction payload : ${JSON.stringify(_)}`),await n(a.interaction.id,_),o("update")}else{console.log("create interaction");const _=v();_.interaction_user_id=c,_.resource_id=a.resourceId,await t(a.resourceId,_),o("update")}},l=async c=>{await n(a.interaction.id,c),o("update")};return(c,_)=>(e(),r("div",io,[d(Je,{"model-value":i.value,"onUpdate:modelValue":_[0]||(_[0]=b=>y(b))},null,8,["model-value"]),c.interaction?(e(),R(ee,{key:0,class:"text-2xs",label:"Date d'écriture","model-value":c.interaction.interaction_date?c.interaction.interaction_date.split("T")[0]:null,"onUpdate:modelValue":_[1]||(_[1]=b=>l({...c.interaction,interaction_date:b})),type:"date"},null,8,["model-value"])):$("",!0),c.interaction?(e(),R(no,{key:1,class:"",label:"Progression",modelValue:c.interaction.interaction_progress,"onUpdate:modelValue":_[2]||(_[2]=b=>l({...c.interaction,interaction_progress:b}))},null,8,["modelValue"])):$("",!0)]))}}),vo={key:0,class:"text-center text-2xl pt-10"},mo={key:1},po={key:0},_o={class:"my-8"},fo=["src"],ho={class:"text-3xl my-3 font-mplus md:text-center text-left"},go={class:"md:text-center text-left"},xo={class:"md:text-center text-left"},yo={class:"md:flex my-8"},bo=["href"],wo={key:1,class:"my-2 flex flex-col"},ko={class:"flex flex-row-reverse mb-4"},$o=p("hr",{class:"border-top border-zinc-400 my-4"},null,-1),Co={key:2},Ro=p("div",{class:"text-xs italic"},"Contenu",-1),Io={key:3},Vo={key:4},To={key:5},Uo={class:"fixed right-3 bottom-5"},Ao=E({__name:"ResourceComponent",props:{resourceId:{},secondLevel:{type:Boolean}},setup(f){const o=f,a=qe(),i=B(()=>o.secondLevel?"popup_tab":"tab"),t=B(()=>[{text:"Contenu",value:"ctnt"},{text:"Biblio",value:"bbli",count:c.value.length},{text:"Sujets",value:"pblm",count:M.value.length},{text:"Interactions",value:"inpt",count:K.value.length}]),v=m(!0),h=m(a.query[i.value]&&typeof a.query[i.value]=="string"?a.query[i.value]:"ctnt"),n=m(a.query[i.value]);re(()=>a.query[i.value],x=>{console.log("new route query",x),typeof x=="string"&&(n.value=x)});const{getResourceRelationsForResource:y,getUsagesForResource:l}=Ae(),c=m([]),_=m(!1),b=m(!1),P=async()=>{c.value=await y(fe(o).resourceId.value)},J=B(()=>c.value.map(x=>({resource:x.origin_resource,date:x.created_at,user_id:x.user_id,context_comment:x.relation_comment,progress:null}))),K=m([]),{getInteractionsForResource:oe}=be(),F=async()=>{K.value=await oe(o.resourceId)},G=B(()=>K.value.map(x=>({resource:null,date:x.interaction_date,user_id:x.interaction_user_id,context_comment:x.interaction_comment,progress:x.interaction_progress}))),M=m([]),W=async()=>{M.value=await l(o.resourceId)},X=B(()=>M.value.map(x=>({resource:x.target_resource,date:x.created_at,user_id:x.user_id,context_comment:x.relation_comment,progress:null}))),L=m(!1),{newResource:Y,getResource:le,updateResource:I,getAuthorInteractionForResource:V}=we(),S=m(null),g=m(Y()),s=je();re(()=>a.query.editing,x=>{console.log("Editing : ",x),u.value=x==="false"?!1:!!x});const u=m(!1),k=x=>{s.push({query:{editing:x.toString()}})},U=()=>{!g.value||!g.value.id||(g.value.publishing_state="pbsh",I(g.value.id,g.value))},A=()=>{!g.value||!g.value.id||(g.value.publishing_state="drft",I(g.value.id,g.value))},q=(x,w)=>{g.value=w,S.value!==null&&clearTimeout(S.value),S.value=setTimeout(async()=>{try{await I(x,g.value)}catch(pe){console.log("An error : ",pe)}},1e3)},D=x=>{x!=`
`&&q(fe(o).resourceId.value,{...g.value,content:x})},{user:ce,getUserById:de}=H(),Q=B(()=>g.value.is_external?!0:ce.value?Z.value?Z.value.id==ce.value.id:!0:!1),Z=m(null),j=m(null),ve=m(!1),Fe=async()=>{j.value=await V(o.resourceId)},{getCommentsForThoughtOutput:Se}=Ce(),Re=m([]);return te(async()=>{L.value=!1,g.value=await le(o.resourceId),L.value=!0,await P(),await F(),await W(),Re.value=await Se(o.resourceId),j.value=await V(o.resourceId),j.value&&(Z.value=await de(j.value.interaction_user_id));const x=a.query.editing;u.value=x==="false"?!1:!!x}),(x,w)=>{const pe=Te("router-link");return e(),r("div",null,[L.value?(e(),r("div",mo,[u.value?(e(),r("div",wo,[d(uo,{article:g.value,class:"",onChange:w[0]||(w[0]=T=>q(g.value.id,T))},null,8,["article"]),d(co,{class:"my-2",interaction:j.value,"resource-id":x.resourceId,onChange:Fe},null,8,["interaction","resource-id"]),p("div",ko,[d(N,{class:"ml-2",onClick:w[1]||(w[1]=T=>k(!1)),type:"valid",text:"Preview"},{default:O(()=>[ie("Ok")]),_:1}),g.value.publishing_state=="drft"?(e(),R(N,{key:0,class:"ml-2",onClick:U,type:"valid",text:"Publier"})):(e(),R(N,{key:1,class:"ml-2",onClick:A,type:"abort",text:"Dépublier"})),d(N,{class:"ml-2",onClick:w[2]||(w[2]=T=>v.value=!v.value),type:"valid",text:v.value?"Text brut":"Editeur"},null,8,["text"])])])):(e(),r("div",po,[p("div",_o,[p("img",{src:g.value.image_url,class:"border border-slate-300 dark:border-zinc-700 rounded-xl ml-auto mr-auto",style:{"max-height":"20rem"}},null,8,fo)]),p("h1",ho,C(g.value.title),1),p("div",go,C(g.value.subtitle),1),p("div",xo,[Z.value?(e(),R(pe,{key:0,to:"/users/"+Z.value.id,class:"text-sm underline"},{default:O(()=>[ie(C(Z.value.first_name)+" "+C(Z.value.last_name),1)]),_:1},8,["to"])):$("",!0),j.value?(e(),R(oo,{key:1,date:j.value.interaction_date},null,8,["date"])):$("",!0)]),p("div",yo,[j.value?(e(),R(Ue,{key:0,"progress-value":j.value.interaction_progress,class:"m-2 w-1/3"},null,8,["progress-value"])):$("",!0),g.value.external_content_url?(e(),r("a",{key:1,class:"ml-auto underline",href:g.value.external_content_url,target:"_blank"}," Lien ressource externe ",8,bo)):$("",!0)])])),p("div",null,[u.value?$("",!0):(e(),R(Ve,{key:0,choices:t.value,default:h.value,"url-key":i.value,url:""},null,8,["choices","default","url-key"]))]),$o,n.value=="ctnt"?(e(),r("div",Co,[Ro,L.value&&!g.value.is_local_draft&&v.value?(e(),R(He,{key:0,class:"min-h-fit","ext-comments":Re.value,"resource-id":g.value.id,text:g.value.content,editable:Q.value,onChange:w[3]||(w[3]=T=>D(T))},null,8,["ext-comments","resource-id","text","editable"])):(e(),R(ye,{key:1,class:"h-96",label:"Contenu",modelValue:g.value.content,"onUpdate:modelValue":w[4]||(w[4]=T=>D(T))},null,8,["modelValue"])),d(Qt,{class:"mt-6","resource-id":x.resourceId},null,8,["resource-id"])])):n.value=="bbli"?(e(),r("div",Io,[d(me,{open:_.value,onClose:w[6]||(w[6]=T=>_.value=!1)},{default:O(()=>[d(Ie,{onRefresh:P,onClose:w[5]||(w[5]=T=>_.value=!1),"target-resource":g.value},null,8,["target-resource"])]),_:1},8,["open"]),p("div",{onClick:w[7]||(w[7]=T=>_.value=!0),class:"text-sm italic underline"}," Ajouter une référence "),d(ue,{"contextual-resources":J.value},null,8,["contextual-resources"])])):n.value=="pblm"?(e(),r("div",Vo,[d(ue,{"contextual-resources":X.value},null,8,["contextual-resources"])])):n.value=="inpt"?(e(),r("div",To,[d(ue,{"contextual-resources":G.value},null,8,["contextual-resources"])])):$("",!0),p("div",Uo,[Q.value?(e(),R(_e,{key:0,title:"Modifier",onClick:w[8]||(w[8]=T=>k(!0))},{default:O(()=>[d(z(Me),{class:"m-1"})]),_:1})):$("",!0),Q.value?(e(),R(_e,{key:1,class:"mt-2",color:"red",title:"Marquer comme lu",onClick:w[9]||(w[9]=T=>ve.value=!0)},{default:O(()=>[d(z(Ge),{class:"m-1"})]),_:1})):$("",!0),d(me,{open:ve.value,onClose:w[11]||(w[11]=T=>ve.value=!1)},{default:O(()=>[d(to,{onRefresh:F,onClose:w[10]||(w[10]=T=>ve.value=!1),resource:g.value},null,8,["resource"])]),_:1},8,["open"]),Q.value?(e(),R(_e,{key:2,class:"mt-2",color:"green",title:"Relier à d'autres ressources",onClick:w[12]||(w[12]=T=>b.value=!0)},{default:O(()=>[d(z(Xe),{class:"m-1"})]),_:1})):$("",!0),d(me,{open:b.value,onClose:w[14]||(w[14]=T=>b.value=!1)},{default:O(()=>[d(Ie,{onRefresh:W,onClose:w[13]||(w[13]=T=>b.value=!1),"origin-resource":g.value},null,8,["origin-resource"])]),_:1},8,["open"])])])):(e(),r("div",vo,"Loading..."))])}}});export{Ao as _,Tt as a,ue as b};
