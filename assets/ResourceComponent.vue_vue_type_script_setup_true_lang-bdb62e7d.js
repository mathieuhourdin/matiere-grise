import{_ as Ue,u as Oe}from"./useArticle-0486585e.js";import{_ as ge}from"./RoundLinkButton.vue_vue_type_style_index_0_lang-4794eede.js";import{o as e,f as r,a as v,d as E,h as B,m as C,t as $,i as d,q as be,A as Pe,p as H,b as p,j as ue,B as pe,e as ee,C as Le,F as le,g as se,n as j,D as xe,c as R,y as Ne,r as Ae,w as O,l as ce,E as qe,_ as ae,G as ze,u as je,k as Me}from"./index-87965c5e.js";import{_ as q}from"./ActionButton.vue_vue_type_script_setup_true_lang-01794496.js";import{_ as _e,a as fe,u as We,r as He}from"./useThoughtInputs-630fa7e6.js";import{_ as Je,a as Ve}from"./SelectionTextInterface.vue_vue_type_script_setup_true_lang-fe42bbf5.js";import{_ as Z}from"./TextInput.vue_vue_type_script_setup_true_lang-7866759b.js";import{u as we}from"./useInteraction-50898c02.js";import"./SelectionTextInterface.vue_vue_type_style_index_0_lang-e8ecb4bc.js";import{_ as De}from"./ProgressBar.vue_vue_type_script_setup_true_lang-01378c85.js";import{_ as Ke}from"./UserPicker.vue_vue_type_script_setup_true_lang-46d348ac.js";import{u as ke}from"./useResource-ce9e204a.js";import{u as Fe}from"./useResourceRelations-ce7cbcc2.js";import{u as Ge}from"./useProblem-577050be.js";function Xe(f,o){return e(),r("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true"},[v("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M9 8.25H7.5a2.25 2.25 0 00-2.25 2.25v9a2.25 2.25 0 002.25 2.25h9a2.25 2.25 0 002.25-2.25v-9a2.25 2.25 0 00-2.25-2.25H15M9 12l3 3m0 0l3-3m-3 3V2.25"})])}function Ye(f,o){return e(),r("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true"},[v("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M7.217 10.907a2.25 2.25 0 100 2.186m0-2.186c.18.324.283.696.283 1.093s-.103.77-.283 1.093m0-2.186l9.566-5.314m-9.566 7.5l9.566 5.314m0 0a2.25 2.25 0 103.935 2.186 2.25 2.25 0 00-3.935-2.186zm0-12.814a2.25 2.25 0 103.933-2.185 2.25 2.25 0 00-3.933 2.185z"})])}const Qe={class:"bg-slate-100 border p-1 m-1 rounded shadow-xl"},Ze={class:"flex"},et={key:0,class:"text-xs mt-0.5 mb-1 font-bold flex"},tt=["src"],ot={class:"my-auto"},lt={class:"text-2xs italic ml-auto mr-1 my-auto"},st={key:0},at=["value"],nt={class:"flex"},rt={key:1,class:"text-xs mt-0.5"},ye=E({__name:"CommentCard",props:{editing:{type:Boolean},modelValue:{},author:{},createdAt:{}},emits:["update:modelValue","validate","abort"],setup(f,{emit:o}){const a=f,i=B(()=>a.createdAt?a.createdAt.toLocaleString("fr-FR",{hour:"numeric",weekday:"short",day:"numeric",month:"short",year:"2-digit"}):""),t=n=>{o("update:modelValue",n.target.value)},m=()=>{o("validate")},h=()=>{o("abort")};return(n,b)=>(e(),r("div",Qe,[v("div",Ze,[n.author?(e(),r("div",et,[n.author.profile_picture_url?(e(),r("img",{key:0,class:"h-5 w-5 rounded-full mr-1",src:n.author.profile_picture_url},null,8,tt)):C("",!0),v("div",ot,$(n.author.first_name)+" "+$(n.author.last_name),1)])):C("",!0),v("div",lt,$(i.value),1)]),n.editing?(e(),r("div",st,[v("textarea",{class:"w-full text-xs rounded-xl p-2",value:n.modelValue,onInput:t},null,40,at),v("div",nt,[d(q,{onClick:m,class:"text-sm",rounded:"",size:"2xs",text:"Commenter",type:"valid"}),d(q,{onClick:h,class:"text-sm",rounded:"",size:"2xs",text:"Annuler",type:"abort"})])])):(e(),r("div",rt,$(n.modelValue),1))]))}}),{launchSnackbar:Ce}=Pe(),ut=async(f,o,a,i)=>{const{user:t}=H(),m={start_index:o,end_index:o,content:a,editing:i};try{const h=await be.post("/resources/"+f+"/comments",m),n=$e(h.data);return t.value&&n.author_id==t.value.id&&(n.author=t.value),n}catch(h){throw console.log("error : ",h),Ce(`Error creating comment : ${h}`,"error"),h}},$e=f=>(f.updated_at=new Date(f.updated_at.split(".")[0]),f.created_at=new Date(f.created_at.split(".")[0]),f),it=async(f,o=!0)=>{const a=o?"?author=true":"";try{return(await be.get("/resources/"+f+"/comments"+a)).data.map(t=>$e(t))}catch(i){throw console.log("error : ",i),Ce(`Error getting comments : ${i}`,"error"),i}},Se=async f=>{try{const o=await be.put("/comments/"+f.id,f);return $e(o.data)}catch(o){console.log("error : ",o),Ce(`Error updating comment : ${o}`,"error")}},ct=async f=>{console.log("comments : ",f),f.map(o=>Se(o))};function Re(){return{createComment:ut,getCommentsForThoughtOutput:it,updateComment:Se,batchUpdateComments:ct}}const dt={class:"relative"},vt={key:0},mt=v("div",{class:"text-sm align-middle flex items-center p-2",style:{height:"50px"}}," Corriger une faute ",-1),pt={class:"flex mx-auto max-w-full"},_t={class:"w-full"},ft={key:0,class:"flex"},ht=v("div",{class:"w-6"},[v("div",{class:"rounded-full ml-4 mr-2 mt-2 h-1 w-1 bg-black"})],-1),gt=[ht],xt={class:"flex flex-wrap flex-1"},yt=["onClick","onContextmenu"],bt={key:0,style:{width:"5px"}},wt={key:1,style:{height:"25px"}},kt={key:2},Ct=["onClick"],$t={key:1,class:"absolute h-full",style:{right:"-2%",width:"27%"}},Rt={key:0,style:{width:"33%"}},It=E({__name:"TextInterface",props:{resourceId:{},fullText:{},extComments:{default:()=>[]},editable:{type:Boolean,default:!0}},emits:["change","changeComments"],setup(f,{emit:o}){const a=f,i=s=>{console.log("selectCursorPosition letter : ",s),a.editable&&(t.value={id:s.id,char:s.char})},t=p(null),m=p([]),h=p([]),n=async()=>{let s=[{id:0,words:[{id:0,text:[]}],comments:[]}],u=0,k=0;for(var U=0;U<m.value.length;U++){m.value[U].char==`
`&&(u+=1,k=0,s.push({id:u,words:[{id:0,text:[]}],lineStyle:U<m.value.length-1?m.value[U+1].char:null,comments:[]}));const A=F.value.find(N=>N.start_index==U);A&&s[u].comments.push(A),s[u].words[k].text.push({id:U,char:m.value[U].char,comment:A}),m.value[U].char==" "&&(k+=1,s[u].words.push({id:k,text:[]}))}return s},b=s=>{s==1?F.value.forEach(u=>{t.value&&u.start_index>t.value.id&&(u.start_index+=1),t.value&&u.end_index>t.value.id&&(u.end_index+=1)}):s==-1&&F.value.forEach(u=>{t.value&&u.start_index>=t.value.id&&(u.start_index-=1),t.value&&u.end_index>=t.value.id&&(u.end_index-=1)})},l=s=>{console.log("insertChar : ",s),t.value&&(console.log("insertChar with cursor set : ",s),m.value.filter(u=>t.value&&u.id>=t.value.id+1).forEach(u=>u.id+=1),m.value.splice(t.value.id+1,0,{id:t.value.id+1,char:s}),b(1),t.value.id+=1)},c=s=>{if(console.log("Writes : ",s.key),t.value===null)return;const u=s.key;if(_.value&&u=="v"){w();return}if(u.length==1)s.preventDefault(),l(u);else if(u=="Backspace")m.value.splice(t.value.id,1),m.value.filter(k=>t.value&&k.id>t.value.id).forEach(k=>k.id-=1),b(-1),t.value.id-=1;else if(u=="Enter")l(`
`);else if(u=="ArrowRight"){let k=t.value.id;k<m.value.length-1&&i(m.value[k+1])}else if(u=="ArrowLeft"){let k=t.value.id;k>0&&i(m.value[k-1])}else u=="Control"&&(console.log("Control"),_.value=!0)},_=p(!1),w=async()=>{try{let u=await navigator.clipboard.readText();console.log("Clippedtext : ",u);for(var s=0;s<u.length;s++)l(u[s])}catch(u){console.log("Error with clippboard : ",u)}},P=s=>{s.key=="Control"&&(_.value=!1)},{createComment:J,batchUpdateComments:K}=Re(),{isMobile:te}=Ne(),F=p([]),G=p(null),M=async s=>{F.value=s.filter(u=>u.start_index!=null)},W=async()=>{if(console.log("Add Comment"),console.log(a.resourceId),console.log(L.value),!a.resourceId||!L.value)return;console.log("Add Comment 2");const s=await J(a.resourceId,L.value);F.value.push(s)};ue(F,async(s,u)=>{console.log("Watch comments triggered : ",s),g.value&&(console.log("Comments : ",s),o("changeComments",s),G.value!==null&&clearTimeout(G.value),G.value=setTimeout(()=>K(s),1e3)),console.log(`Old comments lenght : ${u.length} new length: ${s.length}`),console.log("OldComments : ",u),console.log("NewComments : ",s),u.length===0&&s.length>0&&(console.log("Finally loading comments"),h.value=await n())},{deep:!0}),ue(pe(a).extComments,async s=>{await M(s)});const X=p(!1),L=p(null),Y=p({position:"absolute","z-index":90,top:"0px",left:"0px",height:"106px",width:"260px"}),{user:oe}=H(),V=(s,u)=>{s.preventDefault(),oe.value&&(t.value=null,Y.value.top=`${s.layerY}px`,Y.value.left=`${s.layerX}px`,X.value=!0,L.value=u,console.log("event : ",s),console.log("Have a new right click"))},T=s=>{if(m.value=[],s===void 0||s==""){m.value=[{id:0,char:`
`}],i({id:0,char:`
`});return}for(var u=0;u<s.length;u++){const k=F.value.find(U=>U.start_index==u);m.value.push({id:u,char:s[u],comment:k})}},S=s=>s.reduce((u,k)=>u+k.char,""),g=p(!1);return ee(async()=>{await M(a.extComments),await T(a.fullText),await new Promise(s=>setTimeout(s,10)),h.value=await n(),g.value=!0}),ue(m,async s=>{console.log("Watch triggered : ",s),g.value&&(o("change",S(s)),h.value=await n())},{deep:!0}),(s,u)=>(e(),r("div",dt,[d(Je,{text:s.fullText,class:"absolute z-10 h-6 right-2"},null,8,["text"]),g.value?(e(),r("div",{key:1,id:"main-interface",class:"relative md:p-4",tabindex:"0",onKeydown:c,onKeyup:P,onClick:u[0]||(u[0]=k=>X.value=!1)},[X.value?(e(),r("div",{key:0,class:"bg-white border-4",style:Le(Y.value)},[v("div",{onClick:W,class:"text-sm border-b-2 flex items-center p-2",style:{height:"50px"}}," Ajouter un commentaire "),mt],4)):C("",!0),v("div",pt,[v("div",_t,[(e(!0),r(le,null,se(h.value,(k,U)=>(e(),r("div",{key:U,class:"flex"},[k.lineStyle=="*"?(e(),r("div",ft,gt)):C("",!0),v("div",xt,[(e(!0),r(le,null,se(k.words,(A,N)=>(e(),r("div",{key:N,class:"flex flex-wrap"},[(e(!0),r(le,null,se(A.text,(D,de)=>{var ne;return e(),r("div",{key:de,class:xe(["border-blue-400",{"border-r-2":D.id==((ne=t.value)==null?void 0:ne.id),"bg-yellow-400":D.comment}]),onClick:ve=>i(D),onContextmenu:ve=>V(ve,D.id)},[D.char==" "?(e(),r("div",bt)):D.char==`
`?(e(),r("div",wt)):(D.char=="#"||D.char=="*")&&N==0?(e(),r("div",kt)):(e(),r("div",{key:3,class:xe({"font-bold":k.lineStyle=="#"})},[v("div",null,$(D.char),1)],2))],42,yt)}),128))]))),128)),v("div",{class:"flex-1",onClick:A=>i(k.words.slice(-1)[0].text.slice(-1)[0])},null,8,Ct)]),F.value.length>0&&!j(te)?(e(),r("div",$t,[(e(!0),r(le,null,se(k.comments,(A,N)=>(e(),R(ye,{key:N,class:"w-full",modelValue:A.content,"onUpdate:modelValue":D=>A.content=D,editing:A.editing,onValidate:D=>A.editing=!1,author:A.author,"created-at":A.created_at},null,8,["modelValue","onUpdate:modelValue","editing","onValidate","author","created-at"]))),128))])):C("",!0)]))),128))]),F.value.length>0&&!j(te)?(e(),r("div",Rt)):C("",!0)])],32)):(e(),r("div",vt,[v("span",null,$(s.fullText),1)]))]))}}),Vt=v("hr",{class:"border-top border-zinc-400 my-4"},null,-1),Tt=v("div",{class:"text-xs italic"},"Raison de la lecture",-1),Ut=E({__name:"SeeThoughtInput",props:{thoughtInput:{}},setup(f){const o=f,{getUserById:a,user:i}=H(),t=p(null),m=B(()=>i.value?o.thoughtInput.interaction_user_id===i.value.id:!1);return ee(async()=>{o.thoughtInput.interaction_user_id&&(t.value=await a(o.thoughtInput.interaction_user_id))}),(h,n)=>(e(),r("div",null,[d(So,{id:h.thoughtInput.resource_id,"second-level":""},null,8,["id"]),Vt,Tt,d(It,{"full-text":h.thoughtInput.interaction_comment,editable:m.value},null,8,["full-text","editable"])]))}}),At={class:"w-full md:w-96"},Dt={key:0,class:"text-xs italic mb-2 bg-white"},Ft={class:"flex flex-wrap"},St={key:1,class:"text-2xs italic ml-2"},Bt={key:2,class:"ml-auto m-1 w-1/3"},Et={key:0,class:"border shadow-lg rounded p-4 md:w-96 bg-white"},Ot={class:"flex"},Pt=["src"],Lt={class:"flex flex-wrap w-full",style:{"margin-top":"-8px"}},Nt={class:"text-2xs"},qt={class:"flex flex-wrap"},zt={key:0,class:"text-2xs italic"},jt=E({__name:"ThoughtInputCard",props:{contextualResource:{},isDisabled:{type:Boolean,default:!1}},setup(f){const o=f,{getUserById:a}=H(),{getAuthorInteractionForResource:i}=ke(),t=p(null),m=p(null),h=p(null);ee(async()=>{o.contextualResource.user_id&&(h.value=await a(o.contextualResource.user_id)),o.contextualResource.resource&&(m.value=await i(o.contextualResource.resource.id)),m.value&&(t.value=await a(m.value.interaction_user_id))});const n=l=>l?l.toLocaleString("fr-FR",{hour:"numeric",weekday:"short",day:"numeric",month:"short",year:"2-digit"}):"",b=l=>l.length>200?l.slice(0,150)+"...":l;return(l,c)=>{const _=Ae("router-link");return e(),r("div",At,[l.contextualResource.context_comment?(e(),r("div",Dt,[v("div",null,$(l.contextualResource.context_comment),1),v("div",Ft,[h.value?(e(),R(_,{key:0,to:"/users/"+h.value.id,class:"text-2xs underline"},{default:O(()=>[ce($(h.value.first_name)+" "+$(h.value.last_name),1)]),_:1},8,["to"])):C("",!0),l.contextualResource.date?(e(),r("div",St,$(n(l.contextualResource.date)),1)):C("",!0),l.contextualResource.progress?(e(),r("div",Bt,[d(De,{"progress-value":l.contextualResource.progress},null,8,["progress-value"])])):C("",!0)])])):C("",!0),l.contextualResource.resource?(e(),R(qe(l.isDisabled?"span":"vue-router"),{key:1,to:"/resources/"+l.contextualResource.resource.id+"?tab=ctnt"},{default:O(()=>[l.contextualResource.resource?(e(),r("div",Et,[v("div",Ot,[l.contextualResource.resource?(e(),r("img",{key:0,class:"w-8 h-fit mr-4",src:l.contextualResource.resource.image_url},null,8,Pt)):C("",!0),v("div",null,[v("div",null,$(l.contextualResource.resource.title)+" "+$(l.contextualResource.resource.subtitle),1),v("div",Lt,[t.value?(e(),R(_,{key:0,to:"/users/"+t.value.id,class:"text-2xs underline"},{default:O(()=>[ce($(t.value.first_name)+" "+$(t.value.last_name),1)]),_:1},8,["to"])):C("",!0)]),v("div",Nt,$(b(l.contextualResource.resource.comment)),1)])]),v("div",qt,[l.contextualResource.date?(e(),r("div",zt,$(n(l.contextualResource.resourcedate)),1)):C("",!0)])])):C("",!0)]),_:1},8,["to"])):C("",!0)])}}}),Mt={class:"w-fit"},Wt=E({__name:"ThoughtInputCardWithPopup",props:{thoughtInput:{},usageReason:{},isDisabled:{type:Boolean,default:!1}},setup(f){const o=p(!1);return(a,i)=>(e(),r("div",Mt,[d(_e,{open:o.value,onClose:i[0]||(i[0]=t=>o.value=!1)},{default:O(()=>[d(Ut,{"thought-input":a.thoughtInput,"usage-reason":a.usageReason},null,8,["thought-input","usage-reason"])]),_:1},8,["open"]),d(jt,{class:"md:w-96","contextual-resource":a.thoughtInput,"is-disabled":a.isDisabled},null,8,["contextual-resource","is-disabled"])]))}}),Ht={class:"relative max-w-full"},Jt={key:0,class:"absolute md:border h-full start-1/2 -z-10"},ie=E({__name:"ThoughtInputsList",props:{contextualResources:{},center:{type:Boolean,default:!1},linksDisabled:{type:Boolean,default:!1}},emits:["select"],setup(f,{emit:o}){const a=t=>t.sort((m,h)=>+(h.date>m.date)),i=t=>{console.log("Select"),o("select",t)};return(t,m)=>(e(),r("div",Ht,[t.center?C("",!0):(e(),r("div",Jt)),(e(!0),r(le,null,se(a(t.contextualResources),(h,n)=>(e(),R(Wt,{key:h.id,class:xe(["mb-4 md:mb-1 mx-auto max-w-full max-w-fit p-1",{"md:ml-0":n%2==0&&!t.center,"md:mr-0":!t.center}]),"thought-input":h,onClick:b=>i(h),"is-disabled":t.linksDisabled},null,8,["class","thought-input","onClick","is-disabled"]))),128))]))}}),Kt={key:0,class:"mb-4"},Gt={key:1},Xt={key:1},Yt={key:2},Qt={class:"flex flex-row-reverse"},Te=E({__name:"CreateResourceRelationForm",props:{targetResource:{},originResource:{}},emits:["close","refresh"],setup(f,{emit:o}){const a=f,{user:i}=H(),t=p(),m=V=>{console.log("Event : ",V),t.value=V},h=p([{text:"Externes",value:"extr"},{text:"Internes",value:"artl"},{text:"Problème",value:"pblm"}]),n=p([{text:"Biblio",value:"bibl"},{text:"Résumé",value:"sumr"},{text:"Sujet principal",value:"main"},{text:"Evocation",value:"mino"}]),b=p([]),l=p(null),c=p([]),_=p([]),w=p([]),P=p(""),J=p(""),{createResourceRelation:K}=Fe(),{getResources:te}=ke(),{getArticles:F}=Oe(),{getProblems:G}=Ge(),M=B(()=>b.value.map(V=>({resource:V.resource}))),W=V=>V.map(T=>({resource:T})),X=B(()=>({extr:W(c.value),artl:W(_.value),pblm:W(w.value)})),L=async()=>{if(console.log("create"),!l.value)return;const V={target_resource_id:a.targetResource?a.targetResource.id:l.value.id,origin_resource_id:a.originResource?a.originResource.id:l.value.id,relation_comment:P.value,relation_type:J.value};await K(V),o("refresh"),o("close")},{getUserThoughtInputs:Y}=We(),oe=V=>{l.value=V.resource};return ee(async()=>{!i.value||!i.value.id||(a.targetResource&&(b.value=await Y(i.value.id)),a.originResource&&(c.value=await te(),_.value=await F({author:!0}),w.value=await G()))}),(V,T)=>(e(),r("div",null,[j(i)?(e(),r("div",Kt," Nouvelle relation entre ressources par "+$(j(i).first_name)+" "+$(j(i).last_name),1)):C("",!0),l.value?(e(),r("div",Yt,[d(ae,{class:"m-4",label:"Type de lien",choices:n.value,modelValue:J.value,"onUpdate:modelValue":T[2]||(T[2]=S=>J.value=S)},null,8,["choices","modelValue"]),d(fe,{class:"m-4",label:"Pourquoi ajouter cet élément ?",modelValue:P.value,"onUpdate:modelValue":T[3]||(T[3]=S=>P.value=S)},null,8,["modelValue"]),v("div",Qt,[d(q,{type:"valid",onClick:L,text:"Ajouter"}),d(q,{type:"abort",onClick:T[4]||(T[4]=S=>o("close")),text:"Annuler",class:"mr-1"})])])):(e(),r("div",Gt,[V.targetResource?(e(),R(ie,{key:0,"contextual-resources":M.value,center:"","links-disabled":"",onSelect:T[0]||(T[0]=S=>oe(S))},null,8,["contextual-resources"])):(e(),r("div",Xt,[v("div",null,[ce(" Choisir une ressource cible "),d(Ue,{center:"",choices:h.value,default:"pblm",onUpdate:m},null,8,["choices"]),d(ie,{"contextual-resources":X.value[t.value]||[],center:"",onSelect:T[1]||(T[1]=S=>oe(S)),"links-disabled":""},null,8,["contextual-resources"])])]))]))]))}}),Zt=E({__name:"CommentsThread",props:{resourceId:{}},setup(f){const o=f,{user:a}=H(),i=p([]),{createComment:t,getCommentsForThoughtOutput:m}=Re(),h=async()=>{console.log("Comment thread"),console.log("Props id : ",o.resourceId),i.value=await m(o.resourceId)},n=B(()=>i.value.filter(c=>!c.start_index).sort((c,_)=>c.created_at-_.created_at)),b=p(""),l=async()=>{await t(o.resourceId,null,b.value,!1),b.value="",await h()};return ee(async()=>await h()),(c,_)=>(e(),r("div",null,[(e(!0),r(le,null,se(n.value,w=>(e(),R(ye,{key:w.id,class:"w-full",modelValue:w.content,"onUpdate:modelValue":P=>w.content=P,editing:w.editing,onValidate:P=>w.editing=!1,author:w.author,"created-at":w.created_at},null,8,["modelValue","onUpdate:modelValue","editing","onValidate","author","created-at"]))),128)),d(ye,{class:"w-full",modelValue:b.value,"onUpdate:modelValue":_[0]||(_[0]=w=>b.value=w),editing:!0,onValidate:l,author:j(a),"created-at":null},null,8,["modelValue","author"])]))}}),eo={class:"flex flex-wrap"},to={class:"flex flex-row-reverse"},oo=E({__name:"CreateInteraction",props:{resource:{}},emits:["close","refresh"],setup(f,{emit:o}){const a=f,i=p([{text:"Lecture / Visionage",value:"inpt"},{text:"Envie",value:"wish"}]),{newInteraction:t,createInteractionForResource:m}=we(),{user:h}=H(),n=p(t());ee(()=>{n.value.interaction_type||(n.value.interaction_type="inpt")});const b=()=>{n.value.resource_id=a.resource.id,n.value.interaction_user_id=h.value.id,m(a.resource.id,n.value),o("refresh"),l()},l=()=>o("close");return(c,_)=>(e(),r("div",null,[v("div",null,"Nouvelle interaction, avec la ressource : "+$(c.resource.title),1),v("div",eo,[d(Z,{label:"Avancement de l'ouvrage",class:"my-auto",modelValue:n.value.interaction_progress,"onUpdate:modelValue":_[0]||(_[0]=w=>n.value.interaction_progress=w),type:"number"},null,8,["modelValue"]),d(ae,{label:"Type d'interaction",class:"m-4 w-full md:w-5/12 md:ml-auto",choices:i.value,modelValue:n.value.interaction_type,"onUpdate:modelValue":_[1]||(_[1]=w=>n.value.interaction_type=w)},null,8,["choices","modelValue"])]),d(Z,{label:"Date de lecture",modelValue:n.value.interaction_date,"onUpdate:modelValue":_[2]||(_[2]=w=>n.value.interaction_date=w),type:"date"},null,8,["modelValue"]),d(fe,{label:"Pourquoi s'y être interessé ?",modelValue:n.value.interaction_comment,"onUpdate:modelValue":_[3]||(_[3]=w=>n.value.interaction_comment=w)},null,8,["modelValue"]),v("div",to,[d(q,{onClick:b,class:"m-4",text:"Valider",type:"valid"}),d(q,{onClick:l,class:"m-4",text:"Annuler",type:"abort"})])]))}}),lo=E({__name:"DateField",props:{date:{}},setup(f){const o=f,a=B(()=>new Date(o.date).toLocaleDateString("fr-FR",{day:"numeric",month:"short",year:"numeric"}));return(i,t)=>(e(),r("div",null,$(a.value),1))}}),so={class:"flex flex-col"},ao={class:"block text-2xs text-slate-800"},no=["value","placeholder"],ro=E({__name:"NumberInput",props:{label:{},modelValue:{},placeholder:{}},emits:["update:modelValue","input"],setup(f,{emit:o}){const a=i=>{o("update:modelValue",i.target.value),o("input",i.target.value)};return(i,t)=>(e(),r("div",so,[v("label",ao,$(i.label),1),v("input",{class:"border border-neutral-400 block h-full w-full rounded-md border-2 p-1 pl-2 text-xs",type:"number",value:i.modelValue,placeholder:i.placeholder,onInput:t[0]||(t[0]=m=>a(m))},null,40,no)]))}}),uo={class:"grid grid-cols-4 gap-y-2 gap-x-4 auto-rows-auto"},io=E({__name:"ArticleForm",props:{article:{}},emits:["change"],setup(f,{emit:o}){const a=f,i=p([{text:"Terminé",value:"fnsh"},{text:"Relecture",value:"rvew"},{text:"Idée",value:"idea"}]),t=p([{text:"Livre",value:"book"},{text:"Fiche de lecture",value:"shet"},{text:"Article de média",value:"natc"},{text:"Article de recherche",value:"ratc"},{text:"Film",value:"movi"},{text:"Podcast",value:"pcst"}]),{categories:m}=ze(),h=B(()=>m.value.map(b=>({text:b.display_name,value:b.id}))),n=(b,l)=>{let c={...a.article};c[b]=l,c.is_external&&(c.maturing_state="fnsh"),console.log("Article : ",c),o("change",c)};return(b,l)=>(e(),r("div",uo,[d(Z,{class:"col-span-4",label:"Titre",modelValue:b.article.title,"onUpdate:modelValue":l[0]||(l[0]=c=>n("title",c))},null,8,["modelValue"]),d(Z,{class:"col-span-4",label:"Sous-titre",modelValue:b.article.subtitle,"onUpdate:modelValue":l[1]||(l[1]=c=>n("subtitle",c))},null,8,["modelValue"]),d(Z,{class:"col-span-4 md:col-span-2",label:"Lien contenu externe",modelValue:b.article.external_content_url,"onUpdate:modelValue":l[2]||(l[2]=c=>n("external_content_url",c))},null,8,["modelValue"]),d(Z,{class:"col-span-4 md:col-span-2",label:"Lien image",modelValue:b.article.image_url,"onUpdate:modelValue":l[3]||(l[3]=c=>n("image_url",c))},null,8,["modelValue"]),d(ae,{label:"Catégorie",class:"col-span-4 md:col-span-1",choices:h.value,"model-value":b.article.category_id,"onUpdate:modelValue":l[4]||(l[4]=c=>n("category_id",c))},null,8,["choices","model-value"]),d(ae,{label:"Type de ressource",class:"col-span-4 md:col-span-1",choices:t.value,"onUpdate:modelValue":l[5]||(l[5]=c=>n("resource_type",c)),"model-value":b.article.resource_type},null,8,["choices","model-value"]),d(ae,{label:"Ressource externe",class:"col-span-4 md:col-span-1",choices:[{text:"Oui",value:!0},{text:"Non",value:!1}],"onUpdate:modelValue":l[6]||(l[6]=c=>n("is_external",JSON.parse(c))),"model-value":b.article.is_external},null,8,["model-value"]),d(ae,{label:"Stade d'écriture",class:"col-span-4 md:col-span-1",choices:i.value,"model-value":b.article.maturing_state,"onUpdate:modelValue":l[7]||(l[7]=c=>n("maturing_state",c))},null,8,["choices","model-value"])]))}}),co={class:"grid grid-cols-3 gap-4"},vo=E({__name:"ResourceAuthorPicker",props:{interaction:{},resourceId:{}},emits:["update"],setup(f,{emit:o}){const a=f,i=B(()=>{var c;return(c=a.interaction)==null?void 0:c.interaction_user_id}),{createInteractionForResource:t,newInteraction:m,createInteraction:h,updateInteraction:n}=we(),b=async c=>{if(console.log(`newUser : ${JSON.stringify(c)}`),a.interaction){const _={...a.interaction};_.interaction_user_id=c,console.log("newUserid : ",c.id),console.log(`Interaction payload : ${JSON.stringify(_)}`),await n(a.interaction.id,_),o("update")}else{console.log("create interaction");const _=m();_.interaction_user_id=c,_.resource_id=a.resourceId,await t(a.resourceId,_),o("update")}},l=async c=>{await n(a.interaction.id,c),o("update")};return(c,_)=>(e(),r("div",co,[d(Ke,{"model-value":i.value,"onUpdate:modelValue":_[0]||(_[0]=w=>b(w))},null,8,["model-value"]),c.interaction?(e(),R(Z,{key:0,class:"text-2xs",label:"Date d'écriture","model-value":c.interaction.interaction_date?c.interaction.interaction_date.split("T")[0]:null,"onUpdate:modelValue":_[1]||(_[1]=w=>l({...c.interaction,interaction_date:w})),type:"date"},null,8,["model-value"])):C("",!0),c.interaction?(e(),R(ro,{key:1,class:"",label:"Progression",modelValue:c.interaction.interaction_progress,"onUpdate:modelValue":_[2]||(_[2]=w=>l({...c.interaction,interaction_progress:w}))},null,8,["modelValue"])):C("",!0)]))}}),mo={key:0,class:"text-center text-2xl pt-10"},po={key:1},_o={key:0},fo={class:"my-8"},ho=["src"],go={class:"text-3xl my-3 font-mplus md:text-center text-left"},xo={class:"md:text-center text-left"},yo={class:"md:text-center text-left"},bo={class:"md:flex my-8"},wo=["href"],ko={key:1,class:"my-2 flex flex-col"},Co={class:"flex flex-row-reverse mb-4"},$o=v("hr",{class:"border-top border-zinc-400 my-4"},null,-1),Ro={key:2},Io=v("div",{class:"text-xs italic"},"Commentaire",-1),Vo=v("hr",{class:"border-top border-zinc-400 my-4"},null,-1),To=v("div",{class:"text-xs italic"},"Contenu",-1),Uo={key:3},Ao={key:4},Do={key:5},Fo={class:"fixed right-3 bottom-5"},So=E({__name:"ResourceComponent",props:{resourceId:{},secondLevel:{type:Boolean}},setup(f){const o=f,a=je(),i=B(()=>o.secondLevel?"popup_tab":"tab"),t=B(()=>[{text:"Contenu",value:"ctnt"},{text:"Biblio",value:"bbli",count:c.value.length},{text:"Sujets",value:"pblm",count:M.value.length},{text:"Interactions",value:"inpt",count:K.value.length}]),m=p(!0),h=p(a.query[i.value]&&typeof a.query[i.value]=="string"?a.query[i.value]:"ctnt"),n=p(a.query[i.value]);ue(()=>a.query[i.value],x=>{console.log("new route query",x),typeof x=="string"&&(n.value=x)});const{getResourceRelationsForResource:b,getUsagesForResource:l}=Fe(),c=p([]),_=p(!1),w=p(!1),P=async()=>{c.value=await b(pe(o).resourceId.value)},J=B(()=>c.value.map(x=>({resource:x.origin_resource,date:x.created_at,user_id:x.user_id,context_comment:x.relation_comment,progress:null}))),K=p([]),{getInteractionsForResource:te}=we(),F=async()=>{K.value=await te(o.resourceId)},G=B(()=>K.value.map(x=>({resource:null,date:x.interaction_date,user_id:x.interaction_user_id,context_comment:x.interaction_comment,progress:x.interaction_progress}))),M=p([]),W=async()=>{M.value=await l(o.resourceId)},X=B(()=>M.value.map(x=>({resource:x.target_resource,date:x.created_at,user_id:x.user_id,context_comment:x.relation_comment,progress:null}))),L=p(!1),{newResource:Y,getResource:oe,updateResource:V,getAuthorInteractionForResource:T}=ke(),S=p(null),g=p(Y()),s=Me();ue(()=>a.query.editing,x=>{console.log("Editing : ",x),u.value=x==="false"?!1:!!x});const u=p(!1),k=x=>{s.push({query:{editing:x.toString()}})},U=()=>{!g.value||!g.value.id||(g.value.publishing_state="pbsh",V(g.value.id,g.value))},A=()=>{!g.value||!g.value.id||(g.value.publishing_state="drft",V(g.value.id,g.value))},N=(x,y)=>{g.value=y,S.value!==null&&clearTimeout(S.value),S.value=setTimeout(async()=>{try{await V(x,g.value)}catch(he){console.log("An error : ",he)}},1e3)},D=x=>{x!=`
`&&N(pe(o).resourceId.value,{...g.value,content:x})},de=x=>{x!=`
`&&N(pe(o).resourceId.value,{...g.value,comment:x})},{user:ne,getUserById:ve}=H(),re=B(()=>g.value.is_external?!0:ne.value?Q.value?Q.value.id==ne.value.id:!0:!1),Q=p(null),z=p(null),me=p(!1),Be=async()=>{z.value=await T(o.resourceId)},{getCommentsForThoughtOutput:Ee}=Re(),Ie=p([]);return ee(async()=>{L.value=!1,g.value=await oe(o.resourceId),L.value=!0,await P(),await F(),await W(),Ie.value=await Ee(o.resourceId),z.value=await T(o.resourceId),z.value&&(Q.value=await ve(z.value.interaction_user_id));const x=a.query.editing;u.value=x==="false"?!1:!!x}),(x,y)=>{const he=Ae("router-link");return e(),r("div",null,[L.value?(e(),r("div",po,[u.value?(e(),r("div",ko,[d(io,{article:g.value,class:"",onChange:y[0]||(y[0]=I=>N(g.value.id,I))},null,8,["article"]),d(vo,{class:"my-2",interaction:z.value,"resource-id":x.resourceId,onChange:Be},null,8,["interaction","resource-id"]),v("div",Co,[d(q,{class:"ml-2",onClick:y[1]||(y[1]=I=>k(!1)),type:"valid",text:"Preview"},{default:O(()=>[ce("Ok")]),_:1}),g.value.publishing_state=="drft"?(e(),R(q,{key:0,class:"ml-2",onClick:U,type:"valid",text:"Publier"})):(e(),R(q,{key:1,class:"ml-2",onClick:A,type:"abort",text:"Dépublier"})),d(q,{class:"ml-2",onClick:y[2]||(y[2]=I=>m.value=!m.value),type:"valid",text:m.value?"Text brut":"Editeur"},null,8,["text"])])])):(e(),r("div",_o,[v("div",fo,[v("img",{src:g.value.image_url,class:"border border-slate-300 dark:border-zinc-700 rounded-xl ml-auto mr-auto",style:{"max-height":"20rem"}},null,8,ho)]),v("h1",go,$(g.value.title),1),v("div",xo,$(g.value.subtitle),1),v("div",yo,[Q.value?(e(),R(he,{key:0,to:"/users/"+Q.value.id,class:"text-sm underline"},{default:O(()=>[ce($(Q.value.first_name)+" "+$(Q.value.last_name),1)]),_:1},8,["to"])):C("",!0),z.value?(e(),R(lo,{key:1,date:z.value.interaction_date},null,8,["date"])):C("",!0)]),v("div",bo,[z.value?(e(),R(De,{key:0,"progress-value":z.value.interaction_progress,class:"m-2 w-1/3"},null,8,["progress-value"])):C("",!0),g.value.external_content_url?(e(),r("a",{key:1,class:"ml-auto underline",href:g.value.external_content_url,target:"_blank"}," Lien ressource externe ",8,wo)):C("",!0)])])),v("div",null,[u.value?C("",!0):(e(),R(Ue,{key:0,choices:t.value,default:h.value,"url-key":i.value,url:""},null,8,["choices","default","url-key"]))]),$o,n.value=="ctnt"?(e(),r("div",Ro,[Io,g.value.publishing_state!="drft"?(e(),R(Ve,{key:0,text:g.value.comment,editable:re.value,onChange:y[3]||(y[3]=I=>de(I))},null,8,["text","editable"])):(e(),R(fe,{key:1,class:"h-20",label:"Commentaire",modelValue:g.value.comment,"onUpdate:modelValue":y[4]||(y[4]=I=>de(I))},null,8,["modelValue"])),Vo,To,L.value&&!g.value.is_local_draft&&m.value?(e(),R(Ve,{key:2,class:"min-h-fit","ext-comments":Ie.value,"resource-id":g.value.id,text:g.value.content,editable:re.value,onChange:y[5]||(y[5]=I=>D(I))},null,8,["ext-comments","resource-id","text","editable"])):(e(),R(fe,{key:3,class:"h-96",label:"Contenu",modelValue:g.value.content,"onUpdate:modelValue":y[6]||(y[6]=I=>D(I))},null,8,["modelValue"])),d(Zt,{class:"mt-6","resource-id":x.resourceId},null,8,["resource-id"])])):n.value=="bbli"?(e(),r("div",Uo,[d(_e,{open:_.value,onClose:y[8]||(y[8]=I=>_.value=!1)},{default:O(()=>[d(Te,{onRefresh:P,onClose:y[7]||(y[7]=I=>_.value=!1),"target-resource":g.value},null,8,["target-resource"])]),_:1},8,["open"]),v("div",{onClick:y[9]||(y[9]=I=>_.value=!0),class:"text-sm italic underline"}," Ajouter une référence "),d(ie,{"contextual-resources":J.value},null,8,["contextual-resources"])])):n.value=="pblm"?(e(),r("div",Ao,[d(ie,{"contextual-resources":X.value},null,8,["contextual-resources"])])):n.value=="inpt"?(e(),r("div",Do,[d(ie,{"contextual-resources":G.value},null,8,["contextual-resources"])])):C("",!0),v("div",Fo,[re.value?(e(),R(ge,{key:0,title:"Modifier",onClick:y[10]||(y[10]=I=>k(!0))},{default:O(()=>[d(j(He),{class:"m-1"})]),_:1})):C("",!0),re.value?(e(),R(ge,{key:1,class:"mt-2",color:"red",title:"Marquer comme lu",onClick:y[11]||(y[11]=I=>me.value=!0)},{default:O(()=>[d(j(Xe),{class:"m-1"})]),_:1})):C("",!0),d(_e,{open:me.value,onClose:y[13]||(y[13]=I=>me.value=!1)},{default:O(()=>[d(oo,{onRefresh:F,onClose:y[12]||(y[12]=I=>me.value=!1),resource:g.value},null,8,["resource"])]),_:1},8,["open"]),re.value?(e(),R(ge,{key:2,class:"mt-2",color:"green",title:"Relier à d'autres ressources",onClick:y[14]||(y[14]=I=>w.value=!0)},{default:O(()=>[d(j(Ye),{class:"m-1"})]),_:1})):C("",!0),d(_e,{open:w.value,onClose:y[16]||(y[16]=I=>w.value=!1)},{default:O(()=>[d(Te,{onRefresh:W,onClose:y[15]||(y[15]=I=>w.value=!1),"origin-resource":g.value},null,8,["origin-resource"])]),_:1},8,["open"])])])):(e(),r("div",mo,"Loading..."))])}}});export{So as _,Ut as a,ie as b};
