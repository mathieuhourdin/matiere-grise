import{_ as ne,a as me,u as Fe}from"./useThoughtInputs-4fda4338.js";import{a as F,_ as Y}from"./ActionButton.vue_vue_type_script_setup_true_lang-ef651057.js";import{o as t,f as a,a as f,d as V,b as p,n as $e,y as Ce,e as H,m as w,F as Z,g as ee,i as d,t as k,h as S,A as ae,B as xe,C as Oe,p as P,D as ye,c as R,x as Re,q as te,r as Ie,w as D,l as ie,E as qe,_ as re,u as pe,G as se,H as Pe,I as Le}from"./index-fea9a0e5.js";import{a as je,u as we,_ as Ne}from"./SelectionTextInterface.vue_vue_type_script_setup_true_lang-c505bc1a.js";import"./SelectionTextInterface.vue_vue_type_style_index_0_lang-06f5da7c.js";import{_ as Ve}from"./ProgressBar.vue_vue_type_script_setup_true_lang-f0216f4d.js";import{u as fe}from"./useResource-062115cd.js";import{_ as Te}from"./UserPicker.vue_vue_type_script_setup_true_lang-3d204ea6.js";import{u as Ue}from"./useResourceRelations-722f0325.js";function ze(y,r){return t(),a("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true"},[f("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M9 8.25H7.5a2.25 2.25 0 00-2.25 2.25v9a2.25 2.25 0 002.25 2.25h9a2.25 2.25 0 002.25-2.25v-9a2.25 2.25 0 00-2.25-2.25H15M9 12l3 3m0 0l3-3m-3 3V2.25"})])}function Me(y,r){return t(),a("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true"},[f("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M7.217 10.907a2.25 2.25 0 100 2.186m0-2.186c.18.324.283.696.283 1.093s-.103.77-.283 1.093m0-2.186l9.566-5.314m-9.566 7.5l9.566 5.314m0 0a2.25 2.25 0 103.935 2.186 2.25 2.25 0 00-3.935-2.186zm0-12.814a2.25 2.25 0 103.933-2.185 2.25 2.25 0 00-3.933 2.185z"})])}function Ke(y,r){return t(),a("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true"},[f("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M21.75 6.75a4.5 4.5 0 01-4.884 4.484c-1.076-.091-2.264.071-2.95.904l-7.152 8.684a2.548 2.548 0 11-3.586-3.586l8.684-7.152c.833-.686.995-1.874.904-2.95a4.5 4.5 0 016.336-4.486l-3.276 3.276a3.004 3.004 0 002.25 2.25l3.276-3.276c.256.565.398 1.192.398 1.852z"}),f("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M4.867 19.125h.008v.008h-.008v-.008z"})])}const We={class:"justify-items-center mx-auto flex flex-wrap max-w-full"},He={key:0,class:"ml-auto"},Je={key:0,class:"absolute right-0 top-0 w-4 h-4 rounded-square text-2xs bg-green-400 text-center"},Ge=f("div",{class:"mr-auto"},null,-1),Ae=V({__name:"ToggleButtonGroup",props:{choices:{},default:{},urlKey:{},url:{type:Boolean,default:!1},center:{type:Boolean,default:!1}},emits:["update"],setup(y,{emit:r}){const s=y,m=p(null),o=$e(),i=Ce(),c=e=>{if(r("update",e),m.value=e,s.url){const n=i.query,u=i.path,h=s.urlKey??"tab";console.log(h);const _={};_[h]=e;const g={...n,..._};o.push({path:u,query:g}),console.log(`route : ${JSON.stringify(i)}`)}};return H(()=>c(s.default??"")),(e,n)=>(t(),a("div",We,[e.center?(t(),a("div",He)):w("",!0),(t(!0),a(Z,null,ee(e.choices,u=>(t(),a("div",{class:"relative",key:u.value},[d(F,{class:"w-30 my-1 mx-1",text:u.text,onClick:h=>c(u.value),type:u.value==m.value?"valid":"abort"},null,8,["text","onClick","type"]),u.count?(t(),a("div",Je,k(u.count),1)):w("",!0)]))),128)),Ge]))}}),Qe={class:"bg-slate-100 border p-1 m-1 rounded shadow-xl"},Xe={class:"flex"},Ye={key:0,class:"text-xs mt-0.5 mb-1 font-bold flex"},Ze=["src"],et={class:"my-auto"},tt={class:"text-2xs italic ml-auto mr-1 my-auto"},lt={key:0},ot=["value"],st={class:"flex"},nt={key:1,class:"text-xs mt-0.5"},be=V({__name:"CommentCard",props:{editing:{type:Boolean},modelValue:{},author:{},createdAt:{}},emits:["update:modelValue","validate","abort"],setup(y,{emit:r}){const s=y,m=S(()=>s.createdAt?s.createdAt.toLocaleString("fr-FR",{hour:"numeric",weekday:"short",day:"numeric",month:"short",year:"2-digit"}):""),o=e=>{r("update:modelValue",e.target.value)},i=()=>{r("validate")},c=()=>{r("abort")};return(e,n)=>(t(),a("div",Qe,[f("div",Xe,[e.author?(t(),a("div",Ye,[e.author.profile_picture_url?(t(),a("img",{key:0,class:"h-5 w-5 rounded-full mr-1",src:e.author.profile_picture_url},null,8,Ze)):w("",!0),f("div",et,k(e.author.first_name)+" "+k(e.author.last_name),1)])):w("",!0),f("div",tt,k(m.value),1)]),e.editing?(t(),a("div",lt,[f("textarea",{class:"w-full text-xs rounded-xl p-2",value:e.modelValue,onInput:o},null,40,ot),f("div",st,[d(F,{onClick:i,class:"text-sm",rounded:"",size:"2xs",text:"Commenter",type:"valid"}),d(F,{onClick:c,class:"text-sm",rounded:"",size:"2xs",text:"Annuler",type:"abort"})])])):(t(),a("div",nt,k(e.modelValue),1))]))}}),at={class:"relative"},rt={key:0},ut=f("div",{class:"text-sm align-middle flex items-center p-2",style:{height:"50px"}}," Corriger une faute ",-1),it={class:"flex mx-auto max-w-full"},ct={class:"w-full"},dt={key:0,class:"flex"},vt=f("div",{class:"w-6"},[f("div",{class:"rounded-full ml-4 mr-2 mt-2 h-1 w-1 bg-black"})],-1),mt=[vt],pt={class:"flex flex-wrap flex-1"},ft=["onClick","onContextmenu"],_t={key:0,style:{width:"5px"}},ht={key:1,style:{height:"25px"}},gt={key:2},xt=["onClick"],yt={key:1,class:"absolute h-full",style:{right:"-2%",width:"27%"}},bt={key:0,style:{width:"33%"}},wt=V({__name:"TextInterface",props:{resourceId:{},fullText:{},extComments:{default:()=>[]},editable:{type:Boolean,default:!0}},emits:["change","changeComments"],setup(y,{emit:r}){const s=y,m=l=>{console.log("selectCursorPosition letter : ",l),s.editable&&(o.value={id:l.id,char:l.char})},o=p(null),i=p([]),c=p([]),e=async()=>{let l=[{id:0,words:[{id:0,text:[]}],comments:[]}],v=0,b=0;for(var A=0;A<i.value.length;A++){i.value[A].char==`
`&&(v+=1,b=0,l.push({id:v,words:[{id:0,text:[]}],lineStyle:A<i.value.length-1?i.value[A+1].char:null,comments:[]}));const U=E.value.find(z=>z.start_index==A);U&&l[v].comments.push(U),l[v].words[b].text.push({id:A,char:i.value[A].char,comment:U}),i.value[A].char==" "&&(b+=1,l[v].words.push({id:b,text:[]}))}return l},n=l=>{l==1?E.value.forEach(v=>{o.value&&v.start_index>o.value.id&&(v.start_index+=1),o.value&&v.end_index>o.value.id&&(v.end_index+=1)}):l==-1&&E.value.forEach(v=>{o.value&&v.start_index>=o.value.id&&(v.start_index-=1),o.value&&v.end_index>=o.value.id&&(v.end_index-=1)})},u=l=>{console.log("insertChar : ",l),o.value&&(console.log("insertChar with cursor set : ",l),i.value.filter(v=>o.value&&v.id>=o.value.id+1).forEach(v=>v.id+=1),i.value.splice(o.value.id+1,0,{id:o.value.id+1,char:l}),n(1),o.value.id+=1)},h=l=>{if(console.log("Writes : ",l.key),o.value===null)return;const v=l.key;if(_.value&&v=="v"){g();return}if(v.length==1)l.preventDefault(),u(v);else if(v=="Backspace")i.value.splice(o.value.id,1),i.value.filter(b=>o.value&&b.id>o.value.id).forEach(b=>b.id-=1),n(-1),o.value.id-=1;else if(v=="Enter")u(`
`);else if(v=="ArrowRight"){let b=o.value.id;b<i.value.length-1&&m(i.value[b+1])}else if(v=="ArrowLeft"){let b=o.value.id;b>0&&m(i.value[b-1])}else v=="Control"&&(console.log("Control"),_.value=!0)},_=p(!1),g=async()=>{try{let v=await navigator.clipboard.readText();console.log("Clippedtext : ",v);for(var l=0;l<v.length;l++)u(v[l])}catch(v){console.log("Error with clippboard : ",v)}},L=l=>{l.key=="Control"&&(_.value=!1)},{createComment:J,batchUpdateComments:G}=we(),{isMobile:M}=Re(),E=p([]),j=p(null),le=async l=>{E.value=l.filter(v=>v.start_index!=null)},Q=async()=>{if(console.log("Add Comment"),console.log(s.resourceId),console.log(N.value),!s.resourceId||!N.value)return;console.log("Add Comment 2");const l=await J(s.resourceId,N.value,N.value);E.value.push(l)};ae(E,async(l,v)=>{console.log("Watch comments triggered : ",l),W.value&&(console.log("Comments : ",l),r("changeComments",l),j.value!==null&&clearTimeout(j.value),j.value=setTimeout(()=>G(l),1e3)),console.log(`Old comments lenght : ${v.length} new length: ${l.length}`),console.log("OldComments : ",v),console.log("NewComments : ",l),v.length===0&&l.length>0&&(console.log("Finally loading comments"),c.value=await e())},{deep:!0}),ae(xe(s).extComments,async l=>{await le(l)});const K=p(!1),N=p(null),C=p({position:"absolute","z-index":90,top:"0px",left:"0px",height:"106px",width:"260px"}),{user:T}=te(),O=(l,v)=>{l.preventDefault(),T.value&&(o.value=null,C.value.top=`${l.layerY}px`,C.value.left=`${l.layerX}px`,K.value=!0,N.value=v,console.log("event : ",l),console.log("Have a new right click"))},_e=l=>{if(i.value=[],l===void 0||l==""){i.value=[{id:0,char:`
`}],m({id:0,char:`
`});return}for(var v=0;v<l.length;v++){const b=E.value.find(A=>A.start_index==v);i.value.push({id:v,char:l[v],comment:b})}},ce=l=>l.reduce((v,b)=>v+b.char,""),W=p(!1);return H(async()=>{await le(s.extComments),await _e(s.fullText),await new Promise(l=>setTimeout(l,10)),c.value=await e(),W.value=!0}),ae(i,async l=>{console.log("Watch triggered : ",l),W.value&&(r("change",ce(l)),c.value=await e())},{deep:!0}),(l,v)=>(t(),a("div",at,[d(je,{text:l.fullText,class:"absolute z-10 h-6 right-2"},null,8,["text"]),W.value?(t(),a("div",{key:1,id:"main-interface",class:"relative md:p-4",tabindex:"0",onKeydown:h,onKeyup:L,onClick:v[0]||(v[0]=b=>K.value=!1)},[K.value?(t(),a("div",{key:0,class:"bg-white border-4",style:Oe(C.value)},[f("div",{onClick:Q,class:"text-sm border-b-2 flex items-center p-2",style:{height:"50px"}}," Ajouter un commentaire "),ut],4)):w("",!0),f("div",it,[f("div",ct,[(t(!0),a(Z,null,ee(c.value,(b,A)=>(t(),a("div",{key:A,class:"flex"},[b.lineStyle=="*"?(t(),a("div",dt,mt)):w("",!0),f("div",pt,[(t(!0),a(Z,null,ee(b.words,(U,z)=>(t(),a("div",{key:z,class:"flex flex-wrap"},[(t(!0),a(Z,null,ee(U.text,(B,de)=>{var ve;return t(),a("div",{key:de,class:ye(["border-blue-400",{"border-r-2":B.id==((ve=o.value)==null?void 0:ve.id),"bg-yellow-400":B.comment}]),onClick:oe=>m(B),onContextmenu:oe=>O(oe,B.id)},[B.char==" "?(t(),a("div",_t)):B.char==`
`?(t(),a("div",ht)):(B.char=="#"||B.char=="*")&&z==0?(t(),a("div",gt)):(t(),a("div",{key:3,class:ye({"font-bold":b.lineStyle=="#"})},[f("div",null,k(B.char),1)],2))],42,ft)}),128))]))),128)),f("div",{class:"flex-1",onClick:U=>m(b.words.slice(-1)[0].text.slice(-1)[0])},null,8,xt)]),E.value.length>0&&!P(M)?(t(),a("div",yt,[(t(!0),a(Z,null,ee(b.comments,(U,z)=>(t(),R(be,{key:z,class:"w-full",modelValue:U.content,"onUpdate:modelValue":B=>U.content=B,editing:U.editing,onValidate:B=>U.editing=!1,author:U.author,"created-at":U.created_at},null,8,["modelValue","onUpdate:modelValue","editing","onValidate","author","created-at"]))),128))])):w("",!0)]))),128))]),E.value.length>0&&!P(M)?(t(),a("div",bt)):w("",!0)])],32)):(t(),a("div",rt,[f("span",null,k(l.fullText),1)]))]))}}),kt=f("hr",{class:"border-top border-zinc-400 my-4"},null,-1),$t=f("div",{class:"text-xs italic"},"Raison de la lecture",-1),Ct=V({__name:"SeeThoughtInput",props:{thoughtInput:{}},setup(y){const r=y,{getUserById:s,user:m}=te(),o=p(null),i=S(()=>m.value?r.thoughtInput.interaction_user_id===m.value.id:!1);return H(async()=>{r.thoughtInput.interaction_user_id&&(o.value=await s(r.thoughtInput.interaction_user_id))}),(c,e)=>(t(),a("div",null,[d(Tl,{id:c.thoughtInput.resource_id,"second-level":""},null,8,["id"]),kt,$t,d(wt,{"full-text":c.thoughtInput.interaction_comment,editable:i.value},null,8,["full-text","editable"])]))}}),Rt={class:"w-full md:w-96"},It={key:0,class:"text-xs italic mb-2 bg-white"},Vt={class:"flex flex-wrap"},Tt={key:1,class:"text-2xs italic ml-2"},Ut={key:2,class:"ml-auto m-1 w-1/3"},At={key:0,class:"border shadow-lg rounded p-4 md:w-96 bg-white"},Bt={class:"flex"},Dt=["src"],Et={class:"flex flex-wrap w-full",style:{"margin-top":"-8px"}},St={class:"text-2xs"},Ft={class:"flex flex-wrap"},Ot={key:0,class:"text-2xs italic"},qt=V({__name:"ThoughtInputCard",props:{contextualResource:{},isDisabled:{type:Boolean,default:!1}},setup(y){const r=y,{getUserById:s}=te(),{getAuthorInteractionForResource:m}=fe(),o=p(null),i=p(null),c=p(null);H(async()=>{r.contextualResource.user_id&&(c.value=await s(r.contextualResource.user_id)),r.contextualResource.resource&&(i.value=await m(r.contextualResource.resource.id)),i.value&&(o.value=await s(i.value.interaction_user_id))});const e=u=>u?u.toLocaleString("fr-FR",{hour:"numeric",weekday:"short",day:"numeric",month:"short",year:"2-digit"}):"",n=u=>u.length>200?u.slice(0,150)+"...":u;return(u,h)=>{const _=Ie("router-link");return t(),a("div",Rt,[u.contextualResource.context_comment?(t(),a("div",It,[f("div",null,k(u.contextualResource.context_comment),1),f("div",Vt,[c.value?(t(),R(_,{key:0,to:"/users/"+c.value.id,class:"text-2xs underline"},{default:D(()=>[ie(k(c.value.first_name)+" "+k(c.value.last_name),1)]),_:1},8,["to"])):w("",!0),u.contextualResource.date?(t(),a("div",Tt,k(e(u.contextualResource.date)),1)):w("",!0),u.contextualResource.progress?(t(),a("div",Ut,[d(Ve,{"progress-value":u.contextualResource.progress},null,8,["progress-value"])])):w("",!0)])])):w("",!0),u.contextualResource.resource?(t(),R(qe(u.isDisabled?"span":"vue-router"),{key:1,to:"/resources/"+u.contextualResource.resource.id+"?tab=ctnt"},{default:D(()=>[u.contextualResource.resource?(t(),a("div",At,[f("div",Bt,[u.contextualResource.resource?(t(),a("img",{key:0,class:"w-8 h-fit mr-4",src:u.contextualResource.resource.image_url},null,8,Dt)):w("",!0),f("div",null,[f("div",null,k(u.contextualResource.resource.title)+" "+k(u.contextualResource.resource.subtitle),1),f("div",Et,[o.value?(t(),R(_,{key:0,to:"/users/"+o.value.id,class:"text-2xs underline"},{default:D(()=>[ie(k(o.value.first_name)+" "+k(o.value.last_name),1)]),_:1},8,["to"])):w("",!0)]),f("div",St,k(n(u.contextualResource.resource.comment)),1)])]),f("div",Ft,[u.contextualResource.date?(t(),a("div",Ot,k(e(u.contextualResource.resourcedate)),1)):w("",!0)])])):w("",!0)]),_:1},8,["to"])):w("",!0)])}}}),Pt={class:"w-fit"},Lt=V({__name:"ThoughtInputCardWithPopup",props:{thoughtInput:{},usageReason:{},isDisabled:{type:Boolean,default:!1}},setup(y){const r=p(!1);return(s,m)=>(t(),a("div",Pt,[d(ne,{open:r.value,onClose:m[0]||(m[0]=o=>r.value=!1)},{default:D(()=>[d(Ct,{"thought-input":s.thoughtInput,"usage-reason":s.usageReason},null,8,["thought-input","usage-reason"])]),_:1},8,["open"]),d(qt,{class:"md:w-96","contextual-resource":s.thoughtInput,"is-disabled":s.isDisabled},null,8,["contextual-resource","is-disabled"])]))}}),jt={class:"relative max-w-full"},Nt={key:0,class:"absolute md:border h-full start-1/2 -z-10"},ue=V({__name:"ThoughtInputsList",props:{contextualResources:{},center:{type:Boolean,default:!1},linksDisabled:{type:Boolean,default:!1}},emits:["select"],setup(y,{emit:r}){const s=o=>o.sort((i,c)=>+(c.date>i.date)),m=o=>{console.log("Select"),r("select",o)};return(o,i)=>(t(),a("div",jt,[o.center?w("",!0):(t(),a("div",Nt)),(t(!0),a(Z,null,ee(s(o.contextualResources),(c,e)=>(t(),R(Lt,{key:c.id,class:ye(["mb-4 md:mb-1 mx-auto max-w-full max-w-fit p-1",{"md:ml-0":e%2==0&&!o.center,"md:mr-0":!o.center}]),"thought-input":c,onClick:n=>m(c),"is-disabled":o.linksDisabled},null,8,["class","thought-input","onClick","is-disabled"]))),128))]))}}),zt={key:0,class:"mb-4"},Mt={key:1},Kt={key:1},Wt={key:2},Ht={class:"flex flex-row-reverse"},Be=V({__name:"CreateResourceRelationForm",props:{targetResource:{},originResource:{}},emits:["close","refresh"],setup(y,{emit:r}){const s=y,{user:m}=te(),o=p(),i=C=>{console.log("Event : ",C),o.value=C},c=p([{text:"Externes",value:"extr"},{text:"Internes",value:"artl"},{text:"Problème",value:"pblm"}]),e=p([{text:"Biblio",value:"bibl"},{text:"Résumé",value:"sumr"},{text:"Sujet principal",value:"main"},{text:"Evocation",value:"mino"}]),n=p([]),u=p(null),h=p([]),_=p([]),g=p([]),L=p(""),J=p(""),{createResourceRelation:G}=Ue(),{getResources:M}=fe(),E=S(()=>n.value.map(C=>({resource:C.resource}))),j=C=>C.map(T=>({resource:T})),le=S(()=>({extr:j(h.value),artl:j(_.value),pblm:j(g.value)})),Q=async()=>{if(console.log("create"),!u.value)return;const C={target_resource_id:s.targetResource?s.targetResource.id:u.value.id,origin_resource_id:s.originResource?s.originResource.id:u.value.id,relation_comment:L.value,relation_type:J.value};await G(C),r("refresh"),r("close")},{getUserThoughtInputs:K}=Fe(),N=C=>{u.value=C.resource};return H(async()=>{!m.value||!m.value.id||(s.targetResource&&(n.value=await K(m.value.id)),s.originResource&&(h.value=await M({is_external:!0}),_.value=await M({is_external:!1,resource_type:"oatc"}),g.value=await M({is_external:!1,resource_type:"pblm"})))}),(C,T)=>(t(),a("div",null,[P(m)?(t(),a("div",zt," Nouvelle relation entre ressources par "+k(P(m).first_name)+" "+k(P(m).last_name),1)):w("",!0),u.value?(t(),a("div",Wt,[d(re,{class:"m-4",label:"Type de lien",choices:e.value,modelValue:J.value,"onUpdate:modelValue":T[2]||(T[2]=O=>J.value=O)},null,8,["choices","modelValue"]),d(me,{class:"m-4",label:"Pourquoi ajouter cet élément ?",modelValue:L.value,"onUpdate:modelValue":T[3]||(T[3]=O=>L.value=O)},null,8,["modelValue"]),f("div",Ht,[d(F,{type:"valid",onClick:Q,text:"Ajouter"}),d(F,{type:"abort",onClick:T[4]||(T[4]=O=>r("close")),text:"Annuler",class:"mr-1"})])])):(t(),a("div",Mt,[C.targetResource?(t(),R(ue,{key:0,"contextual-resources":E.value,center:"","links-disabled":"",onSelect:T[0]||(T[0]=O=>N(O))},null,8,["contextual-resources"])):(t(),a("div",Kt,[f("div",null,[ie(" Choisir une ressource cible "),d(Ae,{center:"",choices:c.value,default:"pblm",onUpdate:i},null,8,["choices"]),d(ue,{"contextual-resources":le.value[o.value]||[],center:"",onSelect:T[1]||(T[1]=O=>N(O)),"links-disabled":""},null,8,["contextual-resources"])])]))]))]))}}),Jt={class:"flex flex-wrap"},Gt={class:"flex flex-row-reverse"},Qt=V({__name:"CreateInteraction",props:{resource:{}},emits:["close","refresh"],setup(y,{emit:r}){const s=y,m=p([{text:"Lecture / Visionage",value:"inpt"},{text:"Envie",value:"wish"}]),{newInteraction:o,createInteractionForResource:i}=pe(),{user:c}=te(),e=p(o());H(()=>{e.value.interaction_type||(e.value.interaction_type="inpt")});const n=()=>{e.value.resource_id=s.resource.id,e.value.interaction_user_id=c.value.id,i(s.resource.id,e.value),r("refresh"),u()},u=()=>r("close");return(h,_)=>(t(),a("div",null,[f("div",null,"Nouvelle interaction, avec la ressource : "+k(h.resource.title),1),f("div",Jt,[d(Y,{label:"Avancement de l'ouvrage",class:"my-auto",modelValue:e.value.interaction_progress,"onUpdate:modelValue":_[0]||(_[0]=g=>e.value.interaction_progress=g),type:"number"},null,8,["modelValue"]),d(re,{label:"Type d'interaction",class:"m-4 w-full md:w-5/12 md:ml-auto",choices:m.value,modelValue:e.value.interaction_type,"onUpdate:modelValue":_[1]||(_[1]=g=>e.value.interaction_type=g)},null,8,["choices","modelValue"])]),d(Y,{label:"Date de lecture",modelValue:e.value.interaction_date,"onUpdate:modelValue":_[2]||(_[2]=g=>e.value.interaction_date=g),type:"date"},null,8,["modelValue"]),d(me,{label:"Pourquoi s'y être interessé ?",modelValue:e.value.interaction_comment,"onUpdate:modelValue":_[3]||(_[3]=g=>e.value.interaction_comment=g)},null,8,["modelValue"]),f("div",Gt,[d(F,{onClick:n,class:"m-4",text:"Valider",type:"valid"}),d(F,{onClick:u,class:"m-4",text:"Annuler",type:"abort"})])]))}}),Xt=f("div",null,"Demander une Review pour l'article :",-1),Yt={class:"flex flex-row-reverse mt-4"},Zt=V({__name:"CreateReview",props:{resource:{}},emits:["close","refresh"],setup(y,{emit:r}){const s=y,{newInteraction:m,createInteractionForResource:o}=pe(),i=async()=>{const n=m();n.interaction_user_id=e.value,n.resource_id=s.resource.id,n.interaction_type="rvew",n.interaction_comment=c.value,await o(s.resource.id,n),r("refresh"),r("close")},c=p(""),e=p(null);return(n,u)=>(t(),a("div",null,[Xt,f("div",null,k(n.resource.title),1),d(Te,{modelValue:e.value,"onUpdate:modelValue":u[0]||(u[0]=h=>e.value=h)},null,8,["modelValue"]),d(me,{class:"mt-4",label:"Message pour la review",modelValue:c.value,"onUpdate:modelValue":u[1]||(u[1]=h=>c.value=h)},null,8,["modelValue"]),f("div",Yt,[d(F,{type:"valid",onClick:i,text:"Ajouter"}),d(F,{type:"abort",onClick:u[2]||(u[2]=h=>r("close")),text:"Annuler",class:"mr-1"})])]))}}),el=V({__name:"ResourceTools",props:{resource:{},isResourceEditable:{type:Boolean}},emits:["refresh","edit"],setup(y,{emit:r}){const s=p(!1),m=p(!1),o=p(!1),i=p(!1);return(c,e)=>(t(),a("div",null,[c.isResourceEditable&&s.value?(t(),R(se,{key:0,title:"Modifier",onClick:e[0]||(e[0]=n=>r("edit"))},{default:D(()=>[d(P(Pe),{class:"m-1"})]),_:1})):w("",!0),c.isResourceEditable&&s.value?(t(),R(se,{key:1,class:"mt-2",color:"blue",title:"Demander une review",onClick:e[1]||(e[1]=n=>m.value=!0)},{default:D(()=>[d(P(Le),{class:"m-1"})]),_:1})):w("",!0),d(ne,{open:m.value,onClose:e[4]||(e[4]=n=>m.value=!1)},{default:D(()=>[d(Zt,{onRefresh:e[2]||(e[2]=n=>r("refresh")),onClose:e[3]||(e[3]=n=>m.value=!1),resource:c.resource},null,8,["resource"])]),_:1},8,["open"]),c.isResourceEditable&&s.value?(t(),R(se,{key:2,class:"mt-2",color:"red",title:"Marquer comme lu",onClick:e[5]||(e[5]=n=>o.value=!0)},{default:D(()=>[d(P(ze),{class:"m-1"})]),_:1})):w("",!0),d(ne,{open:o.value,onClose:e[8]||(e[8]=n=>o.value=!1)},{default:D(()=>[d(Qt,{onRefresh:e[6]||(e[6]=n=>r("refresh")),onClose:e[7]||(e[7]=n=>o.value=!1),resource:c.resource},null,8,["resource"])]),_:1},8,["open"]),c.isResourceEditable&&s.value?(t(),R(se,{key:3,class:"mt-2",color:"green",title:"Relier à d'autres ressources",onClick:e[9]||(e[9]=n=>i.value=!0)},{default:D(()=>[d(P(Me),{class:"m-1"})]),_:1})):w("",!0),d(ne,{open:i.value,onClose:e[12]||(e[12]=n=>i.value=!1)},{default:D(()=>[d(Be,{onRefresh:e[10]||(e[10]=n=>r("refresh")),onClose:e[11]||(e[11]=n=>i.value=!1),"origin-resource":c.resource},null,8,["origin-resource"])]),_:1},8,["open"]),d(se,{class:"mt-2",color:"gray",onClick:e[13]||(e[13]=n=>s.value=!s.value)},{default:D(()=>[d(P(Ke))]),_:1})]))}}),tl=V({__name:"CommentsThread",props:{resourceId:{}},setup(y){const r=y,{user:s}=te(),m=p([]),{createComment:o,getCommentsForThoughtOutput:i}=we(),c=async()=>{console.log("Comment thread"),console.log("Props id : ",r.resourceId),m.value=await i(r.resourceId)},e=S(()=>m.value.filter(h=>!h.start_index).sort((h,_)=>h.created_at-_.created_at)),n=p(""),u=async()=>{await o(r.resourceId,null,null,n.value,!1),n.value="",await c()};return H(async()=>await c()),(h,_)=>(t(),a("div",null,[(t(!0),a(Z,null,ee(e.value,g=>(t(),R(be,{key:g.id,class:"w-full",modelValue:g.content,"onUpdate:modelValue":L=>g.content=L,editing:g.editing,onValidate:L=>g.editing=!1,author:g.author,"created-at":g.created_at},null,8,["modelValue","onUpdate:modelValue","editing","onValidate","author","created-at"]))),128)),d(be,{class:"w-full",modelValue:n.value,"onUpdate:modelValue":_[0]||(_[0]=g=>n.value=g),editing:!0,onValidate:u,author:P(s),"created-at":null},null,8,["modelValue","author"])]))}}),ll=V({__name:"DateField",props:{date:{}},setup(y){const r=y,s=S(()=>new Date(r.date).toLocaleDateString("fr-FR",{day:"numeric",month:"short",year:"numeric"}));return(m,o)=>(t(),a("div",null,k(s.value),1))}}),ol={class:"flex flex-col"},sl={class:"block text-2xs text-slate-800"},nl=["value","placeholder"],al=V({__name:"NumberInput",props:{label:{},modelValue:{},placeholder:{}},emits:["update:modelValue","input"],setup(y,{emit:r}){const s=m=>{r("update:modelValue",m.target.value),r("input",m.target.value)};return(m,o)=>(t(),a("div",ol,[f("label",sl,k(m.label),1),f("input",{class:"border border-neutral-400 block h-full w-full rounded-md border-2 p-1 pl-2 text-xs",type:"number",value:m.modelValue,placeholder:m.placeholder,onInput:o[0]||(o[0]=i=>s(i))},null,40,nl)]))}}),rl={class:"grid grid-cols-4 gap-y-2 gap-x-4 auto-rows-auto"},ul=V({__name:"ArticleForm",props:{article:{}},emits:["change"],setup(y,{emit:r}){const s=y,m=p([{text:"Terminé",value:"fnsh"},{text:"Relecture",value:"rvew"},{text:"Brouillon",value:"drft"},{text:"Poubelle",value:"trsh"}]),{resourceTypeOptions:o}=fe(),i=(c,e)=>{let n={...s.article};n[c]=e,n.is_external&&(n.maturing_state="fnsh"),console.log("Article : ",n),r("change",n)};return(c,e)=>(t(),a("div",rl,[d(Y,{class:"col-span-4",label:"Titre",modelValue:c.article.title,"onUpdate:modelValue":e[0]||(e[0]=n=>i("title",n))},null,8,["modelValue"]),d(Y,{class:"col-span-4",label:"Sous-titre",modelValue:c.article.subtitle,"onUpdate:modelValue":e[1]||(e[1]=n=>i("subtitle",n))},null,8,["modelValue"]),d(Y,{class:"col-span-4 md:col-span-2",label:"Lien contenu externe",modelValue:c.article.external_content_url,"onUpdate:modelValue":e[2]||(e[2]=n=>i("external_content_url",n))},null,8,["modelValue"]),d(Y,{class:"col-span-4 md:col-span-2",label:"Lien image",modelValue:c.article.image_url,"onUpdate:modelValue":e[3]||(e[3]=n=>i("image_url",n))},null,8,["modelValue"]),d(re,{label:"Type de ressource",class:"col-span-4 md:col-span-2",choices:P(o),"onUpdate:modelValue":e[4]||(e[4]=n=>i("resource_type",n)),"model-value":c.article.resource_type},null,8,["choices","model-value"]),d(re,{label:"Ressource externe",class:"col-span-4 md:col-span-1",choices:[{text:"Oui",value:!0},{text:"Non",value:!1}],"onUpdate:modelValue":e[5]||(e[5]=n=>i("is_external",JSON.parse(n))),"model-value":c.article.is_external},null,8,["model-value"]),d(re,{label:"Stade d'écriture",class:"col-span-4 md:col-span-1",choices:m.value,"model-value":c.article.maturing_state,"onUpdate:modelValue":e[6]||(e[6]=n=>i("maturing_state",n))},null,8,["choices","model-value"])]))}}),il={class:"grid grid-cols-3 gap-4"},cl=V({__name:"ResourceAuthorPicker",props:{interaction:{},resourceId:{}},emits:["update"],setup(y,{emit:r}){const s=y,m=S(()=>{var h;return(h=s.interaction)==null?void 0:h.interaction_user_id}),{createInteractionForResource:o,newInteraction:i,createInteraction:c,updateInteraction:e}=pe(),n=async h=>{if(console.log(`newUser : ${JSON.stringify(h)}`),s.interaction){const _={...s.interaction};_.interaction_user_id=h,console.log("newUserid : ",h.id),console.log(`Interaction payload : ${JSON.stringify(_)}`),await e(s.interaction.id,_),r("update")}else{console.log("create interaction");const _=i();_.interaction_user_id=h,_.resource_id=s.resourceId,await o(s.resourceId,_),r("update")}},u=async h=>{await e(s.interaction.id,h),r("update")};return(h,_)=>(t(),a("div",il,[d(Te,{"model-value":m.value,"onUpdate:modelValue":_[0]||(_[0]=g=>n(g))},null,8,["model-value"]),h.interaction?(t(),R(Y,{key:0,class:"text-2xs",label:"Date d'écriture","model-value":h.interaction.interaction_date?h.interaction.interaction_date.split("T")[0]:null,"onUpdate:modelValue":_[1]||(_[1]=g=>u({...h.interaction,interaction_date:g})),type:"date"},null,8,["model-value"])):w("",!0),h.interaction?(t(),R(al,{key:1,class:"",label:"Progression",modelValue:h.interaction.interaction_progress,"onUpdate:modelValue":_[2]||(_[2]=g=>u({...h.interaction,interaction_progress:g}))},null,8,["modelValue"])):w("",!0)]))}}),dl={key:0,class:"text-center text-2xl pt-10"},vl={key:1},ml={key:0},pl={class:"my-8"},fl=["src"],_l={class:"text-3xl my-3 font-mplus md:text-center text-left"},hl={class:"md:text-center text-left"},gl={class:"md:text-center text-left"},xl={class:"md:flex my-8"},yl=["href"],bl={key:1,class:"my-2 flex flex-col"},wl={class:"flex flex-row-reverse mb-4"},kl=f("hr",{class:"border-top border-zinc-400 my-4"},null,-1),$l={key:2},Cl=f("div",{class:"text-xs italic"},"Contenu",-1),Rl={key:3},Il={key:4},Vl={key:5},Tl=V({__name:"ResourceComponent",props:{resourceId:{},secondLevel:{type:Boolean}},setup(y){const r=y,s=Ce(),m=S(()=>A.value&&b.value||!C.value||l.value.is_local_draft||!c.value),o=S(()=>r.secondLevel?"popup_tab":"tab"),i=S(()=>[{text:"Contenu",value:"ctnt"},{text:"Biblio",value:"bbli",count:_.value.length},{text:"Sujets",value:"pblm",count:Q.value.length},{text:"Interactions",value:"inpt",count:G.value.length}]),c=p(!0),e=p(s.query[o.value]&&typeof s.query[o.value]=="string"?s.query[o.value]:"ctnt"),n=p(s.query[o.value]);ae(()=>s.query[o.value],x=>{console.log("new route query",x),typeof x=="string"&&(n.value=x)});const{getResourceRelationsForResource:u,getUsagesForResource:h}=Ue(),_=p([]),g=p(!1),L=async()=>{_.value=await u(xe(r).resourceId.value)},J=S(()=>_.value.map(x=>({resource:x.origin_resource,date:x.created_at,user_id:x.user_id,context_comment:x.relation_comment,progress:null}))),G=p([]),{getInteractionsForResource:M,updateInteraction:E}=pe(),j=async()=>{G.value=await M(r.resourceId)},le=S(()=>G.value.map(x=>({resource:null,date:x.interaction_date,user_id:x.interaction_user_id,context_comment:x.interaction_comment,progress:x.interaction_progress}))),Q=p([]),K=async()=>{Q.value=await h(r.resourceId)},N=S(()=>Q.value.map(x=>({resource:x.target_resource,date:x.created_at,user_id:x.user_id,context_comment:x.relation_comment,progress:null}))),C=p(!1),{newResource:T,getResource:O,updateResource:_e,getAuthorInteractionForResource:ce}=fe(),W=p(null),l=p(T()),v=$e();ae(()=>s.query.editing,x=>{console.log("Editing : ",x),b.value=x==="false"?!1:!!x});const b=p(!1),{isMobile:A}=Re(),U=x=>{v.push({query:{editing:x.toString()}})},z=(x,$)=>{l.value=$,W.value!==null&&clearTimeout(W.value),W.value=setTimeout(async()=>{try{await _e(x,l.value)}catch(ge){console.log("An error : ",ge)}},1e3)},B=x=>{x!=`
`&&z(xe(r).resourceId.value,{...l.value,content:x})},{user:de,getUserById:ve}=te(),oe=S(()=>l.value.is_external?!0:de.value?X.value?X.value.id==de.value.id:!0:!1),X=p(null),I=p(null),he=async()=>{I.value=await ce(r.resourceId)},De=async()=>{!I.value||!I.value.id||(await E(I.value.id,{...I.value,interaction_is_public:!0}),he())},Ee=async()=>{!I.value||!I.value.id||(await E(I.value.id,{...I.value,interaction_is_public:!1}),he())},{getCommentsForThoughtOutput:Se}=we(),ke=p([]);return H(async()=>{C.value=!1,l.value=await O(r.resourceId),C.value=!0,await L(),await j(),await K(),ke.value=await Se(r.resourceId),I.value=await ce(r.resourceId),I.value&&(X.value=await ve(I.value.interaction_user_id));const x=s.query.editing;b.value=x==="false"?!1:!!x}),(x,$)=>{const ge=Ie("router-link");return t(),a("div",null,[C.value?(t(),a("div",vl,[b.value?(t(),a("div",bl,[d(ul,{article:l.value,class:"",onChange:$[0]||($[0]=q=>z(l.value.id,q))},null,8,["article"]),d(cl,{class:"my-2",interaction:I.value,"resource-id":x.resourceId,onChange:he},null,8,["interaction","resource-id"]),f("div",wl,[d(F,{class:"ml-2",onClick:$[1]||($[1]=q=>U(!1)),type:"valid",text:"Preview"},{default:D(()=>[ie("Ok")]),_:1}),I.value.interaction_is_public?(t(),R(F,{key:1,class:"ml-2",onClick:Ee,type:"abort",text:"Dépublier"})):(t(),R(F,{key:0,class:"ml-2",onClick:De,type:"valid",text:"Publier"})),d(F,{class:"ml-2",onClick:$[2]||($[2]=q=>c.value=!c.value),type:"valid",text:c.value?"Text brut":"Editeur"},null,8,["text"])])])):(t(),a("div",ml,[f("div",pl,[f("img",{src:l.value.image_url,class:"border border-slate-300 dark:border-zinc-700 rounded-xl ml-auto mr-auto",style:{"max-height":"20rem"}},null,8,fl)]),f("h1",_l,k(l.value.title),1),f("div",hl,k(l.value.subtitle),1),f("div",gl,[X.value?(t(),R(ge,{key:0,to:"/users/"+X.value.id,class:"text-sm underline"},{default:D(()=>[ie(k(X.value.first_name)+" "+k(X.value.last_name),1)]),_:1},8,["to"])):w("",!0),I.value?(t(),R(ll,{key:1,date:I.value.interaction_date},null,8,["date"])):w("",!0)]),f("div",xl,[I.value?(t(),R(Ve,{key:0,"progress-value":I.value.interaction_progress,class:"m-2 w-1/3"},null,8,["progress-value"])):w("",!0),l.value.external_content_url?(t(),a("a",{key:1,class:"ml-auto underline",href:l.value.external_content_url,target:"_blank"}," Lien ressource externe ",8,yl)):w("",!0)])])),f("div",null,[b.value?w("",!0):(t(),R(Ae,{key:0,choices:i.value,default:e.value,"url-key":o.value,url:""},null,8,["choices","default","url-key"]))]),kl,n.value=="ctnt"?(t(),a("div",$l,[Cl,m.value?(t(),R(me,{key:0,class:"mt-4 h-96",modelValue:l.value.content,"onUpdate:modelValue":$[3]||($[3]=q=>B(q))},null,8,["modelValue"])):(t(),R(Ne,{key:1,class:"min-h-fit","ext-comments":ke.value,"resource-id":l.value.id,text:l.value.content,editable:oe.value,onChange:$[4]||($[4]=q=>B(q))},null,8,["ext-comments","resource-id","text","editable"])),d(tl,{class:"mt-6","resource-id":x.resourceId},null,8,["resource-id"])])):n.value=="bbli"?(t(),a("div",Rl,[d(ne,{open:g.value,onClose:$[6]||($[6]=q=>g.value=!1)},{default:D(()=>[d(Be,{onRefresh:L,onClose:$[5]||($[5]=q=>g.value=!1),"target-resource":l.value},null,8,["target-resource"])]),_:1},8,["open"]),f("div",{onClick:$[7]||($[7]=q=>g.value=!0),class:"text-sm italic underline"}," Ajouter une référence "),d(ue,{"contextual-resources":J.value},null,8,["contextual-resources"])])):n.value=="pblm"?(t(),a("div",Il,[d(ue,{"contextual-resources":N.value},null,8,["contextual-resources"])])):n.value=="inpt"?(t(),a("div",Vl,[d(ue,{"contextual-resources":le.value},null,8,["contextual-resources"])])):w("",!0),d(el,{class:"fixed right-3 bottom-5",resource:l.value,"is-resource-editable":oe.value,onRefresh:$[8]||($[8]=q=>K()&&j()),onEdit:$[9]||($[9]=q=>U(!0))},null,8,["resource","is-resource-editable"])])):(t(),a("div",dl,"Loading..."))])}}});export{Tl as _,Ct as a,ue as b};
