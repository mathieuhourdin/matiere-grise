import{g as D,o as n,c as i,a as v,t as C,d as U,_ as W,q as T,u as J,r as h,h as Q,n as g,m as P,i as Z,s as ee,l as S,F as _,v as y,x as te,e as oe}from"./index-5e350ad8.js";const ae={class:"bg-slate-100 border p-1 m-1 rounded shadow-xl"},se={class:"text-xs m-0.5 font-bold"},le={key:0},ne=["value"],re={class:"flex"},ie={key:1,class:"text-xs"},ue=D({__name:"CommentCard",props:{editing:{type:Boolean},modelValue:{},author:{}},emits:["update:modelValue","validate","abort"],setup(d,{emit:r}){const u=o=>{r("update:modelValue",o.target.value)},m=()=>{r("validate")},s=()=>{r("abort")};return(o,A)=>(n(),i("div",ae,[v("div",se,C(o.author.first_name)+" "+C(o.author.last_name),1),o.editing?(n(),i("div",le,[v("textarea",{class:"w-full text-xs rounded-xl p-2",value:o.modelValue,onInput:u},null,40,ne),v("div",re,[U(W,{onClick:m,class:"text-sm",rounded:"",size:"2xs",text:"Commenter",type:"valid"}),U(W,{onClick:s,class:"text-sm",rounded:"",size:"2xs",text:"Annuler",type:"abort"})])])):(n(),i("div",ie,C(o.modelValue),1))]))}}),de=async(d,r)=>{const{user:u}=J(),m={start_index:r,end_index:r};try{const o=(await T.post("/articles/"+d+"/comments",m)).data;return u.value&&o.author_id==u.value.id&&(o.author=u.value),o}catch(s){console.log("error : ",s)}},ce=async(d,r=!0)=>{const u=r?"?author=true":"";try{return(await T.get("/articles/"+d+"/comments"+u)).data}catch(m){console.log("error : ",m)}},L=async d=>{try{return(await T.put("/comments/"+d.id,d)).data}catch(r){console.log("error : ",r)}},me=async d=>{console.log("comments : ",d),d.map(r=>L(r))};function ve(){return{createComment:de,getCommentsForArticle:ce,updateComment:L,batchUpdateComments:me}}const he=v("div",{class:"text-sm align-middle flex items-center p-2",style:{height:"50px"}}," Corriger une faute ",-1),pe={class:"flex mx-auto max-w-full"},fe={class:"w-full"},xe={class:"flex flex-wrap"},ge=["onClick","onContextmenu"],_e={key:0,style:{width:"5px"}},ye={key:1,style:{height:"25px"}},Ce={key:2},we={class:"absolute h-full",style:{right:"-2%",width:"27%"}},ke={key:0,style:{width:"33%"}},Ve=D({__name:"TextInterface",props:{ressourceId:{},fullText:{},extComments:{default:()=>[]},editable:{type:Boolean,default:!0}},emits:["change","changeComments"],setup(d,{emit:r}){const u=d,m=e=>{console.log("selectCursorPosition letter : ",e),u.editable&&(s.value={id:e.id,char:e.char})},s=h(null),o=h([]),A=Q(()=>N(o.value)),N=e=>{console.log("textArrayFromString textString: ",e);let t=[{id:0,words:[{id:0,text:[]}],text:[],comments:[]}],a=0,f=0;for(var l=0;l<o.value.length;l++){o.value[l].char==`
`&&(a+=1,f=0,t.push({id:a,words:[{id:0,text:[]}],text:[],comments:[]}));const x=p.value.find(c=>c.start_index==l);x&&t[a].comments.push(x),t[a].words[f].text.push({id:l,char:o.value[l].char,comment:x}),o.value[l].char==" "&&(f+=1,t[a].words.push({id:f,text:[{id:l,char:o.value[l].char}]}))}return t},w=e=>{o.value.filter(t=>t.id>=s.value.id+1).forEach(t=>t.id+=1),o.value.splice(s.value.id+1,0,{id:s.value.id+1,char:e,line:0}),p.value.forEach(t=>{t.start_index>s.value.id&&(t.start_index+=1),t.end_index>s.value.id&&(t.end_index+=1)}),s.value.id+=1},R=e=>{if(console.log("Writes : ",e.key),s.value===null)return;const t=e.key;if(k.value&&t=="v"){K();return}if(t.length==1)e.preventDefault(),w(t);else if(t=="Backspace")o.value.splice(s.value.id,1),o.value.filter(a=>a.id>s.value.id).forEach(a=>a.id-=1),s.value.id-=1;else if(t=="Enter")w(`
`);else if(t=="ArrowRight"){let a=s.value.id;a<o.value.length-1&&m(o.value[a+1])}else if(t=="ArrowLeft"){let a=s.value.id;a>0&&m(o.value[a-1])}else t=="Control"&&(console.log("Control"),k.value=!0)},k=h(!1),K=async()=>{try{let t=await navigator.clipboard.readText();console.log("Clippedtext : ",t);for(var e=0;e<t.length;e++)w(t[e])}catch(t){console.log("Error with clippboard : ",t)}},O=e=>{e.key=="Control"&&(k.value=!1)},{createComment:j,batchUpdateComments:q}=ve(),p=h([]),E=h(null),H=e=>{console.log("Comments loading : ",e),p.value=e},M=async()=>{console.log("Add Comment");const e=await j(u.ressourceId,I.value);p.value.push(e)};g(p,e=>{console.log("Watch comments triggered : ",e.value),$.value&&(console.log("Comments : ",e),r("changeComments",e.value),clearTimeout(E.value),E.value=setTimeout(()=>q(e),1e3))},{deep:!0}),g(P(u).extComments,e=>{p.value=e});const b=h(!1),I=h(null),V=h({position:"absolute","z-index":90,top:0,left:0,height:"106px",width:"260px"}),X=(e,t)=>{e.preventDefault(),V.value.top=`${e.layerY}px`,V.value.left=`${e.layerX}px`,b.value=!0,I.value=t,console.log("event : ",e),console.log("Have a new right click")},B=e=>{if(console.log("textArrayFromString textString: ",e),o.value=[],e===void 0||e==""){o.value=[{id:0,char:`
`}],m({id:0,char:`
`});return}for(var t=0;t<e.length;t++){const a=p.value.find(f=>f.start_index==t);o.value.push({id:t,char:e[t],comment:a})}},Y=e=>e.reduce((t,a)=>t+a.char,""),$=h(!1);return Z(()=>{B(u.fullText),H(u.extComments),$.value=!0}),g(o,e=>{console.log("Watch triggered : ",e),$.value&&r("change",Y(e))},{deep:!0}),g(P(u).fullText,e=>{B(e)}),(e,t)=>(n(),i("div",{class:"relative p-4",tabindex:"0",onKeydown:R,onKeyup:O,onClick:t[0]||(t[0]=a=>b.value=!1)},[b.value?(n(),i("div",{key:0,class:"bg-white border-4",style:ee(V.value)},[v("div",{onClick:M,class:"text-sm border-b-2 flex items-center p-2",style:{height:"50px"}}," Ajouter un commentaire "),he],4)):S("",!0),v("div",pe,[v("div",fe,[(n(!0),i(_,null,y(A.value,(a,f)=>(n(),i("div",{key:f,class:"flex flex-wrap"},[v("div",xe,[(n(!0),i(_,null,y(a.words,(l,x)=>(n(),i("div",{key:x,class:"flex flex-wrap"},[(n(!0),i(_,null,y(l.text,(c,G)=>{var F;return n(),i("div",{key:G,class:te(["border-blue-400",{"border-r-2":c.id==((F=s.value)==null?void 0:F.id),"bg-yellow-400":c.comment}]),onClick:z=>m(c),onContextmenu:z=>X(z,c.id)},[c.char==" "?(n(),i("div",_e)):c.char==`
`?(n(),i("div",ye)):(n(),i("div",Ce,[v("div",null,C(c.char),1)]))],42,ge)}),128))]))),128))]),v("div",we,[(n(!0),i(_,null,y(a.comments,(l,x)=>(n(),oe(ue,{key:x,class:"w-full",modelValue:l.content,"onUpdate:modelValue":c=>l.content=c,editing:l.editing,onValidate:c=>l.editing=!1,author:l.author},null,8,["modelValue","onUpdate:modelValue","editing","onValidate","author"]))),128))])]))),128))]),p.value.length>0?(n(),i("div",ke,"Espace")):S("",!0)])],32))}});export{Ve as _,ve as u};
